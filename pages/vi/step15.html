<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Shinhan Bank - Xác thực eKYC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="https://shinhan.com.vn/favicon.ico">
    <style>
        :root {
            --primary-color: #0072CE; --secondary-color: #F5F7FA; --accent-color: #00A859;
            --error-color: #E63946; --text-color: #333; --text-light: #6c757d;
            --border-color: #DEE2E6; --border-radius: 8px; --shadow: 0 4px 15px rgba(0, 0, 0, 0.07);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: var(--secondary-color); color: var(--text-color); line-height: 1.6; margin: 0; padding: 0; overflow-x: hidden; }
        .hidden { display: none !important; }
        .app-header { background: #fff; padding: 15px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: center; margin-bottom: 20px; position: sticky; top: 0; z-index: 1010; display: flex; align-items: center; justify-content: center; }
        .app-header img { height: 30px; max-width: 150px; }
        .back-button { position: absolute; left: 20px; font-size: 1.5rem; color: var(--text-color); cursor: pointer; }
        .progress-bar-container { display: flex; justify-content: space-between; align-items: center; max-width: 400px; margin: 20px auto; position: relative; }
        .progress-bar-line { position: absolute; top: 50%; left: 0; right: 0; height: 2px; background-color: var(--border-color); transform: translateY(-50%); z-index: 1; }
        .progress-bar-fill { position: absolute; top: 0; left: 0; height: 100%; width: 0%; background-color: var(--primary-color); transition: width 0.4s ease-in-out; }
        .progress-step { display: flex; flex-direction: column; align-items: center; z-index: 2; position: relative; }
        .step-circle { width: 30px; height: 30px; border-radius: 50%; background-color: #fff; border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; font-weight: 600; color: var(--text-light); transition: var(--transition); }
        .step-label { font-size: 0.8rem; color: var(--text-light); margin-top: 8px; transition: var(--transition); }
        .progress-step.active .step-circle { border-color: var(--primary-color); background-color: var(--primary-color); color: #fff; }
        .progress-step.active .step-label { color: var(--primary-color); font-weight: 600; }
        .progress-step.completed .step-circle { border-color: var(--accent-color); background-color: var(--accent-color); color: #fff; }
        .content-card { background: white; padding: clamp(20px, 5vw, 40px); border-radius: var(--border-radius); box-shadow: var(--shadow); margin: 20px auto 120px; max-width: 600px; }
        #guideSection ul li { margin: 15px 0; display: flex; align-items: center; font-size: 1rem; }
        .camera-frame { position: relative; width: 100%; max-width: 480px; aspect-ratio: 1.586 / 1; margin: 15px auto; border-radius: var(--border-radius); overflow: hidden; background: #000; }
        .camera-frame video { display: none; }
        .camera-frame canvas { width: 100%; height: 100%; display: block; }
        .error-message { background-color: #FFF2F2; color: var(--error-color); border: 1px solid var(--border-color); opacity: 0; transition: opacity 0.3s ease; padding: 10px; border-radius: var(--border-radius); margin-top: 1rem; font-weight: 500; min-height: 1.5rem; }
        .error-message.visible { opacity: 1; border-color: var(--error-color); }
        .field-error { background-color: #FFF2F2; color: var(--error-color); border: 1px solid var(--error-color); padding: 5px 8px; border-radius: var(--border-radius); margin: 5px 0 0 120px; font-size: 0.8rem; min-height: 1.2rem; opacity: 0; transition: opacity 0.3s ease; }
        .field-error:not(:empty) { opacity: 1; }
        .loader { width: 48px; height: 48px; border: 5px solid var(--secondary-color); border-top: 5px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 50px auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .btn { border-radius: var(--border-radius); padding: 12px 28px; font-weight: 600; transition: var(--transition); border: 1px solid transparent; }
        .btn .spinner-border { width: 1rem; height: 1rem; vertical-align: middle; margin-right: 0.5rem; display: none; }
        .btn.is-loading .spinner-border { display: inline-block; }
        .btn:disabled { cursor: not-allowed; opacity: 0.65; }
        .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #005a9e; border-color: #005a9e; }
        .btn-secondary { background-color: #e9ecef; border-color: #e9ecef; color: var(--text-color); }
        .btn-secondary:hover:not(:disabled) { background-color: #d8dde1; border-color: #d8dde1; }
        .camera-frame.blink-once { animation: blink 0.5s 1; }
        @keyframes blink { 50% { box-shadow: 0 0 20px var(--primary-color); } }
        .status-message { font-size: 0.9rem; color: var(--primary-color); margin: 1rem 0; min-height: 1.5rem; text-align: center; }
        .info-group { margin: 20px 0; padding: 15px; border: 1px solid var(--border-color); border-radius: var(--border-radius); background-color: var(--secondary-color); }
        .info-item { display: flex; flex-wrap: wrap; align-items: center; margin-bottom: 10px; }
        .info-item:last-of-type { margin-bottom: 0; }
        .info-label { font-weight: 600; width: 120px; color: var(--text-light); flex-shrink: 0; }
        .info-value { flex: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: var(--border-radius); background: white; min-width: 150px; }
        .info-value[contenteditable="true"]:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(0, 114, 206, 0.2); }
        #captureSection .cameraView, #captureSection .loader, #captureSection .manualCaptureBtn, #captureSection .recaptureBtn, #captureSection .nextStepBtn { display: none; }
        #captureSection[data-state="capture_streaming"] .cameraView { display: block; }
        #captureSection[data-state="capture_streaming"] .manualCaptureBtn { display: inline-flex; }
        #captureSection[data-state="capture_review"] .cameraView { display: block; }
        #captureSection[data-state="capture_review"] .recaptureBtn, #captureSection[data-state="capture_review"] .nextStepBtn { display: inline-flex; }
        #captureSection[data-state="loading"] .loader { display: block; }
    </style>
</head>
<body>
    <header class="app-header">
        <i id="backButton" class="fas fa-arrow-left back-button hidden"></i>
        <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo.png" alt="Shinhan Bank Logo">
    </header>
    <main class="container">
        <div class="progress-bar-container">
            <div class="progress-bar-line"><div id="progressBarFill" class="progress-bar-fill"></div></div>
            <div id="step1" class="progress-step"><div class="step-circle">1</div><div class="step-label">Mặt trước</div></div>
            <div id="step2" class="progress-step"><div class="step-circle">2</div><div class="step-label">Mặt sau</div></div>
        </div>
        <div class="content-card">
            <div id="guideSection">
                <div style="text-align: center; padding: 10px;">
                    <h3>Xác thực Giấy tờ tùy thân</h3>
                    <ul style="list-style: none; padding: 0; text-align: left; max-width: 450px; margin: 30px auto;">
                        <li><i class="fas fa-mobile-alt" style="color: var(--primary-color); margin-right: 15px; width: 24px; text-align: center;"></i> Ưu tiên sử dụng camera sau của điện thoại.</li>
                        <li><i class="fas fa-image" style="color: var(--primary-color); margin-right: 15px; width: 24px; text-align: center;"></i> Đặt CCCD trên một mặt phẳng, màu tối.</li>
                        <li><i class="fas fa-lightbulb" style="color: var(--primary-color); margin-right: 15px; width: 24px; text-align: center;"></i> Đảm bảo môi trường đủ sáng, không lóa.</li>
                    </ul>
                    <p id="mainErrorMessage" class="error-message" role="alert" aria-live="assertive"></p>
                    <div class="button-group"><button id="startCaptureBtn" class="btn btn-primary">Bắt đầu chụp</button></div>
                </div>
            </div>
            <div id="captureSection" class="hidden">
                <div style="text-align: center;"> <h3 id="captureTitle"></h3><p id="captureInstruction" style="color: var(--text-light);"></p></div>
                <div id="cameraView" class="camera-frame"><video id="cameraVideo" autoplay playsinline></video><canvas id="cameraCanvasPreview"></canvas></div>
                <div id="loader" class="loader"></div>
                <div>
                    <p id="statusMessage" class="status-message" aria-live="polite"></p>
                    <div class="button-group">
                        <button id="manualCaptureBtn" class="btn btn-secondary"><i class="fas fa-camera"></i> Chụp ảnh</button>
                        <button id="recaptureBtn" class="btn btn-secondary"><i class="fas fa-redo"></i> Chụp lại</button>
                        <button id="nextStepBtn" class="btn btn-primary">Tiếp tục</button>
                    </div>
                </div>
            </div>
            <div id="confirmSection" class="hidden">
                <div><h3>Xác nhận thông tin</h3><p style="color: var(--text-light);">Vui lòng kiểm tra và chỉnh sửa (nếu cần).</p></div>
                <div style="display: flex; flex-direction: column; gap: 20px; margin: 20px 0;">
                    <img id="frontPreview" alt="Ảnh xem trước mặt trước của giấy tờ tùy thân" style="width: 100%; max-width: 300px; border-radius: 8px; margin: 0 auto;">
                    <img id="backPreview" alt="Ảnh xem trước mặt sau của giấy tờ tùy thân" style="width: 100%; max-width: 300px; border-radius: 8px; margin: 0 auto;">
                </div>
                <dl class="info-group">
                    <div class="info-item"><dt class="info-label">Số CCCD:</dt><dd id="ocrCccdNumber" class="info-value" contenteditable="true" role="textbox" aria-label="Số Căn cước công dân" aria-describedby="cccdError"></dd><p id="cccdError" class="field-error"></p></div>
                    <div class="info-item"><dt class="info-label">Họ và tên:</dt><dd id="ocrFullName" class="info-value" contenteditable="true" role="textbox" aria-label="Họ và tên" aria-describedby="fullNameError"></dd><p id="fullNameError" class="field-error"></p></div>
                    <div class="info-item"><dt class="info-label">Ngày sinh:</dt><dd id="ocrDateOfBirth" class="info-value" contenteditable="true" role="textbox" aria-label="Ngày sinh" aria-describedby="dobError"></dd><p id="dobError" class="field-error"></p></div>
                    <div class="info-item"><dt class="info-label">Giới tính:</dt><dd id="ocrGender" class="info-value" contenteditable="true" role="textbox" aria-label="Giới tính" aria-describedby="genderError"></dd><p id="genderError" class="field-error"></p></div>
                    <div class="info-item"><dt class="info-label">Địa chỉ:</dt><dd id="ocrAddress" class="info-value" contenteditable="true" role="textbox" aria-label="Địa chỉ"></dd></div>
                </dl>
                <div class="button-group"><button id="redoAllBtn" class="btn btn-secondary">Chụp lại từ đầu</button></div>
                <div class="button-group"><button id="confirmBtn" class="btn btn-primary w-100"><span class="spinner-border spinner-border-sm"></span>Xác nhận</button></div>
            </div>
        </div>
    </main>

<script>
"use strict";
const IDCaptureApp = {
    state: {
        isBusy: false, isPermanentError: false, appStep: 'guide', error: null,
        captureType: 'front', imageData: { front: null, back: null },
        stream: null, videoOrientation: 0, facingMode: 'environment',
        animationFrameId: null, extractedInfo: null, previewImage: null,
        boundResizeHandler: null, boundPopstateHandler: null,
    },
    elements: {},
    config: {
        ERROR_MESSAGE_TIMEOUT: 5000, NEXT_STEP_URL: 'https://vaytieudung.github.io/shinhanbank/pages/vi/step3.html',
        cameraResolution: { width: { ideal: 1280 }, height: { ideal: 720 } }
    },

    setState(newState) { Object.assign(this.state, newState); requestAnimationFrame(() => this._updateUI()); },
    logError(message, error, isPermanent = false) { console.error(`[EKYC] ${message}`, error || ''); this.setState({ isBusy: false, error: message, isPermanentError: isPermanent }); },

    init() {
        this._cacheDOMElements(); this._addEventListeners();
        if (!('mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices)) {
             this.logError("Trình duyệt không hỗ trợ camera.", null, true);
        }
        this.setState({});
    },
    
    async startCaptureProcess(type) {
        if (this.state.isBusy) return;
        this.setState({ isBusy: true, appStep: 'capture_streaming', captureType: type, error: null });
        let attempts = 2;
        while (attempts--) {
            try {
                let stream, facingMode = 'environment';
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: 'environment' }, ...this.config.cameraResolution } });
                } catch (err) {
                    if (err.name === "OverconstrainedError" || err.name === "NotFoundError") {
                        console.warn("Không tìm thấy camera sau, đang thử camera trước.");
                        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', ...this.config.cameraResolution } });
                        facingMode = 'user';
                    } else { throw err; }
                }
                this.elements.cameraVideo.srcObject = stream;
                await new Promise(resolve => { this.elements.cameraVideo.onloadedmetadata = resolve; });
                try { await this.elements.cameraVideo.play(); } 
                catch (playErr) {
                    this.stopCamera(); this.logError("Không thể phát luồng camera.", playErr, true);
                    this.setState({ appStep: 'guide' }); return;
                }
                const video = this.elements.cameraVideo;
                this.setState({
                    isBusy: false, stream: stream, facingMode: facingMode,
                    videoOrientation: video.videoHeight > video.videoWidth ? 90 : 0
                });
                this._runRenderLoop();
                return;
            } catch (err) {
                if (attempts === 0) {
                    this.stopCamera();
                    this.logError("Không thể truy cập camera. Vui lòng kiểm tra quyền trong cài đặt trình duyệt.", err, true);
                    this.setState({ appStep: 'guide' });
                }
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }
    },
    
    stopCamera() {
        if (this.state.stream && this.state.stream.active) this.state.stream.getTracks().forEach(track => track.stop());
        if (this.state.animationFrameId) cancelAnimationFrame(this.state.animationFrameId);
        this.setState({ stream: null, animationFrameId: null });
    },

    triggerCapture() {
        if (this.state.isBusy) return;
        const canvas = this.elements.cameraCanvasPreview;
        if (canvas.width === 0 || canvas.height === 0) { this.logError("Không thể chụp ảnh do canvas không hợp lệ."); return; }
        this.setState({ isBusy: true });
        this.elements.cameraFrame.classList.add('blink-once');
        setTimeout(() => this.elements.cameraFrame.classList.remove('blink-once'), 500);
        this._triggerHapticFeedback();
        const imageDataUrl = canvas.toDataURL('image/jpeg', 0.9);
        if (!imageDataUrl || !imageDataUrl.startsWith('data:image/jpeg')) {
            this.logError("Không thể tạo ảnh từ canvas."); this.setState({ isBusy: false }); return;
        }
        const { captureType, imageData } = this.state;
        this.stopCamera();
        this.setState({ imageData: { ...imageData, [captureType]: imageDataUrl }, appStep: 'capture_review', isBusy: false });
    },

    confirmAndProceed() {
        if (this.state.captureType === 'front') this.startCaptureProcess('back');
        else this.setState({ extractedInfo: this._simulateOCR(), appStep: 'confirm' });
    },
    
    _updateUI() {
        const { isBusy, appStep, captureType, imageData, error, stream, isPermanentError } = this.state;
        if(this.elements.confirmBtn) this.elements.confirmBtn.classList.toggle('is-loading', isBusy && appStep === 'confirm');
        
        document.querySelectorAll('button').forEach(btn => btn.disabled = isBusy);
        this.elements.guideSection.classList.toggle('hidden', appStep !== 'guide');
        this.elements.captureSection.classList.toggle('hidden', !appStep.startsWith('capture'));
        this.elements.confirmSection.classList.toggle('hidden', appStep !== 'confirm');
        if (this.elements.backButton) this.elements.backButton.classList.toggle('hidden', appStep === 'guide' || appStep === 'confirm');

        const frontDone = !!imageData.front, backDone = !!imageData.back;
        if (this.elements.step1) this.elements.step1.classList.toggle('completed', frontDone);
        if (this.elements.step2) this.elements.step2.classList.toggle('completed', backDone);
        if (this.elements.step1) this.elements.step1.classList.toggle('active', appStep.startsWith('capture') && captureType === 'front');
        if (this.elements.step2) this.elements.step2.classList.toggle('active', appStep.startsWith('capture') && captureType === 'back');
        if (this.elements.progressBarFill) this.elements.progressBarFill.style.width = backDone ? '100%' : (frontDone ? '50%' : '0%');
        
        if (appStep.startsWith('capture')) {
            this._updateCanvasSize();
            this.elements.captureSection.dataset.state = isBusy ? 'loading' : appStep;
            if (this.elements.captureTitle) this.elements.captureTitle.textContent = captureType === 'front' ? "Chụp mặt trước CCCD" : "Chụp mặt sau CCCD";
            if (this.elements.captureInstruction) this.elements.captureInstruction.textContent = appStep === 'capture_streaming' ? "Căn chỉnh giấy tờ và nhấn nút Chụp ảnh." : "Kiểm tra ảnh vừa chụp.";
            if (this.elements.statusMessage) this.elements.statusMessage.textContent = isBusy ? "Đang xử lý..." : appStep === 'capture_streaming' ? "Sẵn sàng chụp." : "Ảnh đã được chụp.";
            
            if (this.state.previewImage) { this.state.previewImage.onload = null; this.state.previewImage.onerror = null; this.state.previewImage.src = ''; }
            if (appStep === 'capture_review') {
                if (this.elements.nextStepBtn) this.elements.nextStepBtn.textContent = captureType === 'front' ? 'Tiếp tục: Chụp mặt sau' : 'Hoàn tất & Xem lại';
                const canvas = this.elements.cameraCanvasPreview, ctx = canvas && canvas.getContext('2d');
                if (!ctx) { this.logError("Không thể truy cập context canvas."); return; }
                if (imageData[captureType]) {
                    const img = new Image();
                    img.onload = () => { this._updateCanvasSize(); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); };
                    img.onerror = () => this.logError("Không thể tải ảnh xem trước.");
                    img.src = imageData[captureType];
                    this.state.previewImage = img;
                } else { this.logError("Không có ảnh để xem trước."); }
            }
        }
        
        if (appStep === 'confirm') {
            this.elements.frontPreview.src = imageData.front; this.elements.backPreview.src = imageData.back;
            Object.entries(this.state.extractedInfo || {}).forEach(([key, value]) => {
                const elId = 'ocr' + key.charAt(0).toUpperCase() + key.slice(1);
                if (this.elements[elId]) this.elements[elId].textContent = value;
            });
            if (this.elements.confirmBtn) this.elements.confirmBtn.disabled = !frontDone || !backDone || isBusy;
        }
        
        const errorEl = this.elements.mainErrorMessage;
        if (error && errorEl) {
            errorEl.textContent = error; errorEl.classList.add('visible');
            if (isPermanentError) { errorEl.style.opacity = '1'; if(this.elements.startCaptureBtn) this.elements.startCaptureBtn.classList.add('hidden'); } 
            else { setTimeout(() => { if (this.state.error === error) this.setState({ error: null }); }, this.config.ERROR_MESSAGE_TIMEOUT); }
        } else if(errorEl) { errorEl.textContent = ''; errorEl.classList.remove('visible'); }
    },
    
    _runRenderLoop() {
        if (!this.state.stream || !this.elements.cameraVideo.videoWidth) {
            if (this.state.animationFrameId) cancelAnimationFrame(this.state.animationFrameId);
            return;
        }
        const video = this.elements.cameraVideo, canvas = this.elements.cameraCanvasPreview, context = canvas.getContext('2d');
        if (!context) { this.logError("Không thể truy cập context canvas."); return; }
        const frameWidth = this.elements.cameraFrame.offsetWidth, frameHeight = this.elements.cameraFrame.offsetHeight;
        if (canvas.width !== frameWidth || canvas.height !== frameHeight) {
            canvas.width = frameWidth; canvas.height = frameHeight;
        }
        context.clearRect(0, 0, canvas.width, canvas.height); context.save();
        context.translate(canvas.width / 2, canvas.height / 2);
        context.rotate(this.state.videoOrientation * (Math.PI / 180));
        if (this.state.facingMode === 'user') context.scale(-1, 1);
        const logicalWidth = this.state.videoOrientation === 90 ? video.videoHeight : video.videoWidth;
        const logicalHeight = this.state.videoOrientation === 90 ? video.videoWidth : video.videoHeight;
        const scale = Math.max(canvas.width / logicalWidth, canvas.height / logicalHeight);
        context.drawImage(video, -video.videoWidth*scale / 2, -video.videoHeight*scale / 2, video.videoWidth * scale, video.videoHeight*scale);
        context.restore();
        this.state.animationFrameId = requestAnimationFrame(() => this._runRenderLoop());
    },

    _updateCanvasSize() {
        const canvas = this.elements.cameraCanvasPreview;
        if (canvas && this.elements.cameraFrame) {
            canvas.width = this.elements.cameraFrame.offsetWidth;
            canvas.height = this.elements.cameraFrame.offsetHeight;
        }
    },

    _simulateOCR: () => ({ cccdNumber: `0${Math.floor(1e11+9e11*Math.random())}`, fullName: "NGUYEN VAN A", dateOfBirth: "01/01/1990", gender: "Nam", address: "TP. Hồ Chí Minh" }),

    _triggerHapticFeedback() {
        if ("vibrate" in navigator) navigator.vibrate(50); 
        else { document.body.classList.add('feedback-flash'); setTimeout(() => document.body.classList.remove('feedback-flash'), 300); }
    },
    
    cleanupAndReset() {
        this.stopCamera();
        this.setState({ appStep: 'guide', error: null, isPermanentError: false, imageData: { front: null, back: null }, extractedInfo: null });
        ['cccdError', 'dobError', 'fullNameError', 'genderError'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = ''; });
        if (this.state.previewImage) {
            this.state.previewImage.onload = null; this.state.previewImage.onerror = null;
            this.state.previewImage.src = ''; this.state.previewImage = null;
        }
        const canvas = this.elements.cameraCanvasPreview;
        if (canvas) canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
    },
    
    _addEventListeners() {
        this.handlers = {
            startCaptureBtn: () => this.startCaptureProcess('front'),
            manualCaptureBtn: () => this.triggerCapture(),
            recaptureBtn: () => this.startCaptureProcess(this.state.captureType),
            nextStepBtn: () => this.confirmAndProceed(),
            backButton: () => this.cleanupAndReset(),
            redoAllBtn: () => this.cleanupAndReset(),
            confirmBtn: async () => {
                const updatedOcr = {}; let isValid = true;
                Object.keys(this._simulateOCR()).forEach(key => {
                    const elId = 'ocr' + key.charAt(0).toUpperCase() + key.slice(1);
                    if (this.elements[elId]) { updatedOcr[key] = this.elements[elId].textContent.trim(); this.elements[elId].style.borderColor = 'var(--border-color)'; }
                });
                const errorElements = { cccdError: 'cccdError', dobError: 'dobError', fullNameError: 'fullNameError', genderError: 'genderError' };
                Object.values(errorElements).forEach(id => { const el = document.getElementById(id); if(el) el.textContent = ''; });
                if (updatedOcr.cccdNumber && !/^\d{12}$/.test(updatedOcr.cccdNumber)) { document.getElementById(errorElements.cccdError).textContent = "Số CCCD phải có 12 chữ số."; isValid = false; }
                if (updatedOcr.dateOfBirth && !/^\d{2}\/\d{2}\/\d{4}$/.test(updatedOcr.dateOfBirth)) { document.getElementById(errorElements.dobError).textContent = "Định dạng ngày sinh là DD/MM/YYYY."; isValid = false; }
                if (!updatedOcr.fullName || !/^[a-zA-Z\sÀ-ỹ]+$/.test(updatedOcr.fullName)) { document.getElementById(errorElements.fullNameError).textContent = "Họ tên không hợp lệ."; this.elements.ocrFullName.style.borderColor = 'var(--error-color)'; isValid = false; }
                if (!updatedOcr.gender || !/^(Nam|Nữ)$/i.test(updatedOcr.gender)) { document.getElementById(errorElements.genderError).textContent = "Giới tính là 'Nam' hoặc 'Nữ'."; this.elements.ocrGender.style.borderColor = 'var(--error-color)'; isValid = false; }
                
                if (!isValid) {
                    setTimeout(() => {
                        Object.values(errorElements).forEach(id => { const el = document.getElementById(id); if(el) el.textContent = ''; });
                        ['ocrFullName', 'ocrGender'].forEach(id => { if (this.elements[id]) this.elements[id].style.borderColor = 'var(--border-color)'; });
                    }, this.config.ERROR_MESSAGE_TIMEOUT);
                    return;
                }
                this.setState({ isBusy: true });
                await new Promise(r => setTimeout(r, 1500));
                console.log("Final Data:", { imageData: this.state.imageData, ocrData: updatedOcr });
                window.location.href = this.config.NEXT_STEP_URL;
            }
        };
        Object.entries(this.handlers).forEach(([id, handler]) => {
            if (this.elements[id]) { this.elements[id].__handler = handler.bind(this); this.elements[id].addEventListener('click', this.elements[id].__handler); }
        });
        this.state.boundResizeHandler = () => this._updateCanvasSize();
        this.state.boundPopstateHandler = () => { if (this.state.appStep !== 'guide') this.cleanupAndReset(); };
        window.addEventListener('resize', this.state.boundResizeHandler);
        window.addEventListener('popstate', this.state.boundPopstateHandler);
    },

    cleanup() {
        this.stopCamera();
        Object.values(this.elements).forEach(el => { if (el && el.__handler) el.removeEventListener('click', el.__handler); });
        if (this.state.boundResizeHandler) window.removeEventListener('resize', this.state.boundResizeHandler);
        if (this.state.boundPopstateHandler) window.removeEventListener('popstate', this.state.boundPopstateHandler);
    },
    
    _cacheDOMElements() {
        const ids=["guideSection","captureSection","startCaptureBtn","cameraView","cameraFrame","cameraVideo","statusMessage","loader","errorMessage","manualCaptureBtn","recaptureBtn","nextStepBtn","captureTitle","captureInstruction","backButton","confirmSection","frontPreview","backPreview","redoAllBtn","confirmBtn","cameraCanvasPreview","ocrCccdNumber","ocrFullName","ocrDateOfBirth","ocrGender","ocrAddress", "mainErrorMessage", "step1", "step2", "progressBarFill"];
        ids.forEach(id => { if(document.getElementById(id)) this.elements[id] = document.getElementById(id) });
    },
};

document.addEventListener('DOMContentLoaded', () => IDCaptureApp.init());
</script>
</body>
</html>
