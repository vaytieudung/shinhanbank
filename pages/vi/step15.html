<script>
"use strict";

const IDCaptureApp = {
    // Application State
    state: {
        frontImageVerified: false,
        backImageVerified: false,
        frontImageDataUrl: null,
        backImageDataUrl: null,
        currentStream: null,
        currentCaptureType: 'front',
        isAutoCapturing: false, // Vẫn giữ để quản lý trạng thái loading
        simulationAttempts: 0,
        currentFacingMode: 'environment',
        videoOrientation: 0,
        
        cameraCanvasPreview: null,
        cameraCanvasContext: null,
        animationFrameId: null,
        
        extractedInfo: {
            cccdNumber: '',
            fullName: '',
            dateOfBirth: '',
            gender: '',
            address: ''
        }
    },

    elements: {},

    // [ĐÃ SỬA] Xóa bỏ AUTO_CAPTURE_INTERVAL
    config: {
        ERROR_MESSAGE_TIMEOUT: 4000,
        NEXT_STEP_URL: 'https://vaytieudung.github.io/shinhanbank/pages/vi/step3.html',
        mirrorFrontCamera: false
    },

    init() {
        this.cacheDOMElements();
        if (!('mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices)) {
             this.showPermanentError("Trình duyệt không hỗ trợ camera. Vui lòng sử dụng một trình duyệt khác.");
             return;
        }
        this.addEventListeners();
        console.log("Professional eKYC App initialized.");
    },

    cacheDOMElements() {
        const ids = [
            'guideSection', 'captureSection', 'startCaptureBtn', 'cameraView', 'cameraFrame', 'cameraVideo', 
            'statusMessage', 'loader', 'errorMessage', 'manualCaptureBtn', 'recaptureBtn', 'nextStepBtn', 
            'captureTitle', 'captureInstruction', 'bottomBar', 'finalContinueBtn',
            'step1', 'step2', 'progressBarFill', 'backButton', 'confirmSection',
            'frontPreview', 'backPreview', 'redoFrontBtn', 'redoBackBtn', 'confirmBtn',
            'cameraCanvasPreview',
            'ocrCccdNumber', 'ocrFullName', 'ocrDateOfBirth', 'ocrGender', 'ocrAddress'
        ];
        ids.forEach(id => this.elements[id] = document.getElementById(id));
        this.state.cameraCanvasPreview = this.elements.cameraCanvasPreview;
        this.state.cameraCanvasContext = this.state.cameraCanvasPreview.getContext('2d');
    },

    addEventListeners() {
        this.elements.startCaptureBtn.addEventListener('click', () => this.startCaptureProcess('front'));
        this.elements.manualCaptureBtn.addEventListener('click', () => this.triggerCapture()); // Không cần `false` nữa
        this.elements.recaptureBtn.addEventListener('click', () => this.startCaptureProcess(this.state.currentCaptureType));
        this.elements.nextStepBtn.addEventListener('click', () => {
            if (this.state.currentCaptureType === 'front') {
                this.startCaptureProcess('back');
            }
        });
        this.elements.backButton.addEventListener('click', () => this.cancelCapture(true)); 
        this.elements.finalContinueBtn.addEventListener('click', () => this.showConfirmationScreen());
        this.elements.redoFrontBtn.addEventListener('click', () => this.retakePhoto('front'));
        this.elements.redoBackBtn.addEventListener('click', () => this.retakePhoto('back'));
        this.elements.confirmBtn.addEventListener('click', () => this.submitFinalData());

        if ('orientation' in screen) {
            screen.orientation.addEventListener('change', this.handleOrientationChange.bind(this));
        }
    },
    
    handleOrientationChange() {
        console.log(`Màn hình đã xoay. Hướng hiện tại: ${screen.orientation.type}`);
        if (!this.elements.captureSection.classList.contains('hidden')) {
            console.log("Đang trong màn hình chụp, khởi động lại camera để điều chỉnh hướng.");
            this.stopCamera();
            setTimeout(() => {
                this.startCaptureProcess(this.state.currentCaptureType);
            }, 200);
        }
    },
    
    async startCaptureProcess(type) {
        this.state.currentCaptureType = type;
        this.state.simulationAttempts = 0;
        this.resetUIForCapture(type);
        
        try {
            const constraints = {
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1920 }, 
                    height: { ideal: 1080 },
                }
            };
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            this.state.currentStream = stream;
            this.elements.cameraVideo.srcObject = stream;
            
            const videoTrack = stream.getVideoTracks()[0];
            const trackSettings = videoTrack.getSettings();
            this.state.currentFacingMode = trackSettings.facingMode || 'environment';

            if (!stream.active) {
                this.showPermanentError("Không thể kích hoạt luồng camera.");
                return;
            }

            this.elements.cameraVideo.onloadedmetadata = () => {
                const video = this.elements.cameraVideo;
                if (video.videoHeight > video.videoWidth) {
                     this.state.videoOrientation = 90;
                } else {
                     this.state.videoOrientation = 0;
                }
                
                this.state.cameraCanvasPreview.width = this.elements.cameraFrame.offsetWidth;
                this.state.cameraCanvasPreview.height = this.elements.cameraFrame.offsetHeight;
                
                this.drawVideoToCanvas();
                this.autoCaptureLoop(); // Bắt đầu vòng lặp HƯỚNG DẪN
            };

            await this.elements.cameraVideo.play();
        } catch (err) {
            console.error("Camera Error:", err);
            let message = "Không thể truy cập camera.";
            if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") {
                message = "Bạn đã từ chối quyền truy cập camera. Vui lòng cấp quyền trong cài đặt trình duyệt.";
            }
            this.showPermanentError(message);
        }
    },

    drawVideoToCanvas() {
        if (!this.state.currentStream || !this.state.currentStream.active) {
            if (this.state.animationFrameId) cancelAnimationFrame(this.state.animationFrameId);
            return;
        }

        const video = this.elements.cameraVideo;
        const canvas = this.state.cameraCanvasPreview;
        const context = this.state.cameraCanvasContext;
        const canvasWidth = canvas.width;
        const canvasHeight = canvas.height;
        
        let videoWidth = video.videoWidth;
        let videoHeight = video.videoHeight;

        context.save();
        context.clearRect(0, 0, canvasWidth, canvasHeight);

        let rotateAngle = 0;
        let drawSourceWidth = videoWidth;
        let drawSourceHeight = videoHeight;

        if (this.state.videoOrientation === 90) {
            rotateAngle = Math.PI / 2;
            [drawSourceWidth, drawSourceHeight] = [videoHeight, videoWidth];
        }

        let scaleX = 1;
        let scaleY = 1;

        if (this.state.currentFacingMode === 'user' && this.config.mirrorFrontCamera) {
            scaleX = -1;
        }
        
        let scale = Math.max(canvasWidth / drawSourceWidth, canvasHeight / drawSourceHeight);
        let scaledWidth = drawSourceWidth * scale;
        let scaledHeight = drawSourceHeight * scale;

        context.translate(canvasWidth / 2, canvasHeight / 2);
        context.rotate(rotateAngle);
        context.scale(scaleX, scaleY);
        context.drawImage(video, -scaledWidth / 2, -scaledHeight / 2, scaledWidth, scaledHeight);
        context.restore();

        this.state.animationFrameId = requestAnimationFrame(() => this.drawVideoToCanvas());
    },
    
    // [ĐÃ SỬA] Hàm này giờ chỉ hướng dẫn và bật/tắt nút chụp thủ công
    autoCaptureLoop() {
        if (!this.state.currentStream || !this.state.currentStream.active) {
            return;
        }

        const validation = this.simulateValidation();
        this.elements.statusMessage.textContent = validation.message;

        // Kiểm tra xem điều kiện chụp đã tốt chưa
        if (validation.code === 'READY') {
            // Nếu tốt, bật khung viền xanh
            this.setCameraFrameReady(true);
            // và kích hoạt nút chụp thủ công
            this.elements.manualCaptureBtn.disabled = false;
        } else {
            // Nếu chưa tốt, tắt khung viền xanh
            this.setCameraFrameReady(false);
            // và vô hiệu hóa nút chụp thủ công để người dùng không chụp ảnh xấu
            this.elements.manualCaptureBtn.disabled = true;
        }
        
        // Tiếp tục vòng lặp để cập nhật hướng dẫn liên tục
        setTimeout(() => this.autoCaptureLoop(), 700);
    },

    triggerCapture() {
        if (this.isAutoCapturing) return;

        // Dừng vòng lặp hướng dẫn để tránh các thông báo không cần thiết
        this.stopAutoCapture();
        this.isAutoCapturing = true; // Sử dụng để ngăn các hành động khác

        this.toggleUIState('loading');
        this.elements.cameraFrame.classList.add('blink-once');
        setTimeout(() => this.elements.cameraFrame.classList.remove('blink-once'), 500);

        this.handleImageVerification();
    },

    async handleImageVerification() {
        if (!this.state.currentStream) {
            this.showError("Lỗi: Luồng camera không hoạt động.");
            this.toggleUIState('error');
            this.isAutoCapturing = false;
            return;
        }

        const imageDataUrl = this.state.cameraCanvasPreview.toDataURL('image/jpeg', 0.9);
        const { isValid, message } = this.simulateValidationAfterCapture(); 
        
        await new Promise(resolve => setTimeout(resolve, 1000));

        if (isValid) {
            this.handleVerificationSuccess(imageDataUrl);
        } else {
            this.handleVerificationFailure(message);
        }
        
        this.isAutoCapturing = false;
        // Nếu chụp lỗi, khởi động lại vòng lặp hướng dẫn
        if (!isValid) {
            this.autoCaptureLoop(); 
        }
    },
    
    simulateValidation() {
        const randomFactor = Math.random();
        if (this.elements.cameraFrame.classList.contains('ready-to-capture') === false && randomFactor > 0.5) {
            return { code: 'NO_CARD', message: "Hãy đưa giấy tờ vào trong khung hình..." };
        }
        if (randomFactor < 0.2) {
             return { code: 'BLURRY', message: "Ảnh bị mờ, vui lòng giữ máy ổn định." };
        }
        if (randomFactor > 0.8) {
             return { code: 'GLARE', message: "Ảnh bị lóa sáng, vui lòng tránh ánh đèn." };
        }
        return { code: 'READY', message: "Rất tốt! Nhấn nút để chụp ảnh." }; // Thay đổi thông báo
    },

    simulateValidationAfterCapture() {
        this.state.simulationAttempts++;
        const testCase = this.state.simulationAttempts % 4;
        
        switch (testCase) {
            case 0: return { isValid: true, message: "Tải ảnh thành công!" }; 
            case 1: return { isValid: false, message: "Ảnh không phải là CCCD/CMND. Vui lòng chụp lại." };
            case 2: return { isValid: false, message: "Ảnh CCCD bị mờ. Vui lòng chụp lại rõ nét hơn." };
            case 3: return { isValid: false, message: "Ảnh CCCD bị lóa sáng. Vui lòng chụp lại." };
            default: return { isValid: true, message: "Tải ảnh thành công!" };
        }
    },

    handleVerificationSuccess(imageDataUrl) {
        this.stopCamera();
        const type = this.state.currentCaptureType;
        if (type === 'front') {
            this.state.frontImageDataUrl = imageDataUrl;
            this.state.frontImageVerified = true;
            this.updateProgress(1, true);
        } else {
            this.state.backImageDataUrl = imageDataUrl;
            this.state.backImageVerified = true;
            this.updateProgress(2, true);
        }
        
        if (this.state.frontImageVerified && this.state.backImageVerified) {
            this.state.extractedInfo = this.simulateOCR();
        }

        this.triggerHapticFeedback(); 
        this.setCameraFrameReady(false); 
        this.toggleUIState('success');
        this.updateFinalButtonState();
    },

    simulateOCR() {
        const randomId = Math.floor(100000000000 + Math.random() * 900000000000);
        return {
            cccdNumber: `0${String(randomId).slice(1)}`,
            fullName: "NGUYEN VAN A",
            dateOfBirth: "01/01/1990",
            gender: "Nam",
            address: "TP. Hồ Chí Minh, Việt Nam"
        };
    },

    handleVerificationFailure(message) {
        this.elements.statusMessage.textContent = message; 
        this.showError(message, true); 
        this.toggleUIState('error'); 
    },
    
    updateProgress(step, isComplete = false) {
        if (step === 0) {
            this.elements.step1.classList.remove('active', 'completed');
            this.elements.step2.classList.remove('active', 'completed');
            this.elements.progressBarFill.style.width = '0%';
            return;
        }
        if (step === 1) {
            this.elements.step1.classList.add('active');
            this.elements.step2.classList.remove('active', 'completed');
            this.elements.progressBarFill.style.width = '0%';
            if (isComplete) {
                this.elements.step1.classList.add('completed');
                this.elements.progressBarFill.style.width = '50%';
            }
        } else if (step === 2) {
            this.elements.step1.classList.add('active', 'completed');
            this.elements.step2.classList.add('active');
            this.elements.progressBarFill.style.width = '50%';
            if (isComplete) {
                this.elements.step2.classList.add('completed');
                this.elements.progressBarFill.style.width = '100%';
            }
        }
    },

    stopCamera() {
        if (this.state.currentStream) {
            this.state.currentStream.getTracks().forEach(track => track.stop());
            this.state.currentStream = null;
        }
        this.stopAutoCapture();
        if (this.state.animationFrameId) {
            cancelAnimationFrame(this.state.animationFrameId);
            this.state.animationFrameId = null;
        }
        if (this.state.cameraCanvasContext) {
            this.state.cameraCanvasContext.clearRect(0, 0, this.state.cameraCanvasPreview.width, this.state.cameraCanvasPreview.height);
        }
    },

    // [ĐÃ SỬA] Đổi tên để rõ nghĩa hơn
    stopAutoCapture() {
        // Hàm này giờ có thể dùng để dừng vòng lặp hướng dẫn
        const allTimeouts = setTimeout(function(){}, 0);
        for (let i = 0; i < allTimeouts; i++) {
             clearTimeout(i);
        }
    },

    showError(message, autoHide = false) {
        this.elements.errorMessage.textContent = message || '';
        this.elements.errorMessage.classList.add('visible');
        if (autoHide) {
            setTimeout(() => this.elements.errorMessage.classList.remove('visible'), this.config.ERROR_MESSAGE_TIMEOUT);
        }
    },
    
    showPermanentError(message) {
        this.elements.guideSection.innerHTML = `
            <div class="error-message visible" style="margin-bottom: 20px;">${message}</div>
            <div class="button-group"><button onclick="window.location.reload()" class="btn btn-primary">Tải lại trang</button></div>`;
    },

    updateFinalButtonState() {
        const enabled = this.state.frontImageVerified && this.state.backImageVerified;
        this.elements.finalContinueBtn.disabled = !enabled;
        this.elements.bottomBar.classList.toggle('hidden', !enabled);
    },
    
    showConfirmationScreen() {
        this.stopCamera();
        this.elements.captureSection.classList.add('hidden');
        this.elements.bottomBar.classList.add('hidden');
        this.elements.backButton.classList.add('hidden');
        this.elements.confirmSection.classList.remove('hidden');
        this.elements.frontPreview.src = this.state.frontImageDataUrl;
        this.elements.backPreview.src = this.state.backImageDataUrl;

        this.elements.ocrCccdNumber.textContent = this.state.extractedInfo.cccdNumber;
        this.elements.ocrFullName.textContent = this.state.extractedInfo.fullName;
        this.elements.ocrDateOfBirth.textContent = this.state.extractedInfo.dateOfBirth;
        this.elements.ocrGender.textContent = this.state.extractedInfo.gender;
        this.elements.ocrAddress.textContent = this.state.extractedInfo.address;
    },

    async submitFinalData() {
        this.elements.confirmBtn.classList.add('is-loading'); 
        
        const finalData = {
            frontImage: this.state.frontImageDataUrl,
            backImage: this.state.backImageDataUrl,
            ocrData: {
                cccdNumber: this.elements.ocrCccdNumber.textContent,
                fullName: this.elements.ocrFullName.textContent,
                dateOfBirth: this.elements.ocrDateOfBirth.textContent,
                gender: this.elements.ocrGender.textContent,
                address: this.elements.ocrAddress.textContent,
            }
        };
        console.log("Data to be submitted:", finalData);
        
        try {
            await new Promise(resolve => setTimeout(resolve, 1500));
            console.log('Data submitted successfully (simulated). Redirecting...');
            window.location.href = this.config.NEXT_STEP_URL;
        } catch (err) {
            this.showError("Lỗi khi gửi dữ liệu. Vui lòng thử lại.");
            this.elements.confirmBtn.classList.remove('is-loading'); 
        }
    },
    
    retakePhoto(type) {
        this.elements.confirmSection.classList.add('hidden');
        if (type === 'front') {
            this.state.frontImageVerified = false;
            this.state.frontImageDataUrl = null;
        } else {
            this.state.backImageVerified = false;
            this.state.backImageDataUrl = null;
        }
        this.updateFinalButtonState();
        this.startCaptureProcess(type);
    },

    cancelCapture(isFullReset = false) {
        this.stopCamera();
        this.elements.captureSection.classList.add('hidden');
        this.elements.confirmSection.classList.add('hidden');
        this.elements.guideSection.classList.remove('hidden');
        this.elements.bottomBar.classList.add('hidden');
        this.elements.backButton.classList.add('hidden');
        this.updateProgress(0); 
        
        this.state.frontImageVerified = false;
        this.state.backImageVerified = false;
        this.state.extractedInfo = {};

        if (isFullReset) { 
            this.state.frontImageDataUrl = null;
            this.state.backImageDataUrl = null;
        }
        this.elements.finalContinueBtn.disabled = true;
        this.setCameraFrameReady(false);
    },

    // [ĐÃ SỬA] Vô hiệu hóa nút chụp khi bắt đầu
    resetUIForCapture(type) {
        const isFront = type === 'front';
        this.elements.guideSection.classList.add('hidden');
        this.elements.confirmSection.classList.add('hidden');
        this.elements.captureSection.classList.remove('hidden');
        this.elements.backButton.classList.remove('hidden');
        
        this.elements.captureSection.className = 'capture-type-' + type;

        this.elements.captureTitle.textContent = isFront ? "Chụp mặt trước CCCD/CMND" : "Chụp mặt sau CCCD/CMND";
        this.elements.captureInstruction.textContent = "Vui lòng đặt CCCD/CMND vào khung hình.";
        
        this.updateProgress(isFront ? 1 : 2);
        this.toggleUIState('capturing'); 
        this.setCameraFrameReady(false);
        this.elements.manualCaptureBtn.disabled = true;
    },

    setCameraFrameReady(isReady) {
        this.elements.cameraFrame.classList.toggle('ready-to-capture', isReady);
    },

    triggerHapticFeedback() {
        if ("vibrate" in navigator) {
            navigator.vibrate(50); 
        }
    },
    
    toggleUIState(state) {
        this.elements.captureSection.dataset.state = state;
        this.elements.errorMessage.classList.remove('visible'); 

        if (state === 'capturing') {
            this.elements.statusMessage.textContent = "Hệ thống đang tìm kiếm CCCD/CMND...";
        } else if (state === 'loading') {
            this.elements.statusMessage.textContent = "Đang phân tích hình ảnh...";
        } else if (state === 'success') {
            const type = this.state.currentCaptureType;
            this.elements.statusMessage.textContent = type === 'front' ? "Đã lưu mặt trước." : "Đã lưu mặt sau.";
        }
    }
};

document.addEventListener('DOMContentLoaded', () => {
    IDCaptureApp.init();
});
</script>
